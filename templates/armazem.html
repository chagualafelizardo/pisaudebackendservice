{% extends 'base.html' %}
{% block title %}PI-SA√öDE / Armaz√©ns{% endblock %}

{% block content %}
<!-- {% include 'navbar.html' %} -->

<h2>Gest√£o de Armaz√©ns</h2>

<!-- Campo de pesquisa -->
<div class="mb-3 position-relative" style="max-width: 400px;">
    <input type="text" id="armazemSearch" class="form-control" placeholder="Pesquisar armaz√©m..." oninput="filtrarTabela(this.value)">
</div>

<!-- Bot√£o de exportar Excel -->
<div class="mb-3">
    <button class="btn btn-outline-success" onclick="downloadExcel()">üì• Exportar Excel</button>
</div>

<!-- Bot√£o flutuante -->
<button class="btn btn-success rounded-circle position-fixed"
        style="bottom: 20px; right: 20px; width: 60px; height: 60px; font-size: 28px; z-index: 1000;"
        onclick="abrirModalArmazem()">
    +
</button>

<!-- Tabela -->
<table class="table table-bordered" id="armazemTable">
    <thead>
        <tr>
            <th>ID</th>
            <th>Nome</th>
            <th>Prov√≠ncia</th>
            <th>Latitude</th>
            <th>Longitude</th>
            <th>Sync Status</th>
            <th>A√ß√µes</th>
        </tr>
    </thead>
    <tbody id="armazemTableBody"></tbody>
</table>

<!-- Modal -->
<div class="modal fade" id="armazemModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <form id="armazemForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Adicionar / Editar Armaz√©m</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <input type="hidden" id="armazemId">

        <div class="mb-3">
          <label class="form-label">Nome</label>
          <input type="text" id="armazemNome" class="form-control" required>
        </div>

        <div class="mb-3">
          <label class="form-label">Prov√≠ncia</label>
          <select id="armazemProvincia" class="form-select" required></select>
        </div>

        <!-- Campos de Latitude e Longitude -->
        <div class="row">
          <div class="col">
            <label class="form-label">Latitude</label>
            <input type="text" id="armazemLat" class="form-control" readonly>
          </div>
          <div class="col">
            <label class="form-label">Longitude</label>
            <input type="text" id="armazemLng" class="form-control" readonly>
          </div>
        </div>

        <!-- Campo de pesquisa de local -->
        <div class="mt-3">
          <label for="mapSearch" class="form-label">Pesquisar Local</label>
          <input type="text" id="mapSearch" class="form-control" placeholder="Pesquise um local...">
        </div>

        <!-- Mapa -->
        <div id="mapContainer" style="position: relative; height: 400px; margin-top: 10px;">
          <div id="map" style="height: 100%; border-radius: 10px;"></div>
          <button id="toggleMapTypeBtn" type="button" class="btn btn-info position-absolute" style="top: 10px; left: 10px; z-index: 1000;">
            Satellite
          </button>
        </div>

        <div class="mt-3">
          <label class="form-label">Sync Status</label>
          <select id="armazemSyncStatus" class="form-select">
            <option value="Not Syncronized">Not Syncronized</option>
            <option value="Syncronized">Syncronized</option>
            <option value="Updated">Updated</option>
          </select>
        </div>

        <div class="mb-3 mt-2">
          <label class="form-label">Sync Status Date</label>
          <input type="datetime-local" id="armazemSyncDate" class="form-control">
        </div>
      </div>

      <div class="modal-footer">
        <button type="submit" class="btn btn-primary">Salvar</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
      </div>
    </form>
  </div>
</div>

<!-- XLSX -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<!-- Google Maps -->
<script async
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDw8qHIN9go7Do3aouyR9343opJ33ZdDb0&libraries=places">
</script>

<script>
let allArmazens = [];
let allProvincias = [];
const apiUrl = '/api/armazem';
const provinciaUrl = '/api/provincia';

let map, marker, autocomplete;

// Coordenadas de Maputo
const MAPUTO_CENTER = { lat: -25.9636, lng: 32.5805 };

/* -------------------- CARREGAMENTO -------------------- */
window.onload = () => {
    loadProvincias();
    loadArmazens();
};

/* -------------------- MAPA -------------------- */
function initializeMap(lat = -25.9636, lng = 32.5805) {
    const center = { lat: parseFloat(lat), lng: parseFloat(lng) };

    // Limpa o container antes de recriar se necess√°rio
    if (!document.getElementById("map").innerHTML) {
        document.getElementById("map").innerHTML = "";
    }

    map = new google.maps.Map(document.getElementById("map"), {
        center: center,
        zoom: 7,
        mapTypeId: "terrain"
    });

    // Remove marcador anterior se existir
    if (marker) {
        marker.setMap(null);
    }

    // Cria marcador na posi√ß√£o inicial
    marker = new google.maps.Marker({
        position: center,
        map: map,
        draggable: true
    });

    // Atualiza coordenadas ao clicar no mapa
    map.addListener("click", (event) => {
        marker.setPosition(event.latLng);
        document.getElementById("armazemLat").value = event.latLng.lat().toFixed(6);
        document.getElementById("armazemLng").value = event.latLng.lng().toFixed(6);
    });

    // Atualiza coordenadas ao arrastar o marcador
    marker.addListener("dragend", () => {
        const pos = marker.getPosition();
        document.getElementById("armazemLat").value = pos.lat().toFixed(6);
        document.getElementById("armazemLng").value = pos.lng().toFixed(6);
    });

    // Configura a pesquisa de lugares
    const input = document.getElementById("mapSearch");
    autocomplete = new google.maps.places.Autocomplete(input);
    autocomplete.bindTo("bounds", map);

    autocomplete.addListener("place_changed", () => {
        const place = autocomplete.getPlace();
        if (!place.geometry) return;

        map.panTo(place.geometry.location);
        map.setZoom(15);
        marker.setPosition(place.geometry.location);

        document.getElementById("armazemLat").value = place.geometry.location.lat().toFixed(6);
        document.getElementById("armazemLng").value = place.geometry.location.lng().toFixed(6);
    });

    // Bot√£o para alternar tipo de mapa
    const btn = document.getElementById("toggleMapTypeBtn");
    btn.onclick = () => {
        const current = map.getMapTypeId();
        const newType = current === "terrain" ? "satellite" : "terrain";
        map.setMapTypeId(newType);
        btn.textContent = newType === "terrain" ? "Satellite" : "Map";
    };

    // Atualiza coordenadas iniciais
    document.getElementById("armazemLat").value = center.lat.toFixed(6);
    document.getElementById("armazemLng").value = center.lng.toFixed(6);
}

/* -------------------- MODAL -------------------- */
function abrirModalArmazem() {
    // Reseta o formul√°rio
    document.getElementById('armazemForm').reset();
    document.getElementById('armazemId').value = '';
    document.getElementById('armazemLat').value = '';
    document.getElementById('armazemLng').value = '';
    document.getElementById('mapSearch').value = '';

    // Mostra o modal
    const modal = new bootstrap.Modal(document.getElementById('armazemModal'));
    modal.show();

    // ‚ö° Inicializa o mapa quando o modal estiver vis√≠vel
    document.getElementById('armazemModal').addEventListener('shown.bs.modal', function() {
        initializeMap();
        
        // For√ßa a atualiza√ß√£o do mapa
        setTimeout(() => {
            google.maps.event.trigger(map, "resize");
            map.setCenter(MAPUTO_CENTER);
        }, 100);
    }, { once: true });
}

/* -------------------- CARREGAR DADOS -------------------- */
async function loadProvincias() {
    try {
        const res = await fetch(provinciaUrl);
        allProvincias = await res.json();
        const select = document.getElementById('armazemProvincia');
        select.innerHTML = '<option value="">Selecione a prov√≠ncia</option>';
        allProvincias.forEach(p => select.innerHTML += `<option value="${p.id}">${p.nome}</option>`);
    } catch (error) {
        console.error('Erro ao carregar prov√≠ncias:', error);
    }
}

async function loadArmazens() {
    try {
        const res = await fetch(apiUrl);
        allArmazens = await res.json();
        filtrarTabela(document.getElementById('armazemSearch').value);
    } catch (error) {
        console.error('Erro ao carregar armaz√©ns:', error);
        alert('Erro ao carregar armaz√©ns: ' + error.message);
    }
}

/* -------------------- FILTRO -------------------- */
function filtrarTabela(query) {
    const tbody = document.getElementById('armazemTableBody');
    tbody.innerHTML = '';
    const termo = query.trim().toLowerCase();
    allArmazens
        .filter(a => (a.nome || '').toLowerCase().includes(termo) || (a.provincia_nome || '').toLowerCase().includes(termo))
        .forEach(a => {
            tbody.innerHTML += `
            <tr>
                <td>${a.id}</td>
                <td>${a.nome}</td>
                <td>${a.provincia_nome || ''}</td>
                <td>${a.latitude || ''}</td>
                <td>${a.longitude || ''}</td>
                <td>${a.syncStatus || ''}</td>
                <td>
                    <button class="btn btn-sm btn-warning" onclick="editarArmazem(${a.id})">Editar</button>
                    <button class="btn btn-sm btn-danger" onclick="eliminarArmazem(${a.id})">Apagar</button>
                </td>
            </tr>`;
        });
}

/* -------------------- EDITAR -------------------- */
function editarArmazem(id) {
    const a = allArmazens.find(a => a.id === id);
    if (!a) return;
    
    document.getElementById('armazemId').value = a.id;
    document.getElementById('armazemNome').value = a.nome || '';
    document.getElementById('armazemProvincia').value = a.provincia_id || '';
    document.getElementById('armazemLat').value = a.latitude || '';
    document.getElementById('armazemLng').value = a.longitude || '';
    document.getElementById('armazemSyncStatus').value = a.syncStatus || 'Not Syncronized';
    document.getElementById('armazemSyncDate').value = a.syncStatusDate ? a.syncStatusDate.slice(0,16) : '';

    const modal = new bootstrap.Modal(document.getElementById('armazemModal'));
    modal.show();

    // Inicializa o mapa quando o modal estiver vis√≠vel
    document.getElementById('armazemModal').addEventListener('shown.bs.modal', function() {
        if (a.latitude && a.longitude) {
            // Se tem coordenadas, inicializa o mapa nessa posi√ß√£o
            initializeMap(a.latitude, a.longitude);
            
            // Ajusta o zoom e centraliza
            setTimeout(() => {
                google.maps.event.trigger(map, "resize");
                const position = {
                    lat: parseFloat(a.latitude),
                    lng: parseFloat(a.longitude)
                };
                map.setCenter(position);
                map.setZoom(15);
            }, 100);
        } else {
            // Se n√£o tem coordenadas, inicializa em Maputo
            initializeMap();
            setTimeout(() => {
                google.maps.event.trigger(map, "resize");
                map.setCenter(MAPUTO_CENTER);
            }, 100);
        }
    }, { once: true });
}

/* -------------------- GUARDAR -------------------- */
document.getElementById('armazemForm').addEventListener('submit', async e => {
    e.preventDefault();
    
    const id = document.getElementById('armazemId').value;
    const nome = document.getElementById('armazemNome').value;
    const provincia_id = document.getElementById('armazemProvincia').value;
    const latitude = document.getElementById('armazemLat').value;
    const longitude = document.getElementById('armazemLng').value;
    const syncStatus = document.getElementById('armazemSyncStatus').value;
    const syncStatusDate = document.getElementById('armazemSyncDate').value;

    const payload = {
        nome: nome,
        provincia_id: parseInt(provincia_id),
        latitude: latitude ? parseFloat(latitude) : null,
        longitude: longitude ? parseFloat(longitude) : null,
        syncStatus: syncStatus,
        syncStatusDate: syncStatusDate ? new Date(syncStatusDate).toISOString() : null
    };

    try {
        const url = id ? `${apiUrl}/${id}` : apiUrl;
        const method = id ? 'PUT' : 'POST';

        const res = await fetch(url, {
            method: method,
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(payload)
        });

        if (!res.ok) {
            const error = await res.json();
            throw new Error(error.message || 'Erro ao salvar armaz√©m');
        }

        // Fecha o modal e recarrega a lista
        const modal = bootstrap.Modal.getInstance(document.getElementById('armazemModal'));
        modal.hide();
        
        // Remove o backdrop manualmente
        document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
        
        loadArmazens();
        
    } catch(err) {
        console.error('Erro ao salvar armaz√©m:', err);
        alert(err.message || 'Erro ao salvar armaz√©m');
    }
});

/* -------------------- ELIMINAR -------------------- */
async function eliminarArmazem(id) {
    if (!confirm('Tem certeza que deseja apagar este armaz√©m?')) return;
    
    try {
        const res = await fetch(`${apiUrl}/${id}`, { method: 'DELETE' });
        
        if (!res.ok) {
            const error = await res.json();
            throw new Error(error.message || 'Erro ao apagar armaz√©m');
        }
        
        loadArmazens();
        
    } catch(err) {
        console.error('Erro ao apagar armaz√©m:', err);
        alert(err.message || 'Erro ao apagar armaz√©m');
    }
}

/* -------------------- EXPORTAR EXCEL -------------------- */
function downloadExcel() {
    const table = document.getElementById("armazemTable");
    const wb = XLSX.utils.table_to_book(table, { sheet: "Armazens" });
    XLSX.writeFile(wb, "armazens.xlsx");
}
</script>

{% endblock %}