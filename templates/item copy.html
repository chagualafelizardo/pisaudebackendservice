{% extends 'base.html' %}
{% block title %}PI-SA√öDE / Itens{% endblock %}

{% block content %}
<!-- {% include 'navbar.html' %} -->

<h2>Gest√£o de Itens</h2>

<!-- Controles de visualiza√ß√£o e pesquisa -->
<div class="d-flex justify-content-between align-items-center mb-3">
    <div class="d-flex align-items-center">
        <!-- Campo de pesquisa -->
        <div class="position-relative me-3" style="max-width: 400px;">
            <input type="text" id="itemSearch" class="form-control" placeholder="Pesquisar item..." oninput="filtrarItens(this.value)">
        </div>
        
        <!-- Bot√£o de exportar Excel -->
        <button class="btn btn-outline-success me-2" onclick="downloadExcel()">üì• Exportar Excel</button>
    </div>
    
    <!-- Bot√µes de visualiza√ß√£o -->
    <div class="btn-group" role="group">
        <input type="radio" class="btn-check" name="viewType" id="blockView" autocomplete="off" checked onchange="toggleView('block')">
        <label class="btn btn-outline-primary" for="blockView">
            <i class="bi bi-grid-3x3-gap"></i> Blocos
        </label>
        
        <input type="radio" class="btn-check" name="viewType" id="tableView" autocomplete="off" onchange="toggleView('table')">
        <label class="btn btn-outline-primary" for="tableView">
            <i class="bi bi-table"></i> Tabela
        </label>
    </div>
</div>

<!-- Elemento de anima√ß√£o de distribui√ß√£o -->
<div id="distribuicaoAnimation" style="position: fixed; bottom: 20px; left: 20px; z-index: 999; display: none;">
    <div class="d-flex align-items-center">
        <!-- √çcone do hospital/unidade sanit√°ria -->
        <div class="hospital-icon" style="position: relative;">
            <i class="bi bi-hospital-fill text-primary" style="font-size: 3rem;"></i>
            <div class="hospital-pulse"></div>
        </div>
        
        <!-- Linhas de anima√ß√£o -->
        <div id="animationLines" style="position: absolute; top: 0; left: 60px; width: calc(100vw - 100px); height: 100px; pointer-events: none;"></div>
    </div>
</div>

<!-- Bot√£o flutuante -->
<button class="btn btn-success rounded-circle position-fixed"
        style="bottom: 20px; right: 20px; width: 60px; height: 60px; font-size: 28px; z-index: 1000;"
        onclick="abrirModalItem()">
    +
</button>

<!-- Visualiza√ß√£o em Blocos (PADR√ÉO) -->
<div id="blockViewContainer" style="display: block;">
    <div class="row g-3" id="itemBlocksContainer"></div>
</div>

<!-- Visualiza√ß√£o em Tabela -->
<div id="tableViewContainer" style="display: none;">
    <table class="table table-bordered align-middle" id="itemTable">
        <thead>
            <tr>
                <th>ID</th>
                <th>Image</th>
                <th>C√≥digo</th>
                <th>Designa√ß√£o</th>
                <th>HS Code</th>
                <th>Qtd</th>
                <th>Batch No</th>
                <th>MFG Date</th>
                <th>Expiry Date</th>
                <th>No. Cartons</th>
                <th>Sync Status</th>
                <th>Distribu√≠do</th>
                <th>A√ß√µes</th>
            </tr>
        </thead>
        <tbody id="itemTableBody"></tbody>
    </table>
</div>

<!-- Painel lateral de detalhes -->
<div id="detalhesPanel" style="position:fixed; top:60px; right:-420px; width:420px; height:90%; background:#fff; border-left:1px solid #ccc; box-shadow: -3px 0 5px rgba(0,0,0,0.2); padding:15px; overflow:auto; transition:right 0.3s; z-index:1050;">
    <button class="btn btn-sm btn-secondary mb-2" onclick="fecharDetalhes()">Fechar</button>
    <div id="detalhesContent"></div>
</div>

<!-- Modal Item -->
<div class="modal fade" id="itemModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <form id="itemForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Adicionar / Editar Item</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="itemId">
        <!-- Nav tabs -->
        <ul class="nav nav-tabs mb-3" id="itemTab" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="basic-tab" data-bs-toggle="tab" data-bs-target="#basic" type="button" role="tab">B√°sico</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="logistics-tab" data-bs-toggle="tab" data-bs-target="#logistics" type="button" role="tab">Datas & Log√≠stica</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="location-tab" data-bs-toggle="tab" data-bs-target="#location" type="button" role="tab">Localiza√ß√£o</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="files-tab" data-bs-toggle="tab" data-bs-target="#files" type="button" role="tab">Arquivos & Observa√ß√µes</button>
          </li>
        </ul>

        <!-- Tab panes -->
        <div class="tab-content">
          <!-- B√°sico -->
          <div class="tab-pane fade show active" id="basic" role="tabpanel">
            <div class="row">
              <div class="row">
                <div class="col-md-12 mb-3">
                  <label class="form-label">Nota de Envio (opcional)</label>
                  <select id="itemNotaEnvio" class="form-select">
                    <option value="">Selecione a nota de envio</option>
                  </select>
                </div>
              </div>
              
              <!-- üîπ Sec√ß√£o para visualizar documentos da Nota de Envio -->
              <div id="notaEnvioDocumentos" class="mt-3" style="display: none;">
                <h6>üìé Documentos da Nota de Envio</h6>
                <ul id="notaEnvioDocsList" class="list-group"></ul>
              </div>

              <div class="col-md-4 mb-3">
                <label class="form-label">C√≥digo</label>
                <input type="text" id="itemCodigo" class="form-control" required>
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label">Designa√ß√£o</label>
                <input type="text" id="itemDesignacao" class="form-control" required>
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label">HS Code</label>
                <input type="text" id="itemHsCode" class="form-control">
              </div>
              <div class="col-md-3 mb-3">
                <label class="form-label">Quantidade</label>
                <input type="number" id="itemQuantidade" class="form-control">
              </div>
              <div class="col-md-3 mb-3">
                <label class="form-label">Batch No</label>
                <input type="text" id="itemBatchNo" class="form-control">
              </div>
            </div>
          </div>

          <!-- Datas & Log√≠stica -->
          <div class="tab-pane fade" id="logistics" role="tabpanel">
            <div class="row">
              <div class="col-md-3 mb-3">
                <label class="form-label">MFG Date</label>
                <input type="date" id="itemDataFabricacao" class="form-control">
              </div>
              <div class="col-md-3 mb-3">
                <label class="form-label">Expiry Date</label>
                <input type="date" id="itemDataValidade" class="form-control">
              </div>
              <div class="col-md-3 mb-3">
                <label class="form-label">No. Cartons</label>
                <input type="number" id="itemNoCartoes" class="form-control">
              </div>
              <div class="col-md-3 mb-3">
                <label class="form-label">Peso Bruto Total</label>
                <input type="number" step="0.01" id="itemPesoBruto" class="form-control">
              </div>
              <div class="col-md-3 mb-3">
                <label class="form-label">Volume CBM</label>
                <input type="number" step="0.01" id="itemVolumeCBM" class="form-control">
              </div>
              <div class="col-md-3 mb-3">
                <label class="form-label">Total Cartons</label>
                <input type="number" id="itemTotalCartoes" class="form-control">
              </div>
              <div class="col-md-3 mb-3">
                <label class="form-label">Total Paletes</label>
                <input type="number" id="itemTotalPaletes" class="form-control">
              </div>
              <div class="col-md-3 mb-3">
                <label class="form-label">Dimens√µes Palete (CM)</label>
                <input type="text" id="itemDimensoesPalete" class="form-control">
              </div>
            </div>
          </div>

          <!-- Localiza√ß√£o -->
          <div class="tab-pane fade" id="location" role="tabpanel">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Armaz√©m</label>
                <select id="itemArmazem" class="form-select" required></select>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Porto de Chegada</label>
                <select id="itemPorto" class="form-select">
                  <option value="">Selecione o porto</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Arquivos & Observa√ß√µes -->
          <div class="tab-pane fade" id="files" role="tabpanel">
            <div class="mb-3">
              <label class="form-label">Imagem do Item</label>
              <input type="file" id="itemImagem" class="form-control" accept="image/*" onchange="previewImagem(event)">
              <img id="previewImg" src="" alt="Pr√©-visualiza√ß√£o" class="img-thumbnail mt-2" style="max-width: 200px; display:none;">
            </div>
            <div class="mb-3">
              <label class="form-label">Comprovativo PDF</label>
              <input type="file" id="itemPdf" class="form-control" accept="application/pdf" onchange="previewPDF(event)">
              <div id="previewPdf" class="mt-2"></div>
            </div>
            <div class="mb-3">
              <label class="form-label">Observa√ß√µes</label>
              <textarea id="itemObservacoes" class="form-control" rows="3"></textarea>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Sync Status</label>
                <select id="itemSyncStatus" class="form-select"></select>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Sync Status Date</label>
                <input type="datetime-local" id="itemSyncDate" class="form-control">
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button type="submit" class="btn btn-primary">Salvar</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal Entrada de Stock com Abas -->
<div class="modal fade" id="entradaStockModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <form id="entradaStockForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Gest√£o de Stock / Necessidades</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="entradaItemId">

        <!-- Nav tabs -->
        <ul class="nav nav-tabs mb-3" id="entradaTab" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="entrada-tab" data-bs-toggle="tab" data-bs-target="#entrada" type="button" role="tab">Entrada Stock</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="necessidades-tab" data-bs-toggle="tab" data-bs-target="#necessidades" type="button" role="tab">Necessidades</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="historico-tab" data-bs-toggle="tab" data-bs-target="#historico" type="button" role="tab">Hist√≥rico</button>
          </li>
        </ul>

        <!-- Tab panes -->
        <div class="tab-content">
          <!-- Entrada Stock -->
          <div class="tab-pane fade show active" id="entrada" role="tabpanel">
            <div class="mb-3">
              <label class="form-label">Quantidade</label>
              <input type="number" id="entradaQuantidade" class="form-control" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Observa√ß√µes</label>
              <textarea id="entradaObservacoes" class="form-control"></textarea>
            </div>
          </div>

          <!-- Necessidades -->
          <div class="tab-pane fade" id="necessidades" role="tabpanel">
            <div class="mb-3">
              <h6>Adicionar Necessidade para este item:</h6>
              <div class="row g-2">
                <div class="col-md-4">
                  <input type="number" id="necessidadeQuantidade" class="form-control" placeholder="Quantidade necess√°ria">
                </div>
                <div class="col-md-4">
                  <input type="text" id="necessidadeDescricao" class="form-control" placeholder="Descri√ß√£o / Observa√ß√µes">
                </div>
                <div class="col-md-4">
                  <select id="necessidadeLocation" class="form-select">
                    <option value="">Selecione a Location</option>
                  </select>
                </div>
              </div>
              <button type="button" class="btn btn-sm btn-primary mt-2" onclick="adicionarNecessidade()">Adicionar Necessidade</button>
            </div>
            <hr>
            <div id="listaNecessidadesContainer">
              <!-- Lista carregada via JS -->
              <p>Carregando necessidades...</p>
            </div>
          </div>

          <!-- Hist√≥rico -->
          <div class="tab-pane fade" id="historico" role="tabpanel">
            <div id="historicoStockModalContainer">
              <p>Carregando hist√≥rico...</p>
            </div>
          </div>

        </div>
      </div>

      <div class="modal-footer">
        <button type="submit" class="btn btn-primary">Registrar Entrada</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal Distribui√ß√£o -->
<div class="modal fade" id="distribuicaoModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <form id="distribuicaoForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Distribui√ß√£o de Item</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="distribuicaoItemId">

        <!-- Imagem e descri√ß√£o do item -->
        <div class="mb-3 text-center">
          <img id="distribuicaoItemImg" src="/static/no-image.png" alt="Imagem do Item" class="img-thumbnail mb-2" style="max-width: 200px;">
          <h5 id="distribuicaoItemDescricao"></h5>
          <h6 id="distribuicaoItemHSCode"></h6>
        </div>

        <!-- Campos do formul√°rio -->
        <div class="mb-3">
          <label class="form-label">Armaz√©m</label>
          <select id="distribuicaoArmazem" class="form-select" required>
            <option value="">Selecione o armaz√©m</option>
          </select>
        </div>

        <div class="mb-3">
          <label class="form-label">Unidade Sanit√°ria / Location</label>
          <select id="distribuicaoLocation" class="form-select" required>
            <option value="">Selecione a unidade sanit√°ria</option>
          </select>
        </div>

        <div class="mb-3">
          <label class="form-label">Quantidade</label>
          <input type="number" id="distribuicaoQuantidade" class="form-control" required>
        </div>

        <div class="mb-3">
          <label class="form-label">Data de Distribui√ß√£o</label>
          <input type="date" id="distribuicaoData" class="form-control" required>
        </div>

        <div class="mb-3">
          <label class="form-label">Observa√ß√£o</label>
          <textarea id="distribuicaoObservacao" class="form-control"></textarea>
        </div>

      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-primary">Registrar Distribui√ß√£o</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
      </div>
    </form>
  </div>
</div>

<style>
.card-item {
    transition: transform 0.2s, box-shadow 0.2s;
    height: 100%;
}
.card-item:hover {
    transform: translateY(-5px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
.card-item.distribuido {
    border-left: 4px solid #0d6efd;
    background: linear-gradient(135deg, #f8f9ff 0%, #ffffff 100%);
}
.card-item.nao-distribuido {
    border-left: 4px solid #dc3545;
    background: linear-gradient(135deg, #fff5f5 0%, #ffffff 100%);
}
.card-img-container {
    height: 180px;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #f8f9fa;
}
.card-img-container img {
    max-height: 100%;
    width: auto;
    object-fit: contain;
}
.card-body {
    display: flex;
    flex-direction: column;
}
.card-actions {
    margin-top: auto;
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
}
.card-actions .btn {
    flex: 1;
    min-width: 60px;
}
.status-badge {
    position: absolute;
    top: 10px;
    right: 10px;
}
.expiry-warning {
    background-color: #ffc107;
    color: #000;
}
.expiry-danger {
    background-color: #dc3545;
    color: #fff;
}
.sync-badge {
    position: absolute;
    top: 10px;
    left: 10px;
}
.sync-synchronized {
    background-color: #198754;
}
.sync-not-synchronized {
    background-color: #6c757d;
}
.sync-updated {
    background-color: #0dcaf0;
    color: #000;
}
.distribuicao-badge {
    position: absolute;
    bottom: 10px;
    right: 10px;
}

/* Anima√ß√µes de distribui√ß√£o */
.hospital-pulse {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 60px;
    height: 60px;
    border: 2px solid #0d6efd;
    border-radius: 50%;
    animation: pulse 2s infinite;
    pointer-events: none;
}

@keyframes pulse {
    0% {
        transform: translate(-50%, -50%) scale(0.8);
        opacity: 1;
    }
    70% {
        transform: translate(-50%, -50%) scale(1.2);
        opacity: 0;
    }
    100% {
        transform: translate(-50%, -50%) scale(1.2);
        opacity: 0;
    }
}

.distribution-line {
    position: absolute;
    height: 2px;
    background: linear-gradient(90deg, #0d6efd, transparent);
    animation: distribute 3s ease-in-out;
    transform-origin: left center;
    pointer-events: none;
}

.distribution-line::after {
    content: '‚û§';
    position: absolute;
    right: -10px;
    top: -8px;
    color: #0d6efd;
    font-size: 12px;
    animation: arrowPulse 1s infinite;
}

@keyframes distribute {
    0% {
        transform: scaleX(0);
        opacity: 1;
    }
    80% {
        transform: scaleX(1);
        opacity: 1;
    }
    100% {
        transform: scaleX(1);
        opacity: 0;
    }
}

@keyframes arrowPulse {
    0%, 100% {
        transform: translateX(0);
    }
    50% {
        transform: translateX(3px);
    }
}

.item-distributed {
    animation: itemGlow 2s ease-in-out;
}

@keyframes itemGlow {
    0%, 100% {
        box-shadow: 0 0 5px rgba(13, 110, 253, 0.5);
    }
    50% {
        box-shadow: 0 0 20px rgba(13, 110, 253, 0.8), 0 0 30px rgba(13, 110, 253, 0.6);
    }
}

/* Estilos para cabe√ßalhos de tabela */
.table-dark {
    background-color: #000 !important;
    color: #fff !important;
}

.table-dark th {
    background-color: #000 !important;
    color: #fff !important;
    border-color: #444 !important;
    font-weight: 600;
}

/* Estilos espec√≠ficos para os modais de stock e necessidades */
/* Melhorias gerais para tabelas */
.table {
    border-collapse: separate;
    border-spacing: 0;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
}

.table th {
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.875rem;
    letter-spacing: 0.5px;
}

/* Garantir contraste adequado */
.table-dark th {
    background-color: #000000 !important;
    color: #ffffff !important;
    border-bottom: 2px solid #444444 !important;
}

/* Estilo para badges nos tipos de movimento */
.badge.bg-success {
    background-color: #198754 !important;
}

.badge.bg-warning {
    background-color: #ffc107 !important;
    color: #000 !important;
}

/* Melhorar a apar√™ncia dos bot√µes nas tabelas */
.table .btn-sm {
    padding: 0.2rem 0.4rem;
    font-size: 0.75rem;
    border-radius: 4px;
}

/* Responsividade para tabelas */
@media (max-width: 768px) {
    .table {
        font-size: 0.8rem;
    }
    
    .table .btn-sm {
        padding: 0.15rem 0.3rem;
        font-size: 0.7rem;
    }
}

</style>

<script>
let allItens = [];
let allArmazens = [];
let allPortos = [];
let allLocations = [];
let imagemBase64 = null;
let pdfBase64 = null;
let allNotasEnvio = [];
let currentView = 'block';
let distribuicoes = []; // Para armazenar as distribui√ß√µes
let animationTimeout = null;

const apiUrl = '/api/item';
const armazemUrl = '/api/armazem';
const portoUrl = '/api/porto';
const locationUrl = '/api/location';
const notaEnvioUrl = '/api/notaenvio';
const distribuicaoUrl = '/api/distribuicao';
const SYNC_STATUS_ENUM = ['Not Syncronized', 'Syncronized', 'Updated'];

// Inicializa√ß√£o
window.onload = () => {
    carregarSyncStatus();
    loadArmazens();
    loadPortos();
    loadLocations();
    loadNotasEnvio();
    loadDistribuicoes();
    loadItens();
    iniciarAnimacaoDistribuicao();
};


// ==========================
// üîπ Carregar Itens - VERS√ÉO CORRIGIDA
// ==========================
async function loadItens() {
    try {
        const res = await fetch(apiUrl);
        allItens = await res.json();
        
        // ‚úÖ Adicionar informa√ß√µes de armaz√©m e porto aos itens
        allItens.forEach(item => {
            // Encontrar nome do armaz√©m
            const armazem = allArmazens.find(a => a.id === item.armazem_id);
            item.armazem_nome = armazem ? armazem.nome : 'N/A';
            
            // Encontrar nome do porto
            const porto = allPortos.find(p => p.id === item.porto_id);
            item.porto_nome = porto ? porto.nome : 'N/A';
        });
        
        // ‚úÖ Renderizar na visualiza√ß√£o atual
        if (currentView === 'block') {
            renderizarBlocos(allItens);
        } else {
            renderizarTabela(allItens);
        }
        
        console.log('üì¶ Itens carregados:', allItens.length);
        
    } catch (err) {
        console.error('‚ùå Erro ao carregar itens', err);
        alert('Erro ao carregar itens: ' + err.message);
    }
}

// ==========================
// üîπ Carregar Sync Status - VERS√ÉO CORRIGIDA
// ==========================
function carregarSyncStatus() {
    const select = document.getElementById('itemSyncStatus');
    if (select) {
        select.innerHTML = '';
        SYNC_STATUS_ENUM.forEach(status => {
            select.innerHTML += `<option value="${status}">${status}</option>`;
        });
    }
}

// ==========================
// üîπ Carregar Armaz√©ns - VERS√ÉO CORRIGIDA
// ==========================
async function loadArmazens() {
    try {
        const res = await fetch(armazemUrl);
        allArmazens = await res.json();
        
        // ‚úÖ Preencher dropdown do modal de item
        const selectItem = document.getElementById('itemArmazem');
        selectItem.innerHTML = '<option value="">Selecione o armaz√©m</option>';
        allArmazens.forEach(a => selectItem.innerHTML += `<option value="${a.id}">${a.nome}</option>`);
        
        // ‚úÖ Preencher dropdown do modal de distribui√ß√£o
        const selectDistribuicao = document.getElementById('distribuicaoArmazem');
        if (selectDistribuicao) {
            selectDistribuicao.innerHTML = '<option value="">Selecione o armaz√©m</option>';
            allArmazens.forEach(a => selectDistribuicao.innerHTML += `<option value="${a.id}">${a.nome}</option>`);
        }
        
    } catch (err) {
        console.error('Erro ao carregar armazens', err);
    }
}

// ==========================
// üîπ Carregar Portos - VERS√ÉO CORRIGIDA
// ==========================
async function loadPortos() {
    try {
        const res = await fetch(portoUrl);
        allPortos = await res.json();
        
        const select = document.getElementById('itemPorto');
        select.innerHTML = '<option value="">Selecione o porto</option>';
        allPortos.forEach(p => select.innerHTML += `<option value="${p.id}">${p.nome}</option>`);
        
    } catch (err) {
        console.error('Erro ao carregar portos', err);
    }
}

// ==========================
// üîπ Carregar Locations - VERS√ÉO CORRIGIDA
// ==========================
async function loadLocations() {
    try {
        const res = await fetch(locationUrl);
        allLocations = await res.json();
        
        // ‚úÖ Preencher dropdown de necessidades
        const selectNecessidade = document.getElementById('necessidadeLocation');
        if (selectNecessidade) {
            selectNecessidade.innerHTML = '<option value="">Selecione a Location</option>';
            allLocations.forEach(l => {
                const nome = l.nome || l.name || l.designacao || `Location ${l.id}`;
                selectNecessidade.innerHTML += `<option value="${l.id}">${nome}</option>`;
            });
        }
        
        // ‚úÖ Preencher dropdown de distribui√ß√£o
        const selectDistribuicao = document.getElementById('distribuicaoLocation');
        if (selectDistribuicao) {
            selectDistribuicao.innerHTML = '<option value="">Selecione a unidade sanit√°ria</option>';
            allLocations.forEach(l => {
                const nome = l.nome || l.name || l.designacao || `Location ${l.id}`;
                selectDistribuicao.innerHTML += `<option value="${l.id}">${nome}</option>`;
            });
        }
        
    } catch (err) {
        console.error('Erro ao carregar locations', err);
    }
}

// ==========================
// üîπ Carregar Notas de Envio
// ==========================
async function loadNotasEnvio() {
    try {
        const res = await fetch(notaEnvioUrl);
        allNotasEnvio = await res.json();
        
        const select = document.getElementById('itemNotaEnvio');
        select.innerHTML = '<option value="">Selecione a nota de envio</option>';
        
        allNotasEnvio.forEach(nota => {
            select.innerHTML += `<option value="${nota.id}" 
                data-numero="${nota.numero_nota}" 
                data-observacoes="${nota.observacoes || ''}">
                ${nota.numero_nota} - ${nota.origem} ‚Üí ${nota.destino}
            </option>`;
        });

        // ‚úÖ Adicionar evento para quando selecionar uma nota
        select.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            if (selectedOption.value) {
                // Preencher automaticamente os campos
                document.getElementById('itemCodigo').value = selectedOption.getAttribute('data-numero');
                document.getElementById('itemDesignacao').value = selectedOption.getAttribute('data-observacoes');
                
                // Carregar itens da nota selecionada
                carregarItensDaNota(selectedOption.value);
            } else {
                // Limpar campos se nenhuma nota for selecionada
                document.getElementById('itemCodigo').value = '';
                document.getElementById('itemDesignacao').value = '';
                document.getElementById('notaEnvioDocumentos').style.display = 'none';
            }
        });

    } catch (err) {
        console.error('Erro ao carregar notas de envio', err);
    }
}

// ==========================
// üîπ Carregar Itens da Nota de Envio Selecionada
// ==========================
async function carregarItensDaNota(notaId) {
    try {
        const res = await fetch(`${notaEnvioUrl}/${notaId}`);
        const nota = await res.json();
        
        // ‚úÖ Mostrar documentos da nota
        mostrarDocumentosNota(nota.documentos);
        
        // ‚úÖ Se a nota tiver itens, podemos mostrar ou preencher algo adicional
        if (nota.itens && nota.itens.length > 0) {
            console.log('Itens da nota:', nota.itens);
            // Aqui voc√™ pode fazer algo com os itens, como preencher uma lista
            // ou sugerir a cria√ß√£o de m√∫ltiplos itens baseados na nota
        }
        
    } catch (err) {
        console.error('Erro ao carregar itens da nota', err);
    }
}

// ==========================
// üîπ Mostrar Documentos da Nota de Envio
// ==========================
function mostrarDocumentosNota(documentos) {
    const container = document.getElementById('notaEnvioDocumentos');
    const lista = document.getElementById('notaEnvioDocsList');
    
    lista.innerHTML = '';
    
    if (documentos && documentos.length > 0) {
        container.style.display = 'block';
        
        documentos.forEach(doc => {
            lista.innerHTML += `
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span>üìé ${doc.nome_arquivo}</span>
                    <a href="/api/notaenviodocument/${doc.id}/download" 
                       target="_blank" 
                       class="btn btn-sm btn-outline-primary">
                       <i class="bi bi-download"></i>
                    </a>
                </li>`;
        });
    } else {
        container.style.display = 'none';
    }
}


// Iniciar anima√ß√£o de distribui√ß√£o
function iniciarAnimacaoDistribuicao() {
    const distribuicaoAnimation = document.getElementById('distribuicaoAnimation');
    distribuicaoAnimation.style.display = 'block';
    
    // Verificar se h√° itens distribu√≠dos e iniciar anima√ß√£o
    setTimeout(() => {
        const itensDistribuidos = allItens.filter(item => isItemDistribuido(item.id));
        if (itensDistribuidos.length > 0) {
            animarDistribuicoes(itensDistribuidos);
        }
    }, 1000);
}

// Anima√ß√£o das distribui√ß√µes
function animarDistribuicoes(itens) {
    const animationLines = document.getElementById('animationLines');
    animationLines.innerHTML = '';
    
    itens.forEach((item, index) => {
        // const cardElement = document.querySelector(`[onclick*="${item.id}"]`)?.closest('.card-item') || 
        //                     document.querySelector(`[data-item-id="${item.id}"]`);
        const cardElement = document.querySelector(`.card-item[data-item-id="${item.id}"]`);

        if (cardElement) {
            setTimeout(() => {
                criarAnimacaoDistribuicao(cardElement, item, index);
            }, index * 800);
        }
    });
}

// Criar anima√ß√£o de distribui√ß√£o individual
function criarAnimacaoDistribuicao(cardElement, item, index) {
    const animationLines = document.getElementById('animationLines');
    const hospitalIcon = document.querySelector('.hospital-icon');
    const cardRect = cardElement.getBoundingClientRect();
    const hospitalRect = hospitalIcon.getBoundingClientRect();
    
    // Calcular posi√ß√µes
    const startX = hospitalRect.left + hospitalRect.width / 2;
    const startY = hospitalRect.top + hospitalRect.height / 2;
    const endX = cardRect.left + cardRect.width / 2;
    const endY = cardRect.top + cardRect.height / 2;
    
    // Calcular dist√¢ncia e √¢ngulo
    const distance = Math.sqrt(Math.pow(endX - startX, 2) + Math.pow(endY - startY, 2));
    const angle = Math.atan2(endY - startY, endX - startX) * 180 / Math.PI;
    
    // Criar linha de anima√ß√£o
    const line = document.createElement('div');
    line.className = 'distribution-line';
    line.style.cssText = `
        top: ${startY}px;
        left: ${startX}px;
        width: ${distance}px;
        transform: rotate(${angle}deg);
        z-index: ${999 - index};
    `;
    
    animationLines.appendChild(line);
    
    // Adicionar efeito de glow no card
    cardElement.classList.add('item-distributed');
    
    // Remover elementos ap√≥s anima√ß√£o
    setTimeout(() => {
        if (line.parentNode) {
            line.parentNode.removeChild(line);
        }
        cardElement.classList.remove('item-distributed');
    }, 3000);
}

// Atualizar anima√ß√µes quando os itens s√£o carregados
function atualizarAnimacoesDistribuicao() {
    if (animationTimeout) {
        clearTimeout(animationTimeout);
    }
    
    animationTimeout = setTimeout(() => {
        const itensDistribuidos = allItens.filter(item => isItemDistribuido(item.id));
        animarDistribuicoes(itensDistribuidos);
    }, 1000);
}

// Carregar distribui√ß√µes
async function loadDistribuicoes() {
    try {
        const res = await fetch(distribuicaoUrl);
        distribuicoes = await res.json();
        atualizarAnimacoesDistribuicao();
    } catch (err) {
        console.error('Erro ao carregar distribui√ß√µes', err);
    }
}

// Verificar se um item foi distribu√≠do
function isItemDistribuido(itemId) {
    return distribuicoes.some(d => d.item_id === itemId);
}

// Obter informa√ß√µes da distribui√ß√£o do item
function getDistribuicaoInfo(itemId) {
    const distribuicao = distribuicoes.find(d => d.item_id === itemId);
    if (distribuicao) {
        const location = allLocations.find(l => l.id === distribuicao.location_id);
        return {
            location: location ? (location.nome || location.name || location.designacao) : 'Location Desconhecida',
            data: distribuicao.data_distribuicao,
            quantidade: distribuicao.quantidade
        };
    }
    return null;
}

// Alternar entre visualiza√ß√µes
function toggleView(viewType) {
    currentView = viewType;
    
    if (viewType === 'table') {
        document.getElementById('tableViewContainer').style.display = 'block';
        document.getElementById('blockViewContainer').style.display = 'none';
    } else {
        document.getElementById('tableViewContainer').style.display = 'none';
        document.getElementById('blockViewContainer').style.display = 'block';
    }
    
    // Reaplicar o filtro atual para a visualiza√ß√£o selecionada
    filtrarItens(document.getElementById('itemSearch').value);
    
    // Atualizar anima√ß√µes ap√≥s mudan√ßa de visualiza√ß√£o
    setTimeout(atualizarAnimacoesDistribuicao, 500);
}

// ==========================
// üîπ Filtrar Itens - VERS√ÉO CORRIGIDA
// ==========================
function filtrarItens(query) {
    const termo = query?.toLowerCase() || '';
    
    const itensFiltrados = allItens.filter(i =>
        (i.codigo || '').toLowerCase().includes(termo) ||
        (i.designacao || '').toLowerCase().includes(termo) ||
        (i.hs_code || '').toLowerCase().includes(termo) ||
        (i.batch_no || '').toLowerCase().includes(termo) ||
        (i.armazem_nome || '').toLowerCase().includes(termo) ||
        (i.porto_nome || '').toLowerCase().includes(termo)
    );
    
    if (currentView === 'block') {
        renderizarBlocos(itensFiltrados);
    } else {
        renderizarTabela(itensFiltrados);
    }
}


// ==========================
// üîπ Renderizar Tabela - NOVA FUN√á√ÉO
// ==========================
function renderizarTabela(itens) {
    const tbody = document.getElementById('itemTableBody');
    tbody.innerHTML = '';
    
    itens.forEach(i => {
        const imgSrc = i.imagem ? `data:image/jpeg;base64,${i.imagem}` : '/static/no-image.png';
        const distribuido = isItemDistribuido(i.id);
        
        tbody.innerHTML += `
            <tr>
                <td>${i.id}</td>
                <td><img src="${imgSrc}" alt="${i.designacao}" style="max-width: 50px; max-height: 50px;"></td>
                <td>${i.codigo}</td>
                <td>${i.designacao}</td>
                <td>${i.hs_code || 'N/A'}</td>
                <td>${i.quantidade || 0}</td>
                <td>${i.batch_no || 'N/A'}</td>
                <td>${i.data_fabricacao ? i.data_fabricacao.slice(0,10) : 'N/A'}</td>
                <td>${i.data_validade ? i.data_validade.slice(0,10) : 'N/A'}</td>
                <td>${i.no_cartoes || 'N/A'}</td>
                <td><span class="badge ${i.syncStatus === 'Syncronized' ? 'bg-success' : i.syncStatus === 'Updated' ? 'bg-info' : 'bg-secondary'}">${i.syncStatus || 'Not Syncronized'}</span></td>
                <td><span class="badge ${distribuido ? 'bg-success' : 'bg-danger'}">${distribuido ? '‚úì' : '‚úó'}</span></td>
                <td>
                    <button class="btn btn-sm btn-warning me-1" onclick="editarItem(${i.id})" title="Editar">
                        <i class="bi bi-pencil-square"></i>
                    </button>
                    <button class="btn btn-sm btn-danger me-1" onclick="eliminarItem(${i.id})" title="Apagar">
                        <i class="bi bi-trash"></i>
                    </button>
                    <button class="btn btn-sm btn-info me-1" onclick="abrirDetalhes(${i.id})" title="Detalhes">
                        <i class="bi bi-info-circle"></i>
                    </button>
                    <button class="btn btn-sm btn-primary me-1" onclick="abrirEntradaStock(${i.id})" title="Stock">
                        <i class="bi bi-box-arrow-in-down"></i>
                    </button>
                    <button class="btn btn-sm btn-success" onclick="abrirDistribuicao(${i.id})" title="Distribuir">
                        <i class="bi bi-share"></i>
                    </button>
                </td>
            </tr>`;
    });
}

function abrirDistribuicao(itemId) {
    const item = allItens.find(i => i.id === itemId);
    if (!item) return;

    document.getElementById('distribuicaoItemId').value = item.id;
    document.getElementById('distribuicaoItemImg').src = item.imagem 
        ? `data:image/jpeg;base64,${item.imagem}` 
        : '/static/no-image.png';
    document.getElementById('distribuicaoItemDescricao').textContent = item.designacao || '';
    document.getElementById('distribuicaoItemHSCode').textContent = item.hs_code || '';

    const armazemSelect = document.getElementById('distribuicaoArmazem');
    armazemSelect.innerHTML = '<option value="">Selecione o armaz√©m</option>';
    allArmazens.forEach(a => armazemSelect.innerHTML += `<option value="${a.id}">${a.nome}</option>`);

    const locationSelect = document.getElementById('distribuicaoLocation');
    locationSelect.innerHTML = '<option value="">Selecione a unidade sanit√°ria</option>';
    allLocations.forEach(l => locationSelect.innerHTML += `<option value="${l.id}">${l.nome || l.name || l.designacao}</option>`);

    document.getElementById('distribuicaoQuantidade').value = '';
    document.getElementById('distribuicaoData').value = '';
    document.getElementById('distribuicaoObservacao').value = '';

    new bootstrap.Modal(document.getElementById('distribuicaoModal')).show();
}

// Submiss√£o do formul√°rio
document.getElementById('distribuicaoForm').addEventListener('submit', async e => {
    e.preventDefault();

    const payload = {
        item_id: parseInt(document.getElementById('distribuicaoItemId').value),
        armazem_id: parseInt(document.getElementById('distribuicaoArmazem').value),
        location_id: parseInt(document.getElementById('distribuicaoLocation').value),
        quantidade: parseInt(document.getElementById('distribuicaoQuantidade').value),
        data_distribuicao: document.getElementById('distribuicaoData').value,
        observacao: document.getElementById('distribuicaoObservacao').value
    };

    try {
        const res = await fetch('/api/distribuicao', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(payload)
        });
        if (!res.ok) throw await res.json();

        bootstrap.Modal.getInstance(document.getElementById('distribuicaoModal')).hide();
        alert('Distribui√ß√£o registrada com sucesso!');
        // await loadDistribuicoes(); // Recarregar distribui√ß√µes
        // loadItens(); // Recarregar itens
        await loadDistribuicoes(); // atualiza distribuicoes
        renderizarBlocos(allItens); // re-renderiza cards

        // Animar o item distribu√≠do
        const itemId = parseInt(document.getElementById('distribuicaoItemId').value);
        const item = allItens.find(i => i.id === itemId);
        if (item) {
            animarDistribuicoes([item]);
        }
    } catch(err) {
        alert(err.message || 'Erro ao registrar distribui√ß√£o');
        console.error(err);
    }
});

// Renderizar visualiza√ß√£o em blocos (PADR√ÉO)
function renderizarBlocos(itens) {
    const container = document.getElementById('itemBlocksContainer');
    container.innerHTML = '';
    
    itens.forEach(i => {
        const imgSrc = i.imagem ? `data:image/jpeg;base64,${i.imagem}` : '/static/no-image.png';
        const distribuido = isItemDistribuido(i.id);
        const distribuicaoInfo = getDistribuicaoInfo(i.id);

        const syncClass = i.syncStatus === 'Syncronized' ? 'sync-synchronized' :
                          i.syncStatus === 'Updated' ? 'sync-updated' : 'sync-not-synchronized';

        let expiryBadge = '';
        if (i.data_validade) {
            const diffDays = Math.ceil((new Date(i.data_validade) - new Date()) / (1000*60*60*24));
            if (diffDays <= 30 && diffDays > 0) expiryBadge = `<span class="badge expiry-warning status-badge">Expira em ${diffDays} dias</span>`;
            else if (diffDays <= 0) expiryBadge = `<span class="badge expiry-danger status-badge">Expirado</span>`;
        }

        const distribuicaoBadge = distribuido
            ? `<span class="badge bg-success distribuicao-badge"><i class="bi bi-check-circle"></i> Distribu√≠do</span>`
            : `<span class="badge bg-danger distribuicao-badge"><i class="bi bi-x-circle"></i> N√£o Distribu√≠do</span>`;

        container.innerHTML += `
        <div class="col-md-6 col-lg-4 col-xl-3">
            <div class="card card-item ${distribuido ? 'distribuido' : 'nao-distribuido'}" data-item-id="${i.id}">
                <span class="badge ${syncClass} sync-badge">${i.syncStatus || 'Not Syncronized'}</span>
                ${expiryBadge}
                ${distribuicaoBadge}
                <div class="card-img-container">
                    <img src="${imgSrc}" class="card-img-top" alt="${i.designacao}">
                </div>
                <div class="card-body">
                    <h5 class="card-title">${i.designacao}</h5>
                    <p class="card-text">
                        <small class="text-muted">C√≥digo: ${i.codigo}</small><br>
                        <small class="text-muted">HS Code: ${i.hs_code || 'N/A'}</small><br>
                        <small class="text-muted">Quantidade: ${i.quantidade || 0}</small><br>
                        <small class="text-muted">Batch: ${i.batch_no || 'N/A'}</small><br>
                        <small class="text-muted">Validade: ${i.data_validade ? i.data_validade.slice(0,10) : 'N/A'}</small><br>
                        <small class="text-muted">Armaz√©m: ${i.armazem_nome || 'N/A'}</small>
                        ${distribuido && distribuicaoInfo ? `<br><small class="text-success"><strong>Local: ${distribuicaoInfo.location}</strong></small>` : ''}
                    </p>
                    <div class="card-actions">
                        <button class="btn btn-sm btn-warning" onclick="editarItem(${i.id})" data-bs-toggle="tooltip" title="Editar"><i class="bi bi-pencil-square"></i></button>
                        <button class="btn btn-sm btn-danger" onclick="eliminarItem(${i.id})" data-bs-toggle="tooltip" title="Apagar"><i class="bi bi-trash"></i></button>
                        <button class="btn btn-sm btn-info" onclick="abrirDetalhes(${i.id})" data-bs-toggle="tooltip" title="Detalhes"><i class="bi bi-info-circle"></i></button>
                        <button class="btn btn-sm btn-primary" onclick="abrirEntradaStock(${i.id})" data-bs-toggle="tooltip" title="Gest√£o de Stock / Necessidades"><i class="bi bi-box-arrow-in-down"></i></button>
                        <button class="btn btn-sm btn-success" onclick="abrirDistribuicao(${i.id})" data-bs-toggle="tooltip" title="Distribuir"><i class="bi bi-share"></i></button>
                    </div>
                </div>
            </div>
        </div>`;
    });

    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(el => new bootstrap.Tooltip(el));

    // Atualizar anima√ß√µes
    setTimeout(atualizarAnimacoesDistribuicao, 500);
}

// ==========================
// üîπ Abrir Entrada de Stock - VERS√ÉO CORRIGIDA
// ==========================
function abrirEntradaStock(id) {
    document.getElementById('entradaItemId').value = id;
    document.getElementById('entradaQuantidade').value = '';
    document.getElementById('entradaObservacoes').value = '';
    document.getElementById('necessidadeQuantidade').value = '';
    document.getElementById('necessidadeDescricao').value = '';
    
    // ‚úÖ Garantir que locations estejam atualizadas
    loadLocations();
    carregarHistoricoModal(id);
    carregarNecessidades(id);
    
    new bootstrap.Modal(document.getElementById('entradaStockModal')).show();
}
// ==========================
// üîπ Carregar Necessidades - VERS√ÉO CORRIGIDA
// ==========================
async function carregarNecessidades(id) {
    try {
        const res = await fetch(`/api/item/${id}/necessidades`);
        const necessidades = await res.json();

        if (!necessidades || !necessidades.length) {
            document.getElementById('listaNecessidadesContainer').innerHTML = '<p class="text-muted">Nenhuma necessidade registrada.</p>';
            return;
        }

        let html = `<table class="table table-striped table-bordered table-sm align-middle">
            <thead class="table-dark">
                <tr>
                    <th>#</th>
                    <th>Quantidade</th>
                    <th>Descri√ß√£o</th>
                    <th>Location</th>
                    <th>Data</th>
                    <th>A√ß√µes</th>
                </tr>
            </thead>
            <tbody>`;

        necessidades.forEach((n, index) => {
            const loc = allLocations.find(l => l.id === n.location_id);
            const locName = loc ? loc.nome || loc.name || loc.designacao : ('Location ' + (n.location_id || ''));
            html += `<tr>
                <td>${index + 1}</td>
                <td><strong>${n.quantidade}</strong></td>
                <td>${n.descricao || '<span class="text-muted">-</span>'}</td>
                <td>${locName}</td>
                <td>${new Date(n.data_registro).toLocaleString('pt-BR')}</td>
                <td>
                    <button class="btn btn-sm btn-danger" onclick="removerNecessidade(${n.id}, ${id})" title="Eliminar necessidade">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            </tr>`;
        });

        html += `</tbody></table>`;
        document.getElementById('listaNecessidadesContainer').innerHTML = html;
    } catch (err) {
        document.getElementById('listaNecessidadesContainer').innerHTML = '<p class="text-danger">Erro ao carregar necessidades.</p>';
        console.error(err);
    }
}

// ==========================
// üîπ Carregar Hist√≥rico no Modal - VERS√ÉO CORRIGIDA
// ==========================
async function carregarHistoricoModal(id) {
    try {
        const res = await fetch(`/api/item/${id}/historico`);
        const historico = await res.json();

        if (!historico || !historico.length) {
            document.getElementById('historicoStockModalContainer').innerHTML = '<p class="text-muted">Nenhum hist√≥rico registrado.</p>';
            return;
        }

        let html = `<table class="table table-striped table-bordered table-sm align-middle">
            <thead class="table-dark">
                <tr>
                    <th>#</th>
                    <th>Tipo Movimento</th>
                    <th>Quantidade</th>
                    <th>Data</th>
                    <th>Observa√ß√µes</th>
                    <th>User</th>
                    <th>A√ß√µes</th>
                </tr>
            </thead>
            <tbody>`;

        historico.forEach((h, index) => {
            html += `<tr>
                <td>${index + 1}</td>
                <td>
                    <span class="badge ${h.tipo_movimento === 'entrada' ? 'bg-success' : 'bg-warning'}">
                        ${h.tipo_movimento.toUpperCase()}
                    </span>
                </td>
                <td><strong>${h.quantidade}</strong></td>
                <td>${new Date(h.data_movimento).toLocaleString('pt-BR')}</td>
                <td>${h.observacoes || '<span class="text-muted">-</span>'}</td>
                <td><small class="text-muted">${h.user || 'Sistema'}</small></td>
                <td>
                    <button class="btn btn-sm btn-outline-danger" onclick="removerHistorico(${h.id}, ${id})" title="Remover hist√≥rico">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            </tr>`;
        });

        html += `</tbody></table>`;
        document.getElementById('historicoStockModalContainer').innerHTML = html;
    } catch (err) {
        document.getElementById('historicoStockModalContainer').innerHTML = '<p class="text-danger">Erro ao carregar hist√≥rico.</p>';
        console.error(err);
    }
}

// ==========================
// üîπ Remover Hist√≥rico - NOVA FUN√á√ÉO
// ==========================
async function removerHistorico(historicoId, itemId) {
    if (!confirm('Deseja realmente remover este movimento de hist√≥rico?')) return;

    try {
        const res = await fetch(`/api/historico/${historicoId}`, { method: 'DELETE' });
        if (!res.ok) throw await res.json();
        // Recarrega o hist√≥rico do modal
        await carregarHistoricoModal(itemId);
    } catch (err) {
        alert(err.message || 'Erro ao remover hist√≥rico');
        console.error(err);
    }
}

// ==========================
// üîπ Adicionar Necessidade - NOVA FUN√á√ÉO
// ==========================
async function adicionarNecessidade() {
    const id = parseInt(document.getElementById('entradaItemId').value);
    const quantidade = parseInt(document.getElementById('necessidadeQuantidade').value);
    const descricao = document.getElementById('necessidadeDescricao').value;
    const location_id = parseInt(document.getElementById('necessidadeLocation').value);

    if (!quantidade || quantidade <= 0) {
        alert('Informe uma quantidade v√°lida');
        return;
    }
    if (!location_id) {
        alert('Selecione a Location para a necessidade');
        return;
    }

    try {
        const res = await fetch(`/api/item/${id}/necessidades`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                item_id: id, 
                location_id, 
                quantidade, 
                descricao,
                user: "{{ username }}" // ‚úÖ Adicionar username do usu√°rio
            })
        });

        if (!res.ok) {
            const err = await res.json();
            throw err;
        }

        // Atualiza a lista de necessidades
        await carregarNecessidades(id);

        // Limpa os campos do formul√°rio
        document.getElementById('necessidadeQuantidade').value = '';
        document.getElementById('necessidadeDescricao').value = '';
        document.getElementById('necessidadeLocation').value = '';

        // Confirma√ß√£o visual
        alert('Necessidade adicionada com sucesso!');
    } catch (err) {
        alert(err.message || 'Erro ao adicionar necessidade');
        console.error(err);
    }
}


// ==========================
// üîπ Remover Necessidade - NOVA FUN√á√ÉO
// ==========================
async function removerNecessidade(necessidadeId, itemId) {
    if (!confirm('Deseja realmente eliminar esta necessidade?')) return;

    try {
        const res = await fetch(`/api/necessidade/${necessidadeId}`, { method: 'DELETE' });
        if (!res.ok) throw await res.json();
        await carregarNecessidades(itemId); // recarrega a lista
    } catch (err) {
        alert(err.message || 'Erro ao eliminar necessidade');
        console.error(err);
    }
}

// ==========================
// üîπ Abrir Modal Item - VERS√ÉO CORRIGIDA
// ==========================
function abrirModalItem() {
    document.getElementById('itemForm').reset();
    document.getElementById('itemId').value = '';
    document.getElementById('previewImg').style.display = 'none';
    document.getElementById('previewPdf').innerHTML = '';
    document.getElementById('notaEnvioDocumentos').style.display = 'none'; // ‚úÖ Esconder documentos
    imagemBase64 = null;
    pdfBase64 = null;
    
    // ‚úÖ Resetar a sele√ß√£o da nota de envio
    document.getElementById('itemNotaEnvio').selectedIndex = 0;
    
    new bootstrap.Modal(document.getElementById('itemModal')).show();
}

// ==========================
// üîπ Editar Item - VERS√ÉO CORRIGIDA
// ==========================
function editarItem(id) {
    const i = allItens.find(item => item.id === id);
    if (!i) return;

    document.getElementById('itemId').value = i.id;
    document.getElementById('itemCodigo').value = i.codigo || '';
    document.getElementById('itemDesignacao').value = i.designacao || '';
    document.getElementById('itemHsCode').value = i.hs_code || '';
    document.getElementById('itemQuantidade').value = i.quantidade || '';
    document.getElementById('itemBatchNo').value = i.batch_no || '';
    document.getElementById('itemDataFabricacao').value = i.data_fabricacao ? i.data_fabricacao.slice(0,10) : '';
    document.getElementById('itemDataValidade').value = i.data_validade ? i.data_validade.slice(0,10) : '';
    document.getElementById('itemNoCartoes').value = i.no_cartoes || '';
    document.getElementById('itemPesoBruto').value = i.peso_bruto_total || '';
    document.getElementById('itemVolumeCBM').value = i.volume_total_cbm || '';
    document.getElementById('itemTotalCartoes').value = i.total_cartoes || '';
    document.getElementById('itemTotalPaletes').value = i.total_paletes || '';
    document.getElementById('itemDimensoesPalete').value = i.dimensoes_palete_cm || '';
    document.getElementById('itemArmazem').value = i.armazem_id || '';
    document.getElementById('itemPorto').value = i.porto_id || '';
    document.getElementById('itemObservacoes').value = i.observacoes || '';
    document.getElementById('itemSyncStatus').value = i.syncStatus || 'Not Syncronized';
    document.getElementById('itemSyncDate').value = i.syncStatusDate ? i.syncStatusDate.slice(0,16) : '';

    // ‚úÖ Se o item tem uma nota de envio associada, selecion√°-la
    if (i.nota_envio_id) {
        document.getElementById('itemNotaEnvio').value = i.nota_envio_id;
        // Carregar documentos da nota associada
        carregarItensDaNota(i.nota_envio_id);
    } else {
        document.getElementById('itemNotaEnvio').selectedIndex = 0;
        document.getElementById('notaEnvioDocumentos').style.display = 'none';
    }

    if (i.imagem) {
        document.getElementById('previewImg').src = `data:image/jpeg;base64,${i.imagem}`;
        document.getElementById('previewImg').style.display = 'block';
    }
    if (i.pdf_dados) {
        document.getElementById('previewPdf').innerHTML = `<a href="data:application/pdf;base64,${i.pdf_dados}" download="${i.pdf_nome}">üìÑ ${i.pdf_nome}</a>`;
    }
    
    new bootstrap.Modal(document.getElementById('itemModal')).show();
}

// Upload de arquivos
function previewImagem(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => {
        imagemBase64 = e.target.result.split(',')[1];
        const img = document.getElementById('previewImg');
        img.src = e.target.result;
        img.style.display = 'block';
    };
    reader.readAsDataURL(file);
}

function previewPDF(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => {
        pdfBase64 = e.target.result.split(',')[1];
        document.getElementById('previewPdf').innerHTML = `<a href="${e.target.result}" download="${file.name}">üìÑ ${file.name}</a>`;
    };
    reader.readAsDataURL(file);
}

// ==========================
// üîπ Salvar Item - VERS√ÉO ATUALIZADA COM USERNAME
// ==========================
document.getElementById('itemForm').addEventListener('submit', async e => {
    e.preventDefault();
    const id = document.getElementById('itemId').value;
    const notaEnvioId = document.getElementById('itemNotaEnvio').value;
    
    const payload = {
        codigo: document.getElementById('itemCodigo').value,
        designacao: document.getElementById('itemDesignacao').value,
        hs_code: document.getElementById('itemHsCode').value,
        quantidade: parseInt(document.getElementById('itemQuantidade').value) || null,
        batch_no: document.getElementById('itemBatchNo').value,
        data_fabricacao: document.getElementById('itemDataFabricacao').value || null,
        data_validade: document.getElementById('itemDataValidade').value || null,
        no_cartoes: parseInt(document.getElementById('itemNoCartoes').value) || null,
        peso_bruto_total: parseFloat(document.getElementById('itemPesoBruto').value) || null,
        volume_total_cbm: parseFloat(document.getElementById('itemVolumeCBM').value) || null,
        total_cartoes: parseInt(document.getElementById('itemTotalCartoes').value) || null,
        total_paletes: parseInt(document.getElementById('itemTotalPaletes').value) || null,
        dimensoes_palete_cm: document.getElementById('itemDimensoesPalete').value,
        armazem_id: parseInt(document.getElementById('itemArmazem').value),
        porto_id: document.getElementById('itemPorto').value ? parseInt(document.getElementById('itemPorto').value) : null,
        observacoes: document.getElementById('itemObservacoes').value,
        imagem: imagemBase64,
        pdf_nome: document.getElementById('previewPdf').querySelector('a')?.textContent || null,
        pdf_dados: pdfBase64,
        syncStatus: document.getElementById('itemSyncStatus').value,
        syncStatusDate: document.getElementById('itemSyncDate').value 
            ? new Date(document.getElementById('itemSyncDate').value).toISOString() 
            : null,
        nota_envio_id: notaEnvioId ? parseInt(notaEnvioId) : null,
        user: "{{ username }}" // ‚úÖ ADICIONADO: Registrar username do usu√°rio
    };

    try {
        const res = await fetch(id ? `${apiUrl}/${id}` : apiUrl, {
            method: id ? 'PUT' : 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(payload)
        });
        if (!res.ok) throw await res.json();
        
        imagemBase64 = null;
        pdfBase64 = null;
        bootstrap.Modal.getInstance(document.getElementById('itemModal')).hide();
        document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
        loadItens();
    } catch(err) {
        alert(err.message || 'Erro ao salvar item');
    }
});

// ==========================
// üîπ Formul√°rio Entrada Stock - VERS√ÉO CORRIGIDA
// ==========================
document.getElementById('entradaStockForm').addEventListener('submit', async e => {
    e.preventDefault();
    const id = parseInt(document.getElementById('entradaItemId').value);
    const quantidade = parseInt(document.getElementById('entradaQuantidade').value);
    const observacoes = document.getElementById('entradaObservacoes').value;

    try {
        const res = await fetch(`/api/item/${id}/entrada`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ 
                quantidade, 
                observacoes,
                user: "{{ username }}" // ‚úÖ Adicionar username do usu√°rio
            })
        });
        if (!res.ok) throw await res.json();
        
        bootstrap.Modal.getInstance(document.getElementById('entradaStockModal')).hide();
        loadItens();
        
        // ‚úÖ Atualizar hist√≥rico automaticamente
        if (currentView === 'block') {
            renderizarBlocos(allItens);
        } else {
            renderizarTabela(allItens);
        }
    } catch(err) {
        alert(err.message || 'Erro ao registrar entrada');
    }
});


// Apagar item
async function eliminarItem(id) {
    if (!confirm('Tem certeza que deseja apagar este item?')) return;
    try {
        const res = await fetch(`${apiUrl}/${id}`, { method: 'DELETE' });
        if (!res.ok) throw await res.json();
        loadItens();
    } catch(err) {
        alert(err.message || 'Erro ao apagar item');
    }
}

// Abrir detalhes do item e carregar hist√≥rico de stock dentro do painel
async function abrirDetalhes(id) {
    const i = allItens.find(item => item.id === id);
    if (!i) return;

    const imgSrc = i.imagem ? `data:image/jpeg;base64,${i.imagem}` : '/static/no-image.png';
    const pdfLink = i.pdf_dados ? `<a href="data:application/pdf;base64,${i.pdf_dados}" download="${i.pdf_nome}">üìÑ ${i.pdf_nome}</a>` : '';
    const distribuido = isItemDistribuido(i.id);
    const distribuicaoInfo = getDistribuicaoInfo(i.id);

    let html = `
        <h5>${i.designacao}</h5>
        <img src="${imgSrc}" style="width:100%; max-height:200px; object-fit:cover; margin-bottom:10px;">
        <ul class="list-group list-group-flush">
            <li class="list-group-item"><strong>C√≥digo:</strong> ${i.codigo}</li>
            <li class="list-group-item"><strong>HS Code:</strong> ${i.hs_code || ''}</li>
            <li class="list-group-item"><strong>Quantidade:</strong> ${i.quantidade || ''}</li>
            <li class="list-group-item"><strong>Batch No:</strong> ${i.batch_no || ''}</li>
            <li class="list-group-item"><strong>MFG Date:</strong> ${i.data_fabricacao ? i.data_fabricacao.slice(0,10) : ''}</li>
            <li class="list-group-item"><strong>Expiry Date:</strong> ${i.data_validade ? i.data_validade.slice(0,10) : ''}</li>
            <li class="list-group-item"><strong>No. Cartons:</strong> ${i.no_cartoes || ''}</li>
            <li class="list-group-item"><strong>Peso Bruto:</strong> ${i.peso_bruto_total || ''}</li>
            <li class="list-group-item"><strong>Volume CBM:</strong> ${i.volume_total_cbm || ''}</li>
            <li class="list-group-item"><strong>Total Cartons:</strong> ${i.total_cartoes || ''}</li>
            <li class="list-group-item"><strong>Total Paletes:</strong> ${i.total_paletes || ''}</li>
            <li class="list-group-item"><strong>Dimens√µes Palete:</strong> ${i.dimensoes_palete_cm || ''}</li>
            <li class="list-group-item"><strong>Armaz√©m:</strong> ${i.armazem_nome || ''}</li>
            <li class="list-group-item"><strong>Porto:</strong> ${i.porto_nome || ''}</li>
            <li class="list-group-item"><strong>Observa√ß√µes:</strong> ${i.observacoes || ''}</li>
            <li class="list-group-item">${pdfLink}</li>
            <li class="list-group-item"><strong>Sync Status:</strong> ${i.syncStatus || ''}</li>
            <li class="list-group-item"><strong>Sync Date:</strong> ${i.syncStatusDate ? i.syncStatusDate.slice(0,16) : ''}</li>
            <li class="list-group-item"><strong>Status Distribui√ß√£o:</strong> ${distribuido ? 
                `<span class="badge bg-success">‚úì Distribu√≠do</span><br>
                 <small>Local: ${distribuicaoInfo ? distribuicaoInfo.location : 'N/A'}</small><br>
                 <small>Data: ${distribuicaoInfo ? distribuicaoInfo.data.slice(0,10) : 'N/A'}</small><br>
                 <small>Quantidade: ${distribuicaoInfo ? distribuicaoInfo.quantidade : 'N/A'}</small>` : 
                `<span class="badge bg-danger">N√£o Distribu√≠do</span>`}
            </li>
        </ul>
        <hr>
        <div id="historicoStockContent">
            <h6>Hist√≥rico de Movimenta√ß√µes de Stock:</h6>
            <p>Carregando...</p>
        </div>
    `;

    document.getElementById('detalhesContent').innerHTML = html;
    document.getElementById('detalhesPanel').style.right = '0';

    const res = await fetch(`/api/item/${id}/historico`);
    const historico = await res.json();
    let historicoHtml = '<ul class="list-group">';
    historico.forEach(h => {
        historicoHtml += `<li class="list-group-item">
            ${h.tipo_movimento.toUpperCase()} - Qtd: ${h.quantidade} - ${new Date(h.data_movimento).toLocaleString()} - ${new Date(h.user).toLocaleString()} - ${h.observacoes || ''}
        </li>`;
    });
    historicoHtml += '</ul>';

    document.getElementById('historicoStockContent').innerHTML = historicoHtml;
}

function fecharDetalhes() {
    document.getElementById('detalhesPanel').style.right = '-420px';
}

// Exportar Excel
function downloadExcel() {
    alert('Funcionalidade de exporta√ß√£o em constru√ß√£o.');
}

// Inicializar
document.addEventListener('DOMContentLoaded', loadNotasEnvio);
</script>
{% endblock %}