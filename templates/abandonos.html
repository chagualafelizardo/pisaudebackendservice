{% extends 'base.html' %}
{% block title %}PI-SAÚDE/ Observations Import{% endblock %}

{% block content %}
{% include 'navbar.html' %}

<h2>Import Observations - Abandonos ao Levantamento de ARVs</h2>

<!-- Upload File -->
<div class="mb-3">
    <input type="file" id="fileInput" class="form-control" accept=".xlsx,.xls,.csv">
    <button id="importBtn" class="btn btn-primary mt-2">Import Data</button>
</div>

<!-- Dropdowns -->
<div class="row mb-3">
    <div class="col-md-6">
        <label for="stateDropdown" class="form-label">State</label>
        <select id="stateDropdown" class="form-select"></select>
    </div>
    <div class="col-md-6">
        <label for="grouptypeDropdown" class="form-label">Group Type</label>
        <select id="grouptypeDropdown" class="form-select"></select>
    </div>
</div>

<!-- Loader Circular Overlay Centralizado -->
<div id="overlay" style="
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: none;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 9999;
    justify-content: center;
    align-items: center;
">
    <div class="circular-progress" id="progressCircle" style="
        position: relative;
        width: 120px;
        height: 120px;
        border-radius: 50%;
        background: conic-gradient(#007bff 0% 0%, #e0e0e0 0% 100%);
        display: flex;
        justify-content: center;
        align-items: center;
        font-weight: bold;
        font-size: 20px;
        color: #007bff;
        background-color: white;
        box-shadow: 0 0 15px rgba(0,0,0,0.3);
    ">
        <span id="progressText">0%</span>
    </div>
</div>

<!-- Tabela de Observações -->
<table class="table table-bordered mt-3">
    <thead>
        <tr>
            <th>ID</th>
            <th>Full Name</th>
            <th>NID</th>
            <th>Gender</th>
            <th>Age</th>
            <th>Contact</th>
            <th>Occupation</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody id="observationsTableBody"></tbody>
</table>

<!-- SheetJS -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<script>
const fileInput = document.getElementById('fileInput');
const importBtn = document.getElementById('importBtn');
const overlay = document.getElementById('overlay');
const progressCircle = document.getElementById('progressCircle');
const progressText = document.getElementById('progressText');
const observationsTableBody = document.getElementById('observationsTableBody');

const stateDropdown = document.getElementById('stateDropdown');
const grouptypeDropdown = document.getElementById('grouptypeDropdown');

let observationsData = [];

const requiredFields = {
    nid: ['nid', 'NID'],
    fullname: ['fullname', 'FullName', 'NomeCompleto'],
    gender: ['gender', 'Gender', 'sexo', 'Sexo'],
    age: ['age', 'Age', 'idade_actual', 'Idade'],
    contact: ['telefone','Telefone','contact', 'Contact', 'contacto_paciente'],
    occupation: ['occupation', 'Occupation', 'Profissao'],
};

function updateProgress(percent) {
    progressCircle.style.background = `conic-gradient(#007bff ${percent}%, #e0e0e0 ${percent}% 100%)`;
    progressText.innerText = `${percent}%`;
}

function populateTable(data) {
    observationsTableBody.innerHTML = '';
    data.forEach((obs, index) => {
        observationsTableBody.innerHTML += `
            <tr>
                <td>${obs.id || index + 1}</td>
                <td>${obs.fullname || ''}</td>
                <td>${obs.nid || ''}</td>
                <td>${obs.gender || ''}</td>
                <td>${obs.age || ''}</td>
                <td>${obs.contact || ''}</td>
                <td>${obs.occupation || ''}</td>
                <td>
                    <button class="btn btn-sm btn-warning" onclick="editObservation(${index})">Edit</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteObservation(${index})">Delete</button>
                </td>
            </tr>
        `;
    });
}

function mapRow(row) {
    let mapped = {};
    for (let key in requiredFields) {
        for (let col of requiredFields[key]) {
            if (row[col] !== undefined) {
                mapped[key] = row[col];
                break;
            }
        }
    }
    return mapped;
}

async function loadObservationsWithProgress() {
    overlay.style.display = 'flex';
    let progress = 0;

    const interval = setInterval(() => {
        if (progress < 90) {
            progress++;
            updateProgress(progress);
        }
    }, 30);

    try {
        const res = await fetch('/api/observation');
        const data = await res.json();

        clearInterval(interval);
        updateProgress(100);

        observationsData = data;
        populateTable(data);

        await new Promise(r => setTimeout(r, 500));
    } catch (err) {
        alert("Failed to load observations.");
        console.error(err);
    } finally {
        overlay.style.display = 'none';
        updateProgress(0);
    }
}

function normalize(text) {
    return text
        .toLowerCase()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "") // remove acentos
        .trim();
}

async function loadDropdown(url, selectElement, defaultDescription) {
    try {
        const res = await fetch(url);
        const data = await res.json();

        const normalizedDefault = normalize(defaultDescription);

        selectElement.innerHTML = data.map(item => {
            const isSelected = normalize(item.description) === normalizedDefault;
            return `<option value="${item.id}" ${isSelected ? 'selected' : ''}>
                        ${item.description}
                    </option>`;
        }).join('');
    } catch (err) {
        console.error(`Failed to load ${url}`, err);
        selectElement.innerHTML = '<option disabled>Error loading</option>';
    }
}


importBtn.addEventListener('click', async () => {
    const file = fileInput.files[0];
    if (!file) {
        alert("Please select a file first.");
        return;
    }

    const selectedStateID = stateDropdown.value;
    const selectedGroupTypeID = grouptypeDropdown.value;

    overlay.style.display = 'flex';
    let progress = 0;

    const interval = setInterval(() => {
        if (progress < 90) {
            progress++;
            updateProgress(progress);
        }
    }, 25);

    const reader = new FileReader();

    reader.onload = async function (e) {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const sheetData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);

            if (!sheetData.length) throw new Error("Empty sheet");

            const mappedData = sheetData.map(mapRow);

            const payload = {
                stateID: selectedStateID,
                groupTypeID: selectedGroupTypeID,
                observations: mappedData
            };

            const res = await fetch('/api/observations/import', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (res.ok) {
                clearInterval(interval);
                updateProgress(100);
                alert("Data imported successfully.");
                await loadObservationsWithProgress();
            } else {
                const err = await res.json();
                throw new Error(err.message || "Import failed");
            }
        } catch (err) {
            console.error("Import failed:", err);
            alert("Error during import: " + err.message);
        } finally {
            clearInterval(interval);
            setTimeout(() => {
                overlay.style.display = 'none';
                updateProgress(0);
            }, 1000);
        }
    };

    reader.onerror = function (err) {
        clearInterval(interval);
        console.error("File reading error:", err);
        alert("Failed to read file.");
        overlay.style.display = 'none';
    };

    reader.readAsArrayBuffer(file);
});

function editObservation(index) {
    const obs = observationsData[index];
    const newName = prompt("Edit Full Name:", obs.fullname || '');
    if (newName !== null) {
        observationsData[index].fullname = newName;
        populateTable(observationsData);
    }
}

function deleteObservation(index) {
    if (!confirm("Are you sure?")) return;
    observationsData.splice(index, 1);
    populateTable(observationsData);
}

window.onload = async () => {
    await loadObservationsWithProgress();
    await loadDropdown('/api/state', stateDropdown, 'Inicial');
    await loadDropdown('/api/grouptype', grouptypeDropdown, 'Faltosos');
};
</script>
{% endblock %}
