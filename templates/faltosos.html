{% extends 'base.html' %}
{% block title %}PI-SAUDE/ Observations Import{% endblock %}

{% block content %}
{% include 'navbar.html' %}


<h2>Import Observations - Inicio TARV</h2>

<!-- Upload File -->
<div class="mb-3">
    <input type="file" id="fileInput" class="form-control" accept=".xlsx,.xls,.csv">
    <button id="importBtn" class="btn btn-primary mt-2">Import Data</button>
</div>

<!-- Loader Circular Overlay Centralizado -->
<div id="overlay" style="
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: none;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 9999;
    justify-content: center;
    align-items: center;
">
    <div class="circular-progress" id="progressCircle" style="
        position: relative;
        width: 120px;
        height: 120px;
        border-radius: 50%;
        background: conic-gradient(#007bff 0% 0%, #e0e0e0 0% 100%);
        display: flex;
        justify-content: center;
        align-items: center;
        font-weight: bold;
        font-size: 20px;
        color: #007bff;
        background-color: white;
        box-shadow: 0 0 15px rgba(0,0,0,0.3);
    ">
        <span id="progressText">0%</span>
    </div>
</div>

<!-- Tabela de Observações -->
<table class="table table-bordered mt-3">
    <thead>
        <tr>
            <th>ID</th>
            <th>Full Name</th>
            <th>NID</th>
            <th>Gender</th>
            <th>Age</th>
            <th>Contact</th>
            <th>Occupation</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody id="observationsTableBody"></tbody>
</table>

<!-- SheetJS -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<script>
const observationsTableBody = document.getElementById('observationsTableBody');
const fileInput = document.getElementById('fileInput');
const importBtn = document.getElementById('importBtn');
const overlay = document.getElementById('overlay');
const progressCircle = document.getElementById('progressCircle');
const progressText = document.getElementById('progressText');

let observationsData = [];

// Campos mapeáveis do Excel
const requiredFields = {
    nid: ['nid', 'NID'],
    fullname: ['fullname', 'FullName', 'NomeCompleto'],
    gender: ['gender', 'Gender', 'sexo'],
    age: ['age', 'Age', 'idade_actual'],
    contact: ['contact', 'Contact', 'contacto_paciente'],
    occupation: ['occupation', 'Occupation', 'Profissao'],
};

function populateTable(data) {
    observationsTableBody.innerHTML = '';
    data.forEach((obs, index) => {
        observationsTableBody.innerHTML += `<tr>
            <td>${obs.id || index + 1}</td>
            <td>${obs.fullname || ''}</td>
            <td>${obs.nid || ''}</td>
            <td>${obs.gender || ''}</td>
            <td>${obs.age || ''}</td>
            <td>${obs.contact || ''}</td>
            <td>${obs.occupation || ''}</td>
            <td>
                <button class="btn btn-sm btn-warning" onclick="editObservation(${index})">Edit</button>
                <button class="btn btn-sm btn-danger" onclick="deleteObservation(${index})">Delete</button>
            </td>
        </tr>`;
    });
}

function mapRow(row) {
    let mapped = {};
    for (let key in requiredFields) {
        for (let col of requiredFields[key]) {
            if (row[col] !== undefined) {
                mapped[key] = row[col];
                break;
            }
        }
    }
    return mapped;
}

function updateProgress(percent) {
    progressCircle.style.background = `conic-gradient(#007bff ${percent}%, #e0e0e0 ${percent}% 100%)`;
    progressText.innerText = `${percent}%`;
}

async function loadObservationsWithProgress() {
    overlay.style.display = 'flex';
    let progress = 0;

    const progressInterval = setInterval(() => {
        if (progress < 90) {
            progress += 1;
            updateProgress(progress);
        }
    }, 30); // velocidade do incremento visual

    try {
        const res = await fetch('/api/observation');
        const data = await res.json();

        clearInterval(progressInterval);
        updateProgress(100);
        observationsData = data;
        populateTable(data);

        await new Promise(r => setTimeout(r, 500));

    } catch (error) {
        console.error("Error loading observations:", error);
        alert("Failed to load data.");
    } finally {
        overlay.style.display = 'none';
        updateProgress(0);
    }
}

importBtn.addEventListener('click', async () => {
    const file = fileInput.files[0];
    if (!file) {
        alert("Please select a file first.");
        return;
    }

    overlay.style.display = 'flex';
    let progress = 0;

    const progressInterval = setInterval(() => {
        if (progress < 90) {
            progress += 1;
            updateProgress(progress);
        }
    }, 25);

    const reader = new FileReader();

    reader.onload = async function (e) {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });

            const firstSheet = workbook.SheetNames[0];
            const sheetData = XLSX.utils.sheet_to_json(workbook.Sheets[firstSheet]);

            if (!sheetData.length) throw new Error("No data found in the sheet.");

            const mappedData = sheetData.map(mapRow);

            const res = await fetch('/api/observations/import', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(mappedData)
            });

            if (res.ok) {
                clearInterval(progressInterval);
                updateProgress(100);
                alert('Data imported successfully!');
                await loadObservationsWithProgress();
            } else {
                const err = await res.json();
                throw new Error(err?.message || "Import failed");
            }

        } catch (error) {
            clearInterval(progressInterval);
            console.error("Import error:", error);
            alert("Error during import: " + error.message);
            updateProgress(0);
        } finally {
            setTimeout(() => {
                overlay.style.display = 'none';
                updateProgress(0);
            }, 1000);
        }
    };

    reader.onerror = function (err) {
        console.error("FileReader error:", err);
        alert("Failed to read file.");
        clearInterval(progressInterval);
        overlay.style.display = 'none';
    };

    reader.readAsArrayBuffer(file);
});

function editObservation(index) {
    const obs = observationsData[index];
    const newName = prompt("Edit Full Name:", obs.fullname || '');
    if (newName !== null) {
        observationsData[index].fullname = newName;
        populateTable(observationsData);
    }
}

function deleteObservation(index) {
    if (!confirm("Are you sure?")) return;
    observationsData.splice(index, 1);
    populateTable(observationsData);
}

window.onload = loadObservationsWithProgress;
</script>
{% endblock %}
