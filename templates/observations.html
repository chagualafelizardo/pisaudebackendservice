{% extends 'base.html' %}
{% block title %}PI-SAÃšDE / Observations{% endblock %}

{% block content %}

<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1">ðŸ‘¥ Patient Observations Management</h2>
            <p class="text-muted mb-0">Manage patient observations, states, and groups</p>
        </div>
        
        <!-- Shortcuts Group -->
        <div class="d-flex align-items-center gap-3">
            <!-- Quick Import Shortcuts -->
            <div class="dropdown">
                <button class="btn btn-outline-primary dropdown-toggle" type="button" id="quickImportDropdown" data-bs-toggle="dropdown">
                    <i class="fas fa-upload me-1"></i> Quick Import
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item" href="/content/iniciotarv">
                        <i class="fas fa-file-medical me-2 text-primary"></i> InÃ­cio TARV
                    </a></li>
                    <li><a class="dropdown-item" href="/content/adesaotarv">
                        <i class="fas fa-heart me-2 text-success"></i> AdesÃ£o ao TARV
                    </a></li>
                    <li><a class="dropdown-item" href="/content/marcadoslevantamento">
                        <i class="fas fa-calendar-check me-2 text-warning"></i> Marcados Para Levantamento de ARVs
                    </a></li>
                    <li><a class="dropdown-item" href="/content/cargaviral">
                        <i class="fas fa-vial me-2 text-info"></i> Carga Viral
                    </a></li>
                    <li><a class="dropdown-item" href="/content/faltosos">
                        <i class="fas fa-user-clock me-2 text-danger"></i> Faltosos
                    </a></li>
                    <li><a class="dropdown-item" href="/content/abandonos">
                        <i class="fas fa-user-slash me-2 text-secondary"></i> Abandonos
                    </a></li>
                </ul>
            </div>
            
            <!-- Quick Filters -->
            <div class="dropdown">
                <button class="btn btn-outline-info dropdown-toggle" type="button" id="quickFilterDropdown" data-bs-toggle="dropdown">
                    <i class="fas fa-filter me-1"></i> Quick Filters
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item" href="#" onclick="filterInitialState()">
                        <i class="fas fa-flag me-2 text-primary"></i> Show Initial Status
                    </a></li>
                    <li><a class="dropdown-item" href="#" onclick="filterUnknownStates()">
                        <i class="fas fa-question-circle me-2 text-warning"></i> Unknown State
                    </a></li>
                    <li><a class="dropdown-item" href="#" onclick="filterNoGroup()">
                        <i class="fas fa-user-times me-2 text-danger"></i> No Group
                    </a></li>
                    <li><a class="dropdown-item" href="#" onclick="filterNoSMS()">
                        <i class="fas fa-comment-slash me-2 text-secondary"></i> No SMS Message
                    </a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="#" onclick="selectAllUnknown()">
                        <i class="fas fa-check-square me-2 text-primary"></i> Select All Unknown
                    </a></li>
                </ul>
            </div>
            
            <!-- Add New Observation Button -->
            <button class="btn btn-primary btn-lg" onclick="openObsModal()">
                <i class="fas fa-plus me-2"></i> Add New Observation
            </button>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card border-primary">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-subtitle mb-2 text-muted">Total Observations</h6>
                            <h3 id="totalObservations" class="card-title mb-0">0</h3>
                        </div>
                        <i class="fas fa-clipboard-list fs-1 text-primary"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-success">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-subtitle mb-2 text-muted">Active Patients</h6>
                            <h3 id="activePatients" class="card-title mb-0">0</h3>
                        </div>
                        <i class="fas fa-user-check fs-1 text-success"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-warning">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-subtitle mb-2 text-muted">Unknown State</h6>
                            <h3 id="unknownStates" class="card-title mb-0">0</h3>
                        </div>
                        <i class="fas fa-question-circle fs-1 text-warning"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-info">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-subtitle mb-2 text-muted">In Groups</h6>
                            <h3 id="inGroups" class="card-title mb-0">0</h3>
                        </div>
                        <i class="fas fa-users fs-1 text-info"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ðŸ” Advanced Filters -->
    <div class="card mb-4">
        <div class="card-header bg-light">
            <h6 class="mb-0"><i class="fas fa-filter me-2"></i> Filter Observations</h6>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <!-- Date Range -->
                <div class="col-md-3">
                    <label class="form-label">
                        <i class="fas fa-calendar me-1 text-primary"></i> Date Range
                    </label>
                    <div class="input-group">
                        <input type="date" id="filterStartDate" class="form-control" placeholder="Start">
                        <span class="input-group-text">to</span>
                        <input type="date" id="filterEndDate" class="form-control" placeholder="End">
                    </div>
                </div>

                <!-- Status - MODIFICADO: Agora carregado da API -->
                <div class="col-md-2">
                    <label class="form-label">
                        <i class="fas fa-tag me-1 text-primary"></i> Status
                    </label>
                    <select id="filterStatus" class="form-select">
                        <option value="">All Status</option>
                        <!-- Estados serÃ£o carregados via API -->
                    </select>
                </div>

                <!-- Text Message -->
                <div class="col-md-2">
                    <label class="form-label">
                        <i class="fas fa-sms me-1 text-primary"></i> SMS Message
                    </label>
                    <select id="filterTextmessage" class="form-select">
                        <option value="">All Messages</option>
                    </select>
                </div>

                <!-- Group -->
                <div class="col-md-2">
                    <label class="form-label">
                        <i class="fas fa-users me-1 text-primary"></i> Group
                    </label>
                    <select id="filterGroup" class="form-select">
                        <option value="">All Groups</option>
                        <option value="no_group">No Group</option>
                    </select>
                </div>

                <!-- Location -->
                <div class="col-md-2">
                    <label class="form-label">
                        <i class="fas fa-hospital me-1 text-primary"></i> Location
                    </label>
                    <select id="filterLocation" class="form-select">
                        <option value="">All Locations</option>
                    </select>
                </div>

                <!-- Quick Actions -->
                <div class="col-md-1 d-flex flex-column gap-2 align-self-end">
                    <div class="btn-group w-100" role="group">
                        <button class="btn btn-primary" onclick="filterObservations()">
                            <i class="fas fa-search me-1"></i> Filter
                        </button>
                    </div>
                </div>
            </div>

            <!-- Active Filters Display -->
            <div id="activeFilters" class="mt-3" style="display: none;">
                <div class="d-flex align-items-center">
                    <span class="me-2 text-muted"><i class="fas fa-filter"></i> Active filters:</span>
                    <div id="filterTags" class="d-flex flex-wrap gap-2"></div>
                    <button class="btn btn-sm btn-outline-danger ms-2" onclick="clearFilters()">
                        <i class="fas fa-times me-1"></i> Clear All
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Batch Actions -->
    <div class="card mb-4">
        <div class="card-header bg-light">
            <h6 class="mb-0"><i class="fas fa-cogs me-2"></i> Batch Actions</h6>
        </div>
        <div class="card-body">
            <div class="row g-3 align-items-center">
                <div class="col-md-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="selectAll">
                        <label class="form-check-label" for="selectAll">
                            <strong>Select All</strong> (<span id="selectedCount">0</span> selected)
                        </label>
                    </div>
                </div>
                <div class="col-md-9">
                    <div class="btn-group" role="group">
                        <button class="btn btn-success" onclick="confirmAction()">
                            <i class="fas fa-check-circle me-1"></i> Confirm State
                        </button>
                        <button class="btn btn-primary" onclick="openInsertToGroupModal()">
                            <i class="fas fa-user-plus me-1"></i> Add to Group
                        </button>
                        <button class="btn btn-warning" onclick="exportSelected()">
                            <i class="fas fa-file-export me-1"></i> Export
                        </button>
                        <button class="btn btn-danger" onclick="deleteSelected()">
                            <i class="fas fa-trash me-1"></i> Delete
                        </button>
                        <div class="dropdown">
                            <button class="btn btn-info dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                <i class="fas fa-bolt me-1"></i> Quick Actions
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="assignDefaultState()">
                                    <i class="fas fa-tag me-2"></i> Assign Default State
                                </a></li>
                                <li><a class="dropdown-item" href="#" onclick="markAsReviewed()">
                                    <i class="fas fa-eye me-2"></i> Mark as Reviewed
                                </a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" onclick="updateStatusBulk('active')">
                                    <i class="fas fa-check me-2 text-success"></i> Set as Active
                                </a></li>
                                <li><a class="dropdown-item" href="#" onclick="updateStatusBulk('inactive')">
                                    <i class="fas fa-times me-2 text-danger"></i> Set as Inactive
                                </a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Observations Table -->
    <div class="card">
        <div class="card-header bg-white border-bottom-0">
            <div class="row align-items-center">
                <div class="col">
                    <h5 class="mb-0">Observations List</h5>
                    <small class="text-muted" id="resultsInfo">Loading observations...</small>
                </div>
                <div class="col-auto">
                    <button class="btn btn-outline-primary" onclick="loadObservationsWithProgress()">
                        <i class="fas fa-redo me-1"></i> Refresh
                    </button>
                </div>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th width="40">
                                <input type="checkbox" id="selectAllHeader" class="form-check-input">
                            </th>
                            <th>Grupo do Paciente</th>
                            <th>ID</th>
                            <th>Patient</th>
                            <th>Contact</th>
                            <th>dataprimeiracv</th>
                            <th>valorprimeiracv</th>
                            <th>dataultimacv</th>
                            <th>valorultimacv</th>
                            <th>Sate description</th>
                            <th>SMS Message</th>
                            <th>Group</th>
                            <th>Location</th>
                            <th>User</th>
                            <th>Status</th>
                            <th>SMS Status</th>
                            <th>Last Updated</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="obsTableBody">
                        <tr>
                            <td colspan="10" class="text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2 mb-0">Loading observations...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination -->
            <div class="d-flex justify-content-between align-items-center p-3 border-top">
                <div class="text-muted" id="paginationInfo">Showing 0 of 0 observations</div>
                <div class="btn-group" role="group">
                    <button class="btn btn-outline-primary btn-sm" onclick="changePage(-1)" disabled id="prevBtn">
                        <i class="fas fa-chevron-left"></i> Previous
                    </button>
                    <button class="btn btn-outline-primary btn-sm" onclick="changePage(1)" disabled id="nextBtn">
                        Next <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ============== MODAL OBSERVATION ============== -->
<div class="modal fade" id="obsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <form id="obsForm">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="modalTitle">
                        <i class="fas fa-clipboard-medical me-2"></i>
                        Add Observation
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="obsId">
                    
                    <!-- Tabs -->
                    <ul class="nav nav-tabs" id="observationTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="patient-tab" data-bs-toggle="tab" data-bs-target="#patient" type="button">
                                <i class="fas fa-user me-1"></i> Patient Info
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="medical-tab" data-bs-toggle="tab" data-bs-target="#medical" type="button">
                                <i class="fas fa-heartbeat me-1"></i> Medical Info
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="sms-tab" data-bs-toggle="tab" data-bs-target="#sms" type="button">
                                <i class="fas fa-sms me-1"></i> SMS & Status
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="dates-tab" data-bs-toggle="tab" data-bs-target="#dates" type="button">
                                <i class="fas fa-calendar-alt me-1"></i> Dates
                            </button>
                        </li>
                    </ul>
                    
                    <div class="tab-content p-4">
                        <!-- Patient Info Tab -->
                        <div class="tab-pane fade show active" id="patient" role="tabpanel">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="nid" class="form-label">
                                            <i class="fas fa-id-card me-1 text-primary"></i> NID *
                                        </label>
                                        <input type="text" id="nid" class="form-control" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="fullname" class="form-label">
                                            <i class="fas fa-user me-1 text-primary"></i> Full Name *
                                        </label>
                                        <input type="text" id="fullname" class="form-control" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="contact" class="form-label">
                                            <i class="fas fa-phone me-1 text-primary"></i> Contact *
                                        </label>
                                        <input type="tel" id="contact" class="form-control" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="gender" class="form-label">
                                            <i class="fas fa-venus-mars me-1 text-primary"></i> Gender *
                                        </label>
                                        <select id="gender" class="form-select" required>
                                            <option value="">Select Gender</option>
                                            <option value="M">Male</option>
                                            <option value="F">Female</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="age" class="form-label">
                                            <i class="fas fa-birthday-cake me-1 text-primary"></i> Age *
                                        </label>
                                        <input type="number" id="age" class="form-control" min="0" max="120" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="occupation" class="form-label">
                                            <i class="fas fa-briefcase me-1 text-primary"></i> Occupation *
                                        </label>
                                        <select id="occupation" class="form-select" required>
                                            <option value="">Select Occupation</option>
                                            <option value="Militar">Military</option>
                                            <option value="Civil">Civilian</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Medical Info Tab -->
                        <div class="tab-pane fade" id="medical" role="tabpanel">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="linhaterapeutica" class="form-label">Therapeutic Line</label>
                                        <input type="text" id="linhaterapeutica" class="form-control">
                                    </div>
                                    <div class="mb-3">
                                        <label for="regime" class="form-label">Regimen</label>
                                        <input type="text" id="regime" class="form-control">
                                    </div>
                                    <div class="mb-3">
                                        <label for="valorprimeiracv" class="form-label">First CV Value</label>
                                        <input type="number" id="valorprimeiracv" class="form-control" step="0.01">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="valorultimacv" class="form-label">Last CV Value</label>
                                        <input type="number" id="valorultimacv" class="form-control" step="0.01">
                                    </div>
                                    <div class="mb-3">
                                        <label for="dataprimeiracv" class="form-label">First CV Date</label>
                                        <input type="datetime-local" id="dataprimeiracv" class="form-control">
                                    </div>
                                    <div class="mb-3">
                                        <label for="dataultimacv" class="form-label">Last CV Date</label>
                                        <input type="datetime-local" id="dataultimacv" class="form-control">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- SMS & Status Tab -->
                        <div class="tab-pane fade" id="sms" role="tabpanel">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="stateSelect" class="form-label">State *</label>
                                        <select id="stateSelect" class="form-select" required></select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="textmessageSelect" class="form-label">SMS Message *</label>
                                        <select id="textmessageSelect" class="form-select" required></select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="smssendernumber" class="form-label">SMS Sender Number</label>
                                        <input type="tel" id="smssendernumber" class="form-control">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="smssuporternumber" class="form-label">SMS Supporter Number</label>
                                        <input type="tel" id="smssuporternumber" class="form-control">
                                    </div>
                                    <div class="mb-3">
                                        <label for="groupSelect" class="form-label">Group</label>
                                        <select id="groupSelect" class="form-select"></select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="grouptypeSelect" class="form-label">Group Type</label>
                                        <select id="grouptypeSelect" class="form-select"></select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Dates Tab -->
                        <div class="tab-pane fade" id="dates" role="tabpanel">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="datainiciotarv" class="form-label">TARV Start Date</label>
                                        <input type="datetime-local" id="datainiciotarv" class="form-control">
                                    </div>
                                    <div class="mb-3">
                                        <label for="dataconsulta" class="form-label">Consultation Date</label>
                                        <input type="datetime-local" id="dataconsulta" class="form-control">
                                    </div>
                                    <div class="mb-3">
                                        <label for="dataenvio" class="form-label">SMS Send Date</label>
                                        <input type="datetime-local" id="dataenvio" class="form-control">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="datalevantamento" class="form-label">Collection Date</label>
                                        <input type="datetime-local" id="datalevantamento" class="form-control">
                                    </div>
                                    <div class="mb-3">
                                        <label for="dataproximaconsulta" class="form-label">Next Consultation</label>
                                        <input type="datetime-local" id="dataproximaconsulta" class="form-control">
                                    </div>
                                    <div class="mb-3">
                                        <label for="dataalocacao" class="form-label">Allocation Date</label>
                                        <input type="datetime-local" id="dataalocacao" class="form-control">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Common Fields -->
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="locationSelect" class="form-label">
                                    <i class="fas fa-hospital me-1 text-primary"></i> Health Facility
                                </label>
                                <select id="locationSelect" class="form-select"></select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="userSelect" class="form-label">
                                    <i class="fas fa-user-md me-1 text-primary"></i> User
                                </label>
                                <select id="userSelect" class="form-select"></select>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i> Cancel
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-1"></i> Save Observation
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ============== MODAL INSERT TO GROUP ============== -->
<div class="modal fade" id="insertGroupModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-user-plus me-2"></i> Add Patients to Group
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Group Name *</label>
                        <input class="form-control" id="txtGroupName" placeholder="Ex: Grupo A" required>
                        <small class="text-muted">Required if creating new group</small>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Status *</label>
                        <select class="form-select" id="selectStatusInsert" required></select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">SMS Message *</label>
                        <select class="form-select" id="selectTextMessage" required></select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Group Type</label>
                        <select class="form-select" id="selectGroupTypeInsert"></select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Start Date</label>
                        <input class="form-control" id="dateStart" type="date">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">End Date</label>
                        <input class="form-control" id="dateEnd" type="date">
                    </div>
                    <div class="col-12">
                        <label class="form-label">Observation</label>
                        <textarea class="form-control" id="txtObservation" rows="2" placeholder="Observations about this group..."></textarea>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Select Existing Group (optional)</label>
                        <select class="form-select" id="selectGroupInsert">
                            <option value="">-- Create New Group --</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <div class="form-check mt-4">
                            <input class="form-check-input" type="checkbox" id="updateStatusCheckbox" checked>
                            <label class="form-check-label" for="updateStatusCheckbox">
                                Update patient status to selected state
                            </label>
                        </div>
                    </div>
                </div>

                <hr>
                <h6><i class="fas fa-users me-1"></i> Selected Patients (<span id="selectedPatientsCount">0</span>):</h6>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Note:</strong> Selected patients will be added to the group and their status will be updated according to the selection above.
                </div>
                <div class="table-responsive mt-2">
                    <table class="table table-bordered table-sm">
                        <thead class="table-light">
                            <tr>
                                <th width="50">#</th>
                                <th>Full Name</th>
                                <th>NID</th>
                                <th>Current Status</th>
                                <th>Current SMS</th>
                                <th>New Status</th>
                            </tr>
                        </thead>
                        <tbody id="selectedPatientsBody"></tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i> Cancel
                </button>
                <button type="button" class="btn btn-primary" onclick="confirmAddMembers()">
                    <i class="fas fa-save me-1"></i> Save Changes
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Loader Overlay -->
<div id="overlay" style="
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: none;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 9999;
    justify-content: center;
    align-items: center;
">
    <div style="
        position: relative;
        width: 300px;
        padding: 30px;
        background-color: white;
        border-radius: 10px;
        box-shadow: 0 0 20px rgba(0,0,0,0.3);
        text-align: center;
    ">
        <h5 id="progressTitle" class="mb-3">Processing...</h5>
        
        <!-- Progress Bar -->
        <div class="progress mb-3" style="height: 20px;">
            <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                 role="progressbar" style="width: 0%;"></div>
        </div>
        
        <!-- Circular Progress -->
        <div style="position: relative; display: inline-block;">
            <div id="circularProgress" style="
                width: 100px;
                height: 100px;
                border-radius: 50%;
                background: conic-gradient(#007bff 0% 0%, #e0e0e0 0% 100%);
                display: flex;
                justify-content: center;
                align-items: center;
                margin: 0 auto 15px;
            ">
                <span id="progressPercentage" style="
                    font-weight: bold;
                    font-size: 20px;
                    color: #007bff;
                ">0%</span>
            </div>
        </div>
        
        <div id="progressDetails" class="mt-2">
            <p id="progressMessage" class="mb-1">Starting process...</p>
            <small id="progressStats" class="text-muted">0 of 0 records</small>
        </div>
        
        <!-- Cancel Button -->
        <button class="btn btn-outline-danger btn-sm mt-3" onclick="cancelLoading()">
            <i class="fas fa-times me-1"></i> Cancel
        </button>
    </div>
</div>

<!-- Import Results Modal -->
<div class="modal fade" id="resultsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">Operation Completed</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="text-center p-3 border rounded">
                            <h3 class="text-primary" id="resultsTotal">0</h3>
                            <small>Total Processed</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center p-3 border rounded">
                            <h3 class="text-success" id="resultsSuccess">0</h3>
                            <small>Success</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center p-3 border rounded">
                            <h3 class="text-warning" id="resultsSkipped">0</h3>
                            <small>Skipped</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center p-3 border rounded">
                            <h3 class="text-danger" id="resultsFailed">0</h3>
                            <small>Failed</small>
                        </div>
                    </div>
                </div>

                <div id="errorsSection" style="display: none;">
                    <h6 class="text-danger">
                        <i class="fas fa-exclamation-circle me-1"></i> Operation Errors:
                    </h6>
                    <div class="alert alert-danger">
                        <ul id="errorList" class="mb-0"></ul>
                    </div>
                </div>

                <div id="warningsSection" style="display: none;">
                    <h6 class="text-warning">
                        <i class="fas fa-exclamation-triangle me-1"></i> Operation Warnings:
                    </h6>
                    <div class="alert alert-warning">
                        <ul id="warningList" class="mb-0"></ul>
                    </div>
                </div>

                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-1"></i>
                    <strong>Note:</strong> The operation has been completed.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i> Close
                </button>
                <button type="button" class="btn btn-primary" onclick="loadObservationsWithProgress()">
                    <i class="fas fa-redo me-1"></i> Refresh List
                </button>
            </div>
        </div>
    </div>
</div>

<style>
/* Progress Loader */
.circular-progress {
    animation: progress-animation 0.5s ease-out;
}

@keyframes progress-animation {
    from { transform: scale(0.8); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
}

/* Status badges */
.status-badge {
    padding: 0.35rem 0.65rem;
    font-size: 0.75em;
    font-weight: 500;
}

/* Highlight unknown rows */
tr.unknown-state {
    background-color: #fff3cd !important;
    border-left: 4px solid #ffc107;
}

tr.unknown-state:hover {
    background-color: #ffeaa7 !important;
}

/* Status indicators */
.status-unknown {
    background-color: #ffc107;
    color: #000;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.7; }
    100% { opacity: 1; }
}

/* Filter chips */
.filter-chip {
    display: inline-flex;
    align-items: center;
    background: #e3f2fd;
    border: 1px solid #bbdefb;
    border-radius: 20px;
    padding: 4px 12px;
    font-size: 0.85rem;
    margin-right: 8px;
    margin-bottom: 4px;
}

.filter-chip.unknown {
    background: #fff3cd;
    border-color: #ffc107;
}

.filter-chip.no-group {
    background: #f8d7da;
    border-color: #f5c6cb;
}

/* Quick filter buttons */
.btn-quick-filter {
    border-radius: 20px;
    padding: 0.25rem 1rem;
    font-size: 0.875rem;
}

.bg-pending { background-color: #ffc107; color: #000; }
.bg-completed { background-color: #198754; color: #fff; }
.bg-active { background-color: #0d6efd; color: #fff; }
.bg-inactive { background-color: #6c757d; color: #fff; }

/* Patient card */
.patient-card {
    border-left: 4px solid #0d6efd;
    padding-left: 1rem;
    margin-bottom: 0.75rem;
}

/* Filter tags */
.filter-tag {
    display: inline-flex;
    align-items: center;
    background: #e3f2fd;
    border: 1px solid #bbdefb;
    border-radius: 20px;
    padding: 4px 12px;
    font-size: 0.85rem;
    margin-right: 8px;
    margin-bottom: 4px;
}

.filter-tag .remove-filter {
    margin-left: 6px;
    cursor: pointer;
    color: #666;
}

.filter-tag .remove-filter:hover {
    color: #dc3545;
}

/* Quick import dropdown */
#quickImportDropdown {
    border-width: 2px;
}

#quickImportDropdown:hover {
    background-color: #f8f9fa;
}

.dropdown-menu {
    border: 1px solid #dee2e6;
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
}

.dropdown-item {
    padding: 0.5rem 1rem;
    transition: all 0.2s ease;
}

.dropdown-item:hover {
    background-color: #f8f9fa;
    transform: translateX(5px);
}

.dropdown-item i {
    width: 20px;
    text-align: center;
}

/* Responsive table */
@media (max-width: 768px) {
    .btn-group {
        flex-wrap: wrap;
    }
    
    .btn-group .btn {
        margin-bottom: 0.25rem;
    }
    
    /* Responsive header */
    .d-flex.justify-content-between.align-items-center.mb-4 {
        flex-direction: column;
        align-items: flex-start !important;
    }
    
    .d-flex.align-items-center.gap-3 {
        margin-top: 1rem;
        width: 100%;
        justify-content: space-between;
    }
}

/* Progress Bar Animation */
.progress-bar-striped {
    background-image: linear-gradient(45deg, rgba(255, 255, 255, 0.15) 25%, transparent 25%, transparent 50%, rgba(255, 255, 255, 0.15) 50%, rgba(255, 255, 255, 0.15) 75%, transparent 75%, transparent);
    background-size: 1rem 1rem;
}

.progress-bar-animated {
    animation: progress-bar-stripes 1s linear infinite;
}

@keyframes progress-bar-stripes {
    0% { background-position: 1rem 0; }
    100% { background-position: 0 0; }
}

/* Melhorar a barra de rolagem */
.table-responsive::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

.table-responsive::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
}

.table-responsive::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 4px;
}

.table-responsive::-webkit-scrollbar-thumb:hover {
    background: #555;
}

/* Garantir que os cabeÃ§alhos ficam fixos */
.table-responsive thead th {
    background-color: #f8f9fa;
    position: sticky;
    top: 0;
    z-index: 10;
}
</style>

<script>
/* ======== API ENDPOINTS ======== */
const apiObs = '/api/observation';
const apiState = '/api/state';
const apiTextMessage = '/api/textmessage';
const apiGrouptype = '/api/grouptype';
const apiGroup = '/api/group';
const apiLocation = '/api/location';
const apiUser = '/api/user';

let currentPage = 1;
const pageSize = 50;
let observationsData = [];
let filteredData = [];
let currentFilters = {};
let loadingCancelled = false;

// DOM Elements
const overlay = document.getElementById('overlay');
const progressBar = document.getElementById('progressBar');
const progressPercentage = document.getElementById('progressPercentage');
const circularProgress = document.getElementById('circularProgress');
const progressMessage = document.getElementById('progressMessage');
const progressStats = document.getElementById('progressStats');
const progressTitle = document.getElementById('progressTitle');

/* ======== PROGRESS FUNCTIONS ======== */
function updateProgress(percent, message = '', stats = '') {
    if (progressBar && progressPercentage && circularProgress) {
        progressBar.style.width = `${percent}%`;
        progressPercentage.textContent = `${percent}%`;
        circularProgress.style.background = `conic-gradient(#007bff ${percent}%, #e0e0e0 ${percent}% 100%)`;
        
        if (message) progressMessage.textContent = message;
        if (stats) progressStats.textContent = stats;
    }
}

function showOverlay(title = 'Loading', message = 'Please wait...') {
    if (overlay) {
        loadingCancelled = false;
        progressTitle.textContent = title;
        progressMessage.textContent = message;
        overlay.style.display = 'flex';
        updateProgress(0, message);
    }
}

function hideOverlay() {
    if (overlay) {
        overlay.style.display = 'none';
    }
}

function cancelLoading() {
    loadingCancelled = true;
    hideOverlay();
    showAlert('info', 'Operation cancelled.');
}

function showAlert(type, message) {
    // Remove any existing alerts
    const existingAlerts = document.querySelectorAll('.global-alert');
    existingAlerts.forEach(alert => alert.remove());
    
    const alertDiv = document.createElement('div');
    alertDiv.className = `global-alert alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = `
        top: 20px;
        right: 20px;
        z-index: 99999;
        min-width: 300px;
        max-width: 400px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    `;
    
    const icon = type === 'success' ? 'âœ“' : 
                 type === 'warning' ? 'âš ' : 
                 type === 'error' ? 'âœ—' : 'â„¹';
    
    alertDiv.innerHTML = `
        <strong>${icon} ${type.charAt(0).toUpperCase() + type.slice(1)}!</strong> ${message}
        <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.classList.remove('show');
            setTimeout(() => alertDiv.remove(), 150);
        }
    }, 5000);
}

/* ======== LOAD DROPDOWNS ======== */
async function loadDropdown(url, selectId, field = 'description', placeholder = '') {
    try {
        const res = await fetch(url);
        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
        
        const data = await res.json();
        const select = document.getElementById(selectId);
        
        if (!select) return;
        
        select.innerHTML = placeholder || `<option value="">-- Select --</option>`;
        
        data.forEach(item => {
            const option = document.createElement('option');
            option.value = item.id;
            option.textContent = item[field] || item.name || item.description;
            select.appendChild(option);
        });
    } catch (error) {
        console.error(`Error loading dropdown ${selectId}:`, error);
        showAlert('error', `Error loading ${selectId.replace('filter', '')} options`);
    }
}

/* ======== LOAD OBSERVATIONS ======== */
/* ======== LOAD OBSERVATIONS ======== */
async function loadObservationsWithProgress() {
    showOverlay('Loading Observations', 'Fetching data from server...');
    updateProgress(10, 'Starting process...');
    
    try {
        // Simulate progress for large datasets
        let progress = 10;
        const progressInterval = setInterval(() => {
            if (progress < 70) {
                progress += 5;
                updateProgress(progress, 'Fetching data...', 'Connecting to server...');
            }
        }, 100);
        
        updateProgress(30, 'Connecting to server...');
        await new Promise(resolve => setTimeout(resolve, 500));
        
        if (loadingCancelled) {
            clearInterval(progressInterval);
            return;
        }
        
        updateProgress(50, 'Fetching observations data...');
        const res = await fetch(apiObs);
        
        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
        
        clearInterval(progressInterval);
        updateProgress(80, 'Processing data...');
        
        const data = await res.json();
        observationsData = data;
        
        // FILTRAR APENAS OBSERVAÃ‡Ã•ES COM STATUS 'INICIAL' AO CARREGAR
        // Primeiro, vamos buscar o stateId correspondente a 'Inicial'
        const statusSelect = document.getElementById('filterStatus');
        let initialStateId = null;
        
        // Tentar encontrar o estado 'Inicial' no dropdown
        if (statusSelect && statusSelect.options.length > 0) {
            for (let option of statusSelect.options) {
                if (option.text.toLowerCase() === 'inicial') {
                    initialStateId = option.value;
                    break;
                }
            }
        }
        
        // Se encontrou o stateId, filtrar os dados
        if (initialStateId) {
            filteredData = observationsData.filter(obs => obs.stateId == initialStateId);
            
            // Definir filtro ativo para 'Inicial'
            currentFilters = {
                stateId: initialStateId
            };
            
            // Selecionar a opÃ§Ã£o no dropdown de filtro
            document.getElementById('filterStatus').value = initialStateId;
            
            showAlert('info', `Showing observations with status "Inicial". Use filters to view other statuses.`);
        } else {
            // Se nÃ£o encontrou, mostrar todos os dados
            filteredData = data;
            showAlert('warning', 'Status "Inicial" not found. Showing all observations.');
        }
        
        updateProgress(90, 'Updating UI...');
        updateSummaryCards();
        updateActiveFiltersDisplay(); // Atualizar display de filtros ativos
        renderTablePage(filteredData, currentPage);
        
        updateProgress(100, 'Data loaded successfully!', `${filteredData.length} of ${data.length} records loaded`);
        
        await new Promise(resolve => setTimeout(resolve, 500));
        hideOverlay();
        
        if (filteredData.length === 0) {
            showAlert('info', 'No observations found with status "Inicial". Import data or add new observations.');
        }
        
    } catch (error) {
        console.error('Error loading observations:', error);
        updateProgress(100, 'Error loading data');
        showAlert('error', 'Failed to load observations: ' + error.message);
        
        const tbody = document.getElementById('obsTableBody');
        tbody.innerHTML = `
            <tr>
                <td colspan="10" class="text-center py-5">
                    <i class="fas fa-exclamation-triangle fs-1 text-danger mb-3"></i>
                    <h5 class="text-danger">Error Loading Data</h5>
                    <p class="text-muted">${error.message}</p>
                    <button class="btn btn-primary mt-2" onclick="loadObservationsWithProgress()">
                        <i class="fas fa-redo me-1"></i> Try Again
                    </button>
                </td>
            </tr>
        `;
        hideOverlay();
    }
}

/* ======== HELPER FUNCTIONS ======== */
function findInitialStateId() {
    const statusSelect = document.getElementById('filterStatus');
    if (!statusSelect) return null;
    
    for (let option of statusSelect.options) {
        if (option.text.toLowerCase() === 'inicial') {
            return option.value;
        }
    }
    return null;
}

/* ======== SUMMARY CARDS ======== */
function updateSummaryCards() {
    const totalObservations = observationsData.length;
    const activePatients = observationsData.filter(o => o.stateDescription && o.stateDescription.toLowerCase().includes('active')).length;
    const unknownStates = observationsData.filter(o => 
        !o.stateId || !o.stateDescription || o.stateDescription.toLowerCase().includes('unknown')
    ).length;
    const inGroups = observationsData.filter(o => o.groupId).length;
    
    document.getElementById('totalObservations').textContent = totalObservations;
    document.getElementById('activePatients').textContent = activePatients;
    document.getElementById('unknownStates').textContent = unknownStates;
    document.getElementById('inGroups').textContent = inGroups;
}

/* ======== TABLE & PAGINATION ======== */
function renderTablePage(data, page) {
    const tbody = document.getElementById('obsTableBody');
    const start = (page - 1) * pageSize;
    const pageData = data.slice(start, start + pageSize);
    
    // Buscar o stateId de 'Inicial'
    const statusSelect = document.getElementById('filterStatus');
    let isInitialFilterActive = false;
    if (statusSelect && statusSelect.value && 
        statusSelect.options[statusSelect.selectedIndex]) {
        const selectedText = statusSelect.options[statusSelect.selectedIndex].text.toLowerCase();
        isInitialFilterActive = selectedText === 'inicial';
    }
    
    if (pageData.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="10" class="text-center py-5">
                    <i class="fas fa-search fs-1 text-muted mb-3"></i>
                    <h5 class="text-muted">No observations found</h5>
                    ${isInitialFilterActive ? 
                        `<div class="alert alert-info w-75 mx-auto">
                            <i class="fas fa-info-circle me-2"></i>
                            No observations found with status "Inicial".
                            ${Object.keys(currentFilters).length > 1 ? 
                                `<br><small>Try changing other filters or 
                                 <button class="btn btn-link p-0" onclick="clearFilters()">reset to default</button>.</small>` : 
                                `<br><small>Import data or add new observations.</small>`}
                        </div>` : 
                        `<p class="text-muted">Try changing your filters or 
                         <button class="btn btn-link p-0" onclick="clearFilters()">clear all filters</button>.</p>`}
                </td>
            </tr>
        `;
    } else {
        tbody.innerHTML = '';
        
        pageData.forEach(obs => {
            const statusClass = getStatusClass(obs.stateDescription);
            const isUnknown = !obs.stateId || !obs.stateDescription || obs.stateDescription.toLowerCase().includes('unknown');
            const isInitial = obs.stateDescription && obs.stateDescription.toLowerCase() === 'inicial';
            const rowClass = isUnknown ? 'unknown-state' : (isInitial ? 'initial-state' : '');
            
            const row = document.createElement('tr');
            row.className = rowClass;
            row.innerHTML = `
                <td>
                    <input type="checkbox" class="form-check-input rowCheck" value="${obs.id}">
                </td>
                <td><strong>${obs.groupTypeDescription}</strong></td>
                <td><strong>#${obs.id}</strong></td>
                <td>
                    <div class="fw-bold">${obs.fullname || 'N/A'}</div>
                    <small class="text-muted">NID: ${obs.nid || 'N/A'}</small>
                </td>
                <td>${obs.contact || 'N/A'}</td>
                <td>
                    <span class="badge ${statusClass} status-badge">
                        ${obs.stateDescription || 'Unknown'}
                        ${isInitial ? ' ðŸŽ¯' : ''}
                    </span>
                </td>
                <td>
                    <div class="text-truncate" style="max-width: 200px;">
                        ${obs.textMessageDescription || 'No message'}
                    </div>
                </td>
                <td>
                    ${obs.groupId ? 
                        `<div class="fw-bold">${obs.groupDescription || obs.group?.description || 'Group'}</div>
                        <small class="text-muted">${obs.groupTypeDescription || obs.group?.grouptypeDescription || ''}</small>` : 
                        '<span class="text-danger">No Group</span>'}
                </td>

                <td>
                    ${obs.locationName || 'N/A'}
                </td>

                <td>
                    ${obs.userFullName || 'N/A'}
                </td>

                <td>
                    <small class="text-muted">${(obs.status )}</small>
                </td>

                <td>
                    <small class="text-muted">${(obs.smsStatus )}</small>
                </td>

                <td>
                    <small class="text-muted">${formatDate(obs.updateAt || obs.createdAt)}</small>
                </td>

                <td>
                    <div class="btn-group btn-group-sm" role="group">
                        <button class="btn btn-outline-primary" onclick="editObs(${obs.id})" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-outline-success" onclick="viewObs(${obs.id})" title="View">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-outline-danger" onclick="deleteObs(${obs.id})" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                        ${isUnknown ? `<button class="btn btn-outline-warning" onclick="fixUnknownState(${obs.id})" title="Fix Unknown State">
                            <i class="fas fa-wrench"></i>
                        </button>` : ''}
                    </div>
                </td>
            `;
            tbody.appendChild(row);
        });
    }
    
    updatePagination(data, page);
    updateSelectedCount();
}

function getStatusClass(status) {
    if (!status || status.toLowerCase().includes('unknown')) return 'status-unknown';
    
    const statusMap = {
        'active': 'bg-success',
        'inactive': 'bg-secondary',
        'pending': 'bg-warning',
        'completed': 'bg-primary',
        'cancelled': 'bg-danger',
        'confirmed': 'bg-info'
    };
    
    const lowerStatus = status.toLowerCase();
    for (const [key, value] of Object.entries(statusMap)) {
        if (lowerStatus.includes(key)) return value;
    }
    
    return 'status-unknown';
}

function formatDate(dateString) {
    if (!dateString) return 'N/A';
    const date = new Date(dateString);
    return date.toLocaleDateString('pt-PT', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
    });
}

function updatePagination(data, page) {
    const totalPages = Math.ceil(data.length / pageSize);
    const startIndex = (page - 1) * pageSize + 1;
    const endIndex = Math.min(page * pageSize, data.length);
    
    document.getElementById('paginationInfo').textContent = 
        `Showing ${startIndex} to ${endIndex} of ${data.length} observations`;
    
    document.getElementById('prevBtn').disabled = page === 1;
    document.getElementById('nextBtn').disabled = page === totalPages;
    
    // Update results info
    const resultsInfo = document.getElementById('resultsInfo');
    if (Object.keys(currentFilters).length > 0) {
        resultsInfo.textContent = `Found ${data.length} observations matching your filters`;
    } else {
        resultsInfo.textContent = `Showing ${data.length} observations`;
    }
}

function changePage(direction) {
    const newPage = currentPage + direction;
    const totalPages = Math.ceil(filteredData.length / pageSize);
    
    if (newPage >= 1 && newPage <= totalPages) {
        currentPage = newPage;
        renderTablePage(filteredData, currentPage);
    }
}

/* ======== SELECTION FUNCTIONS ======== */
function updateSelectedCount() {
    const selected = getSelectedIds().length;
    document.getElementById('selectedCount').textContent = selected;
    
    // Update select all checkbox
    const allRows = document.querySelectorAll('.rowCheck');
    const allChecked = allRows.length > 0 && [...allRows].every(cb => cb.checked);
    document.getElementById('selectAll').checked = allChecked;
    document.getElementById('selectAllHeader').checked = allChecked;
}

function getSelectedIds() {
    return [...document.querySelectorAll('.rowCheck:checked')].map(el => Number(el.value));
}

function selectAllRows(checked) {
    document.querySelectorAll('.rowCheck').forEach(cb => {
        cb.checked = checked;
    });
    updateSelectedCount();
}

/* ======== FILTER FUNCTIONS ======== */
function applyFilters() {
    if (Object.keys(currentFilters).length === 0) {
        filteredData = observationsData;
    } else {
        filteredData = observationsData.filter(obs => {
            let pass = true;
            
            // Status filter (usando stateId da API)
            if (currentFilters.stateId) {
                pass = pass && obs.stateId == currentFilters.stateId;
            }
            
            // Filtro para estados desconhecidos
            if (currentFilters.unknownState) {
                pass = pass && (!obs.stateId || !obs.stateDescription || 
                         obs.stateDescription.toLowerCase().includes('unknown'));
            }
            
            // Group filter
            if (currentFilters.group === 'no_group') {
                pass = pass && !obs.groupId;
            }
            
            // No SMS filter
            if (currentFilters.noSMS) {
                pass = pass && (!obs.textMessageDescription || obs.textMessageDescription === 'No message');
            }
            
            // Text message filter
            if (currentFilters.textmessageId) {
                pass = pass && obs.textmessageId == currentFilters.textmessageId;
            }
            
            // Location filter
            if (currentFilters.locationId) {
                pass = pass && obs.locationId == currentFilters.locationId;
            }
            
            // Date filters
            if (currentFilters.startDate) {
                const obsDate = new Date(obs.createdAt);
                const filterDate = new Date(currentFilters.startDate);
                pass = pass && obsDate >= filterDate;
            }
            
            if (currentFilters.endDate) {
                const obsDate = new Date(obs.createdAt);
                const filterDate = new Date(currentFilters.endDate);
                filterDate.setHours(23, 59, 59, 999);
                pass = pass && obsDate <= filterDate;
            }
            
            return pass;
        });
    }
    
    currentPage = 1;
    updateActiveFiltersDisplay();
    renderTablePage(filteredData, currentPage);
    
    // Mensagem especial quando voltar para 'Inicial'
    const statusSelect = document.getElementById('filterStatus');
    if (statusSelect && statusSelect.value && 
        statusSelect.options[statusSelect.selectedIndex].text.toLowerCase() === 'inicial') {
        showAlert('info', `Showing observations with status "Inicial".`);
    } else if (filteredData.length === 0) {
        showAlert('info', 'No observations match your filters.');
    }
}

async function filterObservations() {
    // Collect filter values
    const filters = {
        stateId: document.getElementById('filterStatus').value,
        textmessageId: document.getElementById('filterTextmessage').value,
        group: document.getElementById('filterGroup').value,
        locationId: document.getElementById('filterLocation').value,
        startDate: document.getElementById('filterStartDate').value,
        endDate: document.getElementById('filterEndDate').value
    };
    
    // Limpar filtro de estados desconhecidos quando usar filtros normais
    if (currentFilters.unknownState) {
        delete currentFilters.unknownState;
    }
    
    showOverlay('Filtering Data', 'Applying filters...');
    updateProgress(30, 'Applying filters...');
    
    try {
        // Update current filters
        currentFilters = { ...currentFilters, ...filters };
        
        // Apply filters locally
        applyFilters();
        
        updateProgress(100, 'Filters applied successfully!', `${filteredData.length} records found`);
        
        await new Promise(resolve => setTimeout(resolve, 500));
        hideOverlay();
        
    } catch (error) {
        console.error('Error filtering observations:', error);
        updateProgress(100, 'Error applying filters');
        showAlert('error', 'Error applying filters: ' + error.message);
        hideOverlay();
    }
}

function clearFilters() {
    // Buscar o estado 'Inicial'
    const initialStateId = findInitialStateId();
    
    if (initialStateId) {
        // Limpar outros filtros mas manter 'Inicial'
        document.getElementById('filterTextmessage').value = '';
        document.getElementById('filterGroup').value = '';
        document.getElementById('filterLocation').value = '';
        document.getElementById('filterStartDate').value = '';
        document.getElementById('filterEndDate').value = '';
        
        // Manter apenas o filtro de 'Inicial'
        currentFilters = { stateId: initialStateId };
        document.getElementById('filterStatus').value = initialStateId;
        
        // Aplicar filtro
        filteredData = observationsData.filter(obs => obs.stateId == initialStateId);
        
        showAlert('info', 'Reset to observations with status "Inicial".');
    } else {
        // Se nÃ£o encontrou 'Inicial', limpar tudo
        document.getElementById('filterStatus').value = '';
        document.getElementById('filterTextmessage').value = '';
        document.getElementById('filterGroup').value = '';
        document.getElementById('filterLocation').value = '';
        document.getElementById('filterStartDate').value = '';
        document.getElementById('filterEndDate').value = '';
        
        currentFilters = {};
        filteredData = observationsData;
        showAlert('info', 'All filters cleared.');
    }
    
    currentPage = 1;
    updateActiveFiltersDisplay();
    renderTablePage(filteredData, currentPage);
}

function clearUnknownStateFilter() {
    delete currentFilters.unknownState;
    applyFilters();
}

function updateActiveFiltersDisplay() {
    const activeFiltersDiv = document.getElementById('activeFilters');
    const filterTagsDiv = document.getElementById('filterTags');
    
    const activeFilters = [];
    
    // Verificar se o filtro ativo Ã© 'Inicial'
    if (currentFilters.stateId) {
        const select = document.getElementById('filterStatus');
        const selectedOption = select.options[select.selectedIndex];
        
        // Adicionar badge especial para 'Inicial'
        if (selectedOption && selectedOption.text.toLowerCase() === 'inicial') {
            activeFilters.push({
                label: `ðŸŽ¯ Status: ${selectedOption.text} (Default)`,
                clearFn: "clearAllFiltersIncludingStatus()"
            });
        } else {
            activeFilters.push({
                label: `Status: ${selectedOption.text}`,
                clearFn: "clearFilter('filterStatus')"
            });
        }
    }
    
    // Adicionar filtro para estados desconhecidos
    if (currentFilters.unknownState) {
        activeFilters.push({
            label: 'Status: Unknown State',
            clearFn: "clearUnknownStateFilter()"
        });
    }
    
    if (currentFilters.textmessageId) {
        const select = document.getElementById('filterTextmessage');
        const selectedOption = select.options[select.selectedIndex];
        activeFilters.push({
            label: `SMS: ${selectedOption.text}`,
            clearFn: "clearFilter('filterTextmessage')"
        });
    }
    
    if (currentFilters.group === 'no_group') {
        activeFilters.push({
            label: 'Group: No Group',
            clearFn: "clearFilter('filterGroup')"
        });
    }
    
    if (currentFilters.locationId) {
        const select = document.getElementById('filterLocation');
        const selectedOption = select.options[select.selectedIndex];
        activeFilters.push({
            label: `Location: ${selectedOption.text}`,
            clearFn: "clearFilter('filterLocation')"
        });
    }
    
    if (currentFilters.startDate || currentFilters.endDate) {
        const start = currentFilters.startDate || 'Any';
        const end = currentFilters.endDate || 'Any';
        activeFilters.push({
            label: `Date: ${start} to ${end}`,
            clearFn: "clearDateFilters()"
        });
    }
    
    if (currentFilters.noSMS) {
        activeFilters.push({
            label: 'No SMS Message',
            clearFn: "clearNoSMSFilter()"
        });
    }
    
     if (activeFilters.length > 0) {
        activeFiltersDiv.style.display = 'block';
        filterTagsDiv.innerHTML = '';
        
        activeFilters.forEach(filter => {
            const tag = document.createElement('span');
            tag.className = 'filter-chip';
            
            // Adicionar classe especial para 'Inicial'
            if (filter.label.includes('Inicial')) {
                tag.classList.add('bg-primary', 'text-white');
            }
            
            if (filter.label.includes('Unknown')) tag.classList.add('unknown');
            if (filter.label.includes('No Group')) tag.classList.add('no-group');
            
            tag.innerHTML = `
                ${filter.label}
                <span class="remove-filter ms-2" onclick="${filter.clearFn}" style="cursor: pointer;">
                    <i class="fas fa-times"></i>
                </span>
            `;
            filterTagsDiv.appendChild(tag);
        });
    } else {
        activeFiltersDiv.style.display = 'none';
        filterTagsDiv.innerHTML = '';
    }
}

function filterInitialState() {
    const initialStateId = findInitialStateId();
    
    if (!initialStateId) {
        showAlert('warning', 'Status "Inicial" not found in the system.');
        return;
    }
    
    // Limpar outros filtros
    document.getElementById('filterTextmessage').value = '';
    document.getElementById('filterGroup').value = '';
    document.getElementById('filterLocation').value = '';
    document.getElementById('filterStartDate').value = '';
    document.getElementById('filterEndDate').value = '';
    
    // Aplicar filtro 'Inicial'
    document.getElementById('filterStatus').value = initialStateId;
    currentFilters = { stateId: initialStateId };
    
    applyFilters();
    showAlert('info', 'Showing observations with status "Inicial".');
}

function clearAllFiltersIncludingStatus() {
    document.getElementById('filterStatus').value = '';
    document.getElementById('filterTextmessage').value = '';
    document.getElementById('filterGroup').value = '';
    document.getElementById('filterLocation').value = '';
    document.getElementById('filterStartDate').value = '';
    document.getElementById('filterEndDate').value = '';
    
    currentFilters = {};
    filteredData = observationsData;
    currentPage = 1;
    
    updateActiveFiltersDisplay();
    renderTablePage(filteredData, currentPage);
    showAlert('info', 'All filters cleared. Showing all observations.');
}

function clearFilter(filterId) {
    document.getElementById(filterId).value = '';
    delete currentFilters[filterId.replace('filter', '').toLowerCase()];
    applyFilters();
}

function clearDateFilters() {
    document.getElementById('filterStartDate').value = '';
    document.getElementById('filterEndDate').value = '';
    delete currentFilters.startDate;
    delete currentFilters.endDate;
    applyFilters();
}

function clearNoSMSFilter() {
    delete currentFilters.noSMS;
    applyFilters();
}

/* ======== QUICK FILTER FUNCTIONS ======== */
function filterUnknownStates() {
    // Clear other filters first
    clearFilters();
    
    // Para estados desconhecidos, filtramos observaÃ§Ãµes sem stateId
    // ou com stateDescription que contenha "unknown"
    currentFilters.unknownState = true;
    
    // Apply filter
    applyFilters();
    
    showAlert('info', 'Filtering observations with unknown state.');
}

function filterNoGroup() {
    clearFilters();
    document.getElementById('filterGroup').value = 'no_group';
    currentFilters.group = 'no_group';
    applyFilters();
    showAlert('info', 'Filtering observations without groups.');
}

function filterNoSMS() {
    clearFilters();
    currentFilters.noSMS = true;
    applyFilters();
    showAlert('info', 'Filtering observations without SMS messages.');
}

function selectAllUnknown() {
    // First filter to show only unknown
    filterUnknownStates();
    
    // Then select all visible rows
    setTimeout(() => {
        const visibleIds = filteredData.map(o => o.id);
        
        document.querySelectorAll('.rowCheck').forEach(checkbox => {
            checkbox.checked = visibleIds.includes(Number(checkbox.value));
        });
        updateSelectedCount();
        
        showAlert('success', `Selected ${visibleIds.length} observations with unknown state.`);
    }, 500);
}

/* ======== OBSERVATION CRUD ======== */
function openObsModal(observation = null) {
    const modal = document.getElementById('obsModal');
    const form = document.getElementById('obsForm');
    const title = document.getElementById('modalTitle');
    
    form.reset();
    
    if (observation) {
        title.innerHTML = '<i class="fas fa-edit me-2"></i> Edit Observation';
        document.getElementById('obsId').value = observation.id;
        
        // Fill form fields
        Object.keys(observation).forEach(key => {
            const field = document.getElementById(key);
            if (field) field.value = observation[key];
        });
        
        // Select dropdown values
        ['stateSelect', 'textmessageSelect', 'groupSelect', 'grouptypeSelect', 'locationSelect', 'userSelect'].forEach(selectId => {
            const select = document.getElementById(selectId);
            const fieldName = selectId.replace('Select', 'Id');
            if (observation[fieldName] && select) {
                select.value = observation[fieldName];
            }
        });
    } else {
        title.innerHTML = '<i class="fas fa-plus me-2"></i> Add Observation';
        document.getElementById('obsId').value = '';
    }
    
    new bootstrap.Modal(modal).show();
}

async function editObs(id) {
    try {
        showOverlay('Loading Observation', 'Fetching observation data...');
        updateProgress(30, 'Fetching observation data...');
        
        const res = await fetch(`${apiObs}/${id}`);
        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
        
        updateProgress(70, 'Processing data...');
        const observation = await res.json();
        
        updateProgress(100, 'Ready to edit');
        await new Promise(resolve => setTimeout(resolve, 300));
        
        hideOverlay();
        openObsModal(observation);
        
    } catch (error) {
        console.error('Error fetching observation:', error);
        updateProgress(100, 'Error loading data');
        showAlert('error', 'Error loading observation data');
        hideOverlay();
    }
}

function viewObs(id) {
    // Implementation for view mode
    showAlert('info', 'View functionality will be implemented soon.');
}

async function deleteObs(id) {
    if (!confirm('Are you sure you want to delete this observation? This action cannot be undone.')) return;
    
    showOverlay('Deleting', 'Deleting observation...');
    updateProgress(30, 'Deleting observation...');
    
    try {
        const res = await fetch(`${apiObs}/${id}`, { method: 'DELETE' });
        
        if (res.ok) {
            updateProgress(100, 'Observation deleted');
            await new Promise(resolve => setTimeout(resolve, 300));
            
            hideOverlay();
            showAlert('success', 'Observation deleted successfully.');
            loadObservationsWithProgress();
        } else {
            throw new Error('Failed to delete observation');
        }
    } catch (error) {
        console.error('Error deleting observation:', error);
        updateProgress(100, 'Error deleting');
        showAlert('error', 'Error deleting observation: ' + error.message);
        hideOverlay();
    }
}

async function deleteSelected() {
    const ids = getSelectedIds();
    if (ids.length === 0) {
        showAlert('warning', 'Please select observations to delete.');
        return;
    }
    
    if (!confirm(`Are you sure you want to delete ${ids.length} observation(s)? This action cannot be undone.`)) return;
    
    showOverlay('Deleting', `Deleting ${ids.length} observations...`);
    updateProgress(10, `Starting deletion of ${ids.length} observations...`);
    
    try {
        let successCount = 0;
        let failCount = 0;
        const errors = [];
        
        for (let i = 0; i < ids.length; i++) {
            if (loadingCancelled) break;
            
            const id = ids[i];
            const percent = 10 + Math.floor((i / ids.length) * 80);
            updateProgress(
                percent,
                `Deleting observation ${i + 1} of ${ids.length}`,
                `${successCount} deleted, ${failCount} failed`
            );
            
            try {
                const res = await fetch(`${apiObs}/${id}`, { method: 'DELETE' });
                if (res.ok) {
                    successCount++;
                } else {
                    failCount++;
                    errors.push(`Failed to delete observation #${id}`);
                }
            } catch (error) {
                failCount++;
                errors.push(`Error deleting observation #${id}: ${error.message}`);
            }
            
            // Small delay to prevent overwhelming the server
            await new Promise(resolve => setTimeout(resolve, 50));
        }
        
        updateProgress(100, 'Deletion completed');
        
        // Show results
        showOperationResults({
            total: ids.length,
            success: successCount,
            failed: failCount,
            errors: errors
        });
        
        await new Promise(resolve => setTimeout(resolve, 500));
        hideOverlay();
        
        // Reload data
        if (successCount > 0) {
            loadObservationsWithProgress();
        }
        
    } catch (error) {
        console.error('Error deleting selected observations:', error);
        updateProgress(100, 'Error during deletion');
        showAlert('error', 'Error deleting observations: ' + error.message);
        hideOverlay();
    }
}

/* ======== FORM SUBMISSION ======== */
document.getElementById('obsForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Saving...';
    submitBtn.disabled = true;
    
    const id = document.getElementById('obsId').value;
    const isEdit = !!id;
    
    showOverlay('Saving', isEdit ? 'Updating observation...' : 'Creating observation...');
    updateProgress(30, isEdit ? 'Updating observation...' : 'Creating observation...');
    
    try {
        // Collect form data
        const formData = {};
        document.querySelectorAll('#obsForm input, #obsForm select, #obsForm textarea').forEach(el => {
            if (el.id && el.id !== 'obsId' && el.value !== '') {
                // Convert numeric fields
                const numericFields = ['age', 'valorprimeiracv', 'valorultimacv'];
                const value = numericFields.includes(el.id) ? Number(el.value) : el.value;
                
                // Handle dropdown IDs
                const idField = el.id.replace('Select', 'Id');
                formData[idField] = value;
            }
        });
        
        updateProgress(60, 'Sending to server...');
        
        const url = isEdit ? `${apiObs}/${id}` : apiObs;
        const method = isEdit ? 'PUT' : 'POST';
        
        const res = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
        });
        
        if (!res.ok) {
            const error = await res.text();
            throw new Error(error);
        }
        
        updateProgress(100, 'Saved successfully!');
        await new Promise(resolve => setTimeout(resolve, 300));
        
        const modal = bootstrap.Modal.getInstance(document.getElementById('obsModal'));
        modal.hide();
        
        hideOverlay();
        showAlert('success', isEdit ? 'Observation updated successfully!' : 'Observation created successfully!');
        
        loadObservationsWithProgress();
        
    } catch (error) {
        console.error('Error saving observation:', error);
        updateProgress(100, 'Error saving');
        showAlert('error', 'Error saving observation: ' + error.message);
    } finally {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
        hideOverlay();
    }
});

/* ======== GROUP FUNCTIONS ======== */
async function openInsertToGroupModal() {
    const ids = getSelectedIds();
    if (ids.length === 0) {
        showAlert('warning', 'Please select patients to add to group.');
        return;
    }
    
    showOverlay('Preparing Group', 'Loading group data...');
    updateProgress(30, 'Loading group data...');
    
    try {
        // Load selected patients
        const selectedPatients = observationsData.filter(o => ids.includes(o.id));
        const tbody = document.getElementById('selectedPatientsBody');
        tbody.innerHTML = '';
        
        // Display selected patients with current status
        selectedPatients.forEach((patient, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${index + 1}</td>
                <td>
                    <div class="fw-bold">${patient.fullname}</div>
                    <small class="text-muted">${patient.contact || 'No contact'}</small>
                </td>
                <td>${patient.nid || 'N/A'}</td>
                <td>
                    <span class="badge ${getStatusClass(patient.stateDescription)}">
                        ${patient.stateDescription || 'Unknown'}
                    </span>
                </td>
                <td>
                    <small>${patient.textMessageDescription || 'No SMS'}</small>
                </td>
                <td>
                    <span class="badge bg-secondary">Pending...</span>
                </td>
            `;
            tbody.appendChild(row);
        });
        
        document.getElementById('selectedPatientsCount').textContent = selectedPatients.length;
        
        updateProgress(60, 'Loading dropdowns...');
        
        // Load dropdowns for the modal
        await Promise.all([
            loadDropdown(apiState, 'selectStatusInsert', 'description', '<option value="">-- Select Status --</option>'),
            loadDropdown(apiTextMessage, 'selectTextMessage', 'messagetext', '<option value="">-- Select SMS Message --</option>'),
            loadDropdown(apiGroup, 'selectGroupInsert', 'description', '<option value="">-- Create New Group --</option>'),
            loadDropdown(apiGrouptype, 'selectGroupTypeInsert', 'description', '<option value="">-- Select Group Type --</option>')
        ]);
        
        // Set default dates
        const today = new Date().toISOString().split('T')[0];
        const nextMonth = new Date();
        nextMonth.setMonth(nextMonth.getMonth() + 1);
        const nextMonthStr = nextMonth.toISOString().split('T')[0];
        
        document.getElementById('dateStart').value = today;
        document.getElementById('dateEnd').value = nextMonthStr;
        
        updateProgress(100, 'Ready');
        await new Promise(resolve => setTimeout(resolve, 300));
        
        hideOverlay();
        
        // Reset form (except dates)
        document.getElementById('txtGroupName').value = '';
        document.getElementById('txtObservation').value = '';
        document.getElementById('selectGroupInsert').value = '';
        document.getElementById('selectGroupTypeInsert').value = '';
        document.getElementById('updateStatusCheckbox').checked = true;
        
        new bootstrap.Modal(document.getElementById('insertGroupModal')).show();
        
    } catch (error) {
        console.error('Error opening group modal:', error);
        updateProgress(100, 'Error loading');
        showAlert('error', 'Error preparing group data');
        hideOverlay();
    }
}

async function confirmAddMembers() {
    const selectedPatientIds = getSelectedIds();
    if (selectedPatientIds.length === 0) {
        showAlert('warning', 'No patients selected.');
        return;
    }
    
    // Validate inputs
    const groupName = document.getElementById('txtGroupName').value.trim();
    const existingGroupId = document.getElementById('selectGroupInsert').value;
    const statusId = document.getElementById('selectStatusInsert').value;
    const textMessageId = document.getElementById('selectTextMessage').value;
    const updateStatus = document.getElementById('updateStatusCheckbox').checked;
    
    if (!existingGroupId && !groupName) {
        showAlert('warning', 'Please enter a group name or select an existing group.');
        return;
    }
    
    if (!textMessageId) {
        showAlert('warning', 'Please select an SMS message.');
        return;
    }
    
    if (updateStatus && !statusId) {
        showAlert('warning', 'Please select a status or uncheck "Update patient status".');
        return;
    }
    
    showOverlay('Adding to Group', 'Adding patients to group...');
    updateProgress(20, 'Starting group operation...');
    
    let groupId = existingGroupId;
    
    // Create new group if needed
    if (!existingGroupId && groupName) {
        try {
            updateProgress(40, 'Creating new group...');
            
            const groupData = {
                description: groupName,
                grouptypeId: document.getElementById('selectGroupTypeInsert').value || null,
                dateStart: document.getElementById('dateStart').value || null,
                dateEnd: document.getElementById('dateEnd').value || null,
                observation: document.getElementById('txtObservation').value || null
            };
            
            const res = await fetch(apiGroup, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(groupData)
            });
            
            if (!res.ok) {
                const error = await res.text();
                throw new Error(error);
            }
            
            const newGroup = await res.json();
            groupId = newGroup.id;
            
            updateProgress(60, 'Group created successfully');
            
        } catch (error) {
            console.error('Error creating group:', error);
            updateProgress(100, 'Error creating group');
            showAlert('error', 'Error creating group: ' + error.message);
            hideOverlay();
            return;
        }
    }
    
    // Add patients to group and update status if needed
    try {
        let successCount = 0;
        let failCount = 0;
        const errors = [];
        
        updateProgress(70, 'Processing patients...');
        
        for (let i = 0; i < selectedPatientIds.length; i++) {
            if (loadingCancelled) break;
            
            const obsId = selectedPatientIds[i];
            const percent = 70 + Math.floor((i / selectedPatientIds.length) * 25);
            updateProgress(
                percent,
                `Processing patient ${i + 1} of ${selectedPatientIds.length}`,
                `${successCount} processed, ${failCount} failed`
            );
            
            try {
                // Prepare update data
                const updateData = {
                    groupId: groupId,
                    textmessageId: textMessageId
                };
                
                // Add status update if checkbox is checked
                if (updateStatus && statusId) {
                    updateData.stateId = Number(statusId);
                }
                
                // Update observation
                const res = await fetch(`/api/observation/updategroup/${obsId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updateData)
                });
                
                if (!res.ok) {
                    const error = await res.text();
                    throw new Error(error);
                }
                
                successCount++;
                
                // Update the table row to show success
                const rows = document.querySelectorAll('#selectedPatientsBody tr');
                if (rows[i]) {
                    const statusCell = rows[i].querySelector('td:nth-child(6)');
                    if (statusCell) {
                        const statusSelect = document.getElementById('selectStatusInsert');
                        const selectedOption = statusSelect.options[statusSelect.selectedIndex];
                        statusCell.innerHTML = `
                            <span class="badge bg-success">
                                ${selectedOption ? selectedOption.text : 'Updated'}
                            </span>
                            <br>
                            <small class="text-success">
                                <i class="fas fa-check-circle"></i> Success
                            </small>
                        `;
                    }
                }
                
            } catch (error) {
                failCount++;
                errors.push(`Error processing patient #${obsId}: ${error.message}`);
                
                // Update the table row to show error
                const rows = document.querySelectorAll('#selectedPatientsBody tr');
                if (rows[i]) {
                    const statusCell = rows[i].querySelector('td:nth-child(6)');
                    if (statusCell) {
                        statusCell.innerHTML = `
                            <span class="badge bg-danger">
                                <i class="fas fa-exclamation-triangle"></i> Error
                            </span>
                        `;
                    }
                }
            }
            
            // Small delay to prevent overwhelming the server
            await new Promise(resolve => setTimeout(resolve, 50));
        }
        
        updateProgress(100, 'Operation completed');
        
        // Show results
        showOperationResults({
            total: selectedPatientIds.length,
            success: successCount,
            failed: failCount,
            errors: errors
        });
        
        await new Promise(resolve => setTimeout(resolve, 500));
        
        const modal = bootstrap.Modal.getInstance(document.getElementById('insertGroupModal'));
        modal.hide();
        
        hideOverlay();
        
        if (successCount > 0) {
            showAlert('success', `${successCount} patients successfully added to group.`);
            loadObservationsWithProgress();
        }
        
    } catch (error) {
        console.error('Error adding patients to group:', error);
        updateProgress(100, 'Error processing patients');
        showAlert('error', 'Error adding patients to group: ' + error.message);
        hideOverlay();
    }
}

/* ======== CONFIRM ACTION ======== */
async function confirmAction() {
    const selectedIds = getSelectedIds();
    if (selectedIds.length === 0) {
        showAlert('warning', 'Please select patients to update.');
        return;
    }
    
    // For confirm action, we need stateId from a dropdown
    const stateId = document.getElementById('filterStatus').value;
    if (!stateId) {
        showAlert('warning', 'Please select a status from the filter dropdown first.');
        return;
    }
    
    const textId = document.getElementById('filterTextmessage').value;
    if (!textId) {
        showAlert('warning', 'Please select an SMS message from the filter dropdown first.');
        return;
    }
    
    if (!confirm(`Confirm action for ${selectedIds.length} selected patient(s)?`)) return;
    
    showOverlay('Updating States', 'Updating patient states...');
    updateProgress(10, 'Starting state update...');
    
    try {
        let successCount = 0;
        let failCount = 0;
        const errors = [];
        
        for (let i = 0; i < selectedIds.length; i++) {
            if (loadingCancelled) break;
            
            const id = selectedIds[i];
            const percent = 10 + Math.floor((i / selectedIds.length) * 80);
            updateProgress(
                percent,
                `Updating patient ${i + 1} of ${selectedIds.length}`,
                `${successCount} updated, ${failCount} failed`
            );
            
            try {
                await fetch(`/api/observation/confirm/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        stateId: Number(stateId),
                        textmessageId: Number(textId)
                    })
                });
                successCount++;
            } catch (error) {
                failCount++;
                errors.push(`Error updating patient #${id}: ${error.message}`);
            }
            
            // Small delay to prevent overwhelming the server
            await new Promise(resolve => setTimeout(resolve, 50));
        }
        
        updateProgress(100, 'Update completed');
        
        // Show results
        showOperationResults({
            total: selectedIds.length,
            success: successCount,
            failed: failCount,
            errors: errors
        });
        
        await new Promise(resolve => setTimeout(resolve, 500));
        hideOverlay();
        
        if (successCount > 0) {
            loadObservationsWithProgress();
        }
        
    } catch (error) {
        console.error('Error confirming action:', error);
        updateProgress(100, 'Error updating');
        showAlert('error', 'Error updating patients: ' + error.message);
        hideOverlay();
    }
}

/* ======== EXPORT FUNCTION ======== */
async function exportSelected() {
    const selectedIds = getSelectedIds();
    const data = observationsData.filter(o => selectedIds.includes(o.id));
    
    if (data.length === 0) {
        showAlert('warning', 'No observations selected to export.');
        return;
    }
    
    showOverlay('Exporting', 'Preparing export data...');
    updateProgress(30, 'Preparing export data...');
    
    try {
        // Convert to CSV
        const headers = ['ID', 'Full Name', 'NID', 'Gender', 'Age', 'Contact', 'Status', 'SMS Message', 'Group', 'Location'];
        const csv = [
            headers.join(','),
            ...data.map(o => [
                o.id,
                `"${o.fullname || ''}"`,
                o.nid || '',
                o.gender || '',
                o.age || '',
                o.contact || '',
                o.dataprimeiracv || '',
                o.valorprimeiracv || '',
                o.dataultimacv || '',
                o.valorultimacv || '',
                o.stateDescription || '',
                `"${o.textMessageDescription || ''}"`,
                o.grouptypeDescription || '',
                o.locationName || ''
            ].join(','))
        ].join('\n');
        
        updateProgress(70, 'Creating download...');
        
        // Create download link
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `observations_${new Date().toISOString().slice(0,10)}.csv`;
        
        updateProgress(100, 'Export ready');
        await new Promise(resolve => setTimeout(resolve, 300));
        
        hideOverlay();
        link.click();
        
        showAlert('success', `${data.length} observation(s) exported successfully.`);
        
    } catch (error) {
        console.error('Error exporting data:', error);
        updateProgress(100, 'Export failed');
        showAlert('error', 'Error exporting data: ' + error.message);
        hideOverlay();
    }
}

/* ======== BATCH ACTIONS ======== */
async function assignDefaultState() {
    const selectedIds = getSelectedIds();
    if (selectedIds.length === 0) {
        showAlert('warning', 'Please select patients to update.');
        return;
    }
    
    // Get the first active state from the dropdown
    const stateSelect = document.getElementById('filterStatus');
    const defaultStateId = stateSelect.options[1] ? stateSelect.options[1].value : null;
    
    if (!defaultStateId) {
        showAlert('warning', 'No default state found. Please load states first.');
        return;
    }
    
    const defaultStateName = stateSelect.options[1].text;
    
    showOverlay('Assigning State', `Setting ${selectedIds.length} patients to ${defaultStateName}...`);
    updateProgress(10, 'Starting state assignment...');
    
    try {
        let successCount = 0;
        let failCount = 0;
        const errors = [];
        
        for (let i = 0; i < selectedIds.length; i++) {
            if (loadingCancelled) break;
            
            const id = selectedIds[i];
            const percent = 10 + Math.floor((i / selectedIds.length) * 80);
            updateProgress(
                percent,
                `Updating patient ${i + 1} of ${selectedIds.length}`,
                `${successCount} updated, ${failCount} failed`
            );
            
            try {
                await fetch(`/api/observation/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        stateId: Number(defaultStateId)
                    })
                });
                successCount++;
            } catch (error) {
                failCount++;
                errors.push(`Error updating patient #${id}: ${error.message}`);
            }
            
            await new Promise(resolve => setTimeout(resolve, 50));
        }
        
        updateProgress(100, 'Assignment completed');
        
        showOperationResults({
            total: selectedIds.length,
            success: successCount,
            failed: failCount,
            errors: errors
        });
        
        await new Promise(resolve => setTimeout(resolve, 500));
        hideOverlay();
        
        if (successCount > 0) {
            loadObservationsWithProgress();
        }
        
    } catch (error) {
        console.error('Error assigning default state:', error);
        updateProgress(100, 'Error updating');
        showAlert('error', 'Error assigning state: ' + error.message);
        hideOverlay();
    }
}

async function markAsReviewed() {
    const selectedIds = getSelectedIds();
    if (selectedIds.length === 0) {
        showAlert('warning', 'Please select patients to mark as reviewed.');
        return;
    }
    
    showOverlay('Marking as Reviewed', `Marking ${selectedIds.length} patients...`);
    updateProgress(10, 'Starting review process...');
    
    try {
        let successCount = 0;
        let failCount = 0;
        const errors = [];
        
        for (let i = 0; i < selectedIds.length; i++) {
            if (loadingCancelled) break;
            
            const id = selectedIds[i];
            const percent = 10 + Math.floor((i / selectedIds.length) * 80);
            updateProgress(
                percent,
                `Marking patient ${i + 1} of ${selectedIds.length}`,
                `${successCount} marked, ${failCount} failed`
            );
            
            try {
                await fetch(`/api/observation/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        reviewed: true,
                        reviewedAt: new Date().toISOString()
                    })
                });
                successCount++;
            } catch (error) {
                failCount++;
                errors.push(`Error marking patient #${id}: ${error.message}`);
            }
            
            await new Promise(resolve => setTimeout(resolve, 50));
        }
        
        updateProgress(100, 'Review completed');
        
        showAlert('success', `${successCount} patients marked as reviewed.`);
        await new Promise(resolve => setTimeout(resolve, 500));
        hideOverlay();
        
        if (successCount > 0) {
            loadObservationsWithProgress();
        }
        
    } catch (error) {
        console.error('Error marking as reviewed:', error);
        updateProgress(100, 'Error updating');
        showAlert('error', 'Error marking as reviewed: ' + error.message);
        hideOverlay();
    }
}

async function updateStatusBulk(status) {
    const selectedIds = getSelectedIds();
    if (selectedIds.length === 0) {
        showAlert('warning', 'Please select patients to update.');
        return;
    }
    
    // Find state ID that matches the status
    const stateSelect = document.getElementById('filterStatus');
    let stateId = null;
    for (let option of stateSelect.options) {
        if (option.text.toLowerCase().includes(status.toLowerCase())) {
            stateId = option.value;
            break;
        }
    }
    
    if (!stateId) {
        showAlert('warning', `No state found for status: ${status}`);
        return;
    }
    
    const stateName = stateSelect.options[stateSelect.selectedIndex].text;
    
    showOverlay('Updating Status', `Setting ${selectedIds.length} patients to ${stateName}...`);
    updateProgress(10, 'Starting status update...');
    
    try {
        let successCount = 0;
        let failCount = 0;
        const errors = [];
        
        for (let i = 0; i < selectedIds.length; i++) {
            if (loadingCancelled) break;
            
            const id = selectedIds[i];
            const percent = 10 + Math.floor((i / selectedIds.length) * 80);
            updateProgress(
                percent,
                `Updating patient ${i + 1} of ${selectedIds.length}`,
                `${successCount} updated, ${failCount} failed`
            );
            
            try {
                await fetch(`/api/observation/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        stateId: Number(stateId)
                    })
                });
                successCount++;
            } catch (error) {
                failCount++;
                errors.push(`Error updating patient #${id}: ${error.message}`);
            }
            
            await new Promise(resolve => setTimeout(resolve, 50));
        }
        
        updateProgress(100, 'Update completed');
        
        showAlert('success', `${successCount} patients updated to ${stateName}.`);
        await new Promise(resolve => setTimeout(resolve, 500));
        hideOverlay();
        
        if (successCount > 0) {
            loadObservationsWithProgress();
        }
        
    } catch (error) {
        console.error('Error updating status:', error);
        updateProgress(100, 'Error updating');
        showAlert('error', 'Error updating status: ' + error.message);
        hideOverlay();
    }
}

/* ======== SINGLE OBSERVATION ACTIONS ======== */
async function fixUnknownState(id) {
    try {
        const res = await fetch(`${apiObs}/${id}`);
        if (!res.ok) throw new Error('Failed to fetch observation');
        
        const observation = await res.json();
        
        // Open modal with this observation
        openObsModal(observation);
        
        // Show guidance message
        showAlert('info', 'Please update the status field for this observation and save changes.');
        
    } catch (error) {
        console.error('Error fetching observation:', error);
        showAlert('error', 'Error loading observation: ' + error.message);
    }
}

/* ======== SHOW OPERATION RESULTS ======== */
function showOperationResults(results) {
    // Update result counts
    document.getElementById('resultsTotal').textContent = results.total;
    document.getElementById('resultsSuccess').textContent = results.success;
    document.getElementById('resultsSkipped').textContent = 0;
    document.getElementById('resultsFailed').textContent = results.failed;
    
    // Show errors if any
    const errorsSection = document.getElementById('errorsSection');
    const errorList = document.getElementById('errorList');
    
    if (results.errors && results.errors.length > 0) {
        errorsSection.style.display = 'block';
        errorList.innerHTML = '';
        results.errors.forEach(error => {
            const li = document.createElement('li');
            li.textContent = error;
            errorList.appendChild(li);
        });
    } else {
        errorsSection.style.display = 'none';
    }
    
    // Hide warnings section
    document.getElementById('warningsSection').style.display = 'none';
    
    // Show results modal
    const resultsModal = new bootstrap.Modal(document.getElementById('resultsModal'));
    resultsModal.show();
}

/* ======== INITIALIZATION ======== */
window.onload = async function() {
    // Initialize select all checkboxes
    document.getElementById('selectAll').addEventListener('change', function() {
        selectAllRows(this.checked);
    });
    
    document.getElementById('selectAllHeader').addEventListener('change', function() {
        selectAllRows(this.checked);
    });
    
    // Update selected count when checkboxes change
    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('rowCheck')) {
            updateSelectedCount();
        }
    });
    
    // Load dropdowns
    showOverlay('Initializing', 'Loading application data...');
    updateProgress(20, 'Loading dropdowns...');
    
    try {
        await Promise.all([
            // Carregar o filtro de status da API
            loadDropdown(apiState, 'filterStatus', 'description', '<option value="">All Status</option>'),
            loadDropdown(apiTextMessage, 'filterTextmessage', 'messagetext', '<option value="">All Messages</option>'),
            loadDropdown(apiGroup, 'filterGroup', 'description', '<option value="">All Groups</option><option value="no_group">No Group</option>'),
            loadDropdown(apiLocation, 'filterLocation', 'name', '<option value="">All Locations</option>'),
            loadDropdown(apiState, 'stateSelect'),
            loadDropdown(apiTextMessage, 'textmessageSelect', 'messagetext'),
            loadDropdown(apiGrouptype, 'grouptypeSelect'),
            loadDropdown(apiGroup, 'groupSelect', 'description'),
            loadDropdown(apiLocation, 'locationSelect', 'name'),
            loadDropdown(apiUser, 'userSelect', 'fullname')
        ]);
        
        updateProgress(80, 'Loading observations...');
        
        // Load observations
        await loadObservationsWithProgress();
        
        updateProgress(100, 'Application ready');
        await new Promise(resolve => setTimeout(resolve, 300));
        hideOverlay();
        
    } catch (error) {
        console.error('Error during initialization:', error);
        updateProgress(100, 'Initialization failed');
        showAlert('error', 'Error initializing application: ' + error.message);
        hideOverlay();
    }
    
    // Add event listeners for filters
    document.getElementById('filterStartDate').addEventListener('change', filterObservations);
    document.getElementById('filterEndDate').addEventListener('change', filterObservations);
    document.getElementById('filterTextmessage').addEventListener('change', filterObservations);
    document.getElementById('filterGroup').addEventListener('change', filterObservations);
    document.getElementById('filterLocation').addEventListener('change', filterObservations);
    document.getElementById('filterStatus').addEventListener('change', filterObservations);
};
</script>

<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

{% endblock %}