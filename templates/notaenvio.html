{% extends 'base.html' %}
{% block title %}PI-SA√öDE / Notas de Envio{% endblock %}
{% block content %}

<h2>Gest√£o de Notas de Envio</h2>

<!-- Campo de pesquisa -->
<div class="mb-3 position-relative" style="max-width: 400px;">
  <input type="text" id="notaSearch" class="form-control" placeholder="Pesquisar nota...">
</div>

<!-- Bot√£o flutuante -->
<button class="btn btn-success rounded-circle position-fixed"
        style="bottom: 20px; right: 20px; width: 60px; height: 60px; font-size: 28px; z-index: 1050;"
        onclick="abrirModalNotaEnvio()">
  +
</button>

<!-- Tabela de Notas -->
<table class="table table-striped table-bordered table-sm align-middle">
  <thead class="table-dark">
    <tr>
      <th>#</th>
      <th>N√∫mero Nota</th>
      <th>Tipo Item</th>
      <th>Data Envio</th>
      <th>Origem</th>
      <th>Destino</th>
      <th>Observa√ß√µes</th>
      <th>Documentos</th>
      <th>User</th>
      <th>A√ß√µes</th>
    </tr>
  </thead>
  <tbody id="notaTableBody"></tbody>
</table>


<!-- Modal Nota de Envio -->
<div class="modal fade" id="notaEnvioModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <form id="notaEnvioForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Adicionar / Editar Nota de Envio</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <input type="hidden" id="notaId">

        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label">N√∫mero da Nota</label>
            <input type="text" id="notaNumero" class="form-control" required>
          </div>

          <div class="col-md-6 mb-3">
            <label class="form-label">Data de Envio</label>
            <input type="datetime-local" id="notaDataEnvio" class="form-control" required>
          </div>
        </div>

        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label">Tipo de Item</label>
            <select id="notaTipoItem" class="form-select" required></select>
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label">Origem</label>
            <input type="text" id="notaOrigem" class="form-control" required>
          </div>
        </div>

        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label">Destino</label>
            <input type="text" id="notaDestino" class="form-control" required>
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label">Observa√ß√µes</label>
          <textarea id="notaObservacoes" class="form-control" rows="3"></textarea>
        </div>

        <!-- Upload de documentos individual -->
        <div class="mb-3">
          <label class="form-label">Adicionar Documento</label>
          <div class="d-flex gap-2 mb-2">
            <input type="file" id="fileInput" class="form-control" style="max-width: 400px;">
            <button type="button" class="btn btn-outline-primary" onclick="adicionarDocumento()">Adicionar</button>
          </div>
          <ul id="listaDocs" class="list-group"></ul>
        </div>

        <!-- Lista de documentos j√° existentes -->
        <div id="docsExistentesContainer" class="border-top pt-2" style="display: none;">
          <h6>üìé Documentos Existentes</h6>
          <ul id="docsExistentes" class="list-unstyled small"></ul>
        </div>
      </div>

      <div class="modal-footer">
        <button type="submit" class="btn btn-primary">Salvar</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
      </div>
    </form>
  </div>
</div>

<script>
let allNotas = [];
let allTiposItem = [];
let documentosPendentes = [];

// ‚úÖ URLs CORRETAS - SEM /api
const notaUrl = '/api/notaenvio';
const tipoItemUrl = '/api/tipo_item';
const docUrl = '/api/notaenviodocument';

window.onload = () => {
  loadTiposItem();
  loadNotas();
  document.getElementById('notaSearch').addEventListener('input', e => filtrarNotas(e.target.value));
};

// ==========================
// üîπ Carregar Notas
// ==========================
async function loadNotas() {
  try {
    const res = await fetch(notaUrl);
    if (!res.ok) throw new Error('Erro ao carregar notas');
    
    allNotas = await res.json();
    console.log('üì¶ Notas carregadas:', allNotas);
    filtrarNotas(document.getElementById('notaSearch').value);
  } catch (error) {
    console.error('‚ùå Erro ao carregar notas:', error);
    alert('Erro ao carregar notas: ' + error.message);
  }
}

// ==========================
// üîπ Filtrar Notas - VERS√ÉO CORRIGIDA
// ==========================
function filtrarNotas(query) {
  const tbody = document.getElementById('notaTableBody');
  tbody.innerHTML = '';
  const termo = query?.toLowerCase() || '';

  const notasFiltradas = allNotas.filter(n =>
    (n.numero_nota || '').toLowerCase().includes(termo) ||
    (n.origem || '').toLowerCase().includes(termo) ||
    (n.destino || '').toLowerCase().includes(termo) ||
    (n.tipo_item_nome || '').toLowerCase().includes(termo) ||
    (n.user || '').toLowerCase().includes(termo) || // ‚úÖ Adiciona busca por user
    (n.observacoes || '').toLowerCase().includes(termo) // ‚úÖ Adiciona busca por observa√ß√µes
  );

  if (notasFiltradas.length === 0) {
    // ‚úÖ CORRE√á√ÉO: colspan=10 (agora temos 10 colunas)
    tbody.innerHTML = `<tr><td colspan="10" class="text-center text-muted">Nenhuma nota encontrada</td></tr>`;
    return;
  }

  notasFiltradas.forEach(n => {
    const dataEnvio = n.data_envio ? formatarData(n.data_envio) : '-';
    const tipoItem = n.tipo_item_nome || n.tipo_item?.nome || '(sem tipo)';
    
    // ‚úÖ SIMPLES: Apenas links para os documentos
    const docsHtml = n.documentos && n.documentos.length > 0
      ? n.documentos.map(d => 
          `<div class="mb-1">
            <a href="${docUrl}/${d.id}/download" 
               target="_blank" 
               class="text-decoration-none"
               title="Abrir documento">
               üìé ${d.nome_arquivo}
            </a>
            <small class="text-muted">(${formatarTamanhoArquivo(d.tamanho_bytes)})</small>
          </div>`
        ).join('')
      : '<span class="text-muted">Nenhum documento</span>';

    tbody.innerHTML += `
      <tr>
        <td>${n.id}</td>
        <td><strong>${n.numero_nota}</strong></td>
        <td>${tipoItem}</td>
        <td>${dataEnvio}</td>
        <td>${n.origem}</td>
        <td>${n.destino}</td>
        <td>${n.observacoes || '<span class="text-muted">-</span>'}</td>
        <td>${docsHtml}</td>
        <td>${n.user || '<span class="text-muted">-</span>'}</td>
        <td>
          <button class="btn btn-sm btn-warning me-1" onclick="editarNota(${n.id})" title="Editar">
            <i class="bi bi-pencil"></i>
          </button>
          <button class="btn btn-sm btn-danger" onclick="eliminarNota(${n.id})" title="Excluir">
            <i class="bi bi-trash"></i>
          </button>
        </td>
      </tr>`;
  });
}

// ==========================
// üîπ Fun√ß√µes Auxiliares
// ==========================
function formatarData(dataString) {
  try {
    const data = new Date(dataString);
    return data.toLocaleDateString('pt-BR') + ' ' + data.toLocaleTimeString('pt-BR', {
      hour: '2-digit',
      minute: '2-digit'
    });
  } catch (e) {
    return '-';
  }
}

function formatarTamanhoArquivo(bytes) {
  if (!bytes) return '0 B';
  const sizes = ['B', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(1024));
  return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
}

// ==========================
// üîπ Carregar Tipos de Item
// ==========================
async function loadTiposItem() {
  try {
    const res = await fetch(tipoItemUrl);
    allTiposItem = await res.json();
    const select = document.getElementById('notaTipoItem');
    select.innerHTML = '<option value="">Selecione o tipo</option>';
    allTiposItem.forEach(t => select.innerHTML += `<option value="${t.id}">${t.nome}</option>`);
  } catch (error) {
    console.error('‚ùå Erro ao carregar tipos de item:', error);
  }
}

// ==========================
// üîπ Abrir Modal Nota
// ==========================
function abrirModalNotaEnvio() {
  document.getElementById('notaEnvioForm').reset();
  document.getElementById('notaId').value = '';
  documentosPendentes = [];
  atualizarListaDocumentos();
  document.getElementById('docsExistentesContainer').style.display = 'none';
  document.getElementById('docsExistentes').innerHTML = '';
  
  const agora = new Date();
  document.getElementById('notaDataEnvio').value = agora.toISOString().slice(0, 16);
  
  new bootstrap.Modal(document.getElementById('notaEnvioModal')).show();
}

// ==========================
// üîπ Salvar Nota
// ==========================
document.getElementById('notaEnvioForm').addEventListener('submit', async (e) => {
  e.preventDefault();

  try {
    const formData = new FormData();
    const id = document.getElementById('notaId').value;
    
    formData.append('numero_nota', document.getElementById('notaNumero').value);
    formData.append('tipo_item_id', document.getElementById('notaTipoItem').value);
    formData.append('data_envio', document.getElementById('notaDataEnvio').value + ':00');
    formData.append('origem', document.getElementById('notaOrigem').value);
    formData.append('destino', document.getElementById('notaDestino').value);
    formData.append('observacoes', document.getElementById('notaObservacoes').value || '');
    formData.append('user', "{{ username }}");

    documentosPendentes.forEach((doc) => {
      formData.append('file', doc.file);
    });

    const method = id ? 'PUT' : 'POST';
    const url = id ? `${notaUrl}/${id}` : notaUrl;

    const res = await fetch(url, {
      method,
      body: formData
    });

    if (res.ok) {
      alert('‚úÖ Nota de envio salva com sucesso!');
      bootstrap.Modal.getInstance(document.getElementById('notaEnvioModal')).hide();
      await loadNotas();
    } else {
      const err = await res.json();
      alert('‚ùå Erro: ' + (err.error || err.message || 'Erro desconhecido'));
    }
  } catch (error) {
    console.error('‚ùå Erro ao salvar nota:', error);
    alert('‚ùå Erro ao salvar nota: ' + error.message);
  }
});

// ==========================
// üîπ Editar Nota
// ==========================
async function editarNota(id) {
  try {
    const res = await fetch(`${notaUrl}/${id}`);
    if (!res.ok) throw new Error('Nota n√£o encontrada');
    
    const nota = await res.json();

    document.getElementById('notaId').value = nota.id;
    document.getElementById('notaTipoItem').value = nota.tipo_item_id;
    document.getElementById('notaNumero').value = nota.numero_nota;
    
    if (nota.data_envio) {
      const data = new Date(nota.data_envio);
      document.getElementById('notaDataEnvio').value = data.toISOString().slice(0, 16);
    }
    
    document.getElementById('notaOrigem').value = nota.origem;
    document.getElementById('notaDestino').value = nota.destino;
    document.getElementById('notaObservacoes').value = nota.observacoes || '';

    await carregarDocumentosExistentes(id);
    documentosPendentes = [];
    atualizarListaDocumentos();

    new bootstrap.Modal(document.getElementById('notaEnvioModal')).show();
  } catch (error) {
    console.error('‚ùå Erro ao editar nota:', error);
    alert('Erro ao carregar nota para edi√ß√£o: ' + error.message);
  }
}

// ==========================
// üîπ Documentos Pendentes
// ==========================
function adicionarDocumento() {
  const fileInput = document.getElementById('fileInput');
  const file = fileInput.files[0];
  if (!file) return;

  documentosPendentes.push({ file });
  atualizarListaDocumentos();
  fileInput.value = '';
}

function atualizarListaDocumentos() {
  const ul = document.getElementById('listaDocs');
  ul.innerHTML = '';
  
  if (documentosPendentes.length === 0) {
    ul.innerHTML = '<li class="list-group-item text-muted">Nenhum documento adicionado</li>';
    return;
  }
  
  documentosPendentes.forEach((doc, i) => {
    ul.innerHTML += `<li class="list-group-item d-flex justify-content-between align-items-center">
      üìÑ ${doc.file.name} <small class="text-muted">(${formatarTamanhoArquivo(doc.file.size)})</small>
      <button class="btn btn-sm btn-outline-danger" onclick="removerDocumento(${i})">Remover</button>
    </li>`;
  });
}

function removerDocumento(i) {
  documentosPendentes.splice(i, 1);
  atualizarListaDocumentos();
}

// ==========================
// üîπ Carregar documentos existentes
// ==========================
async function carregarDocumentosExistentes(notaId) {
  try {
    const res = await fetch(`${notaUrl}/${notaId}`);
    if (!res.ok) return;

    const nota = await res.json();
    const lista = document.getElementById('docsExistentes');
    const container = document.getElementById('docsExistentesContainer');
    lista.innerHTML = '';

    if (!nota.documentos || nota.documentos.length === 0) {
      container.style.display = 'none';
      return;
    }

    container.style.display = 'block';
    nota.documentos.forEach(d => {
      lista.innerHTML += `
        <li class="mb-2">
          üìÑ <a href="${docUrl}/${d.id}/download" 
               target="_blank" 
               class="text-decoration-none">
               ${d.nome_arquivo}
            </a>
          <small class="text-muted">(${formatarTamanhoArquivo(d.tamanho_bytes)})</small>
          <button class="btn btn-sm btn-outline-danger ms-2" 
                  onclick="deleteDocumento(${d.id}, ${notaId})"
                  title="Excluir documento">
            <i class="bi bi-trash"></i>
          </button>
        </li>`;
    });
  } catch (error) {
    console.error('‚ùå Erro ao carregar documentos:', error);
  }
}

// ==========================
// üîπ Deletar documento existente
// ==========================
async function deleteDocumento(id, notaId) {
  if (!confirm('Tem certeza que deseja excluir este documento?')) return;
  
  try {
    const res = await fetch(`${docUrl}/${id}`, { method: 'DELETE' });
    if (res.ok) {
      await carregarDocumentosExistentes(notaId);
    } else {
      alert('Erro ao excluir documento');
    }
  } catch (error) {
    console.error('‚ùå Erro ao excluir documento:', error);
    alert('Erro ao excluir documento: ' + error.message);
  }
}

// ==========================
// üîπ Excluir nota
// ==========================
async function eliminarNota(id) {
  if (!confirm('Tem certeza que deseja excluir esta nota?')) return;
  
  try {
    const res = await fetch(`${notaUrl}/${id}`, { method: 'DELETE' });
    if (res.ok) {
      await loadNotas();
    } else {
      alert('Erro ao excluir nota');
    }
  } catch (error) {
    console.error('‚ùå Erro ao excluir nota:', error);
    alert('Erro ao excluir nota: ' + error.message);
  }
}
</script>

{% endblock %}