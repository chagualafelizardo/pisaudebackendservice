{% extends 'base.html' %}
{% block title %}PI-SA√öDE / Itens{% endblock %}

{% block content %}
<!-- {% include 'navbar.html' %} -->

<h2>Gest√£o de Itens</h2>

<!-- Tabs principais -->
<ul class="nav nav-tabs mb-3" id="mainTab" role="tablist">
    <!-- 1Ô∏è‚É£ Itens Solicitados (inicia ativo) -->
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="solicitados-tab" data-bs-toggle="tab" data-bs-target="#solicitados" type="button" role="tab">
            <i class="bi bi-cart-check"></i> Itens Solicitados
        </button>
    </li>

    <!-- 2Ô∏è‚É£ Itens Recebidos (Invent√°rio) -->
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="inventario-tab" data-bs-toggle="tab" data-bs-target="#inventario" type="button" role="tab">
            <i class="bi bi-grid-3x3"></i> Itens Recebidos
        </button>
    </li>

    <!-- 3Ô∏è‚É£ Itens Pendentes -->
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="pendentes-tab" data-bs-toggle="tab" data-bs-target="#pendentes" type="button" role="tab">
            <i class="bi bi-clock-history"></i> Itens Pendentes
        </button>
    </li>

    <!-- 4Ô∏è‚É£ Confirma√ß√£o de Recep√ß√£o -->
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="confirmacao-tab" data-bs-toggle="tab" data-bs-target="#confirmacao" type="button" role="tab">
            <i class="bi bi-clipboard-check"></i> Confirmar Recep√ß√£o
        </button>
    </li>

    <!-- 5Ô∏è‚É£ Forma√ß√µes -->
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="formacoes-tab" data-bs-toggle="tab" data-bs-target="#formacoes" type="button" role="tab">
            <i class="bi bi-mortarboard"></i> Forma√ß√µes
        </button>
    </li>
</ul>

<!-- Conte√∫do das tabs -->
<div class="tab-content">
    
    <!-- ===================== TAB 1: ITENS SOLICITADOS ===================== -->
    <div class="tab-pane fade show active" id="solicitados" role="tabpanel">
        <div class="row">
            <!-- Formul√°rio de Solicita√ß√£o -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-plus-circle"></i> Solicitar Item
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="itemSolicitadoForm">
                            <div class="mb-3">
                                <label class="form-label">Nome do Item *</label>
                                <input type="text" id="solicitadoNome" class="form-control" placeholder="Ex: Paracetamol 500mg, Seringas 10ml..." required>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Quantidade Solicitada *</label>
                                    <input type="number" id="solicitadoQuantidade" class="form-control" placeholder="0" min="1" required>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Data Necess√°ria</label>
                                    <input type="date" id="solicitadoDataNecessaria" class="form-control">
                                </div>
                            </div>
  
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-send-check"></i> Submeter Solicita√ß√£o
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="limparFormSolicitado()">
                                    <i class="bi bi-arrow-clockwise"></i> Limpar
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- Lista de Itens Solicitados -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-list-check text-primary"></i>
                            Solicita√ß√µes em Andamento
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Filtros e Pesquisa -->
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <input type="text" id="solicitadosSearch" class="form-control" 
                                   placeholder="Pesquisar solicita√ß√µes..." style="max-width: 250px;"
                                   oninput="filtrarSolicitacoes(this.value)">
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary active" onclick="filtrarSolicitacoesPorStatus('todos')">Todos</button>
                                <button class="btn btn-outline-warning" onclick="filtrarSolicitacoesPorStatus('pendente')">Pendentes</button>
                                <button class="btn btn-outline-success" onclick="filtrarSolicitacoesPorStatus('aprovado')">Aprovados</button>
                                <button class="btn btn-outline-danger" onclick="filtrarSolicitacoesPorStatus('rejeitado')">Rejeitados</button>
                            </div>
                        </div>
                        
                        <div id="listaItensSolicitados" style="max-height: 600px; overflow-y: auto;">
                            <p class="text-muted">Carregando solicita√ß√µes...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ===================== TAB 2: INVENT√ÅRIO ===================== -->
    <div class="tab-pane fade" id="inventario" role="tabpanel">
        <!-- Controles de visualiza√ß√£o e pesquisa -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="d-flex align-items-center">
                <!-- Campo de pesquisa -->
                <div class="position-relative me-3" style="max-width: 400px;">
                    <input type="text" id="itemSearch" class="form-control" placeholder="Pesquisar item..." oninput="filtrarItens(this.value)">
                </div>
                
                <!-- Bot√£o de exportar Excel -->
                <button class="btn btn-outline-success me-2" onclick="downloadExcel()">üì• Exportar Excel</button>
            </div>
            
            <!-- Bot√µes de visualiza√ß√£o -->
            <div class="btn-group" role="group">
                <input type="radio" class="btn-check" name="viewType" id="blockView" autocomplete="off" checked onchange="toggleView('block')">
                <label class="btn btn-outline-primary" for="blockView">
                    <i class="bi bi-grid-3x3-gap"></i> Blocos
                </label>
                
                <input type="radio" class="btn-check" name="viewType" id="tableView" autocomplete="off" onchange="toggleView('table')">
                <label class="btn btn-outline-primary" for="tableView">
                    <i class="bi bi-table"></i> Tabela
                </label>
            </div>
        </div>

        <!-- Anima√ß√£o de distribui√ß√£o -->
        <div id="distribuicaoAnimation" style="position: fixed; bottom: 20px; left: 20px; z-index: 999; display: block;">
            <div class="hospital-container">
                <div class="hospital-icon">
                    <i class="bi bi-hospital-fill"></i>
                    <div class="hospital-pulse"></div>
                </div>
                <div id="animationLines" style="position: absolute; top: 0; left: 0; width: 100vw; height: 100vh; pointer-events: none;"></div>
            </div>
        </div>

        <!-- Controles de anima√ß√£o -->
        <div class="animation-controls">
            <small class="text-muted d-block mb-1">Anima√ß√£o Distribui√ß√£o</small>
            <button class="btn btn-sm btn-outline-primary" onclick="iniciarAnimacaoDistribuicao()" title="Reiniciar Anima√ß√£o">
                <i class="bi bi-arrow-repeat"></i>
            </button>
            <button class="btn btn-sm btn-outline-secondary" onclick="pausarAnimacao()" title="Pausar Anima√ß√£o">
                <i class="bi bi-pause"></i>
            </button>
            <button class="btn btn-sm btn-outline-info" onclick="animarTodosItens()" title="Animar Todos os Itens">
                <i class="bi bi-play-circle"></i>
            </button>
        </div>

        <!-- Bot√£o flutuante -->
        <button class="btn btn-success rounded-circle position-fixed"
                style="bottom: 20px; right: 20px; width: 60px; height: 60px; font-size: 28px; z-index: 1000;"
                onclick="abrirModalItem()">
            +
        </button>

        <!-- Visualiza√ß√£o em Blocos (PADR√ÉO) -->
        <div id="blockViewContainer" style="display: block;">
            <div class="row g-3" id="itemBlocksContainer"></div>
        </div>

        <!-- Visualiza√ß√£o em Tabela -->
        <div id="tableViewContainer" style="display: none;">
            <table class="table table-bordered align-middle" id="itemTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Image</th>
                        <th>C√≥digo</th>
                        <th>Designa√ß√£o</th>
                        <th>HS Code</th>
                        <th>Qtd</th>
                        <th>Batch No</th>
                        <th>MFG Date</th>
                        <th>Expiry Date</th>
                        <th>No. Cartons</th>
                        <th>Sync Status</th>
                        <th>Distribu√≠do</th>
                        <th>User</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="itemTableBody"></tbody>
            </table>
        </div>
    </div>

    <!-- ===================== TAB 3: ITENS PENDENTES ===================== -->
    <div class="tab-pane fade" id="pendentes" role="tabpanel">
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-clock-history text-warning"></i>
                            Registrar Item Pendente
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="itemPendenteForm">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Nome do Item *</label>
                                    <input type="text" id="itemPendenteNome" class="form-control" placeholder="Ex: Paracetamol 500mg, Seringas 10ml..." required>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">Quantidade Esperada</label>
                                    <input type="number" id="itemPendenteQuantidade" class="form-control" placeholder="0" min="0">
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">Prioridade</label>
                                    <select id="itemPendentePrioridade" class="form-select">
                                        <option value="baixa">Baixa</option>
                                        <option value="media" selected>M√©dia</option>
                                        <option value="alta">Alta</option>
                                        <option value="urgente">Urgente</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Categoria</label>
                                    <select id="itemPendenteCategoria" class="form-select">
                                        <option value="">Selecione a categoria</option>
                                        <option value="medicamentos">Medicamentos</option>
                                        <option value="material_cirurgico">Material Cir√∫rgico</option>
                                        <option value="equipamentos">Equipamentos</option>
                                        <option value="consumiveis">Consum√≠veis</option>
                                        <option value="testes_diagnosticos">Testes Diagn√≥sticos</option>
                                        <option value="outros">Outros</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Data Esperada de Entrega</label>
                                    <input type="date" id="itemPendenteDataEntrega" class="form-control">
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Observa√ß√µes</label>
                                <textarea id="itemPendenteObservacoes" class="form-control" rows="3" placeholder="Detalhes adicionais sobre o item pendente..."></textarea>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Fornecedor/Origem</label>
                                <input type="text" id="itemPendenteFornecedor" class="form-control" placeholder="Nome do fornecedor ou origem do item">
                            </div>
                            
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-plus-circle"></i> Registrar Item Pendente
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="limparFormPendente()">
                                    <i class="bi bi-arrow-clockwise"></i> Limpar
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-list-check text-info"></i>
                            Lista de Itens Pendentes
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="listaItensPendentes">
                            <p class="text-muted">Nenhum item pendente registrado.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ===================== TAB 4: CONFIRMA√á√ÉO DE RECEP√á√ÉO ===================== -->
    <div class="tab-pane fade" id="confirmacao" role="tabpanel">
        <div class="row">
            <!-- Lista de Itens Distribu√≠dos -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-clipboard-check text-success"></i>
                            Confirmar Recep√ß√£o de Item
                        </h5>
                    </div>
                    <div class="card-body">

                        <!-- Pesquisa e Modo de Visualiza√ß√£o -->
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div class="d-flex align-items-center">
                                <div class="position-relative me-3" style="max-width: 400px;">
                                    <input type="text" id="confirmacaoSearch" class="form-control"
                                        placeholder="Pesquisar itens distribu√≠dos..."
                                        oninput="filtrarItensDistribuidos(this.value)">
                                </div>
                            </div>

                            <div class="btn-group" role="group">
                                <input type="radio" class="btn-check" name="confirmacaoViewType" id="confirmacaoBlockView"
                                    autocomplete="off" checked onchange="toggleConfirmacaoView('block')">
                                <label class="btn btn-outline-primary" for="confirmacaoBlockView">
                                    <i class="bi bi-grid-3x3-gap"></i> Blocos
                                </label>

                                <input type="radio" class="btn-check" name="confirmacaoViewType" id="confirmacaoTableView"
                                    autocomplete="off" onchange="toggleConfirmacaoView('table')">
                                <label class="btn btn-outline-primary" for="confirmacaoTableView">
                                    <i class="bi bi-table"></i> Tabela
                                </label>
                            </div>
                        </div>

                        <!-- Visualiza√ß√£o em Blocos -->
                        <div id="confirmacaoBlockViewContainer" style="display: block;">
                            <div class="row g-3" id="confirmacaoBlocksContainer">
                                <!-- blocos carregados dinamicamente -->
                            </div>
                        </div>

                        <!-- Visualiza√ß√£o em Tabela -->
                        <div id="confirmacaoTableViewContainer" style="display: none;">
                            <div class="table-responsive">
                                <table class="table table-bordered align-middle" id="confirmacaoTable">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Item</th>
                                            <th>Unidade Sanit√°ria</th>
                                            <th>Quantidade</th>
                                            <th>Data Distribui√ß√£o</th>
                                            <th>Status</th>
                                            <th>User</th>
                                            <th>A√ß√µes</th>
                                        </tr>
                                    </thead>
                                    <tbody id="confirmacaoTableBody"></tbody>
                                </table>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

            <!-- Formul√°rio de Confirma√ß√£o -->
            <div class="col-md-4">
                <div class="card mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-check-circle"></i>
                            Formul√°rio de Confirma√ß√£o
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="confirmacaoRecepcaoForm">

                            <div class="mb-3">
                                <label class="form-label">Item Selecionado *</label>
                                <div id="itemSelecionadoInfo" class="border rounded p-3 bg-light" style="display: none;">
                                    <div class="d-flex align-items-center">
                                        <img id="itemSelecionadoImg" src="" alt="Imagem do item"
                                            class="me-3 rounded" style="width: 60px; height: 60px; object-fit: cover;">
                                        <div>
                                            <h6 id="itemSelecionadoNome" class="mb-1"></h6>
                                            <small class="text-muted" id="itemSelecionadoDetalhes"></small>
                                        </div>
                                    </div>
                                </div>
                                <small class="form-text text-muted">
                                    Selecione um item da lista ao lado para confirmar recep√ß√£o
                                </small>
                                <input type="text" id="confirmacaoItemId" class="form-control mt-1" readonly>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Nome de Quem Recebeu *</label>
                                <input type="text" id="confirmacaoNomeRecebedor" class="form-control"
                                    placeholder="Ex: Jo√£o Silva, Maria Santos..." required>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Data da Recep√ß√£o *</label>
                                <input type="date" id="confirmacaoDataRecepcao" class="form-control" required>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Local da Recep√ß√£o</label>
                                <select id="confirmacaoLocal" class="form-select">
                                    <option value="">Selecione o local</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Guia Assinada (PDF/Imagem) *</label>
                                <input type="file" id="confirmacaoGuiaAssinada" class="form-control"
                                    accept=".pdf,.jpg,.jpeg,.png" required onchange="previewGuiaAssinada(event)">
                                <div id="previewGuiaAssinada" class="mt-2"></div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Observa√ß√µes</label>
                                <textarea id="confirmacaoObservacoes" class="form-control" rows="3"
                                    placeholder="Detalhes adicionais sobre a recep√ß√£o..."></textarea>
                            </div>

                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-success flex-fill">
                                    <i class="bi bi-check-circle"></i> Confirmar Recep√ß√£o
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="limparFormConfirmacao()">
                                    <i class="bi bi-arrow-clockwise"></i> Limpar
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Confirma√ß√µes Recentes -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-list-check text-success"></i>
                            Confirma√ß√µes Recentes
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="listaConfirmacoes" style="max-height: 300px; overflow-y: auto;">
                            <p class="text-muted">Nenhuma confirma√ß√£o registrada.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ===================== TAB 5: GEST√ÉO DE FORMA√á√ïES ===================== -->
    <div class="tab-pane fade" id="formacoes" role="tabpanel">
        <div class="row">

            <!-- Lista de Forma√ß√µes -->
            <div class="col-md-8">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-mortarboard text-primary"></i> Forma√ß√µes Realizadas
                        </h5>
                    </div>
                    <div class="card-body">

                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <input type="text" id="formacaoSearch" class="form-control"
                                placeholder="Pesquisar forma√ß√µes..." style="max-width: 350px;"
                                oninput="filtrarFormacoes(this.value)">

                            <button class="btn btn-primary" onclick="abrirNovaFormacao()">
                                <i class="bi bi-plus-circle"></i> Nova Forma√ß√£o
                            </button>
                        </div>

                        <div id="formacoesListaContainer" class="table-responsive">
                            <table class="table table-bordered align-middle">
                                <thead>
                                    <tr>
                                        <th>Nome da Forma√ß√£o</th>
                                        <th>Data</th>
                                        <th>Participantes</th>
                                        <th>User</th>
                                        <th>A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="formacoesTableBody"></tbody>
                            </table>
                        </div>

                    </div>
                </div>
            </div>

            <!-- Formul√°rio de Forma√ß√£o + Participantes -->
            <div class="col-md-4">

                <!-- Formul√°rio -->
                <div class="card mb-4" id="formacaoFormCard" style="display: none;">
                    <div class="card-header bg-primary text-white">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-pencil-square"></i> Cadastro de Forma√ß√£o
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="formacaoForm">
                            <input type="hidden" id="formacaoId">

                            <div class="mb-3">
                                <label class="form-label">Nome da Forma√ß√£o *</label>
                                <input type="text" id="formacaoNome" class="form-control" required>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Data da Forma√ß√£o *</label>
                                <input type="date" id="formacaoData" class="form-control" required>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Observa√ß√£o</label>
                                <textarea id="formacaoObservacao" class="form-control" rows="3"></textarea>
                            </div>

                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary flex-fill">
                                    <i class="bi bi-save"></i> Salvar
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="limparFormacao()">
                                    <i class="bi bi-x-circle"></i> Cancelar
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Participantes -->
                <div class="card" id="participantesCard" style="display: none;">
                    <div class="card-header bg-success text-white">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-people"></i> Participantes da Forma√ß√£o
                        </h5>
                    </div>
                    <div class="card-body">

                        <div id="formacaoSelecionadaTitulo" class="fw-bold text-primary mb-2"></div>

                        <form id="participanteForm" class="mb-3">
                            <input type="hidden" id="participanteFormacaoId">

                            <div class="mb-2">
                                <input type="text" id="participanteNome" class="form-control"
                                    placeholder="Nome do participante" required>
                            </div>

                            <div class="mb-2">
                                <input type="text" id="participanteContacto" class="form-control"
                                    placeholder="Contacto (opcional)">
                            </div>

                            <div class="mb-2">
                                <label class="form-label">Presen√ßa</label>
                                <select id="participantePresente" class="form-select">
                                    <option value="yes">Presente</option>
                                    <option value="no">Ausente</option>
                                </select>
                            </div>

                            <button type="submit" class="btn btn-success w-100">
                                <i class="bi bi-person-plus"></i> Adicionar Participante
                            </button>
                        </form>

                        <div id="listaParticipantes" style="max-height: 250px; overflow-y: auto;">
                            <p class="text-muted">Nenhum participante registado.</p>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

</div>

<!-- Painel lateral de detalhes -->
<div id="detalhesPanel" style="position:fixed; top:60px; right:-420px; width:420px; height:90%; background:#fff; border-left:1px solid #ccc; box-shadow: -3px 0 5px rgba(0,0,0,0.2); padding:15px; overflow:auto; transition:right 0.3s; z-index:1050;">
    <button class="btn btn-sm btn-secondary mb-2" onclick="fecharDetalhes()">Fechar</button>
    <div id="detalhesContent"></div>
</div>

<!-- Modal Item -->
<div class="modal fade" id="itemModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <form id="itemForm" class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Adicionar / Editar Item</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="itemId">
                <!-- Nav tabs -->
                <ul class="nav nav-tabs mb-3" id="itemTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="basic-tab" data-bs-toggle="tab" data-bs-target="#basic" type="button" role="tab">B√°sico</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="logistics-tab" data-bs-toggle="tab" data-bs-target="#logistics" type="button" role="tab">Datas & Log√≠stica</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="location-tab" data-bs-toggle="tab" data-bs-target="#location" type="button" role="tab">Localiza√ß√£o</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="files-tab" data-bs-toggle="tab" data-bs-target="#files" type="button" role="tab">Arquivos & Observa√ß√µes</button>
                    </li>
                </ul>

                <!-- Tab panes -->
                <div class="tab-content">
                    <!-- B√°sico -->
                    <div class="tab-pane fade show active" id="basic" role="tabpanel">
                        <div class="row">
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label class="form-label">Nota de Envio (opcional)</label>
                                    <select id="itemNotaEnvio" class="form-select">
                                        <option value="">Selecione a nota de envio</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- üîπ Sec√ß√£o para visualizar documentos da Nota de Envio -->
                            <div id="notaEnvioDocumentos" class="mt-3" style="display: none;">
                                <h6>üìé Documentos da Nota de Envio</h6>
                                <ul id="notaEnvioDocsList" class="list-group"></ul>
                            </div>

                            <div class="col-md-4 mb-3">
                                <label class="form-label">C√≥digo</label>
                                <input type="text" id="itemCodigo" class="form-control" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Designa√ß√£o</label>
                                <input type="text" id="itemDesignacao" class="form-control" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">HS Code</label>
                                <input type="text" id="itemHsCode" class="form-control">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Quantidade</label>
                                <input type="number" id="itemQuantidade" class="form-control">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Batch No</label>
                                <input type="text" id="itemBatchNo" class="form-control">
                            </div>
                        </div>
                    </div>

                    <!-- Datas & Log√≠stica -->
                    <div class="tab-pane fade" id="logistics" role="tabpanel">
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label class="form-label">MFG Date</label>
                                <input type="date" id="itemDataFabricacao" class="form-control">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Expiry Date</label>
                                <input type="date" id="itemDataValidade" class="form-control">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">No. Cartons</label>
                                <input type="number" id="itemNoCartoes" class="form-control">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Peso Bruto Total</label>
                                <input type="number" step="0.01" id="itemPesoBruto" class="form-control">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Volume CBM</label>
                                <input type="number" step="0.01" id="itemVolumeCBM" class="form-control">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Total Cartons</label>
                                <input type="number" id="itemTotalCartoes" class="form-control">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Total Paletes</label>
                                <input type="number" id="itemTotalPaletes" class="form-control">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Dimens√µes Palete (CM)</label>
                                <input type="text" id="itemDimensoesPalete" class="form-control">
                            </div>
                        </div>
                    </div>

                    <!-- Localiza√ß√£o -->
                    <div class="tab-pane fade" id="location" role="tabpanel">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Armaz√©m</label>
                                <select id="itemArmazem" class="form-select" required></select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Porto de Chegada</label>
                                <select id="itemPorto" class="form-select">
                                    <option value="">Selecione o porto</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Arquivos & Observa√ß√µes -->
                    <div class="tab-pane fade" id="files" role="tabpanel">
                        <!-- üîπ NOVA SEC√á√ÉO: TIRAR FOTO COM WEBCAM -->
                        <div class="mb-3">
                            <label class="form-label">Imagem do Item</label>
                            <div class="d-flex gap-2 mb-2">
                                <button type="button" class="btn btn-outline-primary" onclick="abrirCamera()">
                                    <i class="bi bi-camera"></i> Tirar Foto
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="pararCamera()">
                                    <i class="bi bi-camera-video-off"></i> Parar C√¢mera
                                </button>
                            </div>
                            
                            <!-- √Årea da C√¢mera -->
                            <div id="cameraContainer" class="border rounded p-3 text-center mb-2" style="display: none;">
                                <div id="cameraView" class="mb-2">
                                    <video id="video" autoplay playsinline style="max-width: 100%; max-height: 300px;"></video>
                                    <canvas id="canvas" style="display: none;"></canvas>
                                </div>
                                <div class="d-flex gap-2 justify-content-center">
                                    <button type="button" class="btn btn-success" onclick="tirarFoto()">
                                        <i class="bi bi-camera-fill"></i> Capturar Foto
                                    </button>
                                    <button type="button" class="btn btn-warning" onclick="reiniciarCamera()">
                                        <i class="bi bi-arrow-repeat"></i> Nova Foto
                                    </button>
                                </div>
                            </div>

                            <!-- Upload tradicional -->
                            <input type="file" id="itemImagem" class="form-control mt-2" accept="image/*" onchange="previewImagem(event)">
                            
                            <!-- Preview da Imagem -->
                            <div class="mt-2">
                                <img id="previewImg" src="" alt="Pr√©-visualiza√ß√£o" class="img-thumbnail" style="max-width: 200px; display:none;">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Comprovativo PDF</label>
                            <input type="file" id="itemPdf" class="form-control" accept="application/pdf" onchange="previewPDF(event)">
                            <div id="previewPdf" class="mt-2"></div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Observa√ß√µes</label>
                            <textarea id="itemObservacoes" class="form-control" rows="3"></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Sync Status</label>
                                <select id="itemSyncStatus" class="form-select"></select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Sync Status Date</label>
                                <input type="datetime-local" id="itemSyncDate" class="form-control">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button type="submit" class="btn btn-primary">Salvar</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal Entrada de Stock com Abas -->
<div class="modal fade" id="entradaStockModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <form id="entradaStockForm" class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Gest√£o de Stock / Necessidades</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="entradaItemId">

                <!-- Nav tabs -->
                <ul class="nav nav-tabs mb-3" id="entradaTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="entrada-tab" data-bs-toggle="tab" data-bs-target="#entrada" type="button" role="tab">Entrada Stock</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="necessidades-tab" data-bs-toggle="tab" data-bs-target="#necessidades" type="button" role="tab">Necessidades</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="historico-tab" data-bs-toggle="tab" data-bs-target="#historico" type="button" role="tab">Hist√≥rico</button>
                    </li>
                </ul>

                <!-- Tab panes -->
                <div class="tab-content">
                    <!-- Entrada Stock -->
                    <div class="tab-pane fade show active" id="entrada" role="tabpanel">
                        <div class="mb-3">
                            <label class="form-label">Quantidade</label>
                            <input type="number" id="entradaQuantidade" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Observa√ß√µes</label>
                            <textarea id="entradaObservacoes" class="form-control"></textarea>
                        </div>
                    </div>

                    <!-- Necessidades -->
                    <div class="tab-pane fade" id="necessidades" role="tabpanel">
                        <div class="mb-3">
                            <h6>Adicionar Necessidade para este item:</h6>
                            <div class="row g-2">
                                <div class="col-md-4">
                                    <input type="number" id="necessidadeQuantidade" class="form-control" placeholder="Quantidade necess√°ria">
                                </div>
                                <div class="col-md-4">
                                    <input type="text" id="necessidadeDescricao" class="form-control" placeholder="Descri√ß√£o / Observa√ß√µes">
                                </div>
                                <div class="col-md-4">
                                    <select id="necessidadeLocation" class="form-select">
                                        <option value="">Selecione a Location</option>
                                    </select>
                                </div>
                            </div>
                            <button type="button" class="btn btn-sm btn-primary mt-2" onclick="adicionarNecessidade()">Adicionar Necessidade</button>
                        </div>
                        <hr>
                        <div id="listaNecessidadesContainer">
                            <p>Carregando necessidades...</p>
                        </div>
                    </div>

                    <!-- Hist√≥rico -->
                    <div class="tab-pane fade" id="historico" role="tabpanel">
                        <div id="historicoStockModalContainer">
                            <p>Carregando hist√≥rico...</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button type="submit" class="btn btn-primary">Registrar Entrada</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal Distribui√ß√£o -->
<div class="modal fade" id="distribuicaoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <form id="distribuicaoForm" class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Distribui√ß√£o de Item</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="distribuicaoItemId">

                <!-- Imagem e descri√ß√£o do item -->
                <div class="mb-3 text-center">
                    <img id="distribuicaoItemImg" src="/static/no-image.png" alt="Imagem do Item" class="img-thumbnail mb-2" style="max-width: 200px;">
                    <h5 id="distribuicaoItemDescricao"></h5>
                    <h6 id="distribuicaoItemHSCode"></h6>
                </div>

                <!-- Campos do formul√°rio -->
                <div class="mb-3">
                    <label class="form-label">Armaz√©m</label>
                    <select id="distribuicaoArmazem" class="form-select" required>
                        <option value="">Selecione o armaz√©m</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label">Unidade Sanit√°ria / Location</label>
                    <select id="distribuicaoLocation" class="form-select" required>
                        <option value="">Selecione a unidade sanit√°ria</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label">Quantidade</label>
                    <input type="number" id="distribuicaoQuantidade" class="form-control" required>
                </div>

                <div class="mb-3">
                    <label class="form-label">Data de Distribui√ß√£o</label>
                    <input type="date" id="distribuicaoData" class="form-control" required>
                </div>

                <div class="mb-3">
                    <label class="form-label">Observa√ß√£o</label>
                    <textarea id="distribuicaoObservacao" class="form-control"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-primary">Registrar Distribui√ß√£o</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            </div>
        </form>
    </div>
</div>

<style>
/* Estilos existentes mantidos */
.card-item {
    transition: transform 0.2s, box-shadow 0.2s;
    height: 100%;
}
.card-item:hover {
    transform: translateY(-5px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
.card-item.distribuido {
    border-left: 4px solid #0d6efd;
    background: linear-gradient(135deg, #f8f9ff 0%, #ffffff 100%);
}
.card-item.nao-distribuido {
    border-left: 4px solid #dc3545;
    background: linear-gradient(135deg, #fff5f5 0%, #ffffff 100%);
}
.card-img-container {
    height: 180px;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #f8f9fa;
}
.card-img-container img {
    max-height: 100%;
    width: auto;
    object-fit: contain;
}
.card-body {
    display: flex;
    flex-direction: column;
}
.card-actions {
    margin-top: auto;
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
}
.card-actions .btn {
    flex: 1;
    min-width: 60px;
}
.status-badge {
    position: absolute;
    top: 10px;
    right: 10px;
}
.expiry-warning {
    background-color: #ffc107;
    color: #000;
}
.expiry-danger {
    background-color: #dc3545;
    color: #fff;
}
.sync-badge {
    position: absolute;
    top: 10px;
    left: 10px;
}
.sync-synchronized {
    background-color: #198754;
}
.sync-not-synchronized {
    background-color: #6c757d;
}
.sync-updated {
    background-color: #0dcaf0;
    color: #000;
}
.distribuicao-badge {
    position: absolute;
    bottom: 10px;
    right: 10px;
}

/* Anima√ß√µes de distribui√ß√£o */
.hospital-pulse {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 60px;
    height: 60px;
    border: 2px solid #0d6efd;
    border-radius: 50%;
    animation: pulse 2s infinite;
    pointer-events: none;
}

@keyframes pulse {
    0% {
        transform: translate(-50%, -50%) scale(0.8);
        opacity: 1;
    }
    70% {
        transform: translate(-50%, -50%) scale(1.2);
        opacity: 0;
    }
    100% {
        transform: translate(-50%, -50%) scale(1.2);
        opacity: 0;
    }
}

.distribution-line {
    position: absolute;
    height: 2px;
    background: linear-gradient(90deg, #0d6efd, transparent);
    animation: distribute 3s ease-in-out;
    transform-origin: left center;
    pointer-events: none;
}

.distribution-line::after {
    content: '‚û§';
    position: absolute;
    right: -10px;
    top: -8px;
    color: #0d6efd;
    font-size: 12px;
    animation: arrowPulse 1s infinite;
}

@keyframes distribute {
    0% {
        transform: scaleX(0);
        opacity: 1;
    }
    80% {
        transform: scaleX(1);
        opacity: 1;
    }
    100% {
        transform: scaleX(1);
        opacity: 0;
    }
}

@keyframes arrowPulse {
    0%, 100% {
        transform: translateX(0);
    }
    50% {
        transform: translateX(3px);
    }
}

.item-distributed {
    animation: itemGlow 2s ease-in-out;
}

@keyframes itemGlow {
    0%, 100% {
        box-shadow: 0 0 5px rgba(13, 110, 253, 0.5);
    }
    50% {
        box-shadow: 0 0 20px rgba(13, 110, 253, 0.8), 0 0 30px rgba(13, 110, 253, 0.6);
    }
}

/* Estilos para cabe√ßalhos de tabela */
.table-dark {
    background-color: #000 !important;
    color: #fff !important;
}

.table-dark th {
    background-color: #000 !important;
    color: #fff !important;
    border-color: #444 !important;
    font-weight: 600;
}

.table {
    border-collapse: separate;
    border-spacing: 0;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
}

.table th {
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.875rem;
    letter-spacing: 0.5px;
}

.table-dark th {
    background-color: #000000 !important;
    color: #ffffff !important;
    border-bottom: 2px solid #444444 !important;
}

.badge.bg-success {
    background-color: #198754 !important;
}

.badge.bg-warning {
    background-color: #ffc107 !important;
    color: #000 !important;
}

.table .btn-sm {
    padding: 0.2rem 0.4rem;
    font-size: 0.75rem;
    border-radius: 4px;
}

/* Novos estilos para itens pendentes */
.item-pendente-card {
    border-left: 4px solid #ffc107;
    margin-bottom: 10px;
}

.item-pendente-card.alta {
    border-left-color: #fd7e14;
}

.item-pendente-card.urgente {
    border-left-color: #dc3545;
}

.item-pendente-card.concluido {
    border-left-color: #198754;
    opacity: 0.7;
}

.prioridade-badge {
    font-size: 0.7rem;
}

/* üîπ NOVOS ESTILOS PARA CONFIRMA√á√ÉO DE RECEP√á√ÉO */
.confirmacao-card {
    border-left: 4px solid #198754;
    margin-bottom: 10px;
}

.confirmacao-card .card-body {
    padding: 12px;
}

.confirmacao-badge {
    font-size: 0.7rem;
}

.guia-link {
    text-decoration: none;
    color: #0d6efd;
}

.guia-link:hover {
    text-decoration: underline;
}

/* Estilos para preview da guia assinada */
#previewGuiaAssinada img {
    max-width: 200px;
    max-height: 150px;
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 5px;
}

#previewGuiaAssinada .pdf-preview {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 10px;
    margin-top: 5px;
}

@media (max-width: 768px) {
    .table {
        font-size: 0.8rem;
    }
    
    .table .btn-sm {
        padding: 0.15rem 0.3rem;
        font-size: 0.7rem;
    }
}

/* üîπ NOVOS ESTILOS PARA ANIMA√á√ÉO DE DISTRIBUI√á√ÉO */
.hospital-container {
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 120px;
    height: 120px;
}

.hospital-icon {
    position: relative;
    z-index: 2;
    font-size: 4rem;
    color: #0d6efd;
    background: white;
    border-radius: 50%;
    padding: 10px;
    box-shadow: 0 0 20px rgba(13, 110, 253, 0.5);
}

.hospital-pulse {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 80px;
    height: 80px;
    border: 3px solid #0d6efd;
    border-radius: 50%;
    animation: hospitalPulse 3s infinite;
    pointer-events: none;
}

@keyframes hospitalPulse {
    0% {
        transform: translate(-50%, -50%) scale(0.8);
        opacity: 1;
        border-color: #0d6efd;
    }
    50% {
        border-color: #4dabf7;
    }
    100% {
        transform: translate(-50%, -50%) scale(1.5);
        opacity: 0;
        border-color: #a5d8ff;
    }
}

.distribution-line {
    position: absolute;
    height: 3px;
    background: linear-gradient(90deg, #0d6efd, #4dabf7, #a5d8ff);
    animation: distributeLine 4s ease-in-out;
    transform-origin: left center;
    pointer-events: none;
    z-index: 1;
    box-shadow: 0 0 10px rgba(13, 110, 253, 0.7);
}

.distribution-line::before {
    content: '';
    position: absolute;
    right: -8px;
    top: -6px;
    width: 0;
    height: 0;
    border-left: 8px solid #0d6efd;
    border-top: 6px solid transparent;
    border-bottom: 6px solid transparent;
    animation: arrowPulse 1s infinite;
}

.distribution-line::after {
    content: '';
    position: absolute;
    right: -12px;
    top: -10px;
    width: 16px;
    height: 16px;
    background: #0d6efd;
    border-radius: 50%;
    animation: arrowGlow 2s infinite;
    box-shadow: 0 0 10px rgba(13, 110, 253, 0.8);
}

@keyframes distributeLine {
    0% {
        transform: scaleX(0);
        opacity: 1;
        background: linear-gradient(90deg, #0d6efd, #4dabf7);
    }
    70% {
        transform: scaleX(1);
        opacity: 1;
        background: linear-gradient(90deg, #0d6efd, #4dabf7, #a5d8ff);
    }
    100% {
        transform: scaleX(1);
        opacity: 0;
        background: linear-gradient(90deg, #0d6efd, #a5d8ff);
    }
}

@keyframes arrowPulse {
    0%, 100% {
        transform: translateX(0);
        border-left-color: #0d6efd;
    }
    50% {
        transform: translateX(3px);
        border-left-color: #4dabf7;
    }
}

@keyframes arrowGlow {
    0%, 100% {
        transform: scale(1);
        background: #0d6efd;
        box-shadow: 0 0 10px rgba(13, 110, 253, 0.8);
    }
    50% {
        transform: scale(1.2);
        background: #4dabf7;
        box-shadow: 0 0 20px rgba(13, 110, 253, 1);
    }
}

.item-connection-point {
    position: absolute;
    width: 12px;
    height: 12px;
    background: #0d6efd;
    border-radius: 50%;
    border: 2px solid white;
    box-shadow: 0 0 10px rgba(13, 110, 253, 0.8);
    z-index: 3;
    animation: connectionPoint 2s infinite;
}

@keyframes connectionPoint {
    0%, 100% {
        transform: scale(1);
        box-shadow: 0 0 10px rgba(13, 110, 253, 0.8);
    }
    50% {
        transform: scale(1.3);
        box-shadow: 0 0 20px rgba(13, 110, 253, 1);
    }
}

.animation-controls {
    position: fixed;
    bottom: 100px;
    left: 20px;
    z-index: 1000;
    background: white;
    padding: 10px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.animation-controls button {
    margin: 2px;
    padding: 4px 8px;
    font-size: 0.8rem;
}

.card-confirmacao {
    transition: transform 0.2s, box-shadow 0.2s;
    height: 100%;
    cursor: pointer;
    border: 2px solid transparent;
}
.card-confirmacao:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
.card-confirmacao.selecionado {
    border-color: #198754;
    background-color: #f8fff9;
}
.card-confirmacao.confirmado {
    border-left: 4px solid #198754;
}
.card-confirmacao.pendente {
    border-left: 4px solid #fd7e14;
}
.card-img-container-confirmacao {
    height: 120px;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #f8f9fa;
}
.card-img-container-confirmacao img {
    max-height: 100%;
    width: auto;
    object-fit: contain;
}
.status-badge-confirmacao {
    position: absolute;
    top: 10px;
    right: 10px;
}
.confirmacao-badge {
    font-size: 0.7em;
}

/* üîπ NOVOS ESTILOS PARA A C√ÇMERA */
.camera-controls {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
}

#cameraContainer {
    background: #f8f9fa;
    border-radius: 8px;
}

#video {
    border-radius: 8px;
    background: #000;
}

#canvas {
    border-radius: 8px;
}

.camera-preview {
    border: 3px solid #198754;
    box-shadow: 0 0 20px rgba(25, 135, 84, 0.3);
}

</style>

<script>
// üîπ VARI√ÅVEIS GLOBAIS PARA WEBCAM
let stream = null;
let cameraActive = false;

// üîπ VARI√ÅVEIS GLOBAIS PARA CONFIRMA√á√ÉO DE RECEP√á√ÉO
let guiaAssinadaBase64 = null;

// Vari√°veis globais existentes
let allItens = [];
let allArmazens = [];
let allPortos = [];
let allLocations = [];
let imagemBase64 = null;
let pdfBase64 = null;
let allNotasEnvio = [];
let currentView = 'block';
let distribuicoes = [];
let animationTimeout = null;
let itensPendentes = [];

// üîπ VARI√ÅVEIS PARA CONTROLE DA ANIMA√á√ÉO
let animationInterval = null;
let isAnimationPaused = false;
let currentAnimationIndex = 0;

// Vari√°veis para controle da confirma√ß√£o
let itensDistribuidos = [];
let confirmacaoCurrentView = 'block';
let itemSelecionado = null;

const apiUrl = '/api/item';
const armazemUrl = '/api/armazem';
const portoUrl = '/api/porto';
const locationUrl = '/api/location';
const notaEnvioUrl = '/api/notaenvio';
const distribuicaoUrl = '/api/distribuicao';
const itensPendentesUrl = '/api/itenspendentes';
const SYNC_STATUS_ENUM = ['Not Syncronized', 'Syncronized', 'Updated'];

const API_FORMACOES = "/api/formacao_item";
const API_PARTICIPANTES = "/api/participante";
const API_SOLICITACOES = "/api/items_solicitados";

// ==========================
// üîπ FUN√á√ïES DA WEBCAM
// ==========================

// Abrir c√¢mera
async function abrirCamera() {
    try {
        // Parar c√¢mera anterior se estiver ativa
        if (stream) {
            pararCamera();
        }

        // Solicitar acesso √† c√¢mera
        stream = await navigator.mediaDevices.getUserMedia({ 
            video: { 
                facingMode: 'environment', // Preferir c√¢mera traseira
                width: { ideal: 1280 },
                height: { ideal: 720 }
            } 
        });

        const video = document.getElementById('video');
        video.srcObject = stream;
        cameraActive = true;

        // Mostrar container da c√¢mera
        document.getElementById('cameraContainer').style.display = 'block';
        
        // Esconder preview de imagem existente
        document.getElementById('previewImg').style.display = 'none';
        
        console.log('‚úÖ C√¢mera ativada com sucesso');

    } catch (err) {
        console.error('‚ùå Erro ao acessar c√¢mera:', err);
        alert('N√£o foi poss√≠vel acessar a c√¢mera. Verifique as permiss√µes do navegador.');
    }
}

// Parar c√¢mera
function pararCamera() {
    if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
    }
    
    cameraActive = false;
    document.getElementById('cameraContainer').style.display = 'none';
    console.log('üì∑ C√¢mera parada');
}

// Tirar foto
function tirarFoto() {
    if (!cameraActive) {
        alert('Primeiro ative a c√¢mera!');
        return;
    }

    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const previewImg = document.getElementById('previewImg');

    // Configurar canvas com as dimens√µes do v√≠deo
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;

    // Desenhar frame atual do v√≠deo no canvas
    const context = canvas.getContext('2d');
    context.drawImage(video, 0, 0, canvas.width, canvas.height);

    // Converter para base64
    const imageData = canvas.toDataURL('image/jpeg', 0.8);
    imagemBase64 = imageData.split(',')[1];

    // Mostrar preview
    previewImg.src = imageData;
    previewImg.style.display = 'block';
    previewImg.classList.add('camera-preview');

    // Parar c√¢mera ap√≥s tirar foto
    pararCamera();

    console.log('üì∏ Foto capturada com sucesso');
    
    // Feedback visual
    const captureBtn = document.querySelector('button[onclick="tirarFoto()"]');
    const originalText = captureBtn.innerHTML;
    captureBtn.innerHTML = '<i class="bi bi-check-circle"></i> Foto Capturada!';
    captureBtn.classList.remove('btn-success');
    captureBtn.classList.add('btn-primary');
    
    setTimeout(() => {
        captureBtn.innerHTML = originalText;
        captureBtn.classList.remove('btn-primary');
        captureBtn.classList.add('btn-success');
    }, 2000);
}

// Reiniciar c√¢mera para nova foto
function reiniciarCamera() {
    // Limpar imagem atual
    imagemBase64 = null;
    document.getElementById('previewImg').style.display = 'none';
    document.getElementById('previewImg').classList.remove('camera-preview');
    
    // Reabrir c√¢mera
    abrirCamera();
}

// Fechar c√¢mera quando modal fechar
document.getElementById('itemModal').addEventListener('hidden.bs.modal', function () {
    pararCamera();
});

// ==========================
// üîπ INICIALIZA√á√ÉO COMPLETA
// ==========================
window.onload = async () => {
    console.log('üöÄ Iniciando aplica√ß√£o...');
    
    // ‚úÖ CARREGAR PRIMEIRO AS DISTRIBUI√á√ïES E LOCATIONS
    await loadDistribuicoes();
    await loadLocations();
    
    // ‚úÖ DEPOIS CARREGAR O RESTO
    carregarSyncStatus();
    loadArmazens();
    loadPortos();
    loadNotasEnvio();
    loadItens();
    carregarItensPendentes();
    carregarFormacoes();
    // ‚úÖ INICIAR ANIMA√á√ÉO AP√ìS CARREGAMENTO COMPLETO
    setTimeout(() => {
        iniciarAnimacaoDistribuicao();
    }, 1500);
    
    console.log('‚úÖ Aplica√ß√£o inicializada completamente');
};



function abrirNovaFormacao() {
    document.getElementById("formacaoFormCard").style.display = "block";   // mostrar formul√°rio
    document.getElementById("participantesCard").style.display = "none";   // esconder participantes
    document.getElementById("formacaoSelecionadaTitulo").innerText = "";   // limpar info

    // limpar campos
    document.getElementById("formacaoId").value = "";
    document.getElementById("formacaoNome").value = "";
    document.getElementById("formacaoData").value = "";
    document.getElementById("formacaoObservacao").value = "";
}

function limparFormacao() {
    document.getElementById("formacaoFormCard").style.display = "none";
    document.getElementById("participantesCard").style.display = "none";
}


// ========================= CARREGAR LISTA DE FORMA√á√ïES =========================
function carregarFormacoes() {
    fetch(`${API_FORMACOES}`)
        .then(resp => resp.json())
        .then(formacoes => {
            let tbody = document.getElementById("formacoesTableBody");
            tbody.innerHTML = "";

            if (formacoes.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">Nenhuma forma√ß√£o encontrada</td></tr>`;
                return;
            }

            formacoes.forEach(f => {
                let linha = `
                    <tr>
                        <td>${f.nome_formacao}</td>
                        <td>${f.data_formacao ? new Date(f.data_formacao).toLocaleDateString() : '-'}</td>
                        <td>${f.participantes.length}</td>
                        <td>${f.user || '-'}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="editarFormacao(${f.id})">
                                <i class="bi bi-pencil"></i>
                            </button>
                        </td>
                    </tr>`;
                tbody.innerHTML += linha;
            });
        })
        .catch(err => console.error("Erro ao carregar forma√ß√µes:", err));
}


function abrirParticipantes(formacaoId, nome) {
    document.getElementById("participantesCard").style.display = "block";
    document.getElementById("participanteFormacaoId").value = formacaoId;
    document.getElementById("formacaoSelecionadaTitulo").innerText = nome;
    carregarParticipantes(formacaoId);
}

function carregarParticipantes(formacaoId) {
    fetch(`${API_PARTICIPANTES}/formacao/${formacaoId}`)
        .then(res => res.json())
        .then(lista => {
            const div = document.getElementById("listaParticipantes");
            div.innerHTML = "";

            if (lista.length === 0) {
                div.innerHTML = '<p class="text-muted">Nenhum participante registado.</p>';
                return;
            }

            lista.forEach(p => {
                div.innerHTML += `
                    <div class="d-flex justify-content-between border-bottom py-2">
                        <div>
                            <strong>${p.nome}</strong><br>
                            <small>${p.contacto ?? ""}</small>
                        </div>
                        <div>
                            <span class="badge ${p.presente === 'yes' ? 'bg-success' : 'bg-danger'}">
                                ${p.presente === 'yes' ? "Presente" : "Ausente"}
                            </span>
                            <button class="btn btn-sm btn-outline-success ms-2" onclick="marcarPresenca(${p.id})">
                                ‚úì
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="eliminarParticipante(${p.id}, ${formacaoId})">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>`;
            });
        });
}

document.getElementById("formacoes-tab").addEventListener("click", () => {
    carregarFormacoes();
});

document.getElementById("participanteForm").addEventListener("submit", function (e) {
    e.preventDefault();

    const formacaoId = document.getElementById("participanteFormacaoId").value;
    const body = {
        nome: document.getElementById("participanteNome").value,
        contacto: document.getElementById("participanteContacto").value,
        presente: document.getElementById("participantePresente").value,
        formacao_id: formacaoId
    };

    fetch(API_PARTICIPANTES, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
    })
    .then(res => res.json())
    .then(() => {
        carregarParticipantes(formacaoId);
        carregarFormacoes(); // atualiza contagem na lista
        document.getElementById("participanteForm").reset();
    });
});

function marcarPresenca(id) {
    fetch(`${API_PARTICIPANTES}/${id}/presenca`, { method: "PATCH" })
        .then(res => res.json())
        .then(() => {
            const formacaoId = document.getElementById("participanteFormacaoId").value;
            carregarParticipantes(formacaoId);
        });
}

function eliminarParticipante(id, formacaoId) {
    if (!confirm("Remover participante?")) return;

    fetch(`${API_PARTICIPANTES}/${id}`, { method: "DELETE" })
        .then(res => res.json())
        .then(() => {
            carregarParticipantes(formacaoId);
            carregarFormacoes();
        });
}

function filtrarFormacoes(texto) {
    texto = texto.toLowerCase();
    document.querySelectorAll("#formacoesTableBody tr").forEach(row => {
        row.style.display = row.innerText.toLowerCase().includes(texto) ? "" : "none";
    });
}


// ==========================
// üîπ FUN√á√ïES DE CONFIRMA√á√ÉO DE RECEP√á√ÉO (ADICIONADAS DE VOLTA)
// ==========================

// Inicializa√ß√£o da tab de confirma√ß√£o
function inicializarConfirmacao() {
    carregarItensDistribuidos();
    carregarLocaisConfirmacao();
    document.getElementById('confirmacaoDataRecepcao').value = new Date().toISOString().split('T')[0];
}

// Carregar itens distribu√≠dos
async function carregarItensDistribuidos() {
    try {
        const [distribuicoesRes, itensRes, locationsRes] = await Promise.all([
            fetch('/api/distribuicao'),
            fetch('/api/item'),
            fetch('/api/location')
        ]);

        const distribuicoes = await distribuicoesRes.json();
        const allItens = await itensRes.json();
        const allLocations = await locationsRes.json();

        // Combinar dados
        itensDistribuidos = distribuicoes.map(d => {
            const item = allItens.find(i => i.id === d.item_id);
            const location = allLocations.find(l => l.id === d.location_id);
            
            return {
                distribuicao_id: d.id,
                item_id: d.item_id,
                quantidade_distribuida: d.quantidade,
                data_distribuicao: d.data_distribuicao,
                location_nome: location?.nome || location?.name || location?.designacao || 'N/A',
                location_id: d.location_id,
                
                // Dados do item
                item_designacao: item?.designacao || 'Item n√£o encontrado',
                item_codigo: item?.codigo || 'N/A',
                item_imagem: item?.imagem,
                item_quantidade: item?.quantidade || 0,
                item_batch_no: item?.batch_no || 'N/A',
                item_data_validade: item?.data_validade,
                
                // Status de confirma√ß√£o
                recebeu: item?.recebeu || null,
                guia_assinada_dados: item?.guia_assinada_dados || null,
                data_recepcao: item?.updateAt || null
            };
        });

        atualizarListaItensDistribuidos();
    } catch (err) {
        console.error('Erro ao carregar itens distribu√≠dos:', err);
        document.getElementById('confirmacaoBlocksContainer').innerHTML = `
            <div class="col-12 text-center py-4">
                <i class="bi bi-exclamation-triangle text-danger display-4"></i>
                <h5 class="text-danger mt-2">Erro ao carregar dados</h5>
                <p class="text-muted">Tente recarregar a p√°gina</p>
            </div>
        `;
    }
}

// Filtrar itens distribu√≠dos
function filtrarItensDistribuidos(query) {
    const termo = query.trim().toLowerCase();
    const itensFiltrados = itensDistribuidos.filter(item =>
        item.item_designacao.toLowerCase().includes(termo) ||
        item.item_codigo.toLowerCase().includes(termo) ||
        item.location_nome.toLowerCase().includes(termo) ||
        item.item_batch_no.toLowerCase().includes(termo)
    );
    
    renderizarItensDistribuidos(itensFiltrados);
}

// Alternar visualiza√ß√£o
function toggleConfirmacaoView(viewType) {
    confirmacaoCurrentView = viewType;
    
    if (viewType === 'table') {
        document.getElementById('confirmacaoTableViewContainer').style.display = 'block';
        document.getElementById('confirmacaoBlockViewContainer').style.display = 'none';
    } else {
        document.getElementById('confirmacaoTableViewContainer').style.display = 'none';
        document.getElementById('confirmacaoBlockViewContainer').style.display = 'block';
    }
    
    // Reaplicar filtro
    filtrarItensDistribuidos(document.getElementById('confirmacaoSearch').value);
}

// Fun√ß√£o para selecionar item
function selecionarItemParaConfirmacao(item) {
    itemSelecionado = item;

    // Preenche ID no formul√°rio
    document.getElementById('confirmacaoItemId').value = item.item_id;

    // Atualiza √°rea visual do item selecionado
    const infoDiv = document.getElementById('itemSelecionadoInfo');
    document.getElementById('itemSelecionadoNome').textContent = item.item_designacao;
    document.getElementById('itemSelecionadoDetalhes').textContent = `${item.location_nome} ‚Äî ${item.data_distribuicao}`;
    document.getElementById('itemSelecionadoImg').src = item.item_imagem || '/static/no-image.png';
    infoDiv.style.display = 'block';
}

// Alternar visualiza√ß√£o bloco/tabela
function toggleConfirmacaoView(mode) {
    document.getElementById('confirmacaoBlockViewContainer').style.display = (mode === 'block') ? 'block' : 'none';
    document.getElementById('confirmacaoTableViewContainer').style.display = (mode === 'table') ? 'block' : 'none';
}

// Atualizar lista de itens distribu√≠dos
function atualizarListaItensDistribuidos() {
    renderizarItensDistribuidos(itensDistribuidos);
}

// Renderizar itens distribu√≠dos
function renderizarItensDistribuidos(itens) {
    if (confirmacaoCurrentView === 'table') {
        renderizarTabelaConfirmacao(itens);
    } else {
        renderizarBlocosConfirmacao(itens);
    }
}

// Renderizar blocos de confirma√ß√£o
function renderizarBlocosConfirmacao(itens) {
    const container = document.getElementById('confirmacaoBlocksContainer');
    
    if (itens.length === 0) {
        container.innerHTML = `
            <div class="col-12 text-center py-5">
                <i class="bi bi-inbox display-1 text-muted"></i>
                <h4 class="text-muted mt-3">Nenhum item distribu√≠do encontrado</h4>
                <p class="text-muted">N√£o h√° itens distribu√≠dos para confirmar recep√ß√£o</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = '';
    
    itens.forEach(item => {
        const imgSrc = item.item_imagem ? `data:image/jpeg;base64,${item.item_imagem}` : '/static/no-image.png';
        const jaConfirmado = item.recebeu && item.guia_assinada_dados;
        const estaSelecionado = itemSelecionado && itemSelecionado.item_id === item.item_id;
        
        container.innerHTML += `
        <div class="col-md-6 col-lg-4 col-xl-3">
            <div class="card card-confirmacao ${jaConfirmado ? 'confirmado' : 'pendente'} ${estaSelecionado ? 'selecionado' : ''}" 
                 onclick="selecionarItemConfirmacao(${JSON.stringify(item).replace(/'/g, "\\'")})">
                
                ${jaConfirmado ? `
                    <span class="badge bg-success status-badge-confirmacao">
                        <i class="bi bi-check-circle"></i> Confirmado
                    </span>
                ` : `
                    <span class="badge bg-warning status-badge-confirmacao">
                        <i class="bi bi-clock"></i> Pendente
                    </span>
                `}
                
                <div class="card-img-container-confirmacao">
                    <img src="${imgSrc}" class="card-img-top" alt="${item.item_designacao}" 
                         onerror="this.src='/static/no-image.png'">
                </div>
                
                <div class="card-body">
                    <h6 class="card-title">${item.item_designacao}</h6>
                    <p class="card-text small">
                        <strong>C√≥digo:</strong> ${item.item_codigo}<br>
                        <strong>Batch:</strong> ${item.item_batch_no}<br>
                        <strong>Distribu√≠do para:</strong> ${item.location_nome}<br>
                        <strong>Qtd:</strong> <span class="badge bg-primary">${item.quantidade_distribuida}</span><br>
                        <strong>Data distribui√ß√£o:</strong> ${item.data_distribuicao ? new Date(item.data_distribuicao).toLocaleDateString() : 'N/A'}<br>
                        ${jaConfirmado ? `
                            <strong>Recebido por:</strong> ${item.recebeu}<br>
                            <strong>Data confirma√ß√£o:</strong> ${item.data_recepcao ? new Date(item.data_recepcao).toLocaleDateString() : 'N/A'}
                        ` : ''}
                    </p>
                </div>
            </div>
        </div>`;
    });
}

// Renderizar tabela detalhada
function renderizarTabelaConfirmacao(itens) {
    const tbody = document.getElementById('confirmacaoTableBody');
    tbody.innerHTML = '';

    if (!itens || itens.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="text-center py-4">
                    <i class="bi bi-inbox display-4 text-muted"></i>
                    <h5 class="text-muted mt-2">Nenhum item distribu√≠do encontrado</h5>
                </td>
            </tr>
        `;
        return;
    }

    itens.forEach(item => {
        const imgSrc = item.item_imagem ? `data:image/jpeg;base64,${item.item_imagem}` : '/static/no-image.png';
        const jaConfirmado = item.recebeu && item.guia_assinada_dados;

        tbody.innerHTML += `
            <tr onclick="selecionarItemParaConfirmacao(${JSON.stringify(item).replace(/'/g, "\\'")})" 
                style="cursor:pointer; ${itemSelecionado && itemSelecionado.item_id === item.item_id ? 'background-color: #f8fff9;' : ''}">
                
                <td>${item.item_id}</td>

                <td class="d-flex align-items-center">
                    <img src="${imgSrc}" style="width:40px;height:40px;object-fit:cover;margin-right:8px;" 
                         onerror="this.src='/static/no-image.png'">
                    <div>
                        <strong>${item.item_designacao}</strong><br>
                        <small class="text-muted">${item.item_codigo} | Batch: ${item.item_batch_no}</small>
                    </div>
                </td>

                <td>${item.location_nome}</td>
                <td><span class="badge bg-primary">${item.quantidade_distribuida}</span></td>
                <td>${item.data_distribuicao ? new Date(item.data_distribuicao).toLocaleDateString() : '-'}</td>

                <td>
                    ${jaConfirmado ? `
                        <span class="badge bg-success">
                            <i class="bi bi-check-circle"></i> Confirmado
                        </span>
                        <br><small>Por: ${item.recebeu}</small>
                    ` : `
                        <span class="badge bg-warning">
                            <i class="bi bi-clock"></i> Pendente
                        </span>
                    `}
                </td>

                <td>${item.recebeu || '-'}</td>

                <td>
                    <button class="btn btn-sm btn-success" onclick="event.stopPropagation(); selecionarItemParaConfirmacao(${JSON.stringify(item).replace(/'/g, "\\'")})">
                        <i class="bi bi-check-lg"></i> Confirmar
                    </button>
                </td>
            </tr>
        `;
    });
}

// Renderizar blocos detalhados
function renderizarBlocosConfirmacao(itens) {
    const container = document.getElementById('confirmacaoBlocksContainer');
    container.innerHTML = '';

    if (!itens || itens.length === 0) {
        container.innerHTML = `<div class="col-12 text-center py-4 text-muted">Nenhum item distribu√≠do encontrado</div>`;
        return;
    }

    itens.forEach(item => {
        const imgSrc = item.item_imagem ? `data:image/jpeg;base64,${item.item_imagem}` : '/static/no-image.png';
        const jaConfirmado = item.recebeu && item.guia_assinada_dados;

        const bloco = document.createElement('div');
        bloco.className = 'col-md-4';
        bloco.innerHTML = `
            <div class="card h-100 shadow-sm item-bloco" style="cursor:pointer;" onclick='selecionarItemParaConfirmacao(${JSON.stringify(item).replace(/'/g,"\\'")})'>
                <img src="${imgSrc}" class="card-img-top" style="height: 150px; object-fit: cover;">
                <div class="card-body">
                    <h6 class="card-title">${item.item_designacao}</h6>
                    <p class="card-text small text-muted"><i class="bi bi-hospital"></i> ${item.location_nome}</p>
                    <p class="card-text small text-muted"><i class="bi bi-calendar-event"></i> ${item.data_distribuicao ? new Date(item.data_distribuicao).toLocaleDateString() : '-'}</p>
                    ${jaConfirmado ? `<span class="badge bg-success"><i class="bi bi-check-circle"></i> Confirmado</span>` 
                                  : `<span class="badge bg-warning"><i class="bi bi-clock"></i> Pendente</span>`}
                </div>
            </div>
        `;
        container.appendChild(bloco);
    });
}

// Inicializar com dados reais
document.addEventListener('DOMContentLoaded', () => {
    // itensDistribuidos deve vir do backend
    renderizarTabelaConfirmacao(itensDistribuidos);
    renderizarBlocosConfirmacao(itensDistribuidos);
});

// Selecionar item para confirma√ß√£o
function selecionarItemConfirmacao(item) {
    itemSelecionado = item;
    
    // Atualizar formul√°rio
    document.getElementById('confirmacaoItemId').value = item.item_id;
    
    // Atualizar preview do item selecionado
    const infoDiv = document.getElementById('itemSelecionadoInfo');
    const imgSrc = item.item_imagem ? `data:image/jpeg;base64,${item.item_imagem}` : '/static/no-image.png';
    
    document.getElementById('itemSelecionadoImg').src = imgSrc;
    document.getElementById('itemSelecionadoNome').textContent = item.item_designacao;
    document.getElementById('itemSelecionadoDetalhes').textContent = 
        `C√≥digo: ${item.item_codigo} | Batch: ${item.item_batch_no} | Local: ${item.location_nome}`;
    
    infoDiv.style.display = 'block';
    
    // Preencher dados se j√° estiver confirmado
    if (item.recebeu) {
        document.getElementById('confirmacaoNomeRecebedor').value = item.recebeu;
        document.getElementById('confirmacaoDataRecepcao').value = item.data_recepcao ? 
            new Date(item.data_recepcao).toISOString().split('T')[0] : 
            new Date().toISOString().split('T')[0];
    } else {
        document.getElementById('confirmacaoNomeRecebedor').value = '';
        document.getElementById('confirmacaoNomeRecebedor').value = '';
        document.getElementById('confirmacaoDataRecepcao').value = new Date().toISOString().split('T')[0];
    }
    
    // Atualizar visualiza√ß√£o para mostrar item selecionado
    atualizarListaItensDistribuidos();
}

// Carregar locais para confirma√ß√£o
async function carregarLocaisConfirmacao() {
    try {
        const res = await fetch('/api/location');
        const locations = await res.json();
        
        const select = document.getElementById('confirmacaoLocal');
        select.innerHTML = '<option value="">Selecione o local</option>';
        
        locations.forEach(location => {
            const nome = location.nome || location.name || location.designacao;
            select.innerHTML += `<option value="${location.id}">${nome}</option>`;
        });
    } catch (err) {
        console.error('Erro ao carregar locais:', err);
    }
}

// Preview da guia assinada
function previewGuiaAssinada(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = e => {
        guiaAssinadaBase64 = e.target.result.split(',')[1];
        const preview = document.getElementById('previewGuiaAssinada');
        
        if (file.type === 'application/pdf') {
            preview.innerHTML = `
                <div class="pdf-preview">
                    <i class="bi bi-file-earmark-pdf text-danger" style="font-size: 2rem;"></i>
                    <div class="small">${file.name}</div>
                    <small class="text-muted">PDF - ${(file.size / 1024).toFixed(2)} KB</small>
                </div>
            `;
        } else if (file.type.startsWith('image/')) {
            preview.innerHTML = `
                <img src="${e.target.result}" alt="Preview da guia assinada" class="img-thumbnail">
                <div class="small mt-1">${file.name}</div>
                <small class="text-muted">${(file.size / 1024).toFixed(2)} KB</small>
            `;
        }
    };
    reader.readAsDataURL(file);
}

// üîπ FORMUL√ÅRIO DE CONFIRMA√á√ÉO DE RECEP√á√ÉO
document.getElementById('confirmacaoRecepcaoForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    if (!guiaAssinadaBase64) {
        alert('Por favor, fa√ßa upload da guia assinada de recep√ß√£o.');
        return;
    }
    
    const itemId = parseInt(document.getElementById('confirmacaoItemId').value);
    const nomeRecebedor = document.getElementById('confirmacaoNomeRecebedor').value;
    const confirmacaoDataRecepcao = document.getElementById('confirmacaoDataRecepcao').value;
    const fileInput = document.getElementById('confirmacaoGuiaAssinada');
    
    const payload = {
        recebeu: nomeRecebedor,
        guia_assinada_nome: fileInput.files[0].name,
        guia_assinada_tipo: fileInput.files[0].type,
        guia_assinada_dados: guiaAssinadaBase64
    };

    // const res = await fetch(`${apiUrl}/${itemId}/confirmarrecepcao`, {
    const res = await fetch(`${apiUrl}/${itemId}/confirmarrecepcao`, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
    });

    if (!res.ok) {
        const text = await res.text(); // ler raw (HTML ou JSON inv√°lido)
        console.error('Resposta n√£o OK do servidor (raw):', text);
        // tentar parsear JSON amigavelmente
        try {
            const jsonErr = JSON.parse(text);
            throw jsonErr;
        } catch (e) {
            throw new Error('Resposta n√£o-JSON do servidor: ' + (text.slice(0,500)));
        }
    }
});

function limparFormConfirmacao() {
    document.getElementById('confirmacaoRecepcaoForm').reset();
    document.getElementById('previewGuiaAssinada').innerHTML = '';
    guiaAssinadaBase64 = null;
    document.getElementById('confirmacaoDataRecepcao').value = new Date().toISOString().split('T')[0];
}

function atualizarListaConfirmacoes() {
    const container = document.getElementById('listaConfirmacoes');
    
    const itensComGuia = allItens.filter(item => item.guia_assinada_dados);
    
    if (!itensComGuia || itensComGuia.length === 0) {
        container.innerHTML = '<p class="text-muted">Nenhuma confirma√ß√£o registrada.</p>';
        return;
    }

    let html = '';
    itensComGuia.forEach(item => {
        const local = allLocations.find(l => l.id === item.armazem_id);
        const localNome = local ? local.nome : 'N/A';
        
        html += `
            <div class="card confirmacao-card mb-2">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <h6 class="card-title mb-1">${item.designacao}</h6>
                            <div class="d-flex flex-wrap gap-2 mb-2">
                                <span class="badge confirmacao-badge bg-success">
                                    <i class="bi bi-person-check"></i> ${item.recebeu || 'N/A'}
                                </span>
                                <span class="badge confirmacao-badge bg-primary">
                                    <i class="bi bi-calendar-check"></i> ${item.updateAt ? new Date(item.updateAt).toLocaleDateString('pt-BR') : 'N/A'}
                                </span>
                                ${localNome !== 'N/A' ? `<span class="badge confirmacao-badge bg-info">${localNome}</span>` : ''}
                            </div>
                            ${item.observacoes ? `<p class="card-text small mb-1">${item.observacoes}</p>` : ''}
                            <div class="text-muted small">
                                ${item.guia_assinada_nome ? `
                                    <div>
                                        <a href="/api/item/${item.id}/download-guia" 
                                           target="_blank" 
                                           class="guia-link">
                                           <i class="bi bi-download"></i> ${item.guia_assinada_nome}
                                        </a>
                                    </div>
                                ` : ''}
                                <div>Registrado em: ${item.updateAt ? new Date(item.updateAt).toLocaleDateString('pt-BR') : 'N/A'}</div>
                                <div>Por: ${item.user || 'Sistema'}</div>
                            </div>
                        </div>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-danger" onclick="removerConfirmacao(${item.id})" title="Remover confirma√ß√£o">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });

    container.innerHTML = html;
}

async function removerConfirmacao(id) {
    if (!confirm('Deseja realmente remover esta confirma√ß√£o de recep√ß√£o?')) return;
    
    try {
        const payload = {
            recebeu: null,
            guia_assinada_nome: null,
            data_recepcao: null,
            guia_assinada_tipo: null,
            guia_assinada_dados: null
        };

        const res = await fetch(`${apiUrl}/${id}/confirmar-recepcao`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });

        if (!res.ok) throw await res.json();
        
        await loadItens();
        alert('Confirma√ß√£o de recep√ß√£o removida!');
        
    } catch (err) {
        alert('Erro ao remover confirma√ß√£o: ' + (err.message || 'Erro desconhecido'));
        console.error(err);
    }
}

// ==========================
// üîπ FUN√á√ïES EXISTENTES (MANTIDAS DO SEU C√ìDIGO ATUAL)
// ==========================

function carregarSyncStatus() {
    const select = document.getElementById('itemSyncStatus');
    if (select) {
        select.innerHTML = '';
        SYNC_STATUS_ENUM.forEach(status => {
            select.innerHTML += `<option value="${status}">${status}</option>`;
        });
    }
}

async function loadArmazens() {
    try {
        const res = await fetch(armazemUrl);
        allArmazens = await res.json();
        
        const selectItem = document.getElementById('itemArmazem');
        selectItem.innerHTML = '<option value="">Selecione o armaz√©m</option>';
        allArmazens.forEach(a => selectItem.innerHTML += `<option value="${a.id}">${a.nome}</option>`);
        
        const selectDistribuicao = document.getElementById('distribuicaoArmazem');
        if (selectDistribuicao) {
            selectDistribuicao.innerHTML = '<option value="">Selecione o armaz√©m</option>';
            allArmazens.forEach(a => selectDistribuicao.innerHTML += `<option value="${a.id}">${a.nome}</option>`);
        }
        
    } catch (err) {
        console.error('Erro ao carregar armazens', err);
    }
}

async function loadPortos() {
    try {
        const res = await fetch(portoUrl);
        allPortos = await res.json();
        
        const select = document.getElementById('itemPorto');
        select.innerHTML = '<option value="">Selecione o porto</option>';
        allPortos.forEach(p => select.innerHTML += `<option value="${p.id}">${p.nome}</option>`);
        
    } catch (err) {
        console.error('Erro ao carregar portos', err);
    }
}

async function loadLocations() {
    try {
        const res = await fetch(locationUrl);
        allLocations = await res.json();
        
        // Dropdown de necessidades
        const selectNecessidade = document.getElementById('necessidadeLocation');
        if (selectNecessidade) {
            selectNecessidade.innerHTML = '<option value="">Selecione a Location</option>';
            allLocations.forEach(l => {
                const nome = l.nome || l.name || l.designacao || `Location ${l.id}`;
                selectNecessidade.innerHTML += `<option value="${l.id}">${nome}</option>`;
            });
        }
        
        // Dropdown de distribui√ß√£o
        const selectDistribuicao = document.getElementById('distribuicaoLocation');
        if (selectDistribuicao) {
            selectDistribuicao.innerHTML = '<option value="">Selecione a unidade sanit√°ria</option>';
            allLocations.forEach(l => {
                const nome = l.nome || l.name || l.designacao || `Location ${l.id}`;
                selectDistribuicao.innerHTML += `<option value="${l.id}">${nome}</option>`;
            });
        }
        
        // Dropdown de confirma√ß√£o
        const selectConfirmacao = document.getElementById('confirmacaoLocal');
        if (selectConfirmacao) {
            selectConfirmacao.innerHTML = '<option value="">Selecione o local</option>';
            allLocations.forEach(l => {
                const nome = l.nome || l.name || l.designacao || `Location ${l.id}`;
                selectConfirmacao.innerHTML += `<option value="${l.id}">${nome}</option>`;
            });
        }
        
    } catch (err) {
        console.error('Erro ao carregar locations', err);
    }
}

async function loadNotasEnvio() {
    try {
        const res = await fetch(notaEnvioUrl);
        allNotasEnvio = await res.json();
        
        const select = document.getElementById('itemNotaEnvio');
        select.innerHTML = '<option value="">Selecione a nota de envio</option>';
        
        allNotasEnvio.forEach(nota => {
            select.innerHTML += `<option value="${nota.id}" 
                data-numero="${nota.numero_nota}" 
                data-observacoes="${nota.observacoes || ''}">
                ${nota.numero_nota} - ${nota.origem} ‚Üí ${nota.destino}
            </option>`;
        });

        select.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            if (selectedOption.value) {
                document.getElementById('itemCodigo').value = selectedOption.getAttribute('data-numero');
                document.getElementById('itemDesignacao').value = selectedOption.getAttribute('data-observacoes');
                carregarItensDaNota(selectedOption.value);
            } else {
                document.getElementById('itemCodigo').value = '';
                document.getElementById('itemDesignacao').value = '';
                document.getElementById('notaEnvioDocumentos').style.display = 'none';
            }
        });

    } catch (err) {
        console.error('Erro ao carregar notas de envio', err);
    }
}

async function loadDistribuicoes() {
    try {
        console.log('üîÑ Carregando distribui√ß√µes...');
        const res = await fetch(distribuicaoUrl);
        distribuicoes = await res.json();
        console.log('‚úÖ Distribui√ß√µes carregadas:', distribuicoes.length);
    } catch (err) {
        console.error('‚ùå Erro ao carregar distribui√ß√µes', err);
    }
}

// ==========================
// üîπ FUN√á√ïES PRINCIPAIS PARA ITENS
// ==========================

async function loadItens() {
    try {
        console.log('üîÑ Iniciando carregamento de itens...');
        
        const res = await fetch(apiUrl);
        allItens = await res.json();
        
        console.log('üì¶ Itens brutos carregados:', allItens.length);
        
        allItens.forEach(item => {
            const armazem = allArmazens.find(a => a.id === item.armazem_id);
            item.armazem_nome = armazem ? armazem.nome : 'N/A';
            
            const porto = allPortos.find(p => p.id === item.porto_id);
            item.porto_nome = porto ? porto.nome : 'N/A';
            
            const distribuido = isItemDistribuido(item.id);
            console.log(`‚úÖ Item ${item.id} processado: distribuido=${distribuido}`);
        });
        
        if (currentView === 'block') {
            renderizarBlocos(allItens);
        } else {
            renderizarTabela(allItens);
        }
        
        // üîπ ATUALIZAR LISTA DE CONFIRMA√á√ïES
        atualizarListaConfirmacoes();
        
        console.log('üì¶ Itens carregados e processados:', allItens.length);
        
    } catch (err) {
        console.error('‚ùå Erro ao carregar itens', err);
        alert('Erro ao carregar itens: ' + err.message);
    }
}

function isItemDistribuido(itemId) {
    return distribuicoes.some(d => d.item_id === itemId);
}

function getDistribuicaoInfo(itemId) {
    const distribuicao = distribuicoes.find(d => d.item_id === itemId);
    
    if (distribuicao) {
        const location = allLocations.find(l => l.id === distribuicao.location_id);
        const locationNome = location ? (location.nome || location.name || location.designacao) : 'Location Desconhecida';
        
        return {
            location: locationNome,
            data: distribuicao.data_distribuicao,
            quantidade: distribuicao.quantidade,
            user: distribuicao.user
        };
    }
    
    return null;
}

// ==========================
// üîπ RENDERIZA√á√ÉO DE ITENS
// ==========================

function renderizarBlocos(itens) {
    const container = document.getElementById('itemBlocksContainer');
    container.innerHTML = '';
    
    itens.forEach(i => {
        const imgSrc = i.imagem ? `data:image/jpeg;base64,${i.imagem}` : '/static/no-image.png';
        const distribuido = isItemDistribuido(i.id);
        const distribuicaoInfo = getDistribuicaoInfo(i.id);
        const temGuiaAssinada = i.guia_assinada_dados;

        const syncClass = i.syncStatus === 'Syncronized' ? 'sync-synchronized' :
                          i.syncStatus === 'Updated' ? 'sync-updated' : 'sync-not-synchronized';

        let expiryBadge = '';
        if (i.data_validade) {
            const diffDays = Math.ceil((new Date(i.data_validade) - new Date()) / (1000*60*60*24));
            if (diffDays <= 30 && diffDays > 0) expiryBadge = `<span class="badge expiry-warning status-badge">Expira em ${diffDays} dias</span>`;
            else if (diffDays <= 0) expiryBadge = `<span class="badge expiry-danger status-badge">Expirado</span>`;
        }

        let localDistribuicao = '';
        if (distribuido && distribuicaoInfo) {
            localDistribuicao = `<br><small class="text-success"><strong>Local: ${distribuicaoInfo.location}</strong></small>`;
        }

        // üîπ BADGE DE CONFIRMA√á√ÉO DE RECEP√á√ÉO
        const confirmacaoBadge = temGuiaAssinada ? 
            `<span class="badge bg-success confirmacao-badge" style="position: absolute; top: 10px; right: 120px;">
                <i class="bi bi-clipboard-check"></i> Recep√ß√£o Confirmada
            </span>` : '';

        container.innerHTML += `
        <div class="col-md-6 col-lg-4 col-xl-3">
            <div class="card card-item ${distribuido ? 'distribuido' : 'nao-distribuido'}" 
                 data-item-id="${i.id}" 
                 data-item-distribuido="${distribuido}">
                <span class="badge ${syncClass} sync-badge">${i.syncStatus || 'Not Syncronized'}</span>
                ${expiryBadge}
                ${confirmacaoBadge}
                <span class="badge ${distribuido ? 'bg-success' : 'bg-danger'} distribuicao-badge">
                    <i class="bi bi-${distribuido ? 'check' : 'x'}-circle"></i> ${distribuido ? 'Distribu√≠do' : 'N√£o Distribu√≠do'}
                </span>
                <div class="card-img-container">
                    <img src="${imgSrc}" class="card-img-top" alt="${i.designacao}">
                </div>
                <div class="card-body">
                    <h5 class="card-title">${i.designacao}</h5>
                    <p class="card-text">
                        <small class="text-muted">id: ${i.id}</small><br>
                        <small class="text-muted">C√≥digo: ${i.codigo}</small><br>
                        <small class="text-muted">Quantidade: ${i.quantidade || 0}</small><br>
                        <small class="text-muted">Batch: ${i.batch_no || 'N/A'}</small><br>
                        <small class="text-muted">Validade: ${i.data_validade ? i.data_validade.slice(0,10) : 'N/A'}</small><br>
                        <small class="text-muted">Armaz√©m: ${i.armazem_nome || 'N/A'}</small>
                        ${i.recebeu ? `<br><small class="text-success"><strong>Recebido por: ${i.recebeu}</strong></small>` : ''}
                        ${localDistribuicao}
                    </p>
                    <div class="card-actions">
                        <button class="btn btn-sm btn-warning" onclick="editarItem(${i.id})" title="Editar"><i class="bi bi-pencil-square"></i></button>
                        <button class="btn btn-sm btn-danger" onclick="eliminarItem(${i.id})" title="Apagar"><i class="bi bi-trash"></i></button>
                        <button class="btn btn-sm btn-info" onclick="abrirDetalhes(${i.id})" title="Detalhes"><i class="bi bi-info-circle"></i></button>
                        <button class="btn btn-sm btn-primary me-1" onclick="abrirEntradaStock(${i.id})" title="Stock">
                          <i class="bi bi-box-arrow-in-down"></i>
                        </button>
                        <button class="btn btn-sm btn-success" onclick="abrirDistribuicao(${i.id})" title="Distribuir"><i class="bi bi-share"></i></button>
                    </div>
                </div>
            </div>
        </div>`;
    });
}

function renderizarTabela(itens) {
    const tbody = document.getElementById('itemTableBody');
    tbody.innerHTML = '';
    
    itens.forEach(i => {
        const imgSrc = i.imagem ? `data:image/jpeg;base64,${i.imagem}` : '/static/no-image.png';
        const distribuido = isItemDistribuido(i.id);
        
        tbody.innerHTML += `
            <tr>
                <td>${i.id}</td>
                <td><img src="${imgSrc}" alt="${i.designacao}" style="max-width: 50px; max-height: 50px;"></td>
                <td>${i.codigo}</td>
                <td>${i.designacao}</td>
                <td>${i.hs_code || 'N/A'}</td>
                <td>${i.quantidade || 0}</td>
                <td>${i.batch_no || 'N/A'}</td>
                <td>${i.data_fabricacao ? i.data_fabricacao.slice(0,10) : 'N/A'}</td>
                <td>${i.data_validade ? i.data_validade.slice(0,10) : 'N/A'}</td>
                <td>${i.no_cartoes || 'N/A'}</td>
                <td><span class="badge ${i.syncStatus === 'Syncronized' ? 'bg-success' : i.syncStatus === 'Updated' ? 'bg-info' : 'bg-secondary'}">${i.syncStatus || 'Not Syncronized'}</span></td>
                <td><span class="badge ${distribuido ? 'bg-success' : 'bg-danger'}">${distribuido ? '‚úì' : '‚úó'}</span></td>
                <td>${i.user || 'N/A'}</td>
                <td>
                    <button class="btn btn-sm btn-warning me-1" onclick="editarItem(${i.id})" title="Editar">
                        <i class="bi bi-pencil-square"></i>
                    </button>
                    <button class="btn btn-sm btn-danger me-1" onclick="eliminarItem(${i.id})" title="Apagar">
                        <i class="bi bi-trash"></i>
                    </button>
                    <button class="btn btn-sm btn-info me-1" onclick="abrirDetalhes(${i.id})" title="Detalhes">
                        <i class="bi bi-info-circle"></i>
                    </button>
                    <button class="btn btn-sm btn-primary me-1" onclick="abrirEntradaStock(${i.id})" title="Stock">
                        <i class="bi bi-box-arrow-in-down"></i>
                    </button>
                    <button class="btn btn-sm btn-success" onclick="abrirDistribuicao(${i.id})" title="Distribuir">
                        <i class="bi bi-share"></i>
                    </button>
                </td>
            </tr>`;
    });
}

// ==========================
// üîπ FUN√á√ïES PARA ITENS PENDENTES (MANTIDAS)
// ==========================

async function carregarItensPendentes() {
    try {
        const res = await fetch(itensPendentesUrl);
        itensPendentes = await res.json();
        atualizarListaItensPendentes();
    } catch (err) {
        console.error('Erro ao carregar itens pendentes:', err);
        document.getElementById('listaItensPendentes').innerHTML = '<p class="text-danger">Erro ao carregar itens pendentes.</p>';
    }
}

function atualizarListaItensPendentes() {
    const container = document.getElementById('listaItensPendentes');
    
    if (!itensPendentes || itensPendentes.length === 0) {
        container.innerHTML = '<p class="text-muted">Nenhum item pendente registrado.</p>';
        return;
    }

    let html = '';
    itensPendentes.forEach(item => {
        const dataEntrega = item.data_esperada_entrega ? new Date(item.data_esperada_entrega).toLocaleDateString('pt-BR') : 'N√£o definida';
        const statusClass = item.status === 'concluido' ? 'concluido' : '';
        const prioridadeClass = item.prioridade;
        
        html += `
            <div class="card item-pendente-card ${statusClass} ${prioridadeClass} mb-2">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <h6 class="card-title mb-1">${item.nome_item}</h6>
                            <div class="d-flex flex-wrap gap-2 mb-2">
                                <span class="badge prioridade-badge ${getPrioridadeBadgeClass(item.prioridade)}">
                                    ${getPrioridadeTexto(item.prioridade)}
                                </span>
                                ${item.categoria ? `<span class="badge bg-secondary prioridade-badge">${item.categoria}</span>` : ''}
                                ${item.quantidade_esperada ? `<span class="badge bg-info prioridade-badge">Qtd: ${item.quantidade_esperada}</span>` : ''}
                            </div>
                            ${item.observacoes ? `<p class="card-text small mb-1">${item.observacoes}</p>` : ''}
                            <div class="text-muted small">
                                ${item.fornecedor_origem ? `<div>Fornecedor: ${item.fornecedor_origem}</div>` : ''}
                                <div>Entrega: ${dataEntrega}</div>
                                <div>Registrado em: ${new Date(item.data_registro).toLocaleDateString('pt-BR')}</div>
                            </div>
                        </div>
                        <div class="btn-group btn-group-sm">
                            ${item.status !== 'concluido' ? `
                                <button class="btn btn-outline-success" onclick="marcarComoRecebido(${item.id})" title="Marcar como recebido">
                                    <i class="bi bi-check-lg"></i>
                                </button>
                            ` : ''}
                            <button class="btn btn-outline-danger" onclick="removerItemPendente(${item.id})" title="Remover">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });

    container.innerHTML = html;
}

function getPrioridadeBadgeClass(prioridade) {
    const classes = {
        'baixa': 'bg-secondary',
        'media': 'bg-primary',
        'alta': 'bg-warning',
        'urgente': 'bg-danger'
    };
    return classes[prioridade] || 'bg-secondary';
}

function getPrioridadeTexto(prioridade) {
    const textos = {
        'baixa': 'Baixa',
        'media': 'M√©dia',
        'alta': 'Alta',
        'urgente': 'Urgente'
    };
    return textos[prioridade] || 'M√©dia';
}

document.getElementById('itemPendenteForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const payload = {
        nome_item: document.getElementById('itemPendenteNome').value,
        quantidade_esperada: parseInt(document.getElementById('itemPendenteQuantidade').value) || null,
        prioridade: document.getElementById('itemPendentePrioridade').value,
        categoria: document.getElementById('itemPendenteCategoria').value || null,
        data_esperada_entrega: document.getElementById('itemPendenteDataEntrega').value || null,
        observacoes: document.getElementById('itemPendenteObservacoes').value || null,
        fornecedor_origem: document.getElementById('itemPendenteFornecedor').value || null,
        user: "{{ username }}"
    };

    try {
        const res = await fetch(itensPendentesUrl, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });

        if (!res.ok) throw await res.json();

        limparFormPendente();
        await carregarItensPendentes();
        alert('Item pendente registrado com sucesso!');
        
    } catch (err) {
        alert('Erro ao registrar item pendente: ' + (err.message || 'Erro desconhecido'));
        console.error(err);
    }
});

function limparFormPendente() {
    document.getElementById('itemPendenteForm').reset();
    document.getElementById('itemPendentePrioridade').value = 'media';
}

async function marcarComoRecebido(id) {
    if (!confirm('Deseja marcar este item como recebido?')) return;
    
    try {
        const res = await fetch(`${itensPendentesUrl}/${id}/concluir`, {
            method: 'PUT'
        });

        if (!res.ok) throw await res.json();
        
        await carregarItensPendentes();
        alert('Item marcado como recebido!');
        
    } catch (err) {
        alert('Erro ao marcar item como recebido: ' + (err.message || 'Erro desconhecido'));
        console.error(err);
    }
}

async function removerItemPendente(id) {
    if (!confirm('Deseja remover este item pendente?')) return;
    
    try {
        const res = await fetch(`${itensPendentesUrl}/${id}`, {
            method: 'DELETE'
        });

        if (!res.ok) throw await res.json();
        
        await carregarItensPendentes();
        alert('Item pendente removido!');
        
    } catch (err) {
        alert('Erro ao remover item pendente: ' + (err.message || 'Erro desconhecido'));
        console.error(err);
    }
}

// ==========================
// üîπ ANIMA√á√ïES DE DISTRIBUI√á√ÉO (MANTIDAS)
// ==========================

function iniciarAnimacaoDistribuicao() {
    if (animationInterval) clearInterval(animationInterval);
    
    currentAnimationIndex = 0;
    isAnimationPaused = false;
    
    setTimeout(() => {
        const itensDistribuidos = allItens.filter(item => isItemDistribuido(item.id));
        if (itensDistribuidos.length > 0) {
            console.log('üéØ Itens distribu√≠dos encontrados:', itensDistribuidos.length);
            iniciarAnimacaoSequencial(itensDistribuidos);
        }
    }, 500);
}

function iniciarAnimacaoSequencial(itens) {
    if (animationInterval) clearInterval(animationInterval);
    
    animationInterval = setInterval(() => {
        if (!isAnimationPaused && currentAnimationIndex < itens.length) {
            const item = itens[currentAnimationIndex];
            criarAnimacaoDistribuicao(item, currentAnimationIndex);
            currentAnimationIndex++;
            
            if (currentAnimationIndex >= itens.length) {
                currentAnimationIndex = 0;
            }
        }
    }, 3000);
}

function criarAnimacaoDistribuicao(item, index) {
    const animationLines = document.getElementById('animationLines');
    const hospitalIcon = document.querySelector('.hospital-icon');
    
    let cardElement = document.querySelector(`.card-item[data-item-id="${item.id}"]`);
    
    if (!cardElement) {
        cardElement = document.querySelector(`[data-item-id="${item.id}"]`);
    }
    
    if (!cardElement || !hospitalIcon) {
        console.warn('‚ùå Elemento n√£o encontrado para anima√ß√£o:', item.id);
        return;
    }

    const cardRect = cardElement.getBoundingClientRect();
    const hospitalRect = hospitalIcon.getBoundingClientRect();
    
    if (cardRect.width === 0 || cardRect.height === 0) {
        console.warn('‚ö†Ô∏è Elemento do item n√£o est√° vis√≠vel:', item.id);
        return;
    }
    
    const startX = hospitalRect.left + hospitalRect.width / 2;
    const startY = hospitalRect.top + hospitalRect.height / 2;
    const endX = cardRect.left + cardRect.width / 2;
    const endY = cardRect.top + cardRect.height / 2;
    
    const distance = Math.sqrt(Math.pow(endX - startX, 2) + Math.pow(endY - startY, 2));
    const angle = Math.atan2(endY - startY, endX - startX) * 180 / Math.PI;
    
    const line = document.createElement('div');
    line.className = 'distribution-line';
    line.style.cssText = `
        top: ${startY}px;
        left: ${startX}px;
        width: ${distance}px;
        transform: rotate(${angle}deg);
        z-index: ${999 - index};
    `;
    animationLines.appendChild(line);
    
    const connectionPoint = document.createElement('div');
    connectionPoint.className = 'item-connection-point';
    connectionPoint.style.cssText = `
        top: ${endY - 6}px;
        left: ${endX - 6}px;
    `;
    animationLines.appendChild(connectionPoint);
    
    cardElement.classList.add('item-distributed');
    
    setTimeout(() => {
        if (line.parentNode) line.parentNode.removeChild(line);
        if (connectionPoint.parentNode) connectionPoint.parentNode.removeChild(connectionPoint);
        cardElement.classList.remove('item-distributed');
    }, 4000);
}

function pausarAnimacao() {
    isAnimationPaused = !isAnimationPaused;
    
    const pauseButton = document.querySelector('[onclick="pausarAnimacao()"]');
    if (isAnimationPaused) {
        pauseButton.innerHTML = '<i class="bi bi-play"></i>';
        pauseButton.classList.remove('btn-outline-secondary');
        pauseButton.classList.add('btn-outline-success');
    } else {
        pauseButton.innerHTML = '<i class="bi bi-pause"></i>';
        pauseButton.classList.remove('btn-outline-success');
        pauseButton.classList.add('btn-outline-secondary');
    }
}

function animarTodosItens() {
    const itensDistribuidos = allItens.filter(item => isItemDistribuido(item.id));
    const animationLines = document.getElementById('animationLines');
    
    // Limpar anima√ß√µes anteriores
    animationLines.innerHTML = '';
    
    // Animar todos os itens simultaneamente
    itensDistribuidos.forEach((item, index) => {
        setTimeout(() => {
            criarAnimacaoDistribuicao(item, index);
        }, index * 200);
    });
}

// ==========================
// üîπ FUN√á√ïES ADICIONAIS EXISTENTES (MANTIDAS)
// ==========================

function toggleView(viewType) {
    currentView = viewType;
    document.getElementById('tableViewContainer').style.display = viewType === 'table' ? 'block' : 'none';
    document.getElementById('blockViewContainer').style.display = viewType === 'table' ? 'none' : 'block';
    filtrarItens(document.getElementById('itemSearch').value);
    
    setTimeout(() => {
        iniciarAnimacaoDistribuicao();
    }, 800);
}

function filtrarItens(query) {
    const termo = query?.toLowerCase() || '';
    
    const itensFiltrados = allItens.filter(i =>
        (i.codigo || '').toLowerCase().includes(termo) ||
        (i.designacao || '').toLowerCase().includes(termo) ||
        (i.hs_code || '').toLowerCase().includes(termo) ||
        (i.batch_no || '').toLowerCase().includes(termo) ||
        (i.armazem_nome || '').toLowerCase().includes(termo) ||
        (i.porto_nome || '').toLowerCase().includes(termo)
    );
    
    if (currentView === 'block') {
        renderizarBlocos(itensFiltrados);
    } else {
        renderizarTabela(itensFiltrados);
    }
}

function previewPDF(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => {
        pdfBase64 = e.target.result.split(',')[1];
        document.getElementById('previewPdf').innerHTML = `<a href="${e.target.result}" download="${file.name}">üìÑ ${file.name}</a>`;
    };
    reader.readAsDataURL(file);
}

// ==========================
// üîπ Salvar Item - VERS√ÉO ATUALIZADA COM USERNAME
// ==========================
document.getElementById('itemForm').addEventListener('submit', async e => {
    e.preventDefault();
    const id = document.getElementById('itemId').value;
    const notaEnvioId = document.getElementById('itemNotaEnvio').value;
    
    const payload = {
        codigo: document.getElementById('itemCodigo').value,
        designacao: document.getElementById('itemDesignacao').value,
        hs_code: document.getElementById('itemHsCode').value,
        quantidade: parseInt(document.getElementById('itemQuantidade').value) || null,
        batch_no: document.getElementById('itemBatchNo').value,
        data_fabricacao: document.getElementById('itemDataFabricacao').value || null,
        data_validade: document.getElementById('itemDataValidade').value || null,
        no_cartoes: parseInt(document.getElementById('itemNoCartoes').value) || null,
        peso_bruto_total: parseFloat(document.getElementById('itemPesoBruto').value) || null,
        volume_total_cbm: parseFloat(document.getElementById('itemVolumeCBM').value) || null,
        total_cartoes: parseInt(document.getElementById('itemTotalCartoes').value) || null,
        total_paletes: parseInt(document.getElementById('itemTotalPaletes').value) || null,
        dimensoes_palete_cm: document.getElementById('itemDimensoesPalete').value,
        armazem_id: parseInt(document.getElementById('itemArmazem').value),
        porto_id: document.getElementById('itemPorto').value ? parseInt(document.getElementById('itemPorto').value) : null,
        observacoes: document.getElementById('itemObservacoes').value,
        imagem: imagemBase64,
        pdf_nome: document.getElementById('previewPdf').querySelector('a')?.textContent || null,
        pdf_dados: pdfBase64,
        syncStatus: document.getElementById('itemSyncStatus').value,
        syncStatusDate: document.getElementById('itemSyncDate').value 
            ? new Date(document.getElementById('itemSyncDate').value).toISOString() 
            : null,
        nota_envio_id: notaEnvioId ? parseInt(notaEnvioId) : null,
        user: "{{ username }}" // ‚úÖ ADICIONADO: Registrar username do usu√°rio
    };

    try {
        const res = await fetch(id ? `${apiUrl}/${id}` : apiUrl, {
            method: id ? 'PUT' : 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(payload)
        });
        if (!res.ok) throw await res.json();
        
        imagemBase64 = null;
        pdfBase64 = null;
        bootstrap.Modal.getInstance(document.getElementById('itemModal')).hide();
        document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
        loadItens();
    } catch(err) {
        alert(err.message || 'Erro ao salvar item');
    }
});

// ==========================
// üîπ Abrir Entrada de Stock - VERS√ÉO CORRIGIDA
// ==========================
function abrirEntradaStock(id) {
    document.getElementById('entradaItemId').value = id;
    document.getElementById('entradaQuantidade').value = '';
    document.getElementById('entradaObservacoes').value = '';
    document.getElementById('necessidadeQuantidade').value = '';
    document.getElementById('necessidadeDescricao').value = '';
    
    // ‚úÖ Garantir que locations estejam atualizadas
    loadLocations();
    carregarHistoricoModal(id);
    carregarNecessidades(id);
    
    new bootstrap.Modal(document.getElementById('entradaStockModal')).show();
}

// ==========================
// üîπ Carregar Necessidades - VERS√ÉO CORRIGIDA
// ==========================
async function carregarNecessidades(id) {
    try {
        const res = await fetch(`/api/item/${id}/necessidades`);
        const necessidades = await res.json();

        if (!necessidades || !necessidades.length) {
            document.getElementById('listaNecessidadesContainer').innerHTML = '<p class="text-muted">Nenhuma necessidade registrada.</p>';
            return;
        }

        let html = `<table class="table table-striped table-bordered table-sm align-middle">
            <thead class="table-dark">
                <tr>
                    <th>#</th>
                    <th>Quantidade</th>
                    <th>Descricao</th>
                    <th>Location</th>
                    <th>Data</th>
                    <th>A√ß√µes</th>
                </tr>
            </thead>
            <tbody>`;

        necessidades.forEach((n, index) => {
            const loc = allLocations.find(l => l.id === n.location_id);
            const locName = loc ? loc.nome || loc.name || loc.designacao : ('Location ' + (n.location_id || ''));
            html += `<tr>
                <td>${index + 1}</td>
                <td><strong>${n.quantidade}</strong></td>
                <td>${n.descricao || '<span class="text-muted">-</span>'}</td>
                <td>${locName}</td>
                <td>${new Date(n.data_registro).toLocaleString('pt-BR')}</td>
                <td>
                    <button class="btn btn-sm btn-danger" onclick="removerNecessidade(${n.id}, ${id})" title="Eliminar necessidade">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            </tr>`;
        });

        html += `</tbody></table>`;
        document.getElementById('listaNecessidadesContainer').innerHTML = html;
    } catch (err) {
        document.getElementById('listaNecessidadesContainer').innerHTML = '<p class="text-danger">Erro ao carregar necessidades.</p>';
        console.error(err);
    }
}

// ==========================
// üîπ Carregar Hist√≥rico no Modal - VERS√ÉO CORRIGIDA
// ==========================
async function carregarHistoricoModal(id) {
    try {
        const res = await fetch(`/api/item/${id}/historico`);
        const historico = await res.json();

        if (!historico || !historico.length) {
            document.getElementById('historicoStockModalContainer').innerHTML = '<p class="text-muted">Nenhum hist√≥rico registrado.</p>';
            return;
        }

        let html = `<table class="table table-striped table-bordered table-sm align-middle">
            <thead class="table-dark">
                <tr>
                    <th>#</th>
                    <th>Tipo Movimento</th>
                    <th>Quantidade</th>
                    <th>Data</th>
                    <th>Observa√ß√µes</th>
                    <th>User</th>
                    <th>A√ß√µes</th>
                </tr>
            </thead>
            <tbody>`;

        historico.forEach((h, index) => {
            html += `<tr>
                <td>${index + 1}</td>
                <td>
                    <span class="badge ${h.tipo_movimento === 'entrada' ? 'bg-success' : 'bg-warning'}">
                        ${h.tipo_movimento.toUpperCase()}
                    </span>
                </td>
                <td><strong>${h.quantidade}</strong></td>
                <td>${new Date(h.data_movimento).toLocaleString('pt-BR')}</td>
                <td>${h.observacoes || '<span class="text-muted">-</span>'}</td>
                <td><small class="text-muted">${h.user || 'Sistema'}</small></td>
                <td>
                    <button class="btn btn-sm btn-outline-danger" onclick="removerHistorico(${h.id}, ${id})" title="Remover hist√≥rico">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            </tr>`;
        });

        html += `</tbody></table>`;
        document.getElementById('historicoStockModalContainer').innerHTML = html;
    } catch (err) {
        document.getElementById('historicoStockModalContainer').innerHTML = '<p class="text-danger">Erro ao carregar hist√≥rico.</p>';
        console.error(err);
    }
}

// ==========================
// üîπ Adicionar Necessidade - NOVA FUN√á√ÉO
// ==========================
async function adicionarNecessidade() {
    const id = parseInt(document.getElementById('entradaItemId').value);
    const quantidade = parseInt(document.getElementById('necessidadeQuantidade').value);
    const descricao = document.getElementById('necessidadeDescricao').value;
    const location_id = parseInt(document.getElementById('necessidadeLocation').value);

    if (!quantidade || quantidade <= 0) {
        alert('Informe uma quantidade v√°lida');
        return;
    }
    if (!location_id) {
        alert('Selecione a Location para a necessidade');
        return;
    }

    try {
        const payload = {
            item_id: id,
            location_id: location_id,
            quantidade: quantidade,
            descricao: descricao,
            user: "{{ username }}"
        };

        const res = await fetch(`/api/item/${id}/necessidades`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (!res.ok) {
            const err = await res.json();
            throw new Error(err.error || 'Erro ao adicionar necessidade');
        }

        // Atualiza a lista de necessidades
        await carregarNecessidades(id);

        // Limpa os campos do formul√°rio
        document.getElementById('necessidadeQuantidade').value = '';
        document.getElementById('necessidadeDescricao').value = '';
        document.getElementById('necessidadeLocation').value = '';

        alert('Necessidade adicionada com sucesso!');
    } catch (err) {
        alert('Erro ao adicionar necessidade: ' + err.message);
        console.error(err);
    }
}

// ==========================
// üîπ Remover Necessidade - NOVA FUN√á√ÉO
// ==========================
async function removerNecessidade(necessidadeId, itemId) {
    if (!confirm('Deseja realmente eliminar esta necessidade?')) return;

    try {
        const res = await fetch(`/api/necessidade/${necessidadeId}`, { method: 'DELETE' });
        if (!res.ok) throw await res.json();
        await carregarNecessidades(itemId); // recarrega a lista
    } catch (err) {
        alert(err.message || 'Erro ao eliminar necessidade');
        console.error(err);
    }
}

// ==========================
// üîπ Remover Hist√≥rico - NOVA FUN√á√ÉO
// ==========================
async function removerHistorico(historicoId, itemId) {
    if (!confirm('Deseja realmente remover este movimento de hist√≥rico?')) return;

    try {
        const res = await fetch(`/api/historico/${historicoId}`, { method: 'DELETE' });
        if (!res.ok) throw await res.json();
        // Recarrega o hist√≥rico do modal
        await carregarHistoricoModal(itemId);
    } catch (err) {
        alert(err.message || 'Erro ao remover hist√≥rico');
        console.error(err);
    }
}

function abrirDistribuicao(itemId) {
    const item = allItens.find(i => i.id === itemId);
    if (!item) return;

    document.getElementById('distribuicaoItemId').value = item.id;
    document.getElementById('distribuicaoItemImg').src = item.imagem 
        ? `data:image/jpeg;base64,${item.imagem}` 
        : '/static/no-image.png';
    document.getElementById('distribuicaoItemDescricao').textContent = item.designacao || '';
    document.getElementById('distribuicaoItemHSCode').textContent = item.hs_code || '';

    const armazemSelect = document.getElementById('distribuicaoArmazem');
    armazemSelect.innerHTML = '<option value="">Selecione o armaz√©m</option>';
    allArmazens.forEach(a => armazemSelect.innerHTML += `<option value="${a.id}">${a.nome}</option>`);

    const locationSelect = document.getElementById('distribuicaoLocation');
    locationSelect.innerHTML = '<option value="">Selecione a unidade sanit√°ria</option>';
    allLocations.forEach(l => locationSelect.innerHTML += `<option value="${l.id}">${l.nome || l.name || l.designacao}</option>`);

    document.getElementById('distribuicaoQuantidade').value = '';
    document.getElementById('distribuicaoData').value = '';
    document.getElementById('distribuicaoObservacao').value = '';

    new bootstrap.Modal(document.getElementById('distribuicaoModal')).show();
}

// Apagar item
async function eliminarItem(id) {
    if (!confirm('Tem certeza que deseja apagar este item?')) return;
    try {
        const res = await fetch(`${apiUrl}/${id}`, { method: 'DELETE' });
        if (!res.ok) throw await res.json();
        loadItens();
    } catch(err) {
        alert(err.message || 'Erro ao apagar item');
    }
}

// Abrir detalhes do item e carregar hist√≥rico de stock dentro do painel
async function abrirDetalhes(id) {
    const i = allItens.find(item => item.id === id);
    if (!i) return;

    const imgSrc = i.imagem ? `data:image/jpeg;base64,${i.imagem}` : '/static/no-image.png';
    const pdfLink = i.pdf_dados ? `<a href="data:application/pdf;base64,${i.pdf_dados}" download="${i.pdf_nome}">üìÑ ${i.pdf_nome}</a>` : '';
    const distribuido = isItemDistribuido(i.id);
    const distribuicaoInfo = getDistribuicaoInfo(i.id);

    let html = `
        <h5>${i.designacao}</h5>
        <img src="${imgSrc}" style="width:100%; max-height:200px; object-fit:cover; margin-bottom:10px;">
        <ul class="list-group list-group-flush">
            <li class="list-group-item"><strong>C√≥digo:</strong> ${i.codigo}</li>
            <li class="list-group-item"><strong>HS Code:</strong> ${i.hs_code || ''}</li>
            <li class="list-group-item"><strong>Quantidade:</strong> ${i.quantidade || ''}</li>
            <li class="list-group-item"><strong>Batch No:</strong> ${i.batch_no || ''}</li>
            <li class="list-group-item"><strong>MFG Date:</strong> ${i.data_fabricacao ? i.data_fabricacao.slice(0,10) : ''}</li>
            <li class="list-group-item"><strong>Expiry Date:</strong> ${i.data_validade ? i.data_validade.slice(0,10) : ''}</li>
            <li class="list-group-item"><strong>No. Cartons:</strong> ${i.no_cartoes || ''}</li>
            <li class="list-group-item"><strong>Peso Bruto:</strong> ${i.peso_bruto_total || ''}</li>
            <li class="list-group-item"><strong>Volume CBM:</strong> ${i.volume_total_cbm || ''}</li>
            <li class="list-group-item"><strong>Total Cartons:</strong> ${i.total_cartoes || ''}</li>
            <li class="list-group-item"><strong>Total Paletes:</strong> ${i.total_paletes || ''}</li>
            <li class="list-group-item"><strong>Dimens√µes Palete:</strong> ${i.dimensoes_palete_cm || ''}</li>
            <li class="list-group-item"><strong>Armaz√©m:</strong> ${i.armazem_nome || ''}</li>
            <li class="list-group-item"><strong>Porto:</strong> ${i.porto_nome || ''}</li>
            <li class="list-group-item"><strong>Observa√ß√µes:</strong> ${i.observacoes || ''}</li>
            <li class="list-group-item">${pdfLink}</li>
            <li class="list-group-item"><strong>Sync Status:</strong> ${i.syncStatus || ''}</li>
            <li class="list-group-item"><strong>Sync Date:</strong> ${i.syncStatusDate ? i.syncStatusDate.slice(0,16) : ''}</li>
            <li class="list-group-item"><strong>Status Distribui√ß√£o:</strong> ${distribuido ? 
                `<span class="badge bg-success">‚úì Distribu√≠do</span><br>
                 <small>Local: ${distribuicaoInfo ? distribuicaoInfo.location : 'N/A'}</small><br>
                 <small>Data: ${distribuicaoInfo ? distribuicaoInfo.data.slice(0,10) : 'N/A'}</small><br>
                 <small>Quantidade: ${distribuicaoInfo ? distribuicaoInfo.quantidade : 'N/A'}</small><br>
                 <small>User: ${distribuicaoInfo ? distribuicaoInfo.user : 'N/A'}</small>` : 
                `<span class="badge bg-danger">N√£o Distribu√≠do</span>`}
            </li>
        </ul>
        <hr>
        <div id="historicoStockContent">
            <h6>Hist√≥rico de Movimenta√ß√µes de Stock:</h6>
            <p>Carregando...</p>
        </div>
    `;

    document.getElementById('detalhesContent').innerHTML = html;
    document.getElementById('detalhesPanel').style.right = '0';

    const res = await fetch(`/api/item/${id}/historico`);
    const historico = await res.json();
    let historicoHtml = '<ul class="list-group">';
    
    historico.forEach(h => {
        historicoHtml += `<li class="list-group-item">
            ${h.tipo_movimento.toUpperCase()} - Qtd: ${h.quantidade} - 
            ${new Date(h.data_movimento).toLocaleString()} - 
            ${h.observacoes || ''}
            ${h.user || ''}
        </li>`;
    });
    historicoHtml += '</ul>';

    document.getElementById('historicoStockContent').innerHTML = historicoHtml;
}

function fecharDetalhes() {
    document.getElementById('detalhesPanel').style.right = '-420px';
}

// Exportar Excel
function downloadExcel() {
    alert('Funcionalidade de exporta√ß√£o em constru√ß√£o.');
}

// Upload de arquivos
function previewImagem(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => {
        imagemBase64 = e.target.result.split(',')[1];
        const img = document.getElementById('previewImg');
        img.src = e.target.result;
        img.style.display = 'block';
    };
    reader.readAsDataURL(file);
}

function previewPDF(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => {
        pdfBase64 = e.target.result.split(',')[1];
        document.getElementById('previewPdf').innerHTML = `<a href="${e.target.result}" download="${file.name}">üìÑ ${file.name}</a>`;
    };
    reader.readAsDataURL(file);
}

// ==========================
// üîπ Abrir Modal Item - VERS√ÉO CORRIGIDA
// ==========================
function abrirModalItem() {
    document.getElementById('itemForm').reset();
    document.getElementById('itemId').value = '';
    document.getElementById('previewImg').style.display = 'none';
    document.getElementById('previewPdf').innerHTML = '';
    document.getElementById('notaEnvioDocumentos').style.display = 'none'; // ‚úÖ Esconder documentos
    imagemBase64 = null;
    pdfBase64 = null;
    
    // ‚úÖ Resetar a sele√ß√£o da nota de envio
    document.getElementById('itemNotaEnvio').selectedIndex = 0;
    
    new bootstrap.Modal(document.getElementById('itemModal')).show();
}

// ==========================
// üîπ Editar Item - VERS√ÉO CORRIGIDA
// ==========================
function editarItem(id) {
    const i = allItens.find(item => item.id === id);
    if (!i) return;

    document.getElementById('itemId').value = i.id;
    document.getElementById('itemCodigo').value = i.codigo || '';
    document.getElementById('itemDesignacao').value = i.designacao || '';
    document.getElementById('itemHsCode').value = i.hs_code || '';
    document.getElementById('itemQuantidade').value = i.quantidade || '';
    document.getElementById('itemBatchNo').value = i.batch_no || '';
    document.getElementById('itemDataFabricacao').value = i.data_fabricacao ? i.data_fabricacao.slice(0,10) : '';
    document.getElementById('itemDataValidade').value = i.data_validade ? i.data_validade.slice(0,10) : '';
    document.getElementById('itemNoCartoes').value = i.no_cartoes || '';
    document.getElementById('itemPesoBruto').value = i.peso_bruto_total || '';
    document.getElementById('itemVolumeCBM').value = i.volume_total_cbm || '';
    document.getElementById('itemTotalCartoes').value = i.total_cartoes || '';
    document.getElementById('itemTotalPaletes').value = i.total_paletes || '';
    document.getElementById('itemDimensoesPalete').value = i.dimensoes_palete_cm || '';
    document.getElementById('itemArmazem').value = i.armazem_id || '';
    document.getElementById('itemPorto').value = i.porto_id || '';
    document.getElementById('itemObservacoes').value = i.observacoes || '';
    document.getElementById('itemSyncStatus').value = i.syncStatus || 'Not Syncronized';
    document.getElementById('itemSyncDate').value = i.syncStatusDate ? i.syncStatusDate.slice(0,16) : '';

    // ‚úÖ Se o item tem uma nota de envio associada, selecion√°-la
    if (i.nota_envio_id) {
        document.getElementById('itemNotaEnvio').value = i.nota_envio_id;
        // Carregar documentos da nota associada
        carregarItensDaNota(i.nota_envio_id);
    } else {
        document.getElementById('itemNotaEnvio').selectedIndex = 0;
        document.getElementById('notaEnvioDocumentos').style.display = 'none';
    }

    if (i.imagem) {
        document.getElementById('previewImg').src = `data:image/jpeg;base64,${i.imagem}`;
        document.getElementById('previewImg').style.display = 'block';
    }
    if (i.pdf_dados) {
        document.getElementById('previewPdf').innerHTML = `<a href="data:application/pdf;base64,${i.pdf_dados}" download="${i.pdf_nome}">üìÑ ${i.pdf_nome}</a>`;
    }
    
    new bootstrap.Modal(document.getElementById('itemModal')).show();
}

// ==========================
// üîπ INICIALIZA√á√ÉO DE DATA ATUAL
// ==========================
document.addEventListener('DOMContentLoaded', function() {
    const dataInput = document.getElementById('confirmacaoDataRecepcao');
    if (dataInput) {
        dataInput.value = new Date().toISOString().split('T')[0];
    }
});

// Inicializar quando a tab for mostrada
document.addEventListener('DOMContentLoaded', function() {
    const confirmacaoTab = document.getElementById('confirmacao-tab');
    if (confirmacaoTab) {
        confirmacaoTab.addEventListener('shown.bs.tab', function() {
            inicializarConfirmacao();
        });
    }
});

// ==========================
// üîπ FUN√á√ÉO PARA CARREGAR ITENS DA NOTA
// ==========================
async function carregarItensDaNota(notaId) {
    try {
        const res = await fetch(`${notaEnvioUrl}/${notaId}`);
        const nota = await res.json();
        
        // ‚úÖ Mostrar documentos da nota
        mostrarDocumentosNota(nota.documentos);
        
        // ‚úÖ Se a nota tiver itens, podemos mostrar ou preencher algo adicional
        if (nota.itens && nota.itens.length > 0) {
            console.log('Itens da nota:', nota.itens);
        }
        
    } catch (err) {
        console.error('Erro ao carregar itens da nota', err);
    }
}

// ==========================
// üîπ FUN√á√ÉO PARA MOSTRAR DOCUMENTOS DA NOTA
// ==========================
function mostrarDocumentosNota(documentos) {
    const container = document.getElementById('notaEnvioDocumentos');
    const lista = document.getElementById('notaEnvioDocsList');
    
    lista.innerHTML = '';
    
    if (documentos && documentos.length > 0) {
        container.style.display = 'block';
        
        documentos.forEach(doc => {
            lista.innerHTML += `
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span>üìé ${doc.nome_arquivo}</span>
                    <a href="/api/notaenviodocument/${doc.id}/download" 
                       target="_blank" 
                       class="btn btn-sm btn-outline-primary">
                       <i class="bi bi-download"></i>
                    </a>
                </li>`;
        });
    } else {
        container.style.display = 'none';
    }
}

// ==========================
// üîπ FORMUL√ÅRIO ENTRADA STOCK
// ==========================
document.getElementById('entradaStockForm').addEventListener('submit', async e => {
    e.preventDefault();
    const id = parseInt(document.getElementById('entradaItemId').value);
    const quantidade = parseInt(document.getElementById('entradaQuantidade').value);
    const observacoes = document.getElementById('entradaObservacoes').value;

    try {
        const res = await fetch(`/api/item/${id}/entrada`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ 
                quantidade, 
                observacoes,
                user: "{{ username }}" // ‚úÖ Adicionar username do usu√°rio
            })
        });
        if (!res.ok) throw await res.json();
        
        bootstrap.Modal.getInstance(document.getElementById('entradaStockModal')).hide();
        loadItens();
        
        // ‚úÖ Atualizar hist√≥rico automaticamente
        if (currentView === 'block') {
            renderizarBlocos(allItens);
        } else {
            renderizarTabela(allItens);
        }
    } catch(err) {
        alert(err.message || 'Erro ao registrar entrada');
    }
});

// ==========================
// üîπ FORMUL√ÅRIO DISTRIBUI√á√ÉO
// ==========================
document.getElementById('distribuicaoForm').addEventListener('submit', async e => {
    e.preventDefault();

    const payload = {
        item_id: parseInt(document.getElementById('distribuicaoItemId').value),
        armazem_id: parseInt(document.getElementById('distribuicaoArmazem').value),
        location_id: parseInt(document.getElementById('distribuicaoLocation').value),
        quantidade: parseInt(document.getElementById('distribuicaoQuantidade').value),
        data_distribuicao: document.getElementById('distribuicaoData').value,
        observacao: document.getElementById('distribuicaoObservacao').value
    };

    try {
        const res = await fetch('/api/distribuicao', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(payload)
        });
        if (!res.ok) throw await res.json();

        bootstrap.Modal.getInstance(document.getElementById('distribuicaoModal')).hide();
        alert('Distribui√ß√£o registrada com sucesso!');
        
        await loadDistribuicoes();
        renderizarBlocos(allItens);

        // üîπ ANIMAR o item distribu√≠do
        const itemId = parseInt(document.getElementById('distribuicaoItemId').value);
        const item = allItens.find(i => i.id === itemId);
        if (item) {
            criarAnimacaoDistribuicao(item, 0);
            
            // Reiniciar anima√ß√£o sequencial se estiver pausada
            if (isAnimationPaused) {
                pausarAnimacao();
            }
        }
    } catch(err) {
        alert(err.message || 'Erro ao registrar distribui√ß√£o');
        console.error(err);
    }
});

// ==========================
// üîπ FUN√á√ÉO PREVIEW IMAGEM ATUALIZADA
// ==========================
function previewImagem(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = e => {
        imagemBase64 = e.target.result.split(',')[1];
        const img = document.getElementById('previewImg');
        img.src = e.target.result;
        img.style.display = 'block';
        img.classList.remove('camera-preview'); // Remover estilo de c√¢mera se for upload
    };
    reader.readAsDataURL(file);
    
    // Parar c√¢mera se estiver ativa
    if (cameraActive) {
        pararCamera();
    }
}

// ==========================
// üîπ ABRIR MODAL ITEM ATUALIZADO
// ==========================
function abrirModalItem() {
    document.getElementById('itemForm').reset();
    document.getElementById('itemId').value = '';
    document.getElementById('previewImg').style.display = 'none';
    document.getElementById('previewPdf').innerHTML = '';
    document.getElementById('notaEnvioDocumentos').style.display = 'none';
    document.getElementById('cameraContainer').style.display = 'none'; // üîπ Esconder c√¢mera
    imagemBase64 = null;
    pdfBase64 = null;
    
    // ‚úÖ Resetar a sele√ß√£o da nota de envio
    document.getElementById('itemNotaEnvio').selectedIndex = 0;
    
    // üîπ Parar c√¢mera se estiver ativa
    pararCamera();
    
    new bootstrap.Modal(document.getElementById('itemModal')).show();
}

// ==========================
// üîπ EDITAR ITEM ATUALIZADO
// ==========================
function editarItem(id) {
    const i = allItens.find(item => item.id === id);
    if (!i) return;

    document.getElementById('itemId').value = i.id;
    document.getElementById('itemCodigo').value = i.codigo || '';
    document.getElementById('itemDesignacao').value = i.designacao || '';
    document.getElementById('itemHsCode').value = i.hs_code || '';
    document.getElementById('itemQuantidade').value = i.quantidade || '';
    document.getElementById('itemBatchNo').value = i.batch_no || '';
    document.getElementById('itemDataFabricacao').value = i.data_fabricacao ? i.data_fabricacao.slice(0,10) : '';
    document.getElementById('itemDataValidade').value = i.data_validade ? i.data_validade.slice(0,10) : '';
    document.getElementById('itemNoCartoes').value = i.no_cartoes || '';
    document.getElementById('itemPesoBruto').value = i.peso_bruto_total || '';
    document.getElementById('itemVolumeCBM').value = i.volume_total_cbm || '';
    document.getElementById('itemTotalCartoes').value = i.total_cartoes || '';
    document.getElementById('itemTotalPaletes').value = i.total_paletes || '';
    document.getElementById('itemDimensoesPalete').value = i.dimensoes_palete_cm || '';
    document.getElementById('itemArmazem').value = i.armazem_id || '';
    document.getElementById('itemPorto').value = i.porto_id || '';
    document.getElementById('itemObservacoes').value = i.observacoes || '';
    document.getElementById('itemSyncStatus').value = i.syncStatus || 'Not Syncronized';
    document.getElementById('itemSyncDate').value = i.syncStatusDate ? i.syncStatusDate.slice(0,16) : '';

    // ‚úÖ Se o item tem uma nota de envio associada, selecion√°-la
    if (i.nota_envio_id) {
        document.getElementById('itemNotaEnvio').value = i.nota_envio_id;
        // Carregar documentos da nota associada
        carregarItensDaNota(i.nota_envio_id);
    } else {
        document.getElementById('itemNotaEnvio').selectedIndex = 0;
        document.getElementById('notaEnvioDocumentos').style.display = 'none';
    }

    if (i.imagem) {
        document.getElementById('previewImg').src = `data:image/jpeg;base64,${i.imagem}`;
        document.getElementById('previewImg').style.display = 'block';
        document.getElementById('previewImg').classList.remove('camera-preview');
    }
    if (i.pdf_dados) {
        document.getElementById('previewPdf').innerHTML = `<a href="data:application/pdf;base64,${i.pdf_dados}" download="${i.pdf_nome}">üìÑ ${i.pdf_nome}</a>`;
    }
    
    // üîπ Esconder c√¢mera ao editar
    document.getElementById('cameraContainer').style.display = 'none';
    pararCamera();
    
    new bootstrap.Modal(document.getElementById('itemModal')).show();
}

// ----------------------------------------

// üîπ FUN√á√ïES PARA ITENS SOLICITADOS
// Carregar itens solicitados
// üî• CORRE√á√ÉO: Fun√ß√£o para carregar itens solicitados
async function carregarItensSolicitados() {
    try {
        console.log('üîÑ Carregando itens solicitados...');
        const res = await fetch(API_SOLICITACOES);
        
        if (!res.ok) {
            throw new Error(`Erro HTTP: ${res.status} - ${res.statusText}`);
        }
        
        allSolicitacoes = await res.json();
        console.log('‚úÖ Itens solicitados carregados:', allSolicitacoes);
        
        atualizarListaItensSolicitados();
        
    } catch (err) {
        console.error('‚ùå Erro ao carregar itens solicitados:', err);
        document.getElementById('listaItensSolicitados').innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i>
                Erro ao carregar solicita√ß√µes: ${err.message}
            </div>
        `;
    }
}


// Atualizar lista de itens solicitados
// üî• CORRE√á√ÉO: Atualizar lista de itens solicitados
function atualizarListaItensSolicitados() {
    const container = document.getElementById('listaItensSolicitados');
    
    if (!allSolicitacoes || allSolicitacoes.length === 0) {
        container.innerHTML = `
            <div class="text-center py-4">
                <i class="bi bi-inbox display-4 text-muted"></i>
                <h5 class="text-muted mt-2">Nenhuma solicita√ß√£o encontrada</h5>
                <p class="text-muted">Comece criando sua primeira solicita√ß√£o</p>
            </div>
        `;
        return;
    }

    let html = '';
    allSolicitacoes.forEach(solicitacao => {
        const dataSolicitacao = solicitacao.data_solicitacao ? 
            new Date(solicitacao.data_solicitacao).toLocaleDateString('pt-BR') : 
            'N√£o definida';
        
        html += `
            <div class="card solicitacao-card mb-3">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6 class="card-title mb-0 flex-grow-1">${solicitacao.nome || solicitacao.nome_item}</h6>
                        <span class="badge bg-primary">Qtd: ${solicitacao.quantidade}</span>
                    </div>
                    
                    <div class="solicitacao-info">
                        <div class="row g-2">
                            <div class="col-12">
                                <strong>Data Solicita√ß√£o:</strong> ${dataSolicitacao}
                            </div>
                            ${solicitacao.createAt ? `
                                <div class="col-12">
                                    <small class="text-muted">
                                        Criado em: ${new Date(solicitacao.createAt).toLocaleString('pt-BR')}
                                    </small>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <div class="card-actions mt-3">
                        <button class="btn btn-sm btn-warning" onclick="editarSolicitacao(${solicitacao.id})">
                            <i class="bi bi-pencil"></i> Editar
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="eliminarSolicitacao(${solicitacao.id})">
                            <i class="bi bi-trash"></i> Eliminar
                        </button>
                    </div>
                </div>
            </div>
        `;
    });

    container.innerHTML = html;
}


// üîπ FORMUL√ÅRIO DE SOLICITA√á√ÉO
// üî• CORRE√á√ÉO: Formul√°rio de solicita√ß√£o com payload correto
document.getElementById('itemSolicitadoForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const payload = {
        nome_item: document.getElementById('solicitadoNome').value,
        quantidade: parseInt(document.getElementById('solicitadoQuantidade').value),
        data_necessaria: document.getElementById('solicitadoDataNecessaria').value || null,
    };

    console.log('üì§ Enviando solicita√ß√£o:', payload);

    try {
        const res = await fetch(API_SOLICITACOES, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });

        const responseText = await res.text();
        console.log('üì• Resposta do servidor:', responseText);

        if (!res.ok) {
            let errorMessage = 'Erro ao criar solicita√ß√£o';
            try {
                const errorData = JSON.parse(responseText);
                errorMessage = errorData.message || errorData.error || errorMessage;
            } catch (e) {
                errorMessage = `Erro ${res.status}: ${responseText}`;
            }
            throw new Error(errorMessage);
        }

        const novaSolicitacao = JSON.parse(responseText);
        console.log('‚úÖ Solicita√ß√£o criada:', novaSolicitacao);
        
        limparFormSolicitado();
        await carregarItensSolicitados();
        
        mostrarFeedbackSucesso('Solicita√ß√£o criada com sucesso!');
        
    } catch (err) {
        console.error('‚ùå Erro ao criar solicita√ß√£o:', err);
        mostrarFeedbackErro('Erro ao criar solicita√ß√£o: ' + err.message);
    }
});

// Limpar formul√°rio de solicita√ß√£o
function limparFormSolicitado() {
    document.getElementById('itemSolicitadoForm').reset();
    document.getElementById('solicitadoPrioridade').value = 'media';
    document.getElementById('solicitadoDataNecessaria').value = '';
}

// üîπ FUN√á√ïES DE A√á√ÉO PARA SOLICITA√á√ïES

// Aprovar solicita√ß√£o
async function aprovarSolicitacao(id) {
    if (!confirm('Deseja aprovar esta solicita√ß√£o?')) return;
    
    try {
        const payload = {
            status: 'aprovado',
            data_resposta: new Date().toISOString(),
            resposta_administracao: 'Solicita√ß√£o aprovada pela administra√ß√£o.'
        };

        const res = await fetch(`${API_SOLICITACOES}/${id}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });

        if (!res.ok) throw await res.json();
        
        await carregarItensSolicitados();
        mostrarFeedbackSucesso('Solicita√ß√£o aprovada com sucesso!');
        
    } catch (err) {
        console.error('Erro ao aprovar solicita√ß√£o:', err);
        mostrarFeedbackErro('Erro ao aprovar solicita√ß√£o: ' + err.message);
    }
}

// Rejeitar solicita√ß√£o
async function rejeitarSolicitacao(id) {
    const resposta = prompt('Digite o motivo da rejei√ß√£o:');
    if (resposta === null) return;
    
    try {
        const payload = {
            status: 'rejeitado',
            data_resposta: new Date().toISOString(),
            resposta_administracao: resposta
        };

        const res = await fetch(`${API_SOLICITACOES}/${id}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });

        if (!res.ok) throw await res.json();
        
        await carregarItensSolicitados();
        mostrarFeedbackSucesso('Solicita√ß√£o rejeitada!');
        
    } catch (err) {
        console.error('Erro ao rejeitar solicita√ß√£o:', err);
        mostrarFeedbackErro('Erro ao rejeitar solicita√ß√£o: ' + err.message);
    }
}

// Editar solicita√ß√£o
async function editarSolicitacao(id) {
    const solicitacao = allSolicitacoes.find(s => s.id === id);
    if (!solicitacao) return;

    // Preencher formul√°rio com dados existentes
    document.getElementById('solicitadoNome').value = solicitacao.nome;
    document.getElementById('solicitadoQuantidade').value = solicitacao.quantidade;
    document.getElementById('solicitadoDataNecessaria').value = solicitacao.data_solicitacao ? solicitacao.data_necessaria.split('T')[0] : '';

    // Rolar at√© o formul√°rio
    document.getElementById('solicitados-tab').click();
    document.getElementById('itemSolicitadoForm').scrollIntoView({ behavior: 'smooth' });

    // Adicionar ID oculto para edi√ß√£o
    let hiddenId = document.getElementById('solicitacaoEditId');
    if (!hiddenId) {
        hiddenId = document.createElement('input');
        hiddenId.type = 'hidden';
        hiddenId.id = 'solicitacaoEditId';
        document.getElementById('itemSolicitadoForm').appendChild(hiddenId);
    }
    hiddenId.value = id;

    // Alterar texto do bot√£o
    const submitBtn = document.querySelector('#itemSolicitadoForm button[type="submit"]');
    const originalHTML = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="bi bi-save"></i> Atualizar Solicita√ß√£o';
    
    // Restaurar texto original se o usu√°rio cancelar
    setTimeout(() => {
        if (!document.getElementById('solicitacaoEditId').value) {
            submitBtn.innerHTML = originalHTML;
        }
    }, 5000);
}

// Eliminar solicita√ß√£o
async function eliminarSolicitacao(id) {
    if (!confirm('Tem certeza que deseja eliminar esta solicita√ß√£o?')) return;
    
    try {
        const res = await fetch(`${API_SOLICITACOES}/${id}`, {
            method: 'DELETE'
        });

        if (!res.ok) throw await res.json();
        
        await carregarItensSolicitados();
        mostrarFeedbackSucesso('Solicita√ß√£o eliminada com sucesso!');
        
    } catch (err) {
        console.error('Erro ao eliminar solicita√ß√£o:', err);
        mostrarFeedbackErro('Erro ao eliminar solicita√ß√£o: ' + err.message);
    }
}

// üîπ FILTROS E PESQUISA

// Filtrar solicita√ß√µes por texto
function filtrarSolicitacoes(query) {
    const termo = query.toLowerCase().trim();
    
    if (!termo) {
        atualizarListaItensSolicitados();
        return;
    }
    
    const solicitacoesFiltradas = allSolicitacoes.filter(s =>
        s.nome_item.toLowerCase().includes(termo) ||
        (s.categoria && s.categoria.toLowerCase().includes(termo)) ||
        (s.justificativa && s.justificativa.toLowerCase().includes(termo)) ||
        (s.observacoes && s.observacoes.toLowerCase().includes(termo)) ||
        (s.resposta_administracao && s.resposta_administracao.toLowerCase().includes(termo))
    );
    
    renderizarSolicitacoesFiltradas(solicitacoesFiltradas);
}

// Filtrar por status
function filtrarSolicitacoesPorStatus(status) {
    currentSolicitacaoFilter = status;
    
    // Atualizar bot√µes ativos
    document.querySelectorAll('#solicitados-tab ~ .tab-pane .btn-group .btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    atualizarListaItensSolicitados();
}

// Renderizar solicita√ß√µes filtradas
function renderizarSolicitacoesFiltradas(solicitacoes) {
    const container = document.getElementById('listaItensSolicitados');
    
    if (solicitacoes.length === 0) {
        container.innerHTML = `
            <div class="text-center py-3">
                <i class="bi bi-search display-4 text-muted"></i>
                <h5 class="text-muted mt-2">Nenhuma solicita√ß√£o encontrada</h5>
                <p class="text-muted">Tente alterar os termos da pesquisa</p>
            </div>
        `;
        return;
    }
    
    // Reutilizar a l√≥gica de renderiza√ß√£o principal
    const tempSolicitacoes = allSolicitacoes;
    allSolicitacoes = solicitacoes;
    atualizarListaItensSolicitados();
    allSolicitacoes = tempSolicitacoes;
}

// üîπ FEEDBACK VISUAL


// üî• CORRE√á√ÉO: Fun√ß√µes auxiliares
function mostrarFeedbackSucesso(mensagem) {
    // Criar toast de sucesso
    const toast = document.createElement('div');
    toast.className = 'toast align-items-center text-white bg-success border-0 position-fixed top-0 end-0 m-3';
    toast.style.zIndex = '1060';
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                <i class="bi bi-check-circle-fill"></i> ${mensagem}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    document.body.appendChild(toast);
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    toast.addEventListener('hidden.bs.toast', () => {
        document.body.removeChild(toast);
    });
}

// üî• CORRE√á√ÉO: Fun√ß√µes auxiliares
function mostrarFeedbackSucesso(mensagem) {
    // Criar toast de sucesso
    const toast = document.createElement('div');
    toast.className = 'toast align-items-center text-white bg-success border-0 position-fixed top-0 end-0 m-3';
    toast.style.zIndex = '1060';
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                <i class="bi bi-check-circle-fill"></i> ${mensagem}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    document.body.appendChild(toast);
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    toast.addEventListener('hidden.bs.toast', () => {
        document.body.removeChild(toast);
    });
}


// Inicializa√ß√£o quando a tab for mostrada
document.addEventListener('DOMContentLoaded', function() {
    const solicitadosTab = document.getElementById('solicitados-tab');
    if (solicitadosTab) {
        solicitadosTab.addEventListener('shown.bs.tab', function() {
            console.log('üìã Tab de solicita√ß√µes aberta - carregando dados...');
            carregarItensSolicitados();
        });
    }
    
    // Carregar inicialmente se a tab estiver ativa
    if (document.getElementById('solicitados').classList.contains('active')) {
        carregarItensSolicitados();
    }
});

// ----------------------------------------------------

document.addEventListener('DOMContentLoaded', () => {
    renderizarTabelaConfirmacao(itensDistribuidos);
    renderizarBlocosConfirmacao(itensDistribuidos);
});

</script>
{% endblock %}