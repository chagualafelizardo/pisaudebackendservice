{% extends 'base.html' %}

{% block title %}PI-SAÚDE / Resources Mapping{% endblock %}

{% block content %}
<style>
    .category-filter {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 20px;
        padding: 12px;
        background: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #dee2e6;
    }
    
    .category-filter .btn {
        border-radius: 20px;
        padding: 6px 16px;
        font-size: 0.85rem;
        display: flex;
        align-items: center;
        gap: 6px;
    }
    
    .category-filter .btn.active {
        box-shadow: 0 0 0 2px rgba(13, 110, 253, 0.25);
    }
    
    .marker-popup {
        max-width: 350px !important;
    }
    
    .popup-category {
        display: inline-block;
        padding: 3px 10px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        margin-bottom: 10px;
    }
    
    .popup-resource-list {
        max-height: 200px;
        overflow-y: auto;
        margin: 10px 0;
        padding-right: 5px;
    }
    
    .popup-resource-item {
        padding: 8px;
        margin-bottom: 5px;
        background: #f8f9fa;
        border-radius: 6px;
        border-left: 4px solid #0d6efd;
    }
    
    .popup-resource-item.lab {
        border-left-color: #198754;
    }
    
    .popup-resource-item.pharmacy {
        border-left-color: #dc3545;
    }
    
    .popup-resource-item.it {
        border-left-color: #6f42c1;
    }
    
    .popup-resource-item.hr {
        border-left-color: #fd7e14;
    }
    
    .popup-resource-item.medical {
        border-left-color: #0dcaf0;
    }
    
    .resource-category-badge {
        font-size: 0.7rem;
        padding: 2px 8px;
        border-radius: 10px;
    }
    
    .resource-table-category {
        font-weight: 600;
        font-size: 0.85rem;
        padding: 4px 10px;
        border-radius: 12px;
        display: inline-block;
        margin-bottom: 5px;
    }
    
    .category-count {
        display: inline-block;
        background: rgba(0,0,0,0.1);
        border-radius: 10px;
        padding: 0 6px;
        font-size: 0.75rem;
        margin-left: 5px;
    }
    
    .cluster-marker {
        width: 40px;
        height: 40px;
        background-color: #0d6efd;
        color: white;
        border-radius: 50%;
        border: 3px solid white;
        box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 14px;
    }
    
    .cluster-small { width: 35px; height: 35px; font-size: 12px; }
    .cluster-medium { width: 45px; height: 45px; font-size: 16px; }
    .cluster-large { width: 55px; height: 55px; font-size: 18px; }
    
    .print-report-btn {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1000;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
</style>

<div class="container-fluid py-3">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1">
                <i class="fas fa-map-marked-alt text-primary me-2"></i>
                Resources Geographic Mapping
            </h2>
            <p class="text-muted mb-0">Visualize resources distribution by category across health facilities</p>
        </div>
        <div>
            <button class="btn btn-primary" onclick="openLocationModal()">
                <i class="fas fa-plus me-2"></i>Add New Facility
            </button>
        </div>
    </div>

    <!-- Filtros por Categoria -->
    <div class="card mb-4">
        <div class="card-header bg-light">
            <h6 class="mb-0"><i class="fas fa-filter me-2"></i>Filter by Resource Category</h6>
        </div>
        <div class="card-body py-3">
            <div class="category-filter" id="categoryFilters">
                <!-- Categories will be populated by JavaScript -->
            </div>
            
            <!-- Estatísticas Rápidas -->
            <div class="row mt-3">
                <div class="col-md-3">
                    <div class="card border-start border-primary border-3">
                        <div class="card-body py-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <small class="text-muted">Total Facilities</small>
                                    <h4 class="mb-0" id="totalFacilities">0</h4>
                                </div>
                                <i class="fas fa-hospital fs-4 text-primary"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-start border-success border-3">
                        <div class="card-body py-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <small class="text-muted">Total Resources</small>
                                    <h4 class="mb-0" id="totalResources">0</h4>
                                </div>
                                <i class="fas fa-boxes fs-4 text-success"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-start border-info border-3">
                        <div class="card-body py-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <small class="text-muted">Categories</small>
                                    <h4 class="mb-0" id="totalCategories">0</h4>
                                </div>
                                <i class="fas fa-tags fs-4 text-info"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-start border-warning border-3">
                        <div class="card-body py-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <small class="text-muted">Last Updated</small>
                                    <div class="text-muted" id="lastUpdate">-</div>
                                </div>
                                <i class="fas fa-history fs-4 text-warning"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mapa Principal -->
    <div class="row g-4">
        <div class="col-lg-8">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center py-3">
                    <div>
                        <strong><i class="fas fa-map-marked-alt me-2"></i>Resources Geographic Distribution</strong>
                        <small class="d-block mt-1 opacity-75" id="mapInfo">Loading map...</small>
                    </div>
                    <div class="btn-group" role="group">
                        <button class="btn btn-light btn-sm" onclick="setMapLayer('streets')">
                            <i class="fas fa-road me-1"></i>Streets
                        </button>
                        <button class="btn btn-light btn-sm" onclick="setMapLayer('satellite')">
                            <i class="fas fa-satellite me-1"></i>Satellite
                        </button>
                        <button class="btn btn-light btn-sm" onclick="toggleLegend()">
                            <i class="fas fa-eye me-1"></i>Legend
                        </button>
                    </div>
                </div>
                <div class="card-body p-0 position-relative">
                    <div id="mapResources" style="height: 500px; width: 100%; border-radius: 0 0 8px 8px;"></div>
                    
                    <!-- Legend -->
                    <div id="mapLegend" class="position-absolute bg-white p-3 rounded shadow-sm" 
                         style="bottom: 20px; right: 20px; z-index: 1000; max-width: 250px; display: none;">
                        <h6 class="border-bottom pb-2 mb-3">
                            <i class="fas fa-key me-2"></i>Resource Categories
                        </h6>
                        <div id="legendContent">
                            <!-- Legend items will be populated -->
                        </div>
                        <button class="btn btn-sm btn-outline-secondary w-100 mt-2" onclick="toggleLegend()">
                            <i class="fas fa-times me-1"></i>Close
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Informações ao Lado do Mapa -->
        <div class="col-lg-4">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center py-3">
                    <strong><i class="fas fa-chart-pie me-2"></i>Category Summary</strong>
                    <button class="btn btn-light btn-sm" onclick="refreshData()">
                        <i class="fas fa-redo"></i>
                    </button>
                </div>
                <div class="card-body">
                    <div id="categorySummary" class="mb-3">
                        <div class="text-center py-4">
                            <div class="spinner-border text-success" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2 mb-0">Loading categories...</p>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2 mt-4">
                        <button class="btn btn-outline-primary" onclick="exportToPDF()">
                            <i class="fas fa-file-pdf me-2"></i>Export Report
                        </button>
                        <button class="btn btn-outline-success" onclick="exportToCSV()">
                            <i class="fas fa-file-csv me-2"></i>Export Data
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabela de Recursos -->
    <div class="card shadow-sm border-0 mt-4">
        <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center py-3">
            <div>
                <strong><i class="fas fa-table me-2"></i>Resources by Location & Category</strong>
                <small class="d-block mt-1 opacity-75" id="tableInfo">Showing all facilities</small>
            </div>
            <div>
                <div class="input-group input-group-sm" style="width: 300px;">
                    <input type="text" id="searchTable" class="form-control" placeholder="Search facilities or resources...">
                    <button class="btn btn-light" type="button" onclick="searchTable()">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                <table id="resourcesTable" class="table table-hover mb-0">
                    <thead class="table-light sticky-top">
                        <tr>
                            <th>Facility</th>
                            <th>Category</th>
                            <th>Resources</th>
                            <th>Quantity</th>
                            <th>Responsible</th>
                            <th>Location</th>
                            <th>Last Update</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <!-- Populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Botão de Impressão -->
<button class="btn btn-primary print-report-btn" onclick="printReport()">
    <i class="fas fa-print me-2"></i>Print Report
</button>

<!-- Modal para Relatório de Impressão -->
<div class="modal fade" id="printReportModal" tabindex="-1" aria-labelledby="printReportModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="printReportModalLabel">
                    <i class="fas fa-print me-2"></i>Resources Report
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="printReportContent">
                    <!-- Conteúdo do relatório será gerado aqui -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="window.print()">
                    <i class="fas fa-print me-2"></i>Print
                </button>
            </div>
        </div>
    </div>
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
// ==================== CONFIGURAÇÕES ====================
const apiUrl = '/api/location';
const apiResources = '/api/resource';
let availableResources = [];
let allLocations = [];
let map, markersLayer, baseLayers, markerCluster;
let activeCategory = 'all';
let categoryStats = {};
let allMarkers = [];

// Definição das categorias com cores e ícones
const RESOURCE_CATEGORIES = {
    'laboratory': {
        name: 'Laboratory',
        color: '#198754',
        icon: 'fas fa-flask',
        description: 'Lab equipment and supplies'
    },
    'pharmacy': {
        name: 'Pharmacy',
        color: '#dc3545',
        icon: 'fas fa-pills',
        description: 'Medicines and pharmaceuticals'
    },
    'it': {
        name: 'IT & Digital',
        color: '#6f42c1',
        icon: 'fas fa-laptop-medical',
        description: 'Computers, software, and IT equipment'
    },
    'hr': {
        name: 'Human Resources',
        color: '#fd7e14',
        icon: 'fas fa-users',
        description: 'HR equipment and training materials'
    },
    'medical': {
        name: 'Medical Equipment',
        color: '#0dcaf0',
        icon: 'fas fa-stethoscope',
        description: 'Medical devices and instruments'
    },
    'supplies': {
        name: 'General Supplies',
        color: '#6c757d',
        icon: 'fas fa-box-open',
        description: 'General supplies and consumables'
    },
    'furniture': {
        name: 'Furniture',
        color: '#795548',
        icon: 'fas fa-chair',
        description: 'Office and medical furniture'
    },
    'vehicle': {
        name: 'Vehicles',
        color: '#17a2b8',
        icon: 'fas fa-ambulance',
        description: 'Transportation vehicles'
    }
};

// ==================== INICIALIZAÇÃO DO MAPA ====================
function initMap() {
    // Centro de Moçambique
    map = L.map('mapResources', { 
        center: [-18.6657, 35.5296], 
        zoom: 6,
        zoomControl: false
    });

    // Adiciona controle de zoom
    L.control.zoom({ position: 'topleft' }).addTo(map);

    // Camadas base
    const streets = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
    });

    const terrain = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
        attribution: 'Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: &copy; <a href="https://opentopomap.org">OpenTopoMap</a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA</a>)'
    });

    baseLayers = { 'Streets': streets, 'Satellite': satellite, 'Terrain': terrain };

    // Adiciona controle de camadas
    L.control.layers(baseLayers).addTo(map);

    // Inicializa o cluster de marcadores com círculos azuis
    markerCluster = L.markerClusterGroup({
        showCoverageOnHover: false,
        maxClusterRadius: 40,
        spiderfyOnMaxZoom: true,
        disableClusteringAtZoom: 17,
        iconCreateFunction: function(cluster) {
            const count = cluster.getChildCount();
            const size = count < 10 ? 'small' : count < 50 ? 'medium' : 'large';
            const sizeClass = `cluster-${size}`;
            
            return L.divIcon({
                html: `<div class="cluster-marker ${sizeClass}">${count}</div>`,
                className: 'cluster-icon',
                iconSize: L.point(40, 40),
                iconAnchor: [20, 20]
            });
        }
    }).addTo(map);

    // Carrega os dados
    loadLocationsData();
}

// ==================== CARREGAMENTO DE DADOS ====================
async function loadLocationsData() {
    try {
        showLoading();
        
        // Carrega locais
        const locationsRes = await fetch(apiUrl);
        if (!locationsRes.ok) throw new Error('Failed to load locations');
        allLocations = await locationsRes.json();
        
        // Carrega recursos disponíveis
        const resourcesRes = await fetch(apiResources);
        if (resourcesRes.ok) {
            availableResources = await resourcesRes.json();
        }
        
        // Processa os dados
        processLocationsData();
        updateFilters();
        updateSummaryCards();
        updateCategorySummary();
        updateTable();
        updateMapMarkers();
        
        hideLoading();
        
    } catch (error) {
        console.error('Error loading data:', error);
        showAlert('error', 'Failed to load data: ' + error.message);
        hideLoading();
    }
}

function processLocationsData() {
    categoryStats = {};
    
    // Inicializa estatísticas por categoria
    Object.keys(RESOURCE_CATEGORIES).forEach(cat => {
        categoryStats[cat] = {
            count: 0,
            totalQuantity: 0,
            locations: new Set(),
            resources: []
        };
    });
    
    // Processa cada local
    allLocations.forEach(location => {
        if (location.resources && location.resources.length > 0) {
            location.resources.forEach(resource => {
                // Determina a categoria do recurso com função melhorada
                const category = determineResourceCategory(resource);
                
                if (category) {
                    // Atualiza estatísticas
                    if (!categoryStats[category]) {
                        categoryStats[category] = {
                            count: 0,
                            totalQuantity: 0,
                            locations: new Set(),
                            resources: []
                        };
                    }
                    
                    categoryStats[category].count++;
                    categoryStats[category].totalQuantity += (resource.quantity || 1);
                    categoryStats[category].locations.add(location.id);
                    
                    // Adiciona recurso à lista
                    categoryStats[category].resources.push({
                        ...resource,
                        locationId: location.id,
                        locationName: location.name,
                        locationLat: location.latitude,
                        locationLng: location.longitude,
                        locationResponsavel: location.responsavel
                    });
                }
            });
        }
    });
    
    // Converte Sets para arrays para contagem
    Object.keys(categoryStats).forEach(cat => {
        if (categoryStats[cat].locations instanceof Set) {
            categoryStats[cat].locations = categoryStats[cat].locations.size;
        }
    });
}

function determineResourceCategory(resource) {
    const resourceName = (resource.name || '').toLowerCase();
    const resourceDesc = (resource.description || '').toLowerCase();
    
    // Tenta encontrar o tipo de recurso primeiro
    let resourceType = '';
    if (resource.resource_id) {
        const availableResource = availableResources.find(r => r.id == resource.resource_id);
        if (availableResource) {
            resourceType = (availableResource.name || '').toLowerCase();
            const typeDesc = (availableResource.description || '').toLowerCase();
            
            // Verifica palavras-chave no tipo de recurso
            const combinedTypeText = resourceType + ' ' + typeDesc;
            
            if (containsAny(combinedTypeText, ['lab', 'laboratory', 'microscope', 'centrifuge', 'analyzer', 'test', 'sample'])) {
                return 'laboratory';
            }
            if (containsAny(combinedTypeText, ['pharm', 'medicine', 'drug', 'pill', 'tablet', 'capsule', 'syrup'])) {
                return 'pharmacy';
            }
            if (containsAny(combinedTypeText, ['computer', 'laptop', 'printer', 'software', 'digital', 'it', 'network'])) {
                return 'it';
            }
            if (containsAny(combinedTypeText, ['hr', 'human resource', 'training', 'staff', 'employee', 'personnel'])) {
                return 'hr';
            }
            if (containsAny(combinedTypeText, ['medical', 'equipment', 'device', 'instrument', 'surgical', 'diagnostic'])) {
                return 'medical';
            }
            if (containsAny(combinedTypeText, ['furniture', 'chair', 'table', 'desk', 'cabinet', 'shelf'])) {
                return 'furniture';
            }
            if (containsAny(combinedTypeText, ['vehicle', 'car', 'truck', 'ambulance', 'motor', 'transport'])) {
                return 'vehicle';
            }
        }
    }
    
    // Se não encontrou pelo tipo, verifica pelo nome e descrição
    const combinedText = resourceName + ' ' + resourceDesc;
    
    // Lista de palavras-chave por categoria
    const keywordMap = {
        'laboratory': ['lab', 'laboratory', 'microscope', 'centrifuge', 'analyzer', 'test kit', 'blood test', 'urine test', 'chemistry', 'hematology'],
        'pharmacy': ['pharm', 'medicine', 'drug', 'pill', 'tablet', 'capsule', 'syrup', 'injection', 'vaccine', 'antibiotic'],
        'it': ['computer', 'laptop', 'printer', 'software', 'digital', 'it', 'network', 'internet', 'router', 'switch'],
        'hr': ['hr', 'human resource', 'training', 'staff', 'employee', 'personnel', 'workshop', 'seminar'],
        'medical': ['medical', 'equipment', 'device', 'instrument', 'surgical', 'diagnostic', 'monitor', 'defibrillator', 'ventilator'],
        'furniture': ['furniture', 'chair', 'table', 'desk', 'cabinet', 'shelf', 'bed', 'stretcher'],
        'vehicle': ['vehicle', 'car', 'truck', 'ambulance', 'motor', 'transport', 'motorcycle']
    };
    
    // Verifica cada categoria
    for (const [category, keywords] of Object.entries(keywordMap)) {
        if (containsAny(combinedText, keywords)) {
            return category;
        }
    }
    
    // Se não encontrou, retorna 'supplies' como padrão
    return 'supplies';
}

function containsAny(text, keywords) {
    return keywords.some(keyword => text.includes(keyword.toLowerCase()));
}

// ==================== ATUALIZAÇÃO DE FILTROS ====================
function updateFilters() {
    const filtersContainer = document.getElementById('categoryFilters');
    filtersContainer.innerHTML = '';
    
    // Botão "All"
    const allBtn = document.createElement('button');
    allBtn.type = 'button';
    allBtn.className = `btn ${activeCategory === 'all' ? 'btn-primary active' : 'btn-outline-primary'}`;
    allBtn.innerHTML = `<i class="fas fa-layer-group"></i> All Categories`;
    allBtn.onclick = () => setActiveCategory('all');
    filtersContainer.appendChild(allBtn);
    
    // Botões por categoria
    Object.keys(RESOURCE_CATEGORIES).forEach(cat => {
        const catInfo = RESOURCE_CATEGORIES[cat];
        const stats = categoryStats[cat] || { count: 0 };
        
        if (stats.count > 0) {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = `btn ${activeCategory === cat ? 'active' : ''}`;
            btn.style.borderColor = catInfo.color;
            btn.style.color = activeCategory === cat ? '#fff' : catInfo.color;
            btn.style.backgroundColor = activeCategory === cat ? catInfo.color : 'transparent';
            
            btn.innerHTML = `
                <i class="${catInfo.icon}"></i> ${catInfo.name}
                <span class="category-count">${stats.count}</span>
            `;
            
            btn.onclick = () => setActiveCategory(cat);
            filtersContainer.appendChild(btn);
        }
    });
}

function setActiveCategory(category) {
    activeCategory = category;
    updateFilters();
    updateMapMarkers();
    updateTable();
    
    // Atualiza informações
    const mapInfo = document.getElementById('mapInfo');
    const tableInfo = document.getElementById('tableInfo');
    
    if (category === 'all') {
        mapInfo.textContent = `Showing all ${allLocations.length} facilities`;
        tableInfo.textContent = `Showing all resources from ${allLocations.length} facilities`;
    } else {
        const catInfo = RESOURCE_CATEGORIES[category];
        const stats = categoryStats[category] || { count: 0, locations: 0 };
        mapInfo.textContent = `Showing ${catInfo.name} resources in ${stats.locations || 0} facilities`;
        tableInfo.textContent = `Showing ${stats.count} ${catInfo.name} resources`;
    }
}

// ==================== ATUALIZAÇÃO DO MAPA ====================
function updateMapMarkers() {
    // Limpa marcadores existentes
    markerCluster.clearLayers();
    allMarkers = [];
    
    // Filtra locais baseado na categoria ativa
    let filteredLocations = allLocations;
    
    if (activeCategory !== 'all') {
        filteredLocations = allLocations.filter(location => {
            if (!location.resources || location.resources.length === 0) return false;
            
            return location.resources.some(resource => {
                const category = determineResourceCategory(resource);
                return category === activeCategory;
            });
        });
    }
    
    // Adiciona marcadores para cada local
    filteredLocations.forEach(location => {
        if (location.latitude && location.longitude) {
            const lat = parseFloat(location.latitude);
            const lng = parseFloat(location.longitude);
            
            // Determina a cor do marcador baseado na categoria principal
            let markerColor = '#0d6efd'; // Default blue
            
            if (activeCategory !== 'all') {
                markerColor = RESOURCE_CATEGORIES[activeCategory].color;
            } else if (location.resources && location.resources.length > 0) {
                // Se mostrar todas, determina a categoria principal do local
                const mainCategory = getMainCategoryForLocation(location);
                if (mainCategory && RESOURCE_CATEGORIES[mainCategory]) {
                    markerColor = RESOURCE_CATEGORIES[mainCategory].color;
                }
            }
            
            // Conta recursos por categoria neste local para o popup
            const categoryCounts = {};
            if (location.resources) {
                location.resources.forEach(resource => {
                    const category = determineResourceCategory(resource);
                    categoryCounts[category] = (categoryCounts[category] || 0) + 1;
                });
            }
            
            // Cria ícone customizado com contagem
            const resourceCount = location.resources ? location.resources.length : 0;
            const markerIcon = L.divIcon({
                className: 'custom-marker',
                html: `
                    <div style="
                        background-color: ${markerColor};
                        width: 30px;
                        height: 30px;
                        border-radius: 50%;
                        border: 3px solid white;
                        box-shadow: 0 2px 5px rgba(0,0,0,0.3);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: white;
                        font-weight: bold;
                        font-size: ${resourceCount < 10 ? '12px' : '10px'};
                    ">
                        ${resourceCount}
                    </div>
                `,
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            });
            
            // Cria marcador
            const marker = L.marker([lat, lng], { icon: markerIcon });
            
            // Cria popup
            const popupContent = createPopupContent(location);
            marker.bindPopup(popupContent, {
                className: 'marker-popup',
                maxWidth: 350
            });
            
            // Adiciona ao cluster
            markerCluster.addLayer(marker);
            allMarkers.push(marker);
        }
    });
    
    // Se houver marcadores, ajusta o zoom
    if (allMarkers.length > 0) {
        const group = new L.featureGroup(allMarkers);
        map.fitBounds(group.getBounds().pad(0.1));
    }
}

function getMainCategoryForLocation(location) {
    if (!location.resources || location.resources.length === 0) {
        return 'supplies';
    }
    
    // Conta recursos por categoria
    const categoryCounts = {};
    location.resources.forEach(resource => {
        const category = determineResourceCategory(resource);
        categoryCounts[category] = (categoryCounts[category] || 0) + 1;
    });
    
    // Encontra a categoria com mais recursos
    let mainCategory = 'supplies';
    let maxCount = 0;
    
    Object.keys(categoryCounts).forEach(cat => {
        if (categoryCounts[cat] > maxCount) {
            maxCount = categoryCounts[cat];
            mainCategory = cat;
        }
    });
    
    return mainCategory;
}

function createPopupContent(location) {
    const resourcesByCategory = groupResourcesByCategory(location.resources || []);
    
    let resourcesHtml = '';
    let categoryCounts = '';
    
    Object.keys(resourcesByCategory).forEach(cat => {
        const catInfo = RESOURCE_CATEGORIES[cat] || { name: cat, color: '#6c757d', icon: 'fas fa-box' };
        const categoryResources = resourcesByCategory[cat];
        const totalQuantity = categoryResources.reduce((sum, r) => sum + (r.quantity || 1), 0);
        
        categoryCounts += `<span class="badge" style="background-color: ${catInfo.color}; margin: 2px;">${catInfo.name}: ${categoryResources.length}</span> `;
        
        resourcesHtml += `
            <div class="mb-3">
                <div class="popup-category" style="background-color: ${catInfo.color}; color: white;">
                    <i class="${catInfo.icon} me-1"></i> ${catInfo.name}
                    <span class="badge bg-light text-dark ms-1">${categoryResources.length} items</span>
                </div>
                <div class="popup-resource-list">
                    ${categoryResources.map(resource => `
                        <div class="popup-resource-item ${cat}">
                            <strong>${resource.name || 'Unnamed Resource'}</strong>
                            <div class="d-flex justify-content-between">
                                <small>Quantity: ${resource.quantity || 1}</small>
                                ${resource.datarecepcao ? `<small>${new Date(resource.datarecepcao).toLocaleDateString()}</small>` : ''}
                            </div>
                            ${resource.description ? `<small class="d-block mt-1">${resource.description}</small>` : ''}
                            ${resource.status ? `<small class="badge bg-${getStatusBadgeClass(resource.status)}">${resource.status}</small>` : ''}
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    });
    
    return `
        <div style="max-width: 350px;">
            <h6 class="mb-2">
                <i class="fas fa-hospital text-primary me-2"></i>
                <strong>${location.name}</strong>
            </h6>
            
            ${location.description ? `<p class="mb-2"><small>${location.description}</small></p>` : ''}
            
            <div class="mb-3">
                <small class="text-muted d-block">
                    <i class="fas fa-user-shield me-1"></i> ${location.responsavel || 'Not specified'}
                </small>
                <small class="text-muted">
                    <i class="fas fa-map-marker-alt me-1"></i> 
                    ${parseFloat(location.latitude).toFixed(4)}, ${parseFloat(location.longitude).toFixed(4)}
                </small>
            </div>
            
            <div class="mb-2">
                <strong>Resource Summary:</strong>
                <div class="mt-1">${categoryCounts}</div>
            </div>
            
            <hr class="my-2">
            
            <h6 class="mb-2">
                <i class="fas fa-boxes me-2"></i>
                Resources (${location.resources ? location.resources.length : 0})
            </h6>
            
            ${resourcesHtml || '<p class="text-muted"><small>No resources found</small></p>'}
            
            <hr class="my-2">
            
            <div class="d-grid gap-2">
                <button class="btn btn-sm btn-primary" onclick="editLocation(${location.id})">
                    <i class="fas fa-edit me-1"></i> Edit Facility
                </button>
                <button class="btn btn-sm btn-outline-secondary" onclick="viewLocationResources(${location.id}, '${location.name.replace(/'/g, "\\'")}')">
                    <i class="fas fa-eye me-1"></i> View Details
                </button>
                <button class="btn btn-sm btn-info" onclick="printLocationReport(${location.id})">
                    <i class="fas fa-print me-1"></i> Print Report
                </button>
            </div>
        </div>
    `;
}

function groupResourcesByCategory(resources) {
    const grouped = {};
    
    resources.forEach(resource => {
        const category = determineResourceCategory(resource);
        if (!grouped[category]) {
            grouped[category] = [];
        }
        grouped[category].push(resource);
    });
    
    return grouped;
}

function getStatusBadgeClass(status) {
    switch(status) {
        case 'available': return 'success';
        case 'in-use': return 'primary';
        case 'maintenance': return 'warning';
        case 'unavailable': return 'danger';
        default: return 'secondary';
    }
}

// ==================== ATUALIZAÇÃO DA TABELA ====================
function updateTable() {
    const tableBody = document.getElementById('tableBody');
    tableBody.innerHTML = '';
    
    // Filtra locais baseado na categoria ativa
    let filteredLocations = allLocations;
    
    if (activeCategory !== 'all') {
        filteredLocations = allLocations.filter(location => {
            if (!location.resources || location.resources.length === 0) return false;
            
            return location.resources.some(resource => {
                const category = determineResourceCategory(resource);
                return category === activeCategory;
            });
        });
    }
    
    // Adiciona linhas à tabela
    filteredLocations.forEach(location => {
        const resourcesByCategory = groupResourcesByCategory(location.resources || []);
        
        // Para cada categoria no local, cria uma linha
        Object.keys(resourcesByCategory).forEach(cat => {
            if (activeCategory === 'all' || activeCategory === cat) {
                const catInfo = RESOURCE_CATEGORIES[cat] || { name: cat, color: '#6c757d', icon: 'fas fa-box' };
                const categoryResources = resourcesByCategory[cat];
                const totalQuantity = categoryResources.reduce((sum, r) => sum + (r.quantity || 1), 0);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <strong>${location.name}</strong>
                        ${location.description ? `<br><small class="text-muted">${location.description}</small>` : ''}
                    </td>
                    <td>
                        <span class="resource-table-category" style="background-color: ${catInfo.color}; color: white;">
                            <i class="${catInfo.icon} me-1"></i> ${catInfo.name}
                        </span>
                    </td>
                    <td>
                        <div style="max-height: 100px; overflow-y: auto;">
                            ${categoryResources.map(resource => `
                                <div class="mb-1">
                                    <strong>${resource.name || 'Unnamed Resource'}</strong>
                                    <br>
                                    <small class="text-muted">${resource.description || 'No description'}</small>
                                </div>
                            `).join('')}
                        </div>
                    </td>
                    <td>
                        <div class="fw-bold">${totalQuantity}</div>
                        <small class="text-muted">${categoryResources.length} items</small>
                    </td>
                    <td>
                        <span class="badge bg-secondary">${location.responsavel || 'N/A'}</span>
                    </td>
                    <td>
                        ${location.latitude && location.longitude ? 
                            `<small>${parseFloat(location.latitude).toFixed(4)}<br>${parseFloat(location.longitude).toFixed(4)}</small>` : 
                            '<span class="badge bg-warning">No location</span>'}
                    </td>
                    <td>
                        ${location.updateAt ? 
                            `<small>${new Date(location.updateAt).toLocaleDateString()}<br>
                             <span class="text-muted">${new Date(location.updateAt).toLocaleTimeString()}</span></small>` : 
                            'N/A'}
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm" role="group">
                            <button class="btn btn-outline-primary" onclick="editLocation(${location.id})" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-outline-info" onclick="viewLocationResources(${location.id}, '${location.name.replace(/'/g, "\\'")}')" title="View Resources">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-outline-success" onclick="printLocationReport(${location.id})" title="Print Report">
                                <i class="fas fa-print"></i>
                            </button>
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
            }
        });
    });
    
    // Se não houver dados
    if (tableBody.children.length === 0) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="8" class="text-center py-4">
                    <i class="fas fa-inbox fs-1 text-muted mb-3"></i>
                    <h5 class="text-muted">No resources found</h5>
                    <p class="text-muted">
                        ${activeCategory === 'all' ? 
                            'No facilities with resources found.' : 
                            `No ${RESOURCE_CATEGORIES[activeCategory]?.name || activeCategory} resources found.`}
                    </p>
                </td>
            </tr>
        `;
    }
}

// ==================== FUNÇÕES AUXILIARES ====================
function updateSummaryCards() {
    const totalResources = allLocations.reduce((sum, loc) => sum + (loc.resources ? loc.resources.length : 0), 0);
    const categoriesCount = Object.keys(categoryStats).filter(cat => categoryStats[cat].count > 0).length;
    
    document.getElementById('totalFacilities').textContent = allLocations.length;
    document.getElementById('totalResources').textContent = totalResources;
    document.getElementById('totalCategories').textContent = categoriesCount;
    
    // Última atualização
    if (allLocations.length > 0) {
        const latestUpdate = allLocations.reduce((latest, loc) => {
            const updateTime = loc.updateAt ? new Date(loc.updateAt).getTime() : 0;
            return updateTime > latest ? updateTime : latest;
        }, 0);
        
        if (latestUpdate > 0) {
            document.getElementById('lastUpdate').textContent = new Date(latestUpdate).toLocaleString();
        }
    }
}

function updateCategorySummary() {
    const summaryContainer = document.getElementById('categorySummary');
    summaryContainer.innerHTML = '';
    
    // Ordena categorias por quantidade
    const sortedCategories = Object.keys(categoryStats)
        .filter(cat => categoryStats[cat].count > 0)
        .sort((a, b) => categoryStats[b].count - categoryStats[a].count);
    
    if (sortedCategories.length === 0) {
        summaryContainer.innerHTML = `
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                No resources categorized yet.
            </div>
        `;
        return;
    }
    
    sortedCategories.forEach(cat => {
        const catInfo = RESOURCE_CATEGORIES[cat];
        const stats = categoryStats[cat];
        
        const card = document.createElement('div');
        card.className = 'd-flex justify-content-between align-items-center mb-3 p-2 border rounded';
        card.style.borderLeft = `4px solid ${catInfo.color}`;
        
        card.innerHTML = `
            <div>
                <div class="d-flex align-items-center mb-1">
                    <i class="${catInfo.icon} me-2" style="color: ${catInfo.color}"></i>
                    <strong>${catInfo.name}</strong>
                </div>
                <small class="text-muted">${catInfo.description}</small>
            </div>
            <div class="text-end">
                <div class="fw-bold">${stats.count} items</div>
                <small class="text-muted">${stats.locations} locations</small>
            </div>
        `;
        
        card.onclick = () => setActiveCategory(cat);
        card.style.cursor = 'pointer';
        
        summaryContainer.appendChild(card);
    });
}

function toggleLegend() {
    const legend = document.getElementById('mapLegend');
    const isVisible = legend.style.display !== 'none';
    legend.style.display = isVisible ? 'none' : 'block';
    
    // Atualiza conteúdo da legenda
    const legendContent = document.getElementById('legendContent');
    const categoriesToShow = activeCategory === 'all' 
        ? Object.keys(categoryStats).filter(cat => categoryStats[cat].count > 0)
        : [activeCategory];
    
    legendContent.innerHTML = categoriesToShow.map(cat => {
        const catInfo = RESOURCE_CATEGORIES[cat];
        const stats = categoryStats[cat];
        return `
            <div class="d-flex align-items-center mb-2">
                <div style="width: 16px; height: 16px; background-color: ${catInfo.color}; border-radius: 3px; margin-right: 8px;"></div>
                <div style="flex: 1;">
                    <div class="fw-bold">${catInfo.name}</div>
                    <small class="text-muted">${stats.count} items in ${stats.locations} locations</small>
                </div>
            </div>
        `;
    }).join('');
}

function searchTable() {
    const searchTerm = document.getElementById('searchTable').value.toLowerCase();
    const rows = document.querySelectorAll('#tableBody tr');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
    });
}

function setMapLayer(layerName) {
    // Mapeia nomes amigáveis para camadas reais
    const layerMap = {
        'streets': 'Streets',
        'satellite': 'Satellite',
        'terrain': 'Terrain'
    };
    
    const layerKey = layerMap[layerName];
    if (layerKey && baseLayers[layerKey]) {
        map.eachLayer(layer => {
            if (layer === markerCluster) return;
            if (layer instanceof L.TileLayer) {
                map.removeLayer(layer);
            }
        });
        
        baseLayers[layerKey].addTo(map);
    }
}

// ==================== FUNÇÕES DE RELATÓRIO ====================
function printReport() {
    // Cria conteúdo do relatório
    let reportContent = `
        <style>
            @media print {
                body { font-family: Arial, sans-serif; }
                .report-header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 20px; }
                .report-title { font-size: 24px; font-weight: bold; color: #333; }
                .report-subtitle { font-size: 16px; color: #666; margin-top: 5px; }
                .report-date { font-size: 14px; color: #999; margin-top: 10px; }
                .section-title { font-size: 18px; font-weight: bold; margin-top: 30px; margin-bottom: 15px; padding-bottom: 5px; border-bottom: 1px solid #ddd; }
                .summary-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 30px; }
                .summary-card { border: 1px solid #ddd; border-radius: 8px; padding: 15px; text-align: center; }
                .summary-card h3 { margin: 0; font-size: 28px; color: #0d6efd; }
                .summary-card p { margin: 5px 0 0 0; color: #666; }
                .category-stats { margin-bottom: 30px; }
                .category-row { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
                .category-name { font-weight: bold; }
                .category-count { color: #0d6efd; font-weight: bold; }
                .table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                .table th { background-color: #f8f9fa; border-bottom: 2px solid #dee2e6; padding: 12px; text-align: left; }
                .table td { padding: 12px; border-bottom: 1px solid #dee2e6; }
                .location-section { page-break-inside: avoid; margin-bottom: 40px; }
                .location-header { background-color: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
                .resource-item { padding: 10px; margin-bottom: 10px; border-left: 4px solid #0d6efd; background-color: #f8f9fa; }
                .print-only { display: block; }
                .no-print { display: none; }
            }
            @media screen {
                .print-only { display: none; }
            }
        </style>
        
        <div class="report-header">
            <div class="report-title">PI-SAÚDE - Resources Geographic Mapping Report</div>
            <div class="report-subtitle">Resource Distribution Across Health Facilities</div>
            <div class="report-date">Generated on ${new Date().toLocaleString()}</div>
        </div>
        
        <div class="summary-grid">
            <div class="summary-card">
                <h3>${allLocations.length}</h3>
                <p>Total Facilities</p>
            </div>
            <div class="summary-card">
                <h3>${allLocations.reduce((sum, loc) => sum + (loc.resources ? loc.resources.length : 0), 0)}</h3>
                <p>Total Resources</p>
            </div>
            <div class="summary-card">
                <h3>${Object.keys(categoryStats).filter(cat => categoryStats[cat].count > 0).length}</h3>
                <p>Resource Categories</p>
            </div>
            <div class="summary-card">
                <h3>${activeCategory === 'all' ? 'All' : RESOURCE_CATEGORIES[activeCategory]?.name || activeCategory}</h3>
                <p>Current Filter</p>
            </div>
        </div>
        
        <div class="section-title">Resource Categories Summary</div>
        <div class="category-stats">
            ${Object.keys(categoryStats)
                .filter(cat => categoryStats[cat].count > 0)
                .sort((a, b) => categoryStats[b].count - categoryStats[a].count)
                .map(cat => {
                    const catInfo = RESOURCE_CATEGORIES[cat];
                    const stats = categoryStats[cat];
                    return `
                        <div class="category-row">
                            <div class="category-name">${catInfo.name}</div>
                            <div class="category-count">${stats.count} items in ${stats.locations} locations</div>
                        </div>
                    `;
                }).join('')}
        </div>
    `;
    
    // Adiciona seção por localização se não for filtro de categoria específica
    if (activeCategory === 'all') {
        reportContent += `
            <div class="section-title">Resources by Location</div>
        `;
        
        allLocations.forEach((location, index) => {
            if (location.resources && location.resources.length > 0) {
                const resourcesByCategory = groupResourcesByCategory(location.resources);
                
                reportContent += `
                    <div class="location-section">
                        <div class="location-header">
                            <h4>${index + 1}. ${location.name}</h4>
                            <p><strong>Location:</strong> ${location.latitude && location.longitude ? 
                                `${parseFloat(location.latitude).toFixed(4)}, ${parseFloat(location.longitude).toFixed(4)}` : 
                                'Not specified'}</p>
                            <p><strong>Responsible:</strong> ${location.responsavel || 'Not specified'}</p>
                            <p><strong>Total Resources:</strong> ${location.resources.length}</p>
                        </div>
                        
                        ${Object.keys(resourcesByCategory).map(cat => {
                            const catInfo = RESOURCE_CATEGORIES[cat] || { name: cat, color: '#6c757d' };
                            const categoryResources = resourcesByCategory[cat];
                            const totalQuantity = categoryResources.reduce((sum, r) => sum + (r.quantity || 1), 0);
                            
                            return `
                                <h5>${catInfo.name} (${categoryResources.length} items, ${totalQuantity} total)</h5>
                                ${categoryResources.map(resource => `
                                    <div class="resource-item">
                                        <strong>${resource.name || 'Unnamed Resource'}</strong>
                                        <div>Quantity: ${resource.quantity || 1}</div>
                                        ${resource.description ? `<div>${resource.description}</div>` : ''}
                                        ${resource.recebidopor ? `<div>Received by: ${resource.recebidopor}</div>` : ''}
                                        ${resource.datarecepcao ? `<div>Reception Date: ${new Date(resource.datarecepcao).toLocaleDateString()}</div>` : ''}
                                    </div>
                                `).join('')}
                            `;
                        }).join('')}
                    </div>
                `;
            }
        });
    } else {
        // Se for filtro específico, mostra apenas recursos daquela categoria
        const catInfo = RESOURCE_CATEGORIES[activeCategory];
        const stats = categoryStats[activeCategory] || { resources: [] };
        
        reportContent += `
            <div class="section-title">${catInfo.name} Resources (${stats.count} items)</div>
            <table class="table">
                <thead>
                    <tr>
                        <th>Location</th>
                        <th>Resource Name</th>
                        <th>Quantity</th>
                        <th>Description</th>
                        <th>Received By</th>
                        <th>Reception Date</th>
                    </tr>
                </thead>
                <tbody>
                    ${stats.resources.map(resource => `
                        <tr>
                            <td>${resource.locationName}</td>
                            <td>${resource.name || 'Unnamed Resource'}</td>
                            <td>${resource.quantity || 1}</td>
                            <td>${resource.description || ''}</td>
                            <td>${resource.recebidopor || ''}</td>
                            <td>${resource.datarecepcao ? new Date(resource.datarecepcao).toLocaleDateString() : ''}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
    }
    
    // Adiciona mapa impresso (simplificado)
    reportContent += `
        <div class="section-title">Geographic Distribution</div>
        <div style="text-align: center; margin: 30px 0;">
            <p><em>Map visualization showing resource distribution across ${allLocations.length} facilities</em></p>
            <div style="background-color: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6;">
                <p><strong>Map Legend:</strong></p>
                ${Object.keys(RESOURCE_CATEGORIES)
                    .filter(cat => categoryStats[cat] && categoryStats[cat].count > 0)
                    .map(cat => {
                        const catInfo = RESOURCE_CATEGORIES[cat];
                        return `<div style="display: inline-block; margin: 0 10px;">
                            <span style="display: inline-block; width: 12px; height: 12px; background-color: ${catInfo.color}; border-radius: 2px; margin-right: 5px;"></span>
                            ${catInfo.name}
                        </div>`;
                    }).join('')}
            </div>
        </div>
        
        <div style="margin-top: 50px; padding-top: 20px; border-top: 1px solid #ddd; font-size: 12px; color: #666; text-align: center;">
            <p>Report generated by PI-SAÚDE System</p>
            <p>For more information, contact the system administrator</p>
        </div>
    `;
    
    // Mostra no modal
    document.getElementById('printReportContent').innerHTML = reportContent;
    const modal = new bootstrap.Modal(document.getElementById('printReportModal'));
    modal.show();
}

function printLocationReport(locationId) {
    const location = allLocations.find(loc => loc.id == locationId);
    if (!location) return;
    
    let reportContent = `
        <style>
            @media print {
                body { font-family: Arial, sans-serif; }
                .report-header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 20px; }
                .report-title { font-size: 24px; font-weight: bold; color: #333; }
                .report-subtitle { font-size: 16px; color: #666; margin-top: 5px; }
                .report-date { font-size: 14px; color: #999; margin-top: 10px; }
                .location-info { background-color: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px; }
                .info-row { display: flex; margin-bottom: 10px; }
                .info-label { font-weight: bold; min-width: 150px; }
                .section-title { font-size: 18px; font-weight: bold; margin-top: 30px; margin-bottom: 15px; padding-bottom: 5px; border-bottom: 1px solid #ddd; }
                .category-section { margin-bottom: 30px; page-break-inside: avoid; }
                .category-header { background-color: #e9ecef; padding: 10px 15px; border-radius: 5px; margin-bottom: 15px; display: flex; justify-content: space-between; }
                .resource-item { padding: 15px; margin-bottom: 10px; border: 1px solid #dee2e6; border-radius: 5px; }
                .resource-name { font-weight: bold; font-size: 16px; margin-bottom: 5px; }
                .resource-details { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 10px; }
                .detail-item { font-size: 14px; }
                .detail-label { font-weight: bold; color: #666; }
                .print-only { display: block; }
                .no-print { display: none; }
            }
            @media screen {
                .print-only { display: none; }
            }
        </style>
        
        <div class="report-header">
            <div class="report-title">PI-SAÚDE - Facility Resources Report</div>
            <div class="report-subtitle">${location.name}</div>
            <div class="report-date">Generated on ${new Date().toLocaleString()}</div>
        </div>
        
        <div class="location-info">
            <div class="info-row">
                <div class="info-label">Facility Name:</div>
                <div>${location.name}</div>
            </div>
            <div class="info-row">
                <div class="info-label">Description:</div>
                <div>${location.description || 'Not provided'}</div>
            </div>
            <div class="info-row">
                <div class="info-label">Responsible Entity:</div>
                <div>${location.responsavel || 'Not specified'}</div>
            </div>
            <div class="info-row">
                <div class="info-label">Location:</div>
                <div>${location.latitude && location.longitude ? 
                    `${parseFloat(location.latitude).toFixed(6)}, ${parseFloat(location.longitude).toFixed(6)}` : 
                    'Not specified'}</div>
            </div>
            <div class="info-row">
                <div class="info-label">Total Resources:</div>
                <div>${location.resources ? location.resources.length : 0} items</div>
            </div>
            <div class="info-row">
                <div class="info-label">Last Updated:</div>
                <div>${location.updateAt ? new Date(location.updateAt).toLocaleString() : 'Not available'}</div>
            </div>
        </div>
    `;
    
    if (location.resources && location.resources.length > 0) {
        const resourcesByCategory = groupResourcesByCategory(location.resources);
        
        reportContent += `<div class="section-title">Resources by Category</div>`;
        
        Object.keys(resourcesByCategory).forEach(cat => {
            const catInfo = RESOURCE_CATEGORIES[cat] || { name: cat, color: '#6c757d' };
            const categoryResources = resourcesByCategory[cat];
            const totalQuantity = categoryResources.reduce((sum, r) => sum + (r.quantity || 1), 0);
            
            reportContent += `
                <div class="category-section">
                    <div class="category-header" style="border-left: 4px solid ${catInfo.color};">
                        <div>
                            <strong>${catInfo.name}</strong>
                            <div>${categoryResources.length} items, ${totalQuantity} total quantity</div>
                        </div>
                        <div>
                            <i class="${catInfo.icon}"></i>
                        </div>
                    </div>
                    
                    ${categoryResources.map(resource => {
                        // Tenta encontrar o tipo de recurso
                        let resourceType = '';
                        if (resource.resource_id) {
                            const availableResource = availableResources.find(r => r.id == resource.resource_id);
                            if (availableResource) {
                                resourceType = availableResource.name;
                            }
                        }
                        
                        return `
                            <div class="resource-item">
                                <div class="resource-name">${resource.name || 'Unnamed Resource'}</div>
                                ${resourceType ? `<div class="detail-item"><span class="detail-label">Type:</span> ${resourceType}</div>` : ''}
                                ${resource.description ? `<div class="detail-item"><span class="detail-label">Description:</span> ${resource.description}</div>` : ''}
                                
                                <div class="resource-details">
                                    <div class="detail-item">
                                        <span class="detail-label">Quantity:</span> ${resource.quantity || 1}
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">Status:</span> ${resource.status || 'available'}
                                    </div>
                                    ${resource.recebidopor ? `
                                        <div class="detail-item">
                                            <span class="detail-label">Received by:</span> ${resource.recebidopor}
                                        </div>
                                    ` : ''}
                                    ${resource.datarecepcao ? `
                                        <div class="detail-item">
                                            <span class="detail-label">Reception Date:</span> ${new Date(resource.datarecepcao).toLocaleDateString()}
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        });
    } else {
        reportContent += `
            <div class="section-title">Resources</div>
            <div style="text-align: center; padding: 40px; background-color: #f8f9fa; border-radius: 8px;">
                <p style="color: #666;">No resources found for this facility.</p>
            </div>
        `;
    }
    
    reportContent += `
        <div style="margin-top: 50px; padding-top: 20px; border-top: 1px solid #ddd; font-size: 12px; color: #666; text-align: center;">
            <p>Report generated by PI-SAÚDE System</p>
            <p>For more information, contact the system administrator</p>
        </div>
    `;
    
    // Mostra no modal
    document.getElementById('printReportContent').innerHTML = reportContent;
    const modal = new bootstrap.Modal(document.getElementById('printReportModal'));
    modal.show();
}

// ==================== FUNÇÕES DE AÇÃO ====================
function editLocation(id) {
    window.location.href = `/locations?id=${id}`;
}

function viewLocationResources(id, name) {
    window.location.href = `/locations?id=${id}#resources`;
}

function openLocationModal() {
    window.location.href = '/locations';
}

function deleteLocation(id) {
    if (confirm('Are you sure you want to delete this facility? This action cannot be undone.')) {
        fetch(`${apiUrl}/${id}`, { method: 'DELETE' })
            .then(res => {
                if (res.ok) {
                    showAlert('success', 'Facility deleted successfully.');
                    loadLocationsData();
                } else {
                    throw new Error('Failed to delete facility');
                }
            })
            .catch(err => {
                console.error('Error deleting location:', err);
                showAlert('error', 'Error deleting facility: ' + err.message);
            });
    }
}

function refreshData() {
    loadLocationsData();
    showAlert('info', 'Refreshing data...');
}

function exportToPDF() {
    // Primeiro gera o relatório, depois permite imprimir como PDF
    printReport();
}

function exportToCSV() {
    showAlert('info', 'CSV export feature coming soon!');
}

function showLoading() {
    const tableBody = document.getElementById('tableBody');
    if (tableBody) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="8" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 mb-0">Loading resources data...</p>
                </td>
            </tr>
        `;
    }
    
    const summaryContainer = document.getElementById('categorySummary');
    if (summaryContainer) {
        summaryContainer.innerHTML = `
            <div class="text-center py-4">
                <div class="spinner-border text-success" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2 mb-0">Loading categories...</p>
            </div>
        `;
    }
}

function hideLoading() {
    // Remove spinners when data is loaded
}

function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = `
        top: 20px;
        right: 20px;
        z-index: 1050;
        min-width: 300px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    `;
    
    alertDiv.innerHTML = `
        <strong>${type === 'success' ? '✓' : '⚠'} ${type.charAt(0).toUpperCase() + type.slice(1)}!</strong> ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.classList.remove('show');
            setTimeout(() => alertDiv.remove(), 150);
        }
    }, 5000);
}

// ==================== INICIALIZAÇÃO ====================
window.onload = function() {
    initMap();
};

// Atualiza dados a cada 2 minutos
setInterval(refreshData, 2 * 60 * 1000);
</script>
{% endblock %}