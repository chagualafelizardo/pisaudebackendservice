{% extends 'base.html' %}
{% block title %}PI-SA√öDE / Dashboard{% endblock %}

{% block content %}

<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1">üìä Dashboard PI-SA√öDE</h2>
            <p class="text-muted mb-0">Monitoriza√ß√£o e gest√£o de pacientes em tempo real</p>
        </div>
        
        <!-- Shortcuts Group -->
        <div class="d-flex align-items-center gap-3">
            <!-- Quick Access Dropdown -->
            <div class="dropdown">
                <button class="btn btn-outline-primary dropdown-toggle" type="button" id="quickAccessDropdown" data-bs-toggle="dropdown">
                    <i class="fas fa-rocket me-1"></i> Acesso R√°pido
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item" href="/content/iniciotarv">
                        <i class="fas fa-file-medical me-2 text-primary"></i> In√≠cio TARV
                    </a></li>
                    <li><a class="dropdown-item" href="/content/adesaotarv">
                        <i class="fas fa-heart me-2 text-success"></i> Ades√£o ao TARV
                    </a></li>
                    <li><a class="dropdown-item" href="/content/marcadoslevantamento">
                        <i class="fas fa-calendar-check me-2 text-warning"></i> Marcados Para Levantamento de ARVs
                    </a></li>
                    <li><a class="dropdown-item" href="/content/cargaviral">
                        <i class="fas fa-vial me-2 text-info"></i> Carga Viral
                    </a></li>
                    <li><a class="dropdown-item" href="/content/faltosos">
                        <i class="fas fa-user-clock me-2 text-danger"></i> Faltosos
                    </a></li>
                    <li><a class="dropdown-item" href="/content/abandonos">
                        <i class="fas fa-user-slash me-2 text-secondary"></i> Abandonos
                    </a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="/content/observations">
                        <i class="fas fa-clipboard-list me-2 text-dark"></i> Observations
                    </a></li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Filtros de Data -->
    <div class="card p-3 mb-4 shadow-sm">
        <div class="row g-3 align-items-end">
            <div class="col-md-3">
                <label class="form-label"><strong>Data Inicial</strong></label>
                <input type="date" id="filterStartDate" class="form-control">
            </div>
            <div class="col-md-3">
                <label class="form-label"><strong>Data Final</strong></label>
                <input type="date" id="filterEndDate" class="form-control">
            </div>
            <div class="col-md-2">
                <label class="form-label"><strong>Localiza√ß√£o</strong></label>
                <select id="filterLocation" class="form-select">
                    <option value="">Todas</option>
                </select>
            </div>
            <div class="col-md-2">
                <button class="btn btn-primary w-100" onclick="loadDashboardData()">
                    <i class="fas fa-filter me-1"></i> Aplicar
                </button>
            </div>
            <div class="col-md-2">
                <button class="btn btn-secondary w-100" onclick="clearDashboardFilters()">
                    <i class="fas fa-times me-1"></i> Limpar
                </button>
            </div>
        </div>
    </div>

    <!-- Cards de Resumo -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-white bg-primary border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title mb-1">üìã Total Pacientes</h6>
                            <h2 id="totalPatients" class="card-text mb-0">0</h2>
                        </div>
                        <i class="fas fa-users fs-1 opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-success border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title mb-1">üíä Levantamentos</h6>
                            <h2 id="levantamentosCount" class="card-text mb-0">0</h2>
                        </div>
                        <i class="fas fa-pills fs-1 opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-warning border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title mb-1">‚ö†Ô∏è Faltosos</h6>
                            <h2 id="faltososCount" class="card-text mb-0">0</h2>
                        </div>
                        <i class="fas fa-exclamation-triangle fs-1 opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-info border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title mb-1">üìû Chamadas</h6>
                            <h2 id="chamadasCount" class="card-text mb-0">0</h2>
                        </div>
                        <i class="fas fa-phone fs-1 opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Gr√°ficos Principais -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="card-title mb-0">üìà Distribui√ß√£o por Tipo de A√ß√£o (Semanal)</h5>
                </div>
                <div class="card-body">
                    <canvas id="actionsChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="card-title mb-0">üìÖ Evolu√ß√£o Semanal</h5>
                </div>
                <div class="card-body">
                    <canvas id="weeklyTrendChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabelas Detalhadas -->
    <div class="row">
        <!-- 1. Pacientes para Levantamento -->
        <div class="col-md-6 mb-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">üíä Pacientes para Levantamento</h5>
                    <span class="badge bg-primary" id="levantamentosBadge">0</span>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Contacto</th>
                                    <th>Data Levant.</th>
                                    <th>Localiza√ß√£o</th>
                                </tr>
                            </thead>
                            <tbody id="levantamentosTable">
                                <!-- Dados ser√£o carregados via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. Pacientes Faltosos -->
        <div class="col-md-6 mb-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">‚ö†Ô∏è Pacientes Faltosos</h5>
                    <span class="badge bg-warning" id="faltososBadge">0</span>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Contacto</th>
                                    <th>√öltima CV</th>
                                    <th>Dias Faltosos</th>
                                </tr>
                            </thead>
                            <tbody id="faltososTable">
                                <!-- Dados ser√£o carregados via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. Pacientes para Chamadas -->
        <div class="col-md-6 mb-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">üìû Pacientes para Chamadas</h5>
                    <span class="badge bg-info" id="chamadasBadge">0</span>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Contacto</th>
                                    <th>Pr√≥xima Consulta</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody id="chamadasTable">
                                <!-- Dados ser√£o carregados via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 4. Pacientes para Visitas Domiciliares -->
        <div class="col-md-6 mb-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">üè† Pacientes para Visitas</h5>
                    <span class="badge bg-success" id="visitasBadge">0</span>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Contacto</th>
                                    <th>Localiza√ß√£o</th>
                                    <th>Observa√ß√£o</th>
                                </tr>
                            </thead>
                            <tbody id="visitasTable">
                                <!-- Dados ser√£o carregados via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loader -->
<div id="dashboardLoader" class="text-center" style="display: none;">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">A carregar...</span>
    </div>
    <p class="mt-2">A carregar dados do dashboard...</p>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Vari√°veis globais
let actionsChart = null;
let weeklyTrendChart = null;
let dashboardData = {};

// API Endpoints
const apiObs = '/api/observation';
const apiLocation = '/api/location';
const apiDashboard = '/api/dashboard';

/* ============== INICIALIZA√á√ÉO ============== */
async function initializeDashboard() {
    await loadLocations();
    setDefaultDates();
    await loadDashboardData();
}

/* ============== CARREGAMENTO DE DADOS ============== */
async function loadDashboardData() {
    showLoader(true);
    
    try {
        const filters = getDashboardFilters();
        const queryParams = new URLSearchParams(filters).toString();
        const url = queryParams ? `${apiDashboard}?${queryParams}` : apiDashboard;
        
        const response = await fetch(url);
        const data = await response.json();
        
        dashboardData = data;
        updateDashboardUI();
        
    } catch (error) {
        console.error('Erro ao carregar dados:', error);
        showAlert('error', 'Erro ao carregar dados do dashboard');
    } finally {
        showLoader(false);
    }
}

function getDashboardFilters() {
    const filters = {};
    
    const startDate = document.getElementById('filterStartDate').value;
    const endDate = document.getElementById('filterEndDate').value;
    const location = document.getElementById('filterLocation').value;
    
    if (startDate) filters.startDate = startDate;
    if (endDate) filters.endDate = endDate;
    if (location) filters.locationId = location;
    
    return filters;
}

function setDefaultDates() {
    const today = new Date();
    const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
    
    document.getElementById('filterStartDate').value = firstDay.toISOString().split('T')[0];
    document.getElementById('filterEndDate').value = today.toISOString().split('T')[0];
}

/* ============== ATUALIZA√á√ÉO DA UI ============== */
function updateDashboardUI() {
    updateSummaryCards();
    updateCharts();
    updateTables();
}

function updateSummaryCards() {
    const stats = dashboardData.stats || {};
    
    document.getElementById('totalPatients').textContent = stats.totalPatients || 0;
    document.getElementById('levantamentosCount').textContent = stats.levantamentosCount || 0;
    document.getElementById('faltososCount').textContent = stats.faltososCount || 0;
    document.getElementById('chamadasCount').textContent = stats.chamadasCount || 0;
}

function updateCharts() {
    updateActionsChart();
    updateWeeklyTrendChart();
}

function updateActionsChart() {
    const ctx = document.getElementById('actionsChart').getContext('2d');
    const weeklyData = dashboardData.weeklyStats || {};
    
    if (actionsChart) {
        actionsChart.destroy();
    }
    
    actionsChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Levantamentos', 'Faltosos', 'Chamadas', 'Visitas'],
            datasets: [{
                data: [
                    weeklyData.levantamentos || 0,
                    weeklyData.faltosos || 0,
                    weeklyData.chamadas || 0,
                    weeklyData.visitas || 0
                ],
                backgroundColor: [
                    '#007bff', '#ffc107', '#17a2b8', '#28a745'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20
                    }
                }
            }
        }
    });
}

function updateWeeklyTrendChart() {
    const ctx = document.getElementById('weeklyTrendChart').getContext('2d');
    const trendData = dashboardData.weeklyTrend || {};
    
    if (weeklyTrendChart) {
        weeklyTrendChart.destroy();
    }
    
    weeklyTrendChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: trendData.weeks || ['Sem 1', 'Sem 2', 'Sem 3', 'Sem 4'],
            datasets: [
                {
                    label: 'Levantamentos',
                    data: trendData.levantamentos || [0, 0, 0, 0],
                    borderColor: '#007bff',
                    backgroundColor: 'rgba(0, 123, 255, 0.1)',
                    borderWidth: 2,
                    tension: 0.4,
                    fill: true
                },
                {
                    label: 'Faltosos',
                    data: trendData.faltosos || [0, 0, 0, 0],
                    borderColor: '#ffc107',
                    backgroundColor: 'rgba(255, 193, 7, 0.1)',
                    borderWidth: 2,
                    tension: 0.4,
                    fill: true
                },
                {
                    label: 'Chamadas',
                    data: trendData.chamadas || [0, 0, 0, 0],
                    borderColor: '#17a2b8',
                    backgroundColor: 'rgba(23, 162, 184, 0.1)',
                    borderWidth: 2,
                    tension: 0.4,
                    fill: true
                }
            ]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        drawBorder: false
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'top',
                }
            }
        }
    });
}

function updateTables() {
    updateLevantamentosTable();
    updateFaltososTable();
    updateChamadasTable();
    updateVisitasTable();
}

function updateLevantamentosTable() {
    const tableBody = document.getElementById('levantamentosTable');
    const patients = dashboardData.levantamentos || [];
    
    document.getElementById('levantamentosBadge').textContent = patients.length;
    
    tableBody.innerHTML = patients.map(patient => `
        <tr>
            <td><strong>${patient.fullname || 'N/A'}</strong></td>
            <td><span class="text-muted">${patient.contact || 'N/A'}</span></td>
            <td><small>${formatDate(patient.dataproximolevantamento)}</small></td>
            <td><span class="badge bg-light text-dark">${patient.location?.name || 'N/A'}</span></td>
        </tr>
    `).join('');
    
    if (patients.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="4" class="text-center text-muted py-3">Nenhum paciente para levantamento esta semana</td></tr>';
    }
}

function updateFaltososTable() {
    const tableBody = document.getElementById('faltososTable');
    const patients = dashboardData.faltosos || [];
    
    document.getElementById('faltososBadge').textContent = patients.length;
    
    tableBody.innerHTML = patients.map(patient => `
        <tr>
            <td><strong>${patient.fullname || 'N/A'}</strong></td>
            <td><span class="text-muted">${patient.contact || 'N/A'}</span></td>
            <td><small>${formatDate(patient.dataultimacv)}</small></td>
            <td><span class="badge bg-danger">${calculateDaysMissing(patient.dataultimacv)} dias</span></td>
        </tr>
    `).join('');
    
    if (patients.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="4" class="text-center text-muted py-3">Nenhum paciente faltoso</td></tr>';
    }
}

function updateChamadasTable() {
    const tableBody = document.getElementById('chamadasTable');
    const patients = dashboardData.chamadas || [];
    
    document.getElementById('chamadasBadge').textContent = patients.length;
    
    tableBody.innerHTML = patients.map(patient => `
        <tr>
            <td><strong>${patient.fullname || 'N/A'}</strong></td>
            <td><span class="text-muted">${patient.contact || 'N/A'}</span></td>
            <td><small>${formatDate(patient.dataproximaconsulta)}</small></td>
            <td><span class="badge bg-info">Para contactar</span></td>
        </tr>
    `).join('');
    
    if (patients.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="4" class="text-center text-muted py-3">Nenhuma chamada pendente</td></tr>';
    }
}

function updateVisitasTable() {
    const tableBody = document.getElementById('visitasTable');
    const patients = dashboardData.visitas || [];
    
    document.getElementById('visitasBadge').textContent = patients.length;
    
    tableBody.innerHTML = patients.map(patient => `
        <tr>
            <td><strong>${patient.fullname || 'N/A'}</strong></td>
            <td><span class="text-muted">${patient.contact || 'N/A'}</span></td>
            <td><span class="badge bg-light text-dark">${patient.location?.name || 'N/A'}</span></td>
            <td><small class="text-muted">${patient.observation || 'Visita domiciliar necess√°ria'}</small></td>
        </tr>
    `).join('');
    
    if (patients.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="4" class="text-center text-muted py-3">Nenhuma visita pendente</td></tr>';
    }
}

/* ============== FUN√á√ïES AUXILIARES ============== */
async function loadLocations() {
    try {
        const response = await fetch(apiLocation);
        const locations = await response.json();
        
        const select = document.getElementById('filterLocation');
        select.innerHTML = '<option value="">Todas as localiza√ß√µes</option>';
        
        locations.forEach(location => {
            select.innerHTML += `<option value="${location.id}">${location.name}</option>`;
        });
    } catch (error) {
        console.error('Erro ao carregar localiza√ß√µes:', error);
    }
}

function formatDate(dateString) {
    if (!dateString) return 'N/A';
    
    try {
        const date = new Date(dateString);
        return date.toLocaleDateString('pt-PT');
    } catch (error) {
        return 'N/A';
    }
}

function calculateDaysMissing(lastCVDate) {
    if (!lastCVDate) return 'N/A';
    
    try {
        const lastCV = new Date(lastCVDate);
        const today = new Date();
        const diffTime = Math.abs(today - lastCV);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        return diffDays;
    } catch (error) {
        return 'N/A';
    }
}

function showLoader(show) {
    document.getElementById('dashboardLoader').style.display = show ? 'block' : 'none';
}

function clearDashboardFilters() {
    document.getElementById('filterStartDate').value = '';
    document.getElementById('filterEndDate').value = '';
    document.getElementById('filterLocation').value = '';
    loadDashboardData();
}

function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = `
        top: 20px;
        right: 20px;
        z-index: 1050;
        min-width: 300px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    `;
    
    alertDiv.innerHTML = `
        <strong>${type === 'success' ? '‚úì' : '‚ö†'} ${type.charAt(0).toUpperCase() + type.slice(1)}!</strong> ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.classList.remove('show');
            setTimeout(() => alertDiv.remove(), 150);
        }
    }, 5000);
}

/* ============== INICIALIZA√á√ÉO ============== */
document.addEventListener('DOMContentLoaded', function() {
    initializeDashboard();
    
    // Atualizar automaticamente a cada 5 minutos
    setInterval(loadDashboardData, 300000);
});
</script>

<style>
.card {
    transition: transform 0.2s, box-shadow 0.2s;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 .5rem 1rem rgba(0,0,0,.15)!important;
}

.table-responsive {
    max-height: 300px;
    overflow-y: auto;
}

.badge {
    font-size: 0.8em;
    font-weight: 500;
}

/* Quick access dropdown */
#quickAccessDropdown {
    border-width: 2px;
}

#quickAccessDropdown:hover {
    background-color: #f8f9fa;
}

.dropdown-menu {
    border: 1px solid #dee2e6;
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
}

.dropdown-item {
    padding: 0.5rem 1rem;
    transition: all 0.2s ease;
}

.dropdown-item:hover {
    background-color: #f8f9fa;
    transform: translateX(5px);
}

.dropdown-item i {
    width: 20px;
    text-align: center;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .d-flex.justify-content-between.align-items-center.mb-4 {
        flex-direction: column;
        align-items: flex-start !important;
    }
    
    .d-flex.align-items-center.gap-3 {
        margin-top: 1rem;
        width: 100%;
        justify-content: space-between;
    }
}

/* Summary cards improvements */
.card-body .fa-users,
.card-body .fa-pills,
.card-body .fa-exclamation-triangle,
.card-body .fa-phone {
    opacity: 0.7;
}

/* Table styling */
.table-sm th {
    font-weight: 600;
    font-size: 0.85rem;
    color: #495057;
    border-bottom: 2px solid #dee2e6;
}

.table-sm td {
    font-size: 0.875rem;
    padding: 0.5rem;
}

.table-hover tbody tr:hover {
    background-color: rgba(0, 123, 255, 0.05);
}
</style>

<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

{% endblock %}