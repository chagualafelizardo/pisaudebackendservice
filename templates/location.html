{% extends 'base.html' %}

{% block title %}PI-SA√öDE / Locations{% endblock %}

{% block content %}
<!-- {% include 'navbar.html' %} -->

<h2>Manage Health Facility</h2>

<!-- Floating Action Button (FAB) -->
<button class="btn btn-success rounded-circle position-fixed"
        style="bottom: 20px; right: 20px; width: 60px; height: 60px; font-size: 28px; z-index: 1000;"
        onclick="openLocationModal()">
    +
</button>

<!-- Tabela de locations -->
<table class="table table-bordered">
    <thead>
        <tr>
            <th>ID</th>
            <th>Health Facility Name</th>
            <th>Description</th>
            <th>Latitude</th>
            <th>Longitude</th>
            <th>Resources</th>
            <th>Responsavel</th>
            <th>Observa√ß√µes</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody id="locationsTableBody">
        <!-- Populado via JS -->
    </tbody>
</table>

<!-- Modal de Formul√°rio -->
<div class="modal fade" id="locationModal" tabindex="-1" aria-labelledby="locationModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <form id="locationForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="locationModalLabel">Add/Edit Health Facility</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="locationId">

        <div class="mb-3">
          <label for="locationName" class="form-label">Health Facility Name</label>
          <input type="text" id="locationName" class="form-control" required>
        </div>

        <div class="mb-3">
          <label for="locationDescription" class="form-label">Description</label>
          <textarea id="locationDescription" class="form-control" required></textarea>
        </div>

        <!-- üîπ NOVO CAMPO: Respons√°vel -->
        <div class="mb-3">
          <label for="responsavel" class="form-label">Respons√°vel</label>
          <select id="responsavel" class="form-select" required>
            <option value="DOD">DOD</option>
            <option value="Jhpiego">Jhpiego</option>
            <option value="RISE">RISE</option>
          </select>
        </div>

        <div class="mb-3">
          <label for="latitude" class="form-label">Latitude</label>
          <input type="text" id="latitude" class="form-control">
        </div>

        <div class="mb-3">
          <label for="longitude" class="form-label">Longitude</label>
          <input type="text" id="longitude" class="form-control">
        </div>

        <div class="mb-3">
            <label for="observacoes" class="form-label">Observa√ß√µes</label>
            <textarea id="observacoes" class="form-control" rows="3" placeholder="Coment√°rios ou informa√ß√µes adicionais"></textarea>
        </div>

        <!-- Search Location -->
        <div class="mb-3">
            <label for="locationSearch" class="form-label">Search Location</label>
            <input type="text" id="locationSearch" class="form-control" placeholder="Search for a place">
        </div>

        <!-- Container do mapa com bot√£o de altern√¢ncia -->
        <div id="mapContainer" style="position: relative; height: 400px; margin-bottom: 15px;">
          <div id="map" style="height: 100%;"></div>
          <button id="toggleMapTypeBtn" class="btn btn-info position-absolute"
                  style="top: 10px; left: 10px; z-index: 1000; padding: 5px 10px;">
              Satellite
          </button>
        </div>

        <div class="mb-3">
          <label class="form-label">Resources</label>
          <div id="resourceRows"></div>
          <button type="button" class="btn btn-sm btn-secondary mt-2" onclick="addResourceRow()">+ Add Resource</button>
        </div>
      </div>

      <div class="modal-footer">
        <button type="submit" class="btn btn-primary">Save</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
      </div>
    </form>
  </div>
</div>

<script>
const apiUrl = '/api/location';
const apiResources = '/api/resource';
let availableResources = [];

let map, marker, autocomplete;

// Coordenadas de Maputo
const MAPUTO_CENTER = { lat: -25.9636, lng: 32.5805 };

async function fetchResources() {
    try {
        const res = await fetch(apiResources);
        availableResources = await res.json();
    } catch (error) {
        console.error('Error fetching resources:', error);
    }
}

function addResourceRow(resourceId = '', quantity = '') {
    const container = document.getElementById('resourceRows');

    const row = document.createElement('div');
    row.className = 'row mb-2 align-items-center';
    row.innerHTML = `
        <div class="col-md-6">
            <select class="form-select resource-select" required>
                <option value="">Select Resource</option>
                ${availableResources.map(r => `
                    <option value="${r.id}" ${r.id == resourceId ? 'selected' : ''}>${r.name}</option>
                `).join('')}
            </select>
        </div>
        <div class="col-md-4">
            <input type="number" min="0" class="form-control quantity-input" value="${quantity}" placeholder="Quantity" required>
        </div>
        <div class="col-md-2">
            <button type="button" class="btn btn-danger btn-sm" onclick="this.closest('.row').remove()">‚úï</button>
        </div>
    `;
    container.appendChild(row);
}

function initializeMap(lat = -25.9636, lng = 32.5805) {
    const center = { lat: parseFloat(lat), lng: parseFloat(lng) };

    // Limpa o container antes de recriar se necess√°rio
    if (!document.getElementById("map").innerHTML) {
        document.getElementById("map").innerHTML = "";
    }

    map = new google.maps.Map(document.getElementById("map"), {
        center: center,
        zoom: 7,
        mapTypeId: "terrain"
    });

    marker = new google.maps.Marker({
        position: center,
        map: map,
        draggable: true
    });

    // Atualiza coordenadas ao clicar no mapa
    map.addListener("click", (event) => {
        marker.setPosition(event.latLng);
        document.getElementById("latitude").value = event.latLng.lat().toFixed(6);
        document.getElementById("longitude").value = event.latLng.lng().toFixed(6);
    });

    // Atualiza coordenadas ao arrastar o marcador
    marker.addListener("dragend", () => {
        const pos = marker.getPosition();
        document.getElementById("latitude").value = pos.lat().toFixed(6);
        document.getElementById("longitude").value = pos.lng().toFixed(6);
    });

    // Configura a pesquisa de lugares
    const input = document.getElementById("locationSearch");
    autocomplete = new google.maps.places.Autocomplete(input);
    autocomplete.bindTo("bounds", map);

    autocomplete.addListener("place_changed", () => {
        const place = autocomplete.getPlace();
        if (!place.geometry) return;

        map.panTo(place.geometry.location);
        map.setZoom(15);
        marker.setPosition(place.geometry.location);

        document.getElementById("latitude").value = place.geometry.location.lat().toFixed(6);
        document.getElementById("longitude").value = place.geometry.location.lng().toFixed(6);
    });

    // Bot√£o para alternar tipo de mapa
    const btn = document.getElementById("toggleMapTypeBtn");
    btn.onclick = () => {
        const current = map.getMapTypeId();
        const newType = current === "terrain" ? "satellite" : "terrain";
        map.setMapTypeId(newType);
        btn.textContent = newType === "terrain" ? "Satellite" : "Map";
    };

    // Atualiza coordenadas iniciais
    document.getElementById("latitude").value = center.lat.toFixed(6);
    document.getElementById("longitude").value = center.lng.toFixed(6);
}

function openLocationModal(locationData = null) {
    // Reseta o formul√°rio
    document.getElementById('locationForm').reset();
    document.getElementById('locationId').value = '';
    document.getElementById('resourceRows').innerHTML = '';
    document.getElementById('locationSearch').value = '';
    
    // Adiciona uma linha de recurso vazia
    addResourceRow();

    // Se est√° editando, preenche os dados
    if (locationData) {
        document.getElementById('locationId').value = locationData.id;
        document.getElementById('locationName').value = locationData.name;
        document.getElementById('locationDescription').value = locationData.description || '';
        document.getElementById('latitude').value = locationData.latitude || '';
        document.getElementById('longitude').value = locationData.longitude || '';
        document.getElementById('responsavel').value = locationData.responsavel || 'DOD'; // üîπ NOVO CAMPO
        
        // Limpa recursos anteriores e adiciona os novos
        document.getElementById('resourceRows').innerHTML = '';
        if (locationData.resources && locationData.resources.length > 0) {
            locationData.resources.forEach(r => addResourceRow(r.id, r.quantity));
        } else {
            addResourceRow();
        }
    } else {
        // Para novo local, reseta as coordenadas
        document.getElementById('latitude').value = '';
        document.getElementById('longitude').value = '';
        document.getElementById('responsavel').value = 'DOD'; // üîπ VALOR PADR√ÉO
    }

    // Mostra o modal
    const modal = new bootstrap.Modal(document.getElementById('locationModal'));
    modal.show();

    // ‚ö° Corre√ß√£o crucial para modais Bootstrap - inicializa o mapa quando o modal estiver vis√≠vel
    document.getElementById('locationModal').addEventListener('shown.bs.modal', function() {
        if (locationData && locationData.latitude && locationData.longitude) {
            initializeMap(locationData.latitude, locationData.longitude);
        } else {
            initializeMap();
        }
        
        // For√ßa a atualiza√ß√£o do mapa
        setTimeout(() => {
            google.maps.event.trigger(map, "resize");
            if (locationData && locationData.latitude && locationData.longitude) {
                const position = {
                    lat: parseFloat(locationData.latitude),
                    lng: parseFloat(locationData.longitude)
                };
                map.setCenter(position);
                map.setZoom(15);
            } else {
                map.setCenter(MAPUTO_CENTER);
            }
        }, 100);
    }, { once: true });
}

async function loadLocations() {
    try {
        const res = await fetch(apiUrl);
        const locations = await res.json();
        const tbody = document.getElementById('locationsTableBody');
        tbody.innerHTML = '';

        locations.forEach(loc => {
            const resourceList = loc.resources && loc.resources.length > 0 
                ? loc.resources.map(r => `${r.name} (${r.quantity})`).join(', ')
                : 'No resources';

            tbody.innerHTML += `
                <tr>
                    <td>${loc.id}</td>
                    <td>${loc.name}</td>
                    <td>${loc.description || ''}</td>
                    <td>${loc.latitude || ''}</td>
                    <td>${loc.longitude || ''}</td>
                    <td>${resourceList}</td>
                    <td>${loc.responsavel || 'DOD'}</td>
                    <td>${loc.observacoes || ''}</td>
                    <td>
                        <button class="btn btn-sm btn-warning" onclick="editLocation(${loc.id})">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteLocation(${loc.id})">Delete</button>
                    </td>
                </tr>
            `;
        });
    } catch (err) {
        console.error('Error loading locations:', err);
        alert('Error loading locations: ' + err.message);
    }
}

// CORRE√á√ÉO: Esta fun√ß√£o estava com problema - agora chama openLocationModal com os dados
async function editLocation(locationId) {
    try {
        console.log('Fetching location data for ID:', locationId);
        const res = await fetch(`${apiUrl}/${locationId}`);
        
        if (!res.ok) {
            throw new Error(`HTTP error! status: ${res.status}`);
        }
        
        const locationData = await res.json();
        console.log('Location data received:', locationData);
        
        // Chama openLocationModal passando os dados do location
        openLocationModal(locationData);
    } catch (error) {
        console.error('Error fetching location:', error);
        alert('Error loading location data: ' + error.message);
    }
}

async function deleteLocation(id) {
    if (!confirm('Are you sure you want to delete this location?')) return;
    
    try {
        const res = await fetch(`${apiUrl}/${id}`, { 
            method: 'DELETE' 
        });
        
        if (res.ok) {
            loadLocations();
        } else {
            throw new Error('Failed to delete location');
        }
    } catch (err) {
        console.error('Error deleting location:', err);
        alert('Error deleting location: ' + err.message);
    }
}

// Event listener para o formul√°rio
document.getElementById('locationForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const id = document.getElementById('locationId').value;
    const name = document.getElementById('locationName').value;
    const description = document.getElementById('locationDescription').value;
    const latitude = document.getElementById('latitude').value;
    const longitude = document.getElementById('longitude').value;
    const responsavel = document.getElementById('responsavel').value; // üîπ NOVO CAMPO
    const observacoes = document.getElementById('observacoes').value;

    // Coleta os recursos
    const resources = [];
    document.querySelectorAll('#resourceRows .row').forEach(row => {
        const resourceSelect = row.querySelector('.resource-select');
        const quantityInput = row.querySelector('.quantity-input');
        
        if (resourceSelect.value && quantityInput.value) {
            resources.push({
                resourceId: parseInt(resourceSelect.value),
                quantity: parseInt(quantityInput.value)
            });
        }
    });

    const payload = { 
        name, 
        description, 
        latitude: parseFloat(latitude), 
        longitude: parseFloat(longitude), 
        responsavel,
        observacoes,  // üîπ NOVO
        resources 
    };


    try {
        const url = id ? `${apiUrl}/${id}` : apiUrl;
        const method = id ? 'PUT' : 'POST';

        const res = await fetch(url, {
            method: method,
            headers: { 
                'Content-Type': 'application/json' 
            },
            body: JSON.stringify(payload)
        });

        if (!res.ok) {
            const error = await res.json();
            throw new Error(error.message || 'Failed to save location');
        }

        // Fecha o modal e recarrega a lista
        const modal = bootstrap.Modal.getInstance(document.getElementById('locationModal'));
        modal.hide();
        
        // Remove o backdrop manualmente se necess√°rio
        document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
        
        loadLocations();

    } catch (err) {
        console.error('Error saving location:', err);
        alert('Error saving location: ' + err.message);
    }
});

// Inicializa√ß√£o quando a p√°gina carrega
window.onload = async function() {
    await fetchResources();
    await loadLocations();
};
</script>

<!-- Google Maps com Places -->
<script async
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDw8qHIN9go7Do3aouyR9343opJ33ZdDb0&libraries=places">
</script>

{% endblock %}