{% extends "base.html" %}

{% block title %}Gestão de Agendamentos - PI-SAÚDE{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-dark">
                <h1 class="alert-heading">
                    <i class="bi bi-calendar-week me-2"></i>Gestão de Agendamentos
                </h1>
                <p class="mb-0">Administração de consultas e horários médicos</p>
            </div>
        </div>
    </div>

    <!-- Estatísticas Rápidas -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="text-white-50">Agendamentos Hoje</h6>
                            <h3 id="statsHoje">0</h3>
                        </div>
                        <i class="bi bi-calendar-day display-4 opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="text-white-50">Confirmados</h6>
                            <h3 id="statsConfirmados">0</h3>
                        </div>
                        <i class="bi bi-check-circle display-4 opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="text-white-50">Pendentes</h6>
                            <h3 id="statsPendentes">0</h3>
                        </div>
                        <i class="bi bi-clock display-4 opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card bg-danger text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="text-white-50">Cancelados</h6>
                            <h3 id="statsCancelados">0</h3>
                        </div>
                        <i class="bi bi-x-circle display-4 opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Abas de Gestão -->
    <div class="row">
        <div class="col-12">
            <ul class="nav nav-tabs" id="gestaoTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="agendamentos-tab" data-bs-toggle="tab" 
                            data-bs-target="#agendamentos" type="button">
                        <i class="bi bi-calendar3 me-1"></i> Agendamentos
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="medicos-tab" data-bs-toggle="tab" 
                            data-bs-target="#medicos" type="button">
                        <i class="bi bi-person-badge me-1"></i> Médicos
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="horarios-tab" data-bs-toggle="tab" 
                            data-bs-target="#horarios" type="button">
                        <i class="bi bi-clock me-1"></i> Horários
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="sms-tab" data-bs-toggle="tab" 
                            data-bs-target="#sms" type="button">
                        <i class="bi bi-chat-dots me-1"></i> SMS
                    </button>
                </li>
            </ul>
            
            <div class="tab-content" id="gestaoTabsContent">
                <!-- Tab 1: Lista de Agendamentos -->
                <div class="tab-pane fade show active" id="agendamentos" role="tabpanel">
                    <div class="card border-top-0 rounded-top-0">
                        <div class="card-body">
                            <!-- Filtros -->
                            <div class="row mb-3">
                                <div class="col-md-3">
                                    <label class="form-label">Data:</label>
                                    <input type="date" class="form-control" id="filtroData" value="{{ hoje }}">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Médico:</label>
                                    <select class="form-select" id="filtroMedico">
                                        <option value="">Todos</option>
                                        {% for medico in medicos %}
                                        <option value="{{ medico.id }}">{{ medico.nome }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Status:</label>
                                    <select class="form-select" id="filtroStatus">
                                        <option value="">Todos</option>
                                        <option value="pendente">Pendente</option>
                                        <option value="confirmado">Confirmado</option>
                                        <option value="cancelado">Cancelado</option>
                                        <option value="realizado">Realizado</option>
                                    </select>
                                </div>
                                <div class="col-md-3 d-flex align-items-end">
                                    <button class="btn btn-primary w-100" id="btnFiltrar">
                                        <i class="bi bi-funnel"></i> Filtrar
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Tabela de Agendamentos -->
                            <div class="table-responsive">
                                <table class="table table-hover" id="tabelaAgendamentos">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Paciente</th>
                                            <th>Telefone</th>
                                            <th>Médico</th>
                                            <th>Data/Hora</th>
                                            <th>Tipo</th>
                                            <th>Status</th>
                                            <th>Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Carregado via AJAX -->
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Paginação -->
                            <nav aria-label="Paginação">
                                <ul class="pagination justify-content-center" id="paginacao">
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
                
                <!-- Tab 2: Gestão de Médicos -->
                <div class="tab-pane fade" id="medicos" role="tabpanel">
                    <div class="card border-top-0 rounded-top-0">
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalNovoMedico">
                                        <i class="bi bi-plus-circle me-1"></i> Novo Médico
                                    </button>
                                </div>
                            </div>
                            
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Nome</th>
                                            <th>Especialidade</th>
                                            <th>Registro</th>
                                            <th>Telefone</th>
                                            <th>Ativo</th>
                                            <th>Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for medico in medicos %}
                                        <tr>
                                            <td>{{ medico.nome }}</td>
                                            <td><span class="badge bg-info">{{ medico.especialidade }}</span></td>
                                            <td>{{ medico.registro_profissional }}</td>
                                            <td>{{ medico.telefone }}</td>
                                            <td>
                                                {% if medico.ativo %}
                                                <span class="badge bg-success">Ativo</span>
                                                {% else %}
                                                <span class="badge bg-danger">Inativo</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <button class="btn btn-sm btn-warning btn-editar-medico" 
                                                        data-id="{{ medico.id }}">
                                                    <i class="bi bi-pencil"></i>
                                                </button>
                                                <button class="btn btn-sm btn-info" 
                                                        onclick="window.location.href='/admin/medico/{{ medico.id }}/horarios'">
                                                    <i class="bi bi-clock"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Tab 3: Gestão de Horários -->
                <div class="tab-pane fade" id="horarios" role="tabpanel">
                    <div class="card border-top-0 rounded-top-0">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">Configurar Horário Padrão</h6>
                                        </div>
                                        <div class="card-body">
                                            <form id="formHorarioPadrao">
                                                <div class="mb-3">
                                                    <label class="form-label">Dias da Semana:</label>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" name="dias[]" value="1" id="segunda">
                                                        <label class="form-check-label" for="segunda">Segunda-feira</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" name="dias[]" value="2" id="terca">
                                                        <label class="form-check-label" for="terca">Terça-feira</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" name="dias[]" value="3" id="quarta">
                                                        <label class="form-check-label" for="quarta">Quarta-feira</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" name="dias[]" value="4" id="quinta">
                                                        <label class="form-check-label" for="quinta">Quinta-feira</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" name="dias[]" value="5" id="sexta">
                                                        <label class="form-check-label" for="sexta">Sexta-feira</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" name="dias[]" value="6" id="sabado">
                                                        <label class="form-check-label" for="sabado">Sábado</label>
                                                    </div>
                                                </div>
                                                
                                                <div class="mb-3">
                                                    <label class="form-label">Horário de Início:</label>
                                                    <input type="time" class="form-control" name="hora_inicio" value="08:00">
                                                </div>
                                                
                                                <div class="mb-3">
                                                    <label class="form-label">Horário de Fim:</label>
                                                    <input type="time" class="form-control" name="hora_fim" value="17:00">
                                                </div>
                                                
                                                <div class="mb-3">
                                                    <label class="form-label">Duração da Consulta (minutos):</label>
                                                    <select class="form-select" name="duracao">
                                                        <option value="15">15 minutos</option>
                                                        <option value="20">20 minutos</option>
                                                        <option value="30" selected>30 minutos</option>
                                                        <option value="45">45 minutos</option>
                                                        <option value="60">60 minutos</option>
                                                    </select>
                                                </div>
                                                
                                                <div class="mb-3">
                                                    <label class="form-label">Intervalo para Almoço:</label>
                                                    <div class="input-group">
                                                        <input type="time" class="form-control" name="almoco_inicio" value="12:00">
                                                        <span class="input-group-text">às</span>
                                                        <input type="time" class="form-control" name="almoco_fim" value="13:00">
                                                    </div>
                                                </div>
                                                
                                                <button type="submit" class="btn btn-primary w-100">
                                                    <i class="bi bi-save me-1"></i> Salvar Horário Padrão
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-8">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">Calendário de Horários</h6>
                                        </div>
                                        <div class="card-body">
                                            <div id="calendarioHorarios"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Tab 4: Gestão de SMS -->
                <div class="tab-pane fade" id="sms" role="tabpanel">
                    <div class="card border-top-0 rounded-top-0">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">Enviar SMS Manual</h6>
                                        </div>
                                        <div class="card-body">
                                            <form id="formSMSManual">
                                                <div class="mb-3">
                                                    <label class="form-label">Destinatários:</label>
                                                    <select class="form-select" name="tipo_destino" id="tipoDestino">
                                                        <option value="agendamento">Pacientes com Agendamento</option>
                                                        <option value="telefone">Número Específico</option>
                                                        <option value="todos">Todos os Pacientes</option>
                                                    </select>
                                                </div>
                                                
                                                <div class="mb-3" id="containerTelefone" style="display: none;">
                                                    <label class="form-label">Telefone:</label>
                                                    <input type="tel" class="form-control" name="telefone" 
                                                           pattern="[0-9]{9}" placeholder="84XXXXXXX">
                                                </div>
                                                
                                                <div class="mb-3" id="containerFiltroData" style="display: block;">
                                                    <label class="form-label">Data do Agendamento:</label>
                                                    <input type="date" class="form-control" name="data_agendamento" 
                                                           value="{{ hoje }}">
                                                </div>
                                                
                                                <div class="mb-3">
                                                    <label class="form-label">Tipo de SMS:</label>
                                                    <select class="form-select" name="tipo_sms">
                                                        <option value="lembrete">Lembrete de Consulta</option>
                                                        <option value="confirmacao">Confirmação</option>
                                                        <option value="cancelamento">Cancelamento</option>
                                                        <option value="educativo">Mensagem Educativa</option>
                                                        <option value="personalizado">Personalizado</option>
                                                    </select>
                                                </div>
                                                
                                                <div class="mb-3">
                                                    <label class="form-label">Mensagem:</label>
                                                    <textarea class="form-control" name="mensagem" rows="4" 
                                                              placeholder="Digite a mensagem..."></textarea>
                                                    <div class="form-text">
                                                        <span id="contadorCaracteres">0</span>/160 caracteres
                                                    </div>
                                                </div>
                                                
                                                <button type="submit" class="btn btn-primary w-100">
                                                    <i class="bi bi-send me-1"></i> Enviar SMS
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-8">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">Histórico de Envios</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="table-responsive">
                                                <table class="table table-sm">
                                                    <thead>
                                                        <tr>
                                                            <th>Data</th>
                                                            <th>Destinatário</th>
                                                            <th>Mensagem</th>
                                                            <th>Status</th>
                                                            <th>Resposta</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="historicoSMS">
                                                        <!-- Carregado via AJAX -->
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Novo Médico -->
<div class="modal fade" id="modalNovoMedico" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="formMedico" method="POST" action="/admin/medicos">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">Cadastrar Novo Médico</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Nome Completo *</label>
                        <input type="text" class="form-control" name="nome" required>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Especialidade *</label>
                            <input type="text" class="form-control" name="especialidade" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Registro Profissional *</label>
                            <input type="text" class="form-control" name="registro_profissional" required>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Telefone</label>
                            <input type="tel" class="form-control" name="telefone" pattern="[0-9]{9}">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" name="email">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Horário de Trabalho</label>
                        <textarea class="form-control" name="horario_trabalho" rows="2" 
                                  placeholder="Ex: Segunda a Sexta, 8h às 17h"></textarea>
                    </div>
                    
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="ativo" value="1" checked>
                        <label class="form-check-label">Médico ativo</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-success">Salvar Médico</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Editar Agendamento -->
<div class="modal fade" id="modalEditarAgendamento" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="formEditarAgendamento">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Editar Agendamento</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="id" id="editAgendamentoId">
                    
                    <div class="mb-3">
                        <label class="form-label">Status *</label>
                        <select class="form-select" name="status" id="editStatus" required>
                            <option value="pendente">Pendente</option>
                            <option value="confirmado">Confirmado</option>
                            <option value="cancelado">Cancelado</option>
                            <option value="realizado">Realizado</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Observações</label>
                        <textarea class="form-control" name="observacoes" id="editObservacoes" rows="3"></textarea>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" name="enviar_sms" id="editEnviarSMS" checked>
                        <label class="form-check-label">Enviar notificação por SMS</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
    .fc-event {
        cursor: pointer;
    }
    
    .status-badge {
        font-size: 0.75em;
        padding: 0.25em 0.6em;
    }
    
    .slot-disponivel {
        background-color: #d1e7dd !important;
        color: #0f5132 !important;
    }
    
    .slot-indisponivel {
        background-color: #f8d7da !important;
        color: #842029 !important;
        text-decoration: line-through;
    }
    
    .slot-agendado {
        background-color: #cfe2ff !important;
        color: #052c65 !important;
    }
</style>

<script>
    $(document).ready(function() {
        // Carregar estatísticas
        carregarEstatisticas();
        
        // Carregar agendamentos
        carregarAgendamentos();
        
        // Inicializar FullCalendar
        inicializarCalendario();
        
        // Configurar SMS
        configurarSMS();
        
        // Event Listeners
        $('#btnFiltrar').on('click', carregarAgendamentos);
        $('#filtroData, #filtroMedico, #filtroStatus').on('change', carregarAgendamentos);
        
        // Configurar tipo de destino SMS
        $('#tipoDestino').on('change', function() {
            const tipo = $(this).val();
            $('#containerTelefone').toggle(tipo === 'telefone');
            $('#containerFiltroData').toggle(tipo === 'agendamento');
        });
        
        // Contador de caracteres SMS
        $('textarea[name="mensagem"]').on('input', function() {
            const length = $(this).val().length;
            $('#contadorCaracteres').text(length);
            
            if (length > 160) {
                $('#contadorCaracteres').addClass('text-danger');
            } else {
                $('#contadorCaracteres').removeClass('text-danger');
            }
        });
        
        // Formulário de horário padrão
        $('#formHorarioPadrao').on('submit', function(e) {
            e.preventDefault();
            salvarHorarioPadrao();
        });
        
        // Formulário SMS manual
        $('#formSMSManual').on('submit', function(e) {
            e.preventDefault();
            enviarSMSManual();
        });
        
        function carregarEstatisticas() {
            $.ajax({
                url: '/admin/agendamentos/estatisticas',
                method: 'GET',
                success: function(response) {
                    $('#statsHoje').text(response.hoje || 0);
                    $('#statsConfirmados').text(response.confirmados || 0);
                    $('#statsPendentes').text(response.pendentes || 0);
                    $('#statsCancelados').text(response.cancelados || 0);
                }
            });
        }
        
        function carregarAgendamentos(pagina = 1) {
            const filtros = {
                data: $('#filtroData').val(),
                medico_id: $('#filtroMedico').val(),
                status: $('#filtroStatus').val(),
                pagina: pagina
            };
            
            $.ajax({
                url: '/admin/agendamentos/listar',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(filtros),
                success: function(response) {
                    const tbody = $('#tabelaAgendamentos tbody');
                    tbody.empty();
                    
                    if (response.agendamentos && response.agendamentos.length > 0) {
                        response.agendamentos.forEach(ag => {
                            const statusClass = {
                                'pendente': 'warning',
                                'confirmado': 'success',
                                'cancelado': 'danger',
                                'realizado': 'info'
                            }[ag.status] || 'secondary';
                            
                            const row = `
                                <tr>
                                    <td>${ag.id}</td>
                                    <td>
                                        <strong>${ag.paciente_nome}</strong>
                                        ${ag.observacoes ? `<br><small class="text-muted">${ag.observacoes}</small>` : ''}
                                    </td>
                                    <td>${ag.telefone}</td>
                                    <td>${ag.medico_nome}</td>
                                    <td>
                                        ${formatarData(ag.data_consulta)}<br>
                                        <small>${ag.hora_consulta}</small>
                                    </td>
                                    <td>${ag.tipo_consulta}</td>
                                    <td>
                                        <span class="badge bg-${statusClass} status-badge">
                                            ${ag.status}
                                        </span>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-primary btn-editar" 
                                                data-id="${ag.id}">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-sm btn-info btn-detalhes" 
                                                data-id="${ag.id}">
                                            <i class="bi bi-info-circle"></i>
                                        </button>
                                        <button class="btn btn-sm btn-${ag.status !== 'cancelado' ? 'danger' : 'secondary'} btn-cancelar" 
                                                data-id="${ag.id}"
                                                ${ag.status === 'cancelado' ? 'disabled' : ''}>
                                            <i class="bi bi-x-circle"></i>
                                        </button>
                                    </td>
                                </tr>
                            `;
                            tbody.append(row);
                        });
                        
                        // Adicionar eventos
                        $('.btn-editar').on('click', function() {
                            abrirEditarAgendamento($(this).data('id'));
                        });
                        
                        $('.btn-cancelar').on('click', function() {
                            cancelarAgendamentoAdmin($(this).data('id'));
                        });
                        
                        // Configurar paginação
                        configurarPaginacao(response.total_paginas, pagina);
                    } else {
                        tbody.append(`
                            <tr>
                                <td colspan="8" class="text-center text-muted">
                                    <i class="bi bi-calendar-x display-4"></i>
                                    <p class="mt-2">Nenhum agendamento encontrado</p>
                                </td>
                            </tr>
                        `);
                    }
                }
            });
        }
        
        function configurarPaginacao(totalPaginas, paginaAtual) {
            const $paginacao = $('#paginacao');
            $paginacao.empty();
            
            if (totalPaginas <= 1) return;
            
            // Botão anterior
            $paginacao.append(`
                <li class="page-item ${paginaAtual === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" data-pagina="${paginaAtual - 1}">
                        <i class="bi bi-chevron-left"></i>
                    </a>
                </li>
            `);
            
            // Números das páginas
            for (let i = 1; i <= totalPaginas; i++) {
                if (i === 1 || i === totalPaginas || (i >= paginaAtual - 2 && i <= paginaAtual + 2)) {
                    $paginacao.append(`
                        <li class="page-item ${i === paginaAtual ? 'active' : ''}">
                            <a class="page-link" href="#" data-pagina="${i}">${i}</a>
                        </li>
                    `);
                } else if (i === paginaAtual - 3 || i === paginaAtual + 3) {
                    $paginacao.append('<li class="page-item disabled"><span class="page-link">...</span></li>');
                }
            }
            
            // Botão próximo
            $paginacao.append(`
                <li class="page-item ${paginaAtual === totalPaginas ? 'disabled' : ''}">
                    <a class="page-link" href="#" data-pagina="${paginaAtual + 1}">
                        <i class="bi bi-chevron-right"></i>
                    </a>
                </li>
            `);
            
            // Evento de clique
            $paginacao.find('.page-link').on('click', function(e) {
                e.preventDefault();
                const pagina = $(this).data('pagina');
                if (pagina) carregarAgendamentos(pagina);
            });
        }
        
        function abrirEditarAgendamento(id) {
            $.ajax({
                url: '/admin/agendamentos/' + id,
                method: 'GET',
                success: function(response) {
                    $('#editAgendamentoId').val(response.id);
                    $('#editStatus').val(response.status);
                    $('#editObservacoes').val(response.observacoes || '');
                    $('#modalEditarAgendamento').modal('show');
                }
            });
        }
        
        $('#formEditarAgendamento').on('submit', function(e) {
            e.preventDefault();
            
            const dados = {
                id: $('#editAgendamentoId').val(),
                status: $('#editStatus').val(),
                observacoes: $('#editObservacoes').val(),
                enviar_sms: $('#editEnviarSMS').is(':checked')
            };
            
            $.ajax({
                url: '/admin/agendamentos/editar',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(dados),
                success: function(response) {
                    if (response.success) {
                        $('#modalEditarAgendamento').modal('hide');
                        mostrarMensagem('Agendamento atualizado com sucesso!', 'success');
                        carregarAgendamentos();
                        carregarEstatisticas();
                    } else {
                        mostrarMensagem(response.mensagem, 'danger');
                    }
                }
            });
        });
        
        function cancelarAgendamentoAdmin(id) {
            if (confirm('Tem certeza que deseja cancelar este agendamento?')) {
                $.ajax({
                    url: '/admin/agendamentos/cancelar/' + id,
                    method: 'POST',
                    success: function(response) {
                        if (response.success) {
                            mostrarMensagem('Agendamento cancelado com sucesso!', 'success');
                            carregarAgendamentos();
                            carregarEstatisticas();
                        } else {
                            mostrarMensagem(response.mensagem, 'danger');
                        }
                    }
                });
            }
        }
        
        function inicializarCalendario() {
            const calendarEl = document.getElementById('calendarioHorarios');
            
            if (!calendarEl) return;
            
            const calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'timeGridWeek',
                locale: 'pt',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'timeGridWeek,timeGridDay'
                },
                events: '/admin/horarios/calendario',
                eventClick: function(info) {
                    if (info.event.extendedProps.tipo === 'agendamento') {
                        abrirEditarAgendamento(info.event.extendedProps.agendamento_id);
                    }
                },
                slotMinTime: '06:00:00',
                slotMaxTime: '20:00:00',
                slotDuration: '00:30:00',
                allDaySlot: false,
                nowIndicator: true,
                editable: true,
                eventDrop: function(info) {
                    atualizarHorarioAgendamento(
                        info.event.extendedProps.agendamento_id,
                        info.event.start
                    );
                }
            });
            
            calendar.render();
        }
        
        function configurarSMS() {
            // Carregar histórico
            carregarHistoricoSMS();
            
            // Agendar atualização automática
            setInterval(carregarHistoricoSMS, 30000); // A cada 30 segundos
        }
        
        function carregarHistoricoSMS() {
            $.ajax({
                url: '/admin/sms/historico',
                method: 'GET',
                success: function(response) {
                    const tbody = $('#historicoSMS');
                    tbody.empty();
                    
                    response.historico.forEach(sms => {
                        const statusIcon = sms.status === 'enviado' ? 'bi-check-circle text-success' :
                                         sms.status === 'falha' ? 'bi-x-circle text-danger' :
                                         'bi-clock text-warning';
                        
                        const row = `
                            <tr>
                                <td>${formatarDataHora(sms.data_envio)}</td>
                                <td>${sms.destinatario}</td>
                                <td>
                                    <small>${sms.mensagem.substring(0, 50)}${sms.mensagem.length > 50 ? '...' : ''}</small>
                                </td>
                                <td>
                                    <i class="bi ${statusIcon}"></i>
                                    ${sms.status}
                                </td>
                                <td>${sms.resposta || '-'}</td>
                            </tr>
                        `;
                        tbody.append(row);
                    });
                }
            });
        }
        
        function enviarSMSManual() {
            const formData = $('#formSMSManual').serializeArray().reduce((obj, item) => {
                obj[item.name] = item.value;
                return obj;
            }, {});
            
            if (formData.tipo_destino === 'telefone' && !/^[0-9]{9}$/.test(formData.telefone)) {
                mostrarMensagem('Telefone inválido. Use 9 dígitos.', 'warning');
                return;
            }
            
            if (!formData.mensagem.trim()) {
                mostrarMensagem('Digite uma mensagem.', 'warning');
                return;
            }
            
            $.ajax({
                url: '/admin/sms/enviar',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(formData),
                beforeSend: function() {
                    $('#formSMSManual button[type="submit"]')
                        .prop('disabled', true)
                        .html('<span class="spinner-border spinner-border-sm"></span> Enviando...');
                },
                success: function(response) {
                    if (response.success) {
                        mostrarMensagem('SMS enviado com sucesso!', 'success');
                        $('#formSMSManual')[0].reset();
                        $('#contadorCaracteres').text('0');
                        carregarHistoricoSMS();
                    } else {
                        mostrarMensagem(response.mensagem, 'danger');
                    }
                },
                error: function() {
                    mostrarMensagem('Erro ao enviar SMS.', 'danger');
                },
                complete: function() {
                    $('#formSMSManual button[type="submit"]')
                        .prop('disabled', false)
                        .html('<i class="bi bi-send me-1"></i> Enviar SMS');
                }
            });
        }
        
        function salvarHorarioPadrao() {
            const formData = $('#formHorarioPadrao').serializeArray().reduce((obj, item) => {
                if (item.name === 'dias[]') {
                    if (!obj[item.name]) obj[item.name] = [];
                    obj[item.name].push(item.value);
                } else {
                    obj[item.name] = item.value;
                }
                return obj;
            }, {});
            
            $.ajax({
                url: '/admin/horarios/padrao',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function(response) {
                    if (response.success) {
                        mostrarMensagem('Horário padrão salvo com sucesso!', 'success');
                        if (calendar) calendar.refetchEvents();
                    } else {
                        mostrarMensagem(response.mensagem, 'danger');
                    }
                }
            });
        }
        
        function formatarData(dataStr) {
            return new Date(dataStr).toLocaleDateString('pt-MZ');
        }
        
        function formatarDataHora(dataStr) {
            return new Date(dataStr).toLocaleString('pt-MZ');
        }
        
        function mostrarMensagem(texto, tipo) {
            // Implementar notificação
            alert(`${tipo.toUpperCase()}: ${texto}`);
        }
    });
</script>

<!-- Incluir FullCalendar -->
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.css' rel='stylesheet' />
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.js'></script>
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/locales/pt.min.js'></script>
{% endblock %}