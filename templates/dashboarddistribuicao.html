{% extends 'base.html' %}

{% block title %}PI-SA√öDE / Distribui√ß√£o Dashboard{% endblock %}

{% block content %}
<div class="container-fluid mt-3">

<!-- üåç MAPA E GRAFICO COM TABELAS -->
<div class="container-fluid">
  <div class="row g-4">

    <!-- üåç MAPA (lado esquerdo) -->
    <div class="col-lg-7">
      <div class="card shadow-sm border-0">
        <div class="card-header bg-primary text-white fw-semibold d-flex justify-content-between align-items-center">
          <span><i class="bi bi-bar-chart-fill me-2"></i>{{ _('Distribui√ß√µes por Location') }}</span>
          <div class="card-tools">
            <button class="btn btn-sm btn-light me-1 toggle-collapse" title="Recolher/Expandir">
              <i class="bi bi-chevron-up"></i>
            </button>
            <button class="btn btn-sm btn-light toggle-fullscreen" title="Maximizar/Minimizar">
              <i class="bi bi-arrows-fullscreen"></i>
            </button>
          </div>
        </div>
        <div class="card-body p-0">
          <div id="mapDistribuicao" style="height: 480px; width: 100%; border-radius: 0 0 8px 8px;"></div>
        </div>
      </div>
    </div>

    <!-- üìä GRAFICO (lado direito) -->
    <div class="col-lg-5">
      <div class="card shadow-sm border-0">
        <div class="card-header bg-primary text-white fw-semibold d-flex justify-content-between align-items-center">
          <span><i class="bi bi-bar-chart-fill me-2"></i>{{ _('Estat√≠sticas de Distribui√ß√£o') }}</span>
          <div class="card-tools">
            <button class="btn btn-sm btn-light me-1 toggle-collapse" title="Recolher/Expandir">
              <i class="bi bi-chevron-up"></i>
            </button>
            <button class="btn btn-sm btn-light toggle-fullscreen" title="Maximizar/Minimizar">
              <i class="bi bi-arrows-fullscreen"></i>
            </button>
          </div>
        </div>
        <div class="card-body">
          <canvas id="distribuicaoChart" height="250"></canvas>
        </div>
      </div>
    </div>

    <!-- üìä GRAFICO DE NECESSIDADES VS DISTRIBU√çDO -->
    <!-- Bloco 5: Necessidades vs Distribu√≠do por Location -->
    <div class="card mb-3">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center" 
            style="cursor: pointer;" 
            data-bs-toggle="collapse" 
            data-bs-target="#graficoNecessidadesLocation"
            aria-expanded="false">
            <h5 class="mb-0">
                <i class="bi bi-bar-chart me-2"></i>
                Necessidades vs Distribu√≠do por Location
            </h5>
            <i class="bi bi-chevron-down"></i>
        </div>
        <div class="collapse" id="graficoNecessidadesLocation">
            <div class="card-body">
                <canvas id="necessidadesVsDistribuidoChart"></canvas>
            </div>
        </div>
    </div>

    <!-- üìã TABELAS (full width abaixo dos gr√°ficos) -->
    <div class="col-12 mt-4">
      <div class="row g-4">

        <!-- üßæ Tabela de Distribui√ß√µes -->
        <div class="col-md-6">
          <div class="card shadow-sm border-0">
            <div class="card-header bg-secondary text-white fw-semibold d-flex justify-content-between align-items-center">
              <span><i class="bi bi-table me-2"></i>{{ _('Distribui√ß√µes Detalhadas') }}</span>
              <div class="card-tools">
                <button class="btn btn-sm btn-light me-1 toggle-collapse" title="Recolher/Expandir">
                  <i class="bi bi-chevron-up"></i>
                </button>
                <button class="btn btn-sm btn-light toggle-fullscreen" title="Maximizar/Minimizar">
                  <i class="bi bi-arrows-fullscreen"></i>
                </button>
              </div>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive">
                <table id="distribuicaoTable" class="table table-striped table-hover mb-0">
                  <thead class="table-light">
                    <tr>
                      <th>Location / Unidade Sanit√°ria</th>
                      <th>Item</th>
                      <th>Quantidade</th>
                      <th>Data de Distribui√ß√£o</th>
                      <th>Observa√ß√£o</th>
                      <th>User</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- üßæ Tabela de Necessidades -->
        <div class="col-md-6">
          <div class="card shadow-sm border-0">
            <div class="card-header bg-secondary text-white fw-semibold d-flex justify-content-between align-items-center">
              <span><i class="bi bi-table me-2"></i>Necessidades por Location</span>
              <div class="card-tools">
                <button class="btn btn-sm btn-light me-1 toggle-collapse" title="Recolher/Expandir">
                  <i class="bi bi-chevron-up"></i>
                </button>
                <button class="btn btn-sm btn-light toggle-fullscreen" title="Maximizar/Minimizar">
                  <i class="bi bi-arrows-fullscreen"></i>
                </button>
              </div>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive">
                <table id="necessidadeTable" class="table table-striped table-hover mb-0">
                  <thead class="table-light">
                    <tr>
                      <th>#</th>
                      <th>Location / Unidade Sanit√°ria</th>
                      <th>Item</th>
                      <th>Quantidade</th>
                      <th>Descri√ß√£o / Observa√ß√µes</th>
                      <th>Data Registro</th>
                      <th>User</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>

  </div>
</div>

<!-- ======= SCRIPTS EXISTENTES ======= -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css">


<!-- ======= NOVO CSS / JS PARA CONTROLES ======= -->
<style>
.fullscreen {
  position: fixed !important;
  top: 0; left: 0; right: 0; bottom: 0;
  width: 100%; height: 100%;
  z-index: 2000;
  background: #fff;
  overflow: auto;
  padding: 20px;
}

.fullscreen canvas,
.fullscreen table {
  width: 100% !important;
  height: calc(100vh - 120px) !important;
}

.card-tools .btn {
  border: none;
  background: transparent;
  color: #fff;
  transition: transform 0.15s ease;
}

.card-tools .btn:hover {
  color: #ffc107;
  transform: scale(1.15);
}

.card-header[data-bs-toggle="collapse"] .bi-chevron-down {
    transition: transform 0.3s ease;
}
.card-header[data-bs-toggle="collapse"][aria-expanded="true"] .bi-chevron-down {
    transform: rotate(180deg);
}

</style>

<script>
document.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll(".toggle-collapse").forEach(btn => {
    btn.addEventListener("click", () => {
      const card = btn.closest(".card");
      const icon = btn.querySelector("i");
      const body = card.querySelector(".card-body");
      body.classList.toggle("d-none");
      icon.classList.toggle("bi-chevron-up");
      icon.classList.toggle("bi-chevron-down");
    });
  });

  document.querySelectorAll(".toggle-fullscreen").forEach(btn => {
    btn.addEventListener("click", () => {
      const card = btn.closest(".card");
      const icon = btn.querySelector("i");

      if (card.classList.contains("fullscreen")) {
        card.classList.remove("fullscreen");
        document.body.style.overflow = "auto";
        icon.classList.remove("bi-arrows-in");
        icon.classList.add("bi-arrows-fullscreen");
      } else {
        card.classList.add("fullscreen");
        document.body.style.overflow = "hidden";
        icon.classList.remove("bi-arrows-fullscreen");
        icon.classList.add("bi-arrows-in");
      }
    });
  });
});
</script>

<script>
let mapDistribuicao;
let markersLayer;

async function initDistribuicaoMap() {
  mapDistribuicao = L.map('mapDistribuicao').setView([-15.0, 35.0], 6);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap contributors'
  }).addTo(mapDistribuicao);

  markersLayer = L.layerGroup().addTo(mapDistribuicao);

  await loadDistribuicoesMapa();
}

async function loadDistribuicoesMapa() {
  try {
    const [distribRes, locRes, itemRes, armazemRes] = await Promise.all([
      fetch('/api/distribuicao'),
      fetch('/api/location'),
      fetch('/api/item'),
      fetch('/api/armazem') // üîπ nova chamada para buscar armaz√©ns
    ]);

    const [allDistribuicoes, allLocations, allItens, allArmazens] = await Promise.all([
      distribRes.json(),
      locRes.json(),
      itemRes.json(),
      armazemRes.json()
    ]);

    markersLayer.clearLayers();

    // ====== AGRUPAR DISTRIBUI√á√ïES POR LOCATION ======
    const distribPorLocation = {};
    allDistribuicoes.forEach(d => {
      if (!distribPorLocation[d.location_id]) distribPorLocation[d.location_id] = [];
      distribPorLocation[d.location_id].push(d);
    });

    // ====== DESENHAR LINHAS DE ARMAZ√âM PARA UNIDADE ======
    allDistribuicoes.forEach(d => {
      const armazem = allArmazens.find(a => a.id === d.armazem_id);
      const loc = allLocations.find(l => l.id === d.location_id);
      const item = allItens.find(i => i.id === d.item_id);

      if (armazem && loc && armazem.latitude && armazem.longitude && loc.latitude && loc.longitude) {
        // üîπ Criar o popup com os detalhes da distribui√ß√£o
        const popupHtml = `
          <strong>${loc.name || loc.nome}</strong><br>
          <ul>
            <li>
              <strong>${item?.codigo || 'Sem c√≥digo'}</strong> - ${item?.designacao || '-'}<br>
              Quantidade: ${d.quantidade || '-'}<br>
              Data envio: ${
                d.data_distribuicao
                  ? new Date(d.data_distribuicao).toLocaleDateString()
                  : '-'
              }<br>
              <small class="text-muted">Registado por: ${d.user || 'Desconhecido'}</small><br>
              <small class="text-muted">Recebido por: ${d.recebeu || 'Desconhecido'}</small>
            </li>
          </ul>

          <hr>
          <strong>üìå Armaz√©m:</strong> ${armazem?.nome || '-'}<br>
          <strong>Observa√ß√£o:</strong> ${item?.observacao || '-'}
        `;


        // üîπ Criar linha entre armaz√©m e unidade
        const line = L.polyline(
          [
            [armazem.latitude, armazem.longitude],
            [loc.latitude, loc.longitude]
          ],
          {
            color: '#28a745', // verde para linha de distribui√ß√£o
            weight: 5,
            opacity: 0.7,
            dashArray: '5,5' // tracejada
          }
        )
          .addTo(markersLayer)
          .bindPopup(popupHtml); // ‚Üê mostra detalhes ao clicar na linha
      }
    });

    // ====== FILTRAR LOCATIONS COM DISTRIBUI√á√ïES ======
    const locationsComDistrib = allLocations.filter(
      loc => distribPorLocation[loc.id] && loc.latitude && loc.longitude
    );

    const markers = [];

    // ====== ADICIONAR MARKERS DE LOCATIONS ======
    locationsComDistrib.forEach(loc => {
      const distribs = distribPorLocation[loc.id];

      let popupHtml = `<strong>${loc.name || loc.nome}</strong><br><ul>`;
      distribs.forEach(d => {
        const item = allItens.find(i => i.id === d.item_id);
        popupHtml += `<li>
          <strong>${item?.codigo || 'Sem c√≥digo'}</strong> - ${item?.designacao || '-'}<br>
          Quantidade: ${d.quantidade || '-'}<br>
          Data envio: ${d.data_distribuicao ? new Date(d.data_distribuicao).toLocaleDateString() : '-'}<br>
          <small class="text-muted">Registado por: ${d.user || 'Desconhecido'}</small><br>
          <small class="text-muted">Recebido por: ${d.recebeu || 'Desconhecido'}</small>
        </li>`;
      });
      popupHtml += '</ul>';

      const marker = L.circleMarker([loc.latitude, loc.longitude], {
        radius: 10,             // üîπ tamanho do ponto
        color: '#007bff',       // üîπ cor da borda (azul)
        fillColor: '#007bff',   // üîπ cor do preenchimento (azul)
        fillOpacity: 1,         // üîπ opacidade do preenchimento
        weight: 2               // üîπ espessura da borda
      })
      .addTo(markersLayer)
      .bindPopup(popupHtml);

      markers.push(marker);
    });

    // ====== ADICIONAR MARKERS DOS ARMAZ√âNS ======
    loadArmazensMapa(allArmazens, markersLayer, markers);

    // ====== AJUSTAR O ZOOM ======
    if (markers.length > 1) {
      const group = new L.featureGroup(markers);
      mapDistribuicao.fitBounds(group.getBounds().pad(0.2));
    } else if (markers.length === 1) {
      mapDistribuicao.setView(markers[0].getLatLng(), 9);
    } else {
      mapDistribuicao.setView([-15.0, 35.0], 6);
    }

    // ====== LINHA DE ROTA REAL ENTRE ARMAZ√âNS ======
    // if (allArmazens.length > 1) {
    //   for (let i = 0; i < allArmazens.length - 1; i++) {
    //     const origem = allArmazens[i];
    //     const destino = allArmazens[i + 1];

    //     if (!origem.latitude || !origem.longitude || !destino.latitude || !destino.longitude) continue;

    //     const route = L.Routing.control({
    //       waypoints: [
    //         L.latLng(origem.latitude, origem.longitude),
    //         L.latLng(destino.latitude, destino.longitude)
    //       ],
    //       addWaypoints: false,
    //       draggableWaypoints: false,
    //       fitSelectedRoutes: false,   // n√£o altera o zoom do mapa
    //       showAlternatives: false,
    //       lineOptions: {
    //         styles: [
    //           { color: "#ff9800", weight: 5, opacity: 0.85 } // üî∏ laranja
    //         ]
    //       },
    //       createMarker: () => null // üîπ n√£o criar √≠cones extras na rota
    //     }).addTo(mapDistribuicao);

    //     route.on("routesfound", function (e) {
    //       const km = (e.routes[0].summary.totalDistance / 1000).toFixed(1);

    //       const popupHtml = `
    //         <strong>üì¶ Conex√£o entre armaz√©ns</strong><br>
    //         Origem: ${origem.nome}<br>
    //         Destino: ${destino.nome}<br>
    //         <strong>Dist√¢ncia:</strong> ${km} km via estrada
    //       `;

    //       // üîπ Permite abrir popup ao clicar na linha da rota
    //       const coords = e.routes[0].coordinates;
    //       const middleIndex = Math.floor(coords.length / 2);
    //       const centerPoint = coords[middleIndex];

    //       L.marker([centerPoint.lat, centerPoint.lng], {
    //         icon: L.divIcon({ className: "invisible-marker" })
    //       })
    //       .addTo(mapDistribuicao)
    //       .bindPopup(popupHtml);
    //     });
    //   }
    // }
  } catch (error) {
    console.error('‚ùå Erro ao carregar distribui√ß√µes para o mapa:', error);
  }
}

/* ===================================================
   üè• NOVA FUN√á√ÉO: Adiciona os Armaz√©ns no Mapa
   =================================================== */
function loadArmazensMapa(allArmazens, markersLayer, markers) {
  if (!allArmazens?.length) return;

  allArmazens.forEach(a => {
    if (!a.latitude || !a.longitude) return;

    const itens = a.itens || [];

    // üîπ Construir HTML da lista de itens (estoque)
    let estoqueHtml = '<ul style="margin:4px 0; padding-left:16px;">';
    if (itens.length > 0) {
      itens.forEach(i => {
        estoqueHtml += `
          <li style="margin-bottom:6px;">
            <strong>${i.designacao || i.codigo || 'Item sem nome'}</strong><br>
            <small>Em stock: <b>${i.quantidade || 0}</b></small><br>
            ${i.user ? `<small class="text-muted">Registado por: ${i.user}</small><br>` : ''}
            ${i.recebeu ? `<small class="text-muted">Recebido por: ${i.recebeu}</small>` : ''}
          </li>
        `;
      });
    } else {
      estoqueHtml += '<li><em>Sem itens registados</em></li>';
    }
    estoqueHtml += '</ul>';

    // üîπ Popup HTML ‚Äî observa√ß√£o logo ap√≥s o nome
    const popupHtml = `
      <div style="min-width:250px; font-size:13px;">
        <div style="margin-bottom:6px;">
          <strong>üè• ${a.nome || a.name}</strong><br>

          <hr style="margin:6px 0;">
          <div>
          </div>
          
          <div style="margin-top:4px; margin-bottom:6px;">
            <b>üìù Observa√ß√£o do Armaz√©m:</b><br>
            ${a.observacao ? a.observacao : '<i>Sem observa√ß√£o registada</i>'}
          </div>

          ${a.responsavel ? `<b>Respons√°vel:</b> ${a.responsavel}<br>` : ''}
          ${a.contacto ? `<b>Contacto:</b> ${a.contacto}<br>` : ''}
          ${a.endereco ? `<b>Endere√ßo:</b> ${a.endereco}<br>` : ''}
        </div>

        <hr style="margin:6px 0;">
        <div>
          <b>üì¶ Itens em estoque:</b>
          ${estoqueHtml}
        </div>

        <hr style="margin:6px 0;">
        <small class="text-muted">Tipo: Armaz√©m de Distribui√ß√£o</small>
      </div>
    `;

    // üîπ Criar marcador no mapa
    const marker = L.marker([a.latitude, a.longitude], {
      icon: L.icon({
        iconUrl: 'https://cdn-icons-png.flaticon.com/512/883/883407.png',
        iconSize: [36, 36],
        iconAnchor: [18, 36],
        popupAnchor: [0, -28]
      })
    })
      .addTo(markersLayer)
      .bindPopup(popupHtml);

    markers.push(marker);
  });
}


async function loadDistribuicoesTabela() {
  try {
    const distribRes = await fetch('/api/distribuicao');
    const allDistribuicoes = await distribRes.json();

    const locRes = await fetch('/api/location');
    const allLocations = await locRes.json();

    const itemRes = await fetch('/api/item');
    const allItens = await itemRes.json();

    const tbody = document.querySelector('#distribuicaoTable tbody');
    tbody.innerHTML = '';

    allDistribuicoes.forEach(d => {
      const loc = allLocations.find(l => l.id === d.location_id);
      const item = allItens.find(i => i.id === d.item_id);

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${loc?.name || loc?.nome || '-'}</td>
        <td>${item?.designacao || item?.codigo || '-'}</td>
        <td>${d.quantidade || '-'}</td>
        <td>${d.data_distribuicao ? new Date(d.data_distribuicao).toLocaleDateString() : '-'}</td>
        <td>${d.observacao || '-'}</td>
        <td>${d.user || '-'}</td>
      `;
      tbody.appendChild(tr);
    });

  } catch (error) {
    console.error('Erro ao carregar tabela de distribui√ß√µes:', error);
  }
}

async function carregarNecessidadesDistribuicao(itemId = null) {
  try {
    let url = '/api/item/necessidades';
    if (itemId !== null) {
      url = `/api/item/${itemId}/necessidades`;
    }

    const [res, locRes] = await Promise.all([
      fetch(url),
      fetch('/api/location')
    ]);

    if (!res.ok) throw new Error(`Erro HTTP ${res.status}`);
    const necessidades = await res.json();
    const allLocations = await locRes.json();

    const tbody = document.querySelector('#necessidadeTable tbody');
    tbody.innerHTML = '';

    if (!necessidades.length) {
      tbody.innerHTML = `
        <tr>
          <td colspan="6" class="text-center text-muted">
            Nenhuma necessidade registrada.
          </td>
        </tr>`;
      return;
    }

    const html = necessidades.map((n, index) => {
      const loc = allLocations.find(l => l.id === n.location_id);
      const locName = loc ? (loc.nome || loc.name || loc.designacao) : `Location ${n.location_id || ''}`;

      return `
        <tr>
          <td>${index + 1}</td>
          <td>${locName}</td>
          <td>${n.item_nome || n.item_designacao || '-'}</td>
          <td>${n.quantidade ?? '-'}</td>
          <td>${n.descricao || ''}</td>
          <td>${n.data_registro ? new Date(n.data_registro).toLocaleString() : '-'}</td>
          <td>${n.user || '-'}</td>
        </tr>`;
    }).join('');

    tbody.innerHTML = html;

  } catch (err) {
    console.error('‚ùå Erro ao carregar necessidades', err);
    const tbody = document.querySelector('#necessidadeTable tbody');
    tbody.innerHTML = `
      <tr>
        <td colspan="6" class="text-center text-danger">
          Erro ao carregar necessidades.
        </td>
      </tr>`;
  }
}

// Gr√°fico de distribui√ß√µes por m√™s
async function initDistribuicaoChart() {
  try {
    const res = await fetch('/api/distribuicao');
    const distrib = await res.json();

    const itemRes = await fetch('/api/item');
    const allItens = await itemRes.json();

    const itemMap = {};
    allItens.forEach(i => {
      itemMap[i.id] = i.designacao || i.nome || i.codigo || `Item ${i.id}`;
    });

    const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

    const distribPorItemEMes = {};
    distrib.forEach(d => {
      if (!d.data_distribuicao || !d.item_id) return;

      const dt = new Date(d.data_distribuicao);
      if (isNaN(dt)) return;

      const month = dt.getMonth();
      if (!distribPorItemEMes[d.item_id]) distribPorItemEMes[d.item_id] = Array(12).fill(0);
      distribPorItemEMes[d.item_id][month] += Number(d.quantidade) || 0;
    });

    const itensComValor = Object.keys(distribPorItemEMes).filter(itemId => {
      const sum = distribPorItemEMes[itemId].reduce((a,b) => a + b, 0);
      return sum > 0;
    });

    if (itensComValor.length === 0) {
      const ctxEmpty = document.getElementById('distribuicaoChart').getContext('2d');
      if (window._distribChart) window._distribChart.destroy();
      window._distribChart = new Chart(ctxEmpty, {
        type: 'bar',
        data: { labels: months, datasets: [] },
        options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
      });
      return;
    }

    const generateColor = (i, total) => {
      const hue = Math.round((i * 360) / Math.max(1, total));
      return `hsl(${hue}, 65%, 55%)`;
    };

    const datasets = itensComValor.map((itemId, index) => {
      const color = generateColor(index, itensComValor.length);
      return {
        label: itemMap[itemId] || `Item ${itemId}`,
        data: distribPorItemEMes[itemId],
        backgroundColor: color,
        borderColor: color,
        borderWidth: 1
      };
    });

    if (window._distribChart) window._distribChart.destroy();

    const ctx = document.getElementById('distribuicaoChart').getContext('2d');
    window._distribChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: months,
        datasets: datasets
      },
      options: {
        responsive: true,
        interaction: { mode: 'index', intersect: false },
        plugins: {
          legend: { position: 'bottom', labels: { boxWidth: 12 } },
          tooltip: {
            callbacks: {
              title: (tooltipItems) => `M√™s: ${tooltipItems[0].label}`,
              label: (context) => `${context.dataset.label}: ${context.parsed.y}`
            }
          }
        },
        scales: {
          x: {
            stacked: false,
            title: { display: true, text: 'M√™s' }
          },
          y: {
            stacked: false,
            beginAtZero: true,
            title: { display: true, text: 'Quantidade distribu√≠da' }
          }
        }
      }
    });

  } catch (error) {
    console.error('Erro ao carregar gr√°fico de distribui√ß√µes por item e m√™s:', error);
  }
}

// GR√ÅFICO CORRIGIDO: Necessidades vs Distribu√≠do por Item e Location
async function initNecessidadesVsDistribuidoChart() {
  try {
    // Buscar todos os dados necess√°rios
    const [necRes, distribRes, itemRes, locRes] = await Promise.all([
      fetch('/api/item/necessidades'),
      fetch('/api/distribuicao'),
      fetch('/api/item'),
      fetch('/api/location')
    ]);

    const necessidades = await necRes.json();
    const distribuicoes = await distribRes.json();
    const allItens = await itemRes.json();
    const allLocations = await locRes.json();

    // Criar estrutura para agrupar por Item √ó Location
    const dadosPorItemLocation = {};

    // Processar necessidades
    necessidades.forEach(n => {
      if (!n.item_id || !n.location_id) return;
      
      const key = `${n.item_id}-${n.location_id}`;
      if (!dadosPorItemLocation[key]) {
        dadosPorItemLocation[key] = {
          item_id: n.item_id,
          location_id: n.location_id,
          necessidade: 0,
          distribuido: 0,
          item_nome: '',
          location_nome: ''
        };
      }
      dadosPorItemLocation[key].necessidade += Number(n.quantidade || 0);
      
      // Guardar nomes
      if (!dadosPorItemLocation[key].item_nome) {
        const item = allItens.find(i => i.id === n.item_id);
        dadosPorItemLocation[key].item_nome = item?.designacao || item?.nome || item?.codigo || `Item ${n.item_id}`;
      }
      if (!dadosPorItemLocation[key].location_nome) {
        const location = allLocations.find(l => l.id === n.location_id);
        dadosPorItemLocation[key].location_nome = location?.nome || location?.name || location?.designacao || `Location ${n.location_id}`;
      }
    });

    // Processar distribui√ß√µes
    distribuicoes.forEach(d => {
      if (!d.item_id || !d.location_id) return;
      
      const key = `${d.item_id}-${d.location_id}`;
      if (!dadosPorItemLocation[key]) {
        dadosPorItemLocation[key] = {
          item_id: d.item_id,
          location_id: d.location_id,
          necessidade: 0,
          distribuido: 0,
          item_nome: '',
          location_nome: ''
        };
      }
      dadosPorItemLocation[key].distribuido += Number(d.quantidade || 0);
      
      // Guardar nomes se ainda n√£o existirem
      if (!dadosPorItemLocation[key].item_nome) {
        const item = allItens.find(i => i.id === d.item_id);
        dadosPorItemLocation[key].item_nome = item?.designacao || item?.nome || item?.codigo || `Item ${d.item_id}`;
      }
      if (!dadosPorItemLocation[key].location_nome) {
        const location = allLocations.find(l => l.id === d.location_id);
        dadosPorItemLocation[key].location_nome = location?.nome || location?.name || location?.designacao || `Location ${d.location_id}`;
      }
    });

    // Preparar dados para o gr√°fico
    const labels = [];
    const necessidadesData = [];
    const distribuicoesData = [];
    const percentualAtendimento = [];
    const tooltipData = []; // Para armazenar informa√ß√µes para o tooltip

    // Processar cada combina√ß√£o Item √ó Location
    Object.values(dadosPorItemLocation).forEach(dado => {
      const necessidade = dado.necessidade || 0;
      const distribuido = dado.distribuido || 0;
      
      // S√≥ incluir se houver necessidade OU distribui√ß√£o
      if (necessidade > 0 || distribuido > 0) {
        // Usar apenas o nome da location no eixo X
        labels.push(dado.location_nome);
        
        necessidadesData.push(necessidade);
        distribuicoesData.push(distribuido);
        
        // Calcular percentual de atendimento
        const percentual = necessidade > 0 ? Math.min(100, (distribuido / necessidade) * 100) : 0;
        percentualAtendimento.push(percentual.toFixed(1));
        
        // Guardar dados para o tooltip
        tooltipData.push({
          item_nome: dado.item_nome,
          location_nome: dado.location_nome,
          necessidade: necessidade,
          distribuido: distribuido,
          percentual: percentual.toFixed(1)
        });
      }
    });

    // Se n√£o houver dados, mostrar gr√°fico vazio
    if (labels.length === 0) {
      const ctxEmpty = document.getElementById('necessidadesVsDistribuidoChart').getContext('2d');
      if (window._necVsDistChart) window._necVsDistChart.destroy();
      window._necVsDistChart = new Chart(ctxEmpty, {
        type: 'bar',
        data: { labels: ['Sem dados'], datasets: [] },
        options: { 
          plugins: { 
            title: { display: true, text: 'Nenhum dado dispon√≠vel' },
            legend: { display: false }
          } 
        }
      });
      return;
    }

    // Destruir gr√°fico anterior se existir
    if (window._necVsDistChart) window._necVsDistChart.destroy();

    const ctx = document.getElementById('necessidadesVsDistribuidoChart').getContext('2d');
    window._necVsDistChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [
          {
            label: 'Necessidades',
            data: necessidadesData,
            backgroundColor: 'rgba(255, 99, 132, 0.7)',
            borderColor: 'rgba(255, 99, 132, 1)',
            borderWidth: 1,
            order: 2
          },
          {
            label: 'Distribu√≠do',
            data: distribuicoesData,
            backgroundColor: 'rgba(54, 162, 235, 0.7)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1,
            order: 1
          },
          {
            label: '% Atendimento',
            data: percentualAtendimento,
            type: 'line',
            borderColor: 'rgba(75, 192, 192, 1)',
            backgroundColor: 'rgba(75, 192, 192, 0.1)',
            borderWidth: 2,
            pointBackgroundColor: 'rgba(75, 192, 192, 1)',
            pointBorderColor: '#fff',
            pointRadius: 4,
            yAxisID: 'y1',
            order: 0
          }
        ]
      },
      options: {
        responsive: true,
        plugins: {
          title: {
            display: true,
            text: 'Compara√ß√£o: Necessidades vs Distribu√≠do por Unidade Sanit√°ria'
          },
          tooltip: {
            callbacks: {
              title: function(tooltipItems) {
                // Mostrar o nome da unidade como t√≠tulo
                const index = tooltipItems[0].dataIndex;
                return tooltipData[index].location_nome;
              },
              beforeBody: function(tooltipItems) {
                // Mostrar o nome do item antes dos dados
                const index = tooltipItems[0].dataIndex;
                return `Item: ${tooltipData[index].item_nome}`;
              },
              label: function(context) {
                // Manter os labels padr√£o das barras
                const label = context.dataset.label || '';
                const value = context.parsed.y;
                
                if (context.dataset.label === '% Atendimento') {
                  return `${label}: ${value}%`;
                }
                return `${label}: ${value}`;
              },
              afterBody: function(tooltipItems) {
                // Mostrar informa√ß√µes adicionais
                const index = tooltipItems[0].dataIndex;
                const data = tooltipData[index];
                return [
                  `---`,
                  `Necessidade: ${data.necessidade}`,
                  `Distribu√≠do: ${data.distribuido}`,
                  `Atendimento: ${data.percentual}%`
                ];
              }
            }
          },
          legend: {
            position: 'bottom'
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Quantidade'
            },
            stacked: false
          },
          x: {
            title: {
              display: true,
              text: 'Unidade Sanit√°ria'
            },
            ticks: {
              maxRotation: 45,
              minRotation: 45
            }
          },
          y1: {
            type: 'linear',
            display: true,
            position: 'right',
            min: 0,
            max: 100,
            title: {
              display: true,
              text: '% Atendimento'
            },
            grid: {
              drawOnChartArea: false
            },
            ticks: {
              callback: function(value) {
                return value + '%';
              }
            }
          }
        }
      }
    });

  } catch (error) {
    console.error('Erro ao carregar gr√°fico de necessidades vs distribu√≠do:', error);
    
    // Mostrar mensagem de erro no gr√°fico
    const ctx = document.getElementById('necessidadesVsDistribuidoChart').getContext('2d');
    if (window._necVsDistChart) window._necVsDistChart.destroy();
    window._necVsDistChart = new Chart(ctx, {
      type: 'bar',
      data: { labels: ['Erro'], datasets: [] },
      options: { 
        plugins: { 
          title: { display: true, text: 'Erro ao carregar dados' },
          legend: { display: false }
        } 
      }
    });
  }
}

document.addEventListener('DOMContentLoaded', function() {
  initDistribuicaoMap();
  initDistribuicaoChart();
  loadDistribuicoesTabela();
  carregarNecessidadesDistribuicao();
  initNecessidadesVsDistribuidoChart();
});

</script>
{{ super() }}
{% endblock %}
