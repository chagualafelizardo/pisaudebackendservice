{% extends 'base.html' %}

{% block title %}PI-SAÚDE / Especialidades de Saúde{% endblock %}

{% block content %}
{% include 'navbar.html' %}

<h2>Manage Especialidades de Saúde</h2>

<style>
#especialidadeSuggestions {
    position: absolute;
    z-index: 1000;
    width: 100%;
    max-height: 200px;
    overflow-y: auto;
    background: white;
    border: 1px solid #ccc;
    display: none;
}
#especialidadeSuggestions li:hover {
    background-color: #f0f0f0;
    cursor: pointer;
}
</style>

<!-- Campo de Busca -->
<div class="mb-3 position-relative" style="max-width: 400px;">
    <input type="text" id="especialidadeSearch" class="form-control" placeholder="Search by course name...">
    <ul id="especialidadeSuggestions" class="list-group"></ul>
</div>

<!-- Botão Flutuante -->
<button class="btn btn-success rounded-circle position-fixed"
        style="bottom: 20px; right: 20px; width: 60px; height: 60px; font-size: 28px; z-index: 1000;"
        onclick="openEspecialidadeModal()">
    +
</button>

<!-- Tabela de Especialidades -->
<table class="table table-bordered">
    <thead>
        <tr>
            <th>ID</th>
            <th>Course</th>
            <th>Training Year</th>
            <th>Training Institution</th>
            <th>Observation</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody id="especialidadesTableBody"></tbody>
</table>

<!-- Modal de Formulário -->
<div class="modal fade" id="especialidadeModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form id="especialidadeForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add/Edit Especialidade de Saúde</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <input type="hidden" id="especialidadeId">

        <div class="mb-3">
          <label class="form-label">Course</label>
          <input type="text" id="curso" class="form-control" required>
        </div>

        <div class="mb-3">
          <label class="form-label">Training Year</label>
          <input type="text" id="anoFormacao" class="form-control">
        </div>

        <div class="mb-3">
          <label class="form-label">Training Institution</label>
          <input type="text" id="instituicaoFormacao" class="form-control">
        </div>

        <div class="mb-3">
          <label class="form-label">Observation</label>
          <textarea id="observation" class="form-control" rows="3"></textarea>
        </div>

        <div class="mb-3">
          <label class="form-label">Sync Status</label>
          <select id="syncStatus" class="form-select" required>
            <option value="Not Syncronized">Not Syncronized</option>
            <option value="Syncronized">Syncronized</option>
            <option value="Updated">Updated</option>
          </select>
        </div>

        <div class="mb-3">
          <label class="form-label">Sync Status Date</label>
          <input type="datetime-local" id="syncStatusDate" class="form-control">
        </div>
      </div>

      <div class="modal-footer">
        <button type="submit" class="btn btn-primary">Save</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
      </div>
    </form>
  </div>
</div>

<script>
const apiUrl = '/api/especialidadesaude';
let allEspecialidades = [];

// -------------------- Load Especialidades --------------------
async function loadEspecialidades() {
    try {
        const res = await fetch(apiUrl);
        allEspecialidades = await res.json();
        filtrarTabela('');
    } catch (err) { alert('Error loading especialidades: ' + err); }
}

// -------------------- Filtrar / Renderizar Tabela --------------------
function filtrarTabela(query) {
    const tbody = document.getElementById('especialidadesTableBody');
    tbody.innerHTML = '';
    const termo = query.trim().toLowerCase();
    allEspecialidades
        .filter(e => e.curso?.toLowerCase().includes(termo))
        .forEach(e => {
            tbody.innerHTML += `
            <tr>
                <td>${e.id}</td>
                <td>${e.curso}</td>
                <td>${e.anoFormacao || ''}</td>
                <td>${e.instituicaoFormacao || ''}</td>
                <td>${e.observation || ''}</td>
                <td>
                    <button class="btn btn-sm btn-warning" onclick='editEspecialidade(${JSON.stringify(e)})'>Edit</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteEspecialidade(${e.id})">Delete</button>
                </td>
            </tr>`;
        });
}

// -------------------- Search Suggestions --------------------
const searchInput = document.getElementById('especialidadeSearch');
const suggestionList = document.getElementById('especialidadeSuggestions');

searchInput.addEventListener('input', function() {
    const query = this.value.trim().toLowerCase();
    suggestionList.innerHTML = '';
    filtrarTabela(query);
    if (!query) { suggestionList.style.display = 'none'; return; }

    const filtered = allEspecialidades.filter(e => e.curso?.toLowerCase().includes(query));
    if (filtered.length === 0) { suggestionList.style.display = 'none'; return; }

    filtered.forEach(e => {
        const li = document.createElement('li');
        li.className = 'list-group-item';
        li.textContent = e.curso;
        li.onclick = () => { editEspecialidade(e); suggestionList.style.display = 'none'; searchInput.value = ''; };
        suggestionList.appendChild(li);
    });

    suggestionList.style.display = 'block';
});

document.addEventListener('click', e => {
    if (!searchInput.contains(e.target) && !suggestionList.contains(e.target)) {
        suggestionList.style.display = 'none';
    }
});

// -------------------- Open Modal --------------------
function openEspecialidadeModal() {
    document.getElementById('especialidadeForm').reset();
    document.getElementById('especialidadeId').value = '';
    new bootstrap.Modal(document.getElementById('especialidadeModal')).show();
}

// -------------------- Edit Especialidade --------------------
function editEspecialidade(e) {
    document.getElementById('especialidadeId').value = e.id;
    document.getElementById('curso').value = e.curso || '';
    document.getElementById('anoFormacao').value = e.anoFormacao || '';
    document.getElementById('instituicaoFormacao').value = e.instituicaoFormacao || '';
    document.getElementById('observation').value = e.observation || '';
    document.getElementById('syncStatus').value = e.syncStatus || 'Not Syncronized';
    document.getElementById('syncStatusDate').value = e.syncStatusDate ? e.syncStatusDate.slice(0,16) : '';
    new bootstrap.Modal(document.getElementById('especialidadeModal')).show();
}

// -------------------- Save Especialidade --------------------
document.getElementById('especialidadeForm').addEventListener('submit', async e => {
    e.preventDefault();
    const id = document.getElementById('especialidadeId').value;
    const payload = {
        curso: document.getElementById('curso').value,
        anoFormacao: document.getElementById('anoFormacao').value,
        instituicaoFormacao: document.getElementById('instituicaoFormacao').value,
        observation: document.getElementById('observation').value,
        syncStatus: document.getElementById('syncStatus').value,
        syncStatusDate: document.getElementById('syncStatusDate').value ? 
            new Date(document.getElementById('syncStatusDate').value).toISOString() : null
    };

    try {
        const res = await fetch(id ? `${apiUrl}/${id}` : apiUrl, {
            method: id ? 'PUT' : 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (!res.ok) throw await res.json();

        bootstrap.Modal.getInstance(document.getElementById('especialidadeModal')).hide();
        document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
        loadEspecialidades();
    } catch (err) {
        alert(err.message || 'Error saving especialidade');
    }
});

// -------------------- Delete Especialidade --------------------
async function deleteEspecialidade(id) {
    if (!confirm('Are you sure you want to delete this record?')) return;
    try {
        const res = await fetch(`${apiUrl}/${id}`, { method: 'DELETE' });
        if (!res.ok) throw await res.json();
        loadEspecialidades();
    } catch (err) {
        alert(err.message || 'Error deleting especialidade');
    }
}

// -------------------- Initialize --------------------
window.onload = () => loadEspecialidades();
</script>

{% endblock %}
