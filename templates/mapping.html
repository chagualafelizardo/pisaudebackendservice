{% extends 'base.html' %}

{% block title %}PI-SAÃšDE / Resources Mapping{% endblock %}

{% block content %}
{% include 'navbar.html' %}

<h2>Resources And Resources Mapping</h2>

<div class="container-fluid mt-3">
    <div class="row">
        <div class="col-md-12">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <strong>Map of Locations and Resources</strong>
                    <div class="btn-group" role="group" aria-label="Map Type Toggle">
                        <input type="radio" class="btn-check" name="mapType" id="map-terrain" autocomplete="off" checked>
                        <label class="btn btn-light btn-sm" for="map-terrain" onclick="setMapType('terrain')">Map View</label>

                        <input type="radio" class="btn-check" name="mapType" id="map-satellite" autocomplete="off">
                        <label class="btn btn-light btn-sm" for="map-satellite" onclick="setMapType('satellite')">Satellite View</label>
                    </div>
                </div>
                <div class="card-body" style="height: 80vh;">
                    <div id="mapResources" style="height: 100%; width: 100%;"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const apiUrl = '/api/location';
let map;
let markers = [];

function initMap() {
    map = new google.maps.Map(document.getElementById("mapResources"), {
        zoom: 6,
        center: { lat: -25.9636, lng: 32.5805 },
        mapTypeId: 'terrain'
    });

    loadLocations();
}

function setMapType(type) {
    if (map) {
        map.setMapTypeId(type);
    }
}

async function loadLocations() {
    try {
        const res = await fetch(apiUrl);
        const locations = await res.json();

        locations.forEach(loc => {
            if (loc.latitude && loc.longitude) {
                const position = {
                    lat: parseFloat(loc.latitude),
                    lng: parseFloat(loc.longitude)
                };

                const resourceList = loc.resources && loc.resources.length
                    ? loc.resources.map(r => `${r.name} (${r.quantity})`).join('<br>')
                    : 'No resources available';

                const contentString = `
                    <div style="min-width: 250px;">
                        <h6><strong>${loc.name}</strong></h6>
                        <p>${loc.description || ''}</p>
                        <table class="table table-sm table-bordered mb-0">
                            <tr><th>Latitude</th><td>${loc.latitude}</td></tr>
                            <tr><th>Longitude</th><td>${loc.longitude}</td></tr>
                            <tr><th>Resources</th><td>${resourceList}</td></tr>
                        </table>
                    </div>
                `;

                const marker = new google.maps.Marker({
                    position,
                    map,
                    title: loc.name,
                    icon: { url: "https://maps.google.com/mapfiles/ms/icons/green-dot.png" }
                });

                const infoWindow = new google.maps.InfoWindow({ content: contentString });

                marker.addListener('click', () => {
                    infoWindow.open(map, marker);
                });

                markers.push(marker);
            }
        });
    } catch (err) {
        console.error('Error loading locations:', err);
        alert('Failed to load locations.');
    }
}

window.onload = initMap;
</script>

<script async
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDw8qHIN9go7Do3aouyR9343opJ33ZdDb0&libraries=places">
</script>

{% endblock %}
