{% extends 'base.html' %}

{% block title %}PI-SAÚDE / Users{% endblock %}

{% block content %}
<!-- {% include 'navbar.html' %} -->

<h2>Manage Users</h2>

<!-- Botão flutuante -->
<button id="addUserBtn" class="btn btn-success rounded-circle position-fixed" title="Add User" data-bs-toggle="modal"
        style="bottom: 20px; right: 20px; width: 60px; height: 60px; font-size: 28px; z-index: 1000;"
        data-bs-target="#userModal" onclick="openUserModal()">
    +
</button>

<!-- Tabela de Usuários -->
<table class="table table-bordered">
    <thead>
        <tr>
            <th>ID</th>
            <th>Full Name</th>
            <th>Username</th>
            <th>Email</th>
            <th>Contact</th>
            <th>Location</th>
            <th>Roles</th>
            <th>Components</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody id="userTableBody">
        <!-- Populado via JS -->
    </tbody>
</table>

<!-- Modal do formulário -->
<div class="modal fade" id="userModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form id="userForm">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle">Add User</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="userId">
            <div class="row">
                <div class="col-md-6 mb-2">
                    <input type="text" id="fullname" class="form-control" placeholder="Full Name" required>
                </div>
                <div class="col-md-6 mb-2">
                    <input type="text" id="username" class="form-control" placeholder="Username" required>
                </div>
                <div class="col-md-6 mb-2">
                    <input type="password" id="password" class="form-control" placeholder="Password" required>
                </div>
                <div class="col-md-6 mb-2">
                    <select id="gender" class="form-select" required>
                        <option value="">Select Gender</option>
                        <option value="M">M</option>
                        <option value="F">F</option>
                    </select>
                </div>
                <div class="col-md-6 mb-2">
                    <input type="email" id="email" class="form-control" placeholder="Email" required>
                </div>
                <div class="col-md-6 mb-2">
                    <input type="text" id="profile" class="form-control" placeholder="Profile" required>
                </div>
                <div class="col-md-6 mb-2">
                    <input type="text" id="contact" class="form-control" placeholder="Contact" required>
                </div>
                <div class="col-md-6 mb-2">
                    <select id="locationSelect" class="form-select" required>
                        <option value="">Select Location</option>
                    </select>
                </div>
                <div class="col-md-6 mb-2">
                    <label for="rolesSelect">Roles</label>
                    <select id="rolesSelect" class="form-select" multiple>
                        <!-- Populado via JS -->
                    </select>
                </div>
                <div class="col-md-6 mb-2">
                    <label for="componentsSelect">Components</label>
                    <select id="componentsSelect" class="form-select" multiple>
                        <!-- Populado via JS -->
                    </select>
                </div>
            </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Save</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
const apiUsers = '/api/user';
const apiLocations = '/api/location';
const apiRoles = '/api/role';
const apiUserRole = '/api/userrole';
const apiComponents = '/api/componente';
const apiUserComponente = '/api/usercomponente';

// Carregar Locations
async function loadLocations() {
    const res = await fetch(apiLocations);
    const locations = await res.json();
    const select = document.getElementById('locationSelect');
    select.innerHTML = '<option value="">Select Location</option>';
    locations.forEach(loc => select.innerHTML += `<option value="${loc.id}">${loc.name}</option>`);
}

// Carregar Roles
async function loadRoles() {
    const res = await fetch(apiRoles);
    const roles = await res.json();
    const select = document.getElementById('rolesSelect');
    select.innerHTML = '';
    roles.forEach(role => select.innerHTML += `<option value="${role.id}">${role.description}</option>`);
}

// Carregar Components
async function loadComponents() {
    const res = await fetch(apiComponents);
    const components = await res.json();
    const select = document.getElementById('componentsSelect');
    select.innerHTML = '';
    components.forEach(c => select.innerHTML += `<option value="${c.id}">${c.descricao}</option>`);
}

// Carregar Users
async function loadUsers() {
    const res = await fetch(apiUsers);
    const users = await res.json();
    const tbody = document.getElementById('userTableBody');
    tbody.innerHTML = '';

    for (const user of users) {
        // Roles
        const urRes = await fetch(`${apiUserRole}?userId=${user.id}`);
        const userRoles = await urRes.json();
        const roleNames = userRoles.map(r => r.role).join(', ');

        // Components
        const ucRes = await fetch(`${apiUserComponente}?userId=${user.id}`);
        const userComponents = await ucRes.json();
        const componentNames = userComponents.map(uc => uc.componente).join(', ');

        tbody.innerHTML += `
            <tr>
                <td>${user.id}</td>
                <td>${user.fullname}</td>
                <td>${user.username}</td>
                <td>${user.email}</td>
                <td>${user.contact}</td>
                <td>${user.location || ''}</td>
                <td>${roleNames}</td>
                <td>${componentNames}</td>
                <td>
                    <button class="btn btn-sm btn-warning" onclick="editUser(${user.id})">Edit</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteUser(${user.id})">Delete</button>
                </td>
            </tr>
        `;
    }
}

// Abrir Modal para adicionar user
function openUserModal() {
    document.getElementById('modalTitle').innerText = 'Add User';
    document.getElementById('userForm').reset();
    document.getElementById('userId').value = '';
    Array.from(document.getElementById('rolesSelect').options).forEach(opt => opt.selected = false);
    Array.from(document.getElementById('componentsSelect').options).forEach(opt => opt.selected = false);
}

// Editar User
async function editUser(id) {
    const res = await fetch(`${apiUsers}/${id}`);
    const user = await res.json();

    document.getElementById('modalTitle').innerText = 'Edit User';
    document.getElementById('userId').value = user.id;
    document.getElementById('fullname').value = user.fullname;
    document.getElementById('username').value = user.username;
    document.getElementById('password').value = '';
    document.getElementById('gender').value = user.gender;
    document.getElementById('email').value = user.email;
    document.getElementById('profile').value = user.profile;
    document.getElementById('contact').value = user.contact;
    document.getElementById('locationSelect').value = user.locationId || '';

    // Selecionar roles
    const urRes = await fetch(`${apiUserRole}?userId=${id}`);
    const userRoles = await urRes.json();
    const rolesSelect = document.getElementById('rolesSelect');
    Array.from(rolesSelect.options).forEach(opt => opt.selected = userRoles.some(r => r.roleId == opt.value));

    // Selecionar components
    const ucRes = await fetch(`${apiUserComponente}?userId=${id}`);
    const userComponents = await ucRes.json();
    const componentsSelect = document.getElementById('componentsSelect');
    Array.from(componentsSelect.options).forEach(opt => opt.selected = userComponents.some(uc => uc.componente_id == opt.value));

    const modal = new bootstrap.Modal(document.getElementById('userModal'));
    modal.show();
}

// Salvar User
document.getElementById('userForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const id = document.getElementById('userId').value;
    const data = {
        fullname: document.getElementById('fullname').value,
        username: document.getElementById('username').value,
        password: document.getElementById('password').value,
        gender: document.getElementById('gender').value,
        email: document.getElementById('email').value,
        profile: document.getElementById('profile').value,
        contact: document.getElementById('contact').value,
        locationId: parseInt(document.getElementById('locationSelect').value)
    };

    try {
        let res;
        if (id) {
            res = await fetch(`${apiUsers}/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
        } else {
            res = await fetch(apiUsers, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
        }

        if (!res.ok) throw await res.json();

        const userId = id || (await res.json()).id;

        // --- Roles ---
        const selectedRoles = Array.from(document.getElementById('rolesSelect').selectedOptions)
                                    .map(o => parseInt(o.value));

        const oldRolesRes = await fetch(`${apiUserRole}?userId=${userId}`);
        const oldRoles = await oldRolesRes.json();

        for (const r of oldRoles) {
            await fetch(`${apiUserRole}/${r.id}`, { method: 'DELETE' });
        }

        for (const roleId of selectedRoles) {
            await fetch(apiUserRole, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ userId, roleId })
            });
        }

        // --- Components ---
        const selectedComponents = Array.from(document.getElementById('componentsSelect').selectedOptions)
                                        .map(o => parseInt(o.value));

        const oldComponentsRes = await fetch(`${apiUserComponente}?userId=${userId}`);
        const oldComponents = await oldComponentsRes.json();

        for (const uc of oldComponents) {
            await fetch(`${apiUserComponente}/${uc.id}`, { method: 'DELETE' });
        }

        for (const componenteId of selectedComponents) {
            await fetch(apiUserComponente, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: userId, componente_id: componenteId })
            });
        }

        // Fechar modal
        const modalEl = document.getElementById('userModal');
        const modal = bootstrap.Modal.getInstance(modalEl);
        modal.hide();
        document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());

        loadUsers();
    } catch (err) {
        alert(err.message || 'Error saving user');
    }
});

// Deletar User
async function deleteUser(id) {
    if (!confirm('Are you sure you want to delete this user?')) return;
    await fetch(`${apiUsers}/${id}`, { method: 'DELETE' });
    loadUsers();
}

// Inicialização
window.onload = () => {
    loadLocations();
    loadRoles();
    loadComponents();
    loadUsers();
};
</script>

{% endblock %}
