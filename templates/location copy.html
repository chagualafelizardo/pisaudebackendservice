{% extends 'base.html' %}

{% block title %}PI-SA√öDE / Health Facilities{% endblock %}

{% block content %}
<!-- {% include 'navbar.html' %} -->

<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1">üè• Health Facilities Management</h2>
            <p class="text-muted mb-0">Manage health facilities and their resources</p>
        </div>
        <button class="btn btn-primary btn-lg" onclick="openLocationModal()">
            <i class="fas fa-plus me-2"></i> Add New Facility
        </button>
    </div>

    <!-- Cards Summary -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card border-primary">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-subtitle mb-2 text-muted">Total Facilities</h6>
                            <h3 id="totalFacilities" class="card-title mb-0">0</h3>
                        </div>
                        <i class="fas fa-hospital fs-1 text-primary"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-success">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-subtitle mb-2 text-muted">Total Resources</h6>
                            <h3 id="totalResources" class="card-title mb-0">0</h3>
                        </div>
                        <i class="fas fa-boxes fs-1 text-success"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-info">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-subtitle mb-2 text-muted">DOD Facilities</h6>
                            <h3 id="dodFacilities" class="card-title mb-0">0</h3>
                        </div>
                        <i class="fas fa-shield-alt fs-1 text-info"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-warning">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-subtitle mb-2 text-muted">Updated Today</h6>
                            <h3 id="updatedToday" class="card-title mb-0">0</h3>
                        </div>
                        <i class="fas fa-sync-alt fs-1 text-warning"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtros de Busca -->
    <div class="card mb-4">
        <div class="card-header bg-light">
            <h6 class="mb-0"><i class="fas fa-search me-2"></i> Search & Filter Facilities</h6>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-6">
                    <label for="searchByName" class="form-label">
                        <i class="fas fa-hospital me-1 text-primary"></i> Search by Facility Name
                    </label>
                    <div class="input-group">
                        <input type="text" id="searchByName" class="form-control" 
                               placeholder="Enter facility name or description...">
                        <button class="btn btn-outline-primary" type="button" onclick="performSearch()">
                            <i class="fas fa-search"></i>
                        </button>
                        <button class="btn btn-outline-secondary" type="button" onclick="clearSearch()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                <div class="col-md-6">
                    <label for="searchByResponsavel" class="form-label">
                        <i class="fas fa-user-shield me-1 text-primary"></i> Filter by Responsible
                    </label>
                    <div class="input-group">
                        <select id="searchByResponsavel" class="form-select">
                            <option value="">All Responsible Entities</option>
                            <option value="DOD">DOD (Department of Defense)</option>
                            <option value="Jhpiego">Jhpiego</option>
                            <option value="RISE">RISE</option>
                            <option value="MISAU">MISAU</option>
                        </select>
                        <button class="btn btn-outline-primary" type="button" onclick="performSearch()">
                            <i class="fas fa-filter"></i> Filter
                        </button>
                        <button class="btn btn-outline-secondary" type="button" onclick="clearResponsavelFilter()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Active Filters Display -->
            <div id="activeFilters" class="mt-3" style="display: none;">
                <div class="d-flex align-items-center">
                    <span class="me-2 text-muted"><i class="fas fa-filter"></i> Active filters:</span>
                    <div id="filterTags" class="d-flex flex-wrap gap-2"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabela de locations -->
    <div class="card">
        <div class="card-header bg-white border-bottom-0">
            <div class="row align-items-center">
                <div class="col">
                    <h5 class="mb-0">Health Facilities List</h5>
                    <small class="text-muted" id="resultsInfo">Showing all facilities</small>
                </div>
                <div class="col-auto">
                    <button class="btn btn-outline-primary" onclick="loadLocations()">
                        <i class="fas fa-redo me-1"></i> Refresh
                    </button>
                </div>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>ID</th>
                            <th>Health Facility</th>
                            <th>Description</th>
                            <th>Location</th>
                            <th>Resources</th>
                            <th>Respons√°vel</th>
                            <th>Updated</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="locationsTableBody">
                        <!-- Populado via JS -->
                        <tr>
                            <td colspan="8" class="text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2 mb-0">Loading health facilities...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Pagina√ß√£o -->
            <div class="d-flex justify-content-between align-items-center p-3 border-top">
                <div class="text-muted" id="paginationInfo">Showing 0 of 0 facilities</div>
                <div class="btn-group" role="group">
                    <button class="btn btn-outline-primary btn-sm" onclick="changePage(-1)" disabled id="prevBtn">
                        <i class="fas fa-chevron-left"></i> Previous
                    </button>
                    <button class="btn btn-outline-primary btn-sm" onclick="changePage(1)" disabled id="nextBtn">
                        Next <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    
</div>

<!-- Modal de Formul√°rio -->
<div class="modal fade" id="locationModal" tabindex="-1" aria-labelledby="locationModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <form id="locationForm" class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="locationModalLabel">
            <i class="fas fa-hospital me-2"></i>
            <span id="modalTitle">Add Health Facility</span>
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="locationId">

        <!-- Tabs -->
        <ul class="nav nav-tabs" id="locationTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="info-tab" data-bs-toggle="tab" data-bs-target="#info" type="button" role="tab">
                <i class="fas fa-info-circle me-1"></i> Basic Info
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="resources-tab" data-bs-toggle="tab" data-bs-target="#resources" type="button" role="tab">
                <i class="fas fa-boxes me-1"></i> Resources
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="map-tab" data-bs-toggle="tab" data-bs-target="#map-tab-content" type="button" role="tab">
                <i class="fas fa-map-marked-alt me-1"></i> Location
            </button>
          </li>
        </ul>

        <div class="tab-content p-4" id="locationTabsContent">
          
          <!-- Tab 1: Informa√ß√µes B√°sicas -->
          <div class="tab-pane fade show active" id="info" role="tabpanel">
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="locationName" class="form-label">
                    <i class="fas fa-hospital me-1 text-primary"></i> Health Facility Name *
                  </label>
                  <input type="text" id="locationName" class="form-control" placeholder="e.g., Centro de Sa√∫de Militar" required>
                </div>

                <div class="mb-3">
                  <label for="locationDescription" class="form-label">
                    <i class="fas fa-align-left me-1 text-primary"></i> Description *
                  </label>
                  <textarea id="locationDescription" class="form-control" rows="3" 
                            placeholder="Detailed description of the health facility" required></textarea>
                </div>

                <div class="mb-3">
                  <label for="responsavel" class="form-label">
                    <i class="fas fa-user-shield me-1 text-primary"></i> Responsible Entity *
                  </label>
                  <select id="responsavel" class="form-select" required>
                    <option value="">Select responsible...</option>
                    <option value="DOD">DOD (Department of Defense)</option>
                    <option value="Jhpiego">Jhpiego</option>
                    <option value="RISE">RISE</option>
                    <option value="MISAU">MISAU</option>
                  </select>
                </div>
              </div>

              <div class="col-md-6">
                <div class="mb-3">
                  <label for="latitude" class="form-label">
                    <i class="fas fa-map-pin me-1 text-primary"></i> Latitude
                  </label>
                  <input type="text" id="latitude" class="form-control">
                </div>

                <div class="mb-3">
                  <label for="longitude" class="form-label">
                    <i class="fas fa-map-pin me-1 text-primary"></i> Longitude
                  </label>
                  <input type="text" id="longitude" class="form-control">
                </div>

                <div class="mb-3">
                  <label for="observacoes" class="form-label">
                    <i class="fas fa-sticky-note me-1 text-primary"></i> Notes & Observations
                  </label>
                  <textarea id="observacoes" class="form-control" rows="4" 
                            placeholder="Additional comments or observations"></textarea>
                </div>
              </div>
            </div>
          </div>

          <!-- Tab 2: Recursos -->
          <div class="tab-pane fade" id="resources" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <div>
                <h6 class="mb-1">
                  <i class="fas fa-boxes me-2 text-success"></i> Manage Resources
                </h6>
                <p class="text-muted mb-0">Add equipment, supplies, and resources for this facility</p>
              </div>
              <button type="button" class="btn btn-success" onclick="addResourceRow()">
                <i class="fas fa-plus me-1"></i> Add Resource
              </button>
            </div>

            <div id="resourceRows" class="row g-4">
              <!-- Resource rows will be added here -->
              <div class="col-12">
                <div class="alert alert-info mb-0">
                  <i class="fas fa-info-circle me-2"></i>
                  Click "Add Resource" to add equipment and supplies for this health facility.
                </div>
              </div>
            </div>
          </div>

          <!-- Tab 3: Mapa -->
          <div class="tab-pane fade" id="map-tab-content" role="tabpanel">
            <div class="mb-4">
              <div class="row">
                <div class="col-md-8">
                  <label for="locationSearch" class="form-label">
                    <i class="fas fa-search me-1 text-primary"></i> Search Location
                  </label>
                  <div class="input-group">
                    <input type="text" id="locationSearch" class="form-control" 
                           placeholder="Search for a place or address">
                    <button type="button" class="btn btn-outline-secondary" onclick="clearMapSearch()">
                      <i class="fas fa-times"></i>
                    </button>
                  </div>
                </div>
                <div class="col-md-4">
                  <label class="form-label">&nbsp;</label>
                  <button type="button" class="btn btn-outline-primary w-100" onclick="useCurrentLocation()">
                    <i class="fas fa-location-arrow me-1"></i> Current Location
                  </button>
                </div>
              </div>
            </div>

            <div id="mapContainer" style="position: relative; height: 500px; margin-bottom: 15px; border-radius: 8px; overflow: hidden;">
              <div id="map" style="height: 100%;"></div>
              <div class="map-controls position-absolute" style="top: 10px; left: 10px; z-index: 1000;">
                <button id="toggleMapTypeBtn" class="btn btn-light btn-sm shadow-sm me-2">
                  <i class="fas fa-satellite me-1"></i> Satellite
                </button>
                <button id="resetMapBtn" class="btn btn-light btn-sm shadow-sm" onclick="resetMap()">
                  <i class="fas fa-redo me-1"></i> Reset
                </button>
              </div>
            </div>
            
            <div class="alert alert-warning mt-3">
              <i class="fas fa-exclamation-triangle me-2"></i>
              <strong>Instructions:</strong> Click on the map to set the location or drag the marker to adjust position.
            </div>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="fas fa-times me-1"></i> Cancel
        </button>
        <button type="submit" class="btn btn-primary" id="saveBtn">
          <i class="fas fa-save me-1"></i> Save Facility
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Modal para visualizar recursos -->
<div class="modal fade" id="viewResourcesModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">
          <i class="fas fa-boxes me-2"></i>
          <span id="resourcesModalTitle">Facility Resources</span>
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="resourcesList" class="row g-3">
          <!-- Resources will be displayed here -->
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal para visualizar imagem -->
<div class="modal fade" id="imageViewModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Image Preview</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center">
        <img id="imageViewModalImg" src="" class="img-fluid" style="max-height: 70vh;">
      </div>
    </div>
  </div>
</div>

<style>
.resource-card {
    border: 1px solid #dee2e6;
    border-radius: 10px;
    padding: 1.25rem;
    margin-bottom: 1rem;
    background: #fff;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    transition: all 0.3s ease;
}

.resource-card:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    transform: translateY(-2px);
}

.resource-header {
    border-bottom: 2px solid #e9ecef;
    padding-bottom: 0.75rem;
    margin-bottom: 1rem;
}

.image-preview {
    min-height: 80px;
    border: 1px dashed #dee2e6;
    border-radius: 5px;
    padding: 0.5rem;
    background: #f8f9fa;
}

.image-preview img {
    max-width: 100%;
    max-height: 100px;
    object-fit: cover;
    border-radius: 4px;
}

.preview-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
    gap: 0.5rem;
    margin-top: 0.5rem;
}

.preview-grid img {
    width: 80px;
    height: 80px;
    object-fit: cover;
    border-radius: 4px;
    border: 1px solid #dee2e6;
}

.badge-quantity {
    font-size: 0.9em;
    padding: 0.25rem 0.5rem;
}

.table-hover tbody tr:hover {
    background-color: rgba(13, 110, 253, 0.05);
}

.location-coordinates {
    font-family: monospace;
    font-size: 0.9em;
    color: #666;
}

/* Map styles */
#mapContainer {
    border: 1px solid #dee2e6;
    border-radius: 8px;
    overflow: hidden;
}

.map-controls {
    background: rgba(255, 255, 255, 0.9);
    padding: 0.5rem;
    border-radius: 4px;
}

/* Status indicators */
.status-badge {
    padding: 0.35rem 0.65rem;
    font-size: 0.75em;
    font-weight: 500;
}

/* Filter tags */
.filter-tag {
    display: inline-flex;
    align-items: center;
    background: #e3f2fd;
    border: 1px solid #bbdefb;
    border-radius: 20px;
    padding: 4px 12px;
    font-size: 0.85rem;
    margin-right: 8px;
    margin-bottom: 4px;
}

.filter-tag .remove-filter {
    margin-left: 6px;
    cursor: pointer;
    color: #666;
}

.filter-tag .remove-filter:hover {
    color: #dc3545;
}
</style>

<script>
// ==================== VARI√ÅVEIS GLOBAIS ====================
const apiUrl = '/api/location';
const apiResources = '/api/resource';
let availableResources = [];
let map, marker, autocomplete;
const MAPUTO_CENTER = { lat: -25.9636, lng: 32.5805 };
let editMode = false;

// Vari√°veis para busca e pagina√ß√£o
let allLocations = [];
let filteredLocations = [];
let currentPage = 1;
const itemsPerPage = 10;
let currentFilters = {
    name: '',
    responsavel: ''
};

// ==================== FUN√á√ïES DE FILTRO ====================

function performSearch() {
    currentFilters.name = document.getElementById('searchByName').value.trim().toLowerCase();
    currentFilters.responsavel = document.getElementById('searchByResponsavel').value;
    applyFilters();
}

function clearSearch() {
    document.getElementById('searchByName').value = '';
    currentFilters.name = '';
    applyFilters();
}

function clearResponsavelFilter() {
    document.getElementById('searchByResponsavel').value = '';
    currentFilters.responsavel = '';
    applyFilters();
}

function clearAllFilters() {
    document.getElementById('searchByName').value = '';
    document.getElementById('searchByResponsavel').value = '';
    currentFilters = { name: '', responsavel: '' };
    applyFilters();
}

function applyFilters() {
    currentPage = 1;
    
    filteredLocations = allLocations.filter(location => {
        // Filtro por nome/descri√ß√£o
        if (currentFilters.name) {
            const searchTerm = currentFilters.name;
            const nameMatch = location.name.toLowerCase().includes(searchTerm);
            const descMatch = location.description ? 
                location.description.toLowerCase().includes(searchTerm) : false;
            if (!nameMatch && !descMatch) return false;
        }
        
        // Filtro por respons√°vel
        if (currentFilters.responsavel && location.responsavel !== currentFilters.responsavel) {
            return false;
        }
        
        return true;
    });
    
    updateActiveFiltersDisplay();
    updateTable();
}

function updateActiveFiltersDisplay() {
    const activeFiltersDiv = document.getElementById('activeFilters');
    const filterTagsDiv = document.getElementById('filterTags');
    const activeFilters = [];
    
    if (currentFilters.name) {
        activeFilters.push({
            label: `Name: "${currentFilters.name}"`,
            clearFn: "clearSearch()"
        });
    }
    
    if (currentFilters.responsavel) {
        const responsavelNames = {
            'DOD': 'DOD (Department of Defense)',
            'Jhpiego': 'Jhpiego',
            'RISE': 'RISE',
            'MISAU': 'MISAU'
        };
        activeFilters.push({
            label: `Responsible: ${responsavelNames[currentFilters.responsavel] || currentFilters.responsavel}`,
            clearFn: "clearResponsavelFilter()"
        });
    }
    
    if (activeFilters.length > 0) {
        activeFiltersDiv.style.display = 'block';
        filterTagsDiv.innerHTML = '';
        
        activeFilters.forEach(filter => {
            const tag = document.createElement('span');
            tag.className = 'filter-tag';
            tag.innerHTML = `
                ${filter.label}
                <span class="remove-filter" onclick="${filter.clearFn}">
                    <i class="fas fa-times"></i>
                </span>
            `;
            filterTagsDiv.appendChild(tag);
        });
        
        // Bot√£o para limpar todos os filtros
        const clearAllBtn = document.createElement('button');
        clearAllBtn.className = 'btn btn-sm btn-outline-danger ms-2';
        clearAllBtn.innerHTML = '<i class="fas fa-times"></i> Clear All';
        clearAllBtn.onclick = clearAllFilters;
        filterTagsDiv.appendChild(clearAllBtn);
    } else {
        activeFiltersDiv.style.display = 'none';
        filterTagsDiv.innerHTML = '';
    }
}

// ==================== FUN√á√ïES DE PAGINA√á√ÉO ====================

function changePage(direction) {
    const newPage = currentPage + direction;
    const totalPages = Math.ceil(filteredLocations.length / itemsPerPage);
    
    if (newPage >= 1 && newPage <= totalPages) {
        currentPage = newPage;
        updateTable();
    }
}

function updatePaginationControls() {
    const totalPages = Math.ceil(filteredLocations.length / itemsPerPage);
    const startIndex = (currentPage - 1) * itemsPerPage + 1;
    const endIndex = Math.min(currentPage * itemsPerPage, filteredLocations.length);
    
    document.getElementById('paginationInfo').textContent = 
        `Showing ${startIndex} to ${endIndex} of ${filteredLocations.length} facilities`;
    
    document.getElementById('prevBtn').disabled = currentPage === 1;
    document.getElementById('nextBtn').disabled = currentPage === totalPages;
}

// ==================== FUN√á√ïES PRINCIPAIS ====================

async function loadLocations() {
    try {
        showLoading();
        
        const res = await fetch(apiUrl);
        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
        
        allLocations = await res.json();
        
        if (!Array.isArray(allLocations)) {
            throw new Error('Invalid response format');
        }
        
        allLocations.sort((a, b) => b.id - a.id);
        applyFilters();
        updateSummaryCards(allLocations);
        hideLoading();
        
    } catch (err) {
        console.error('Error loading locations:', err);
        const tbody = document.getElementById('locationsTableBody');
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="text-center py-5">
                    <i class="fas fa-exclamation-triangle fs-1 text-danger mb-3"></i>
                    <h5 class="text-danger">Error Loading Data</h5>
                    <p class="text-muted">${err.message}</p>
                    <button class="btn btn-primary mt-2" onclick="loadLocations()">
                        <i class="fas fa-redo me-1"></i> Try Again
                    </button>
                </td>
            </tr>
        `;
        hideLoading();
    }
}

function updateTable() {
    const tbody = document.getElementById('locationsTableBody');
    const resultsInfo = document.getElementById('resultsInfo');
    
    if (filteredLocations.length === 0) {
        let message = 'No facilities found';
        if (currentFilters.name || currentFilters.responsavel) {
            message += ' with the current filters.';
        }
        
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="text-center py-5">
                    <i class="fas fa-search fs-1 text-muted mb-3"></i>
                    <h5 class="text-muted">${message}</h5>
                    ${(currentFilters.name || currentFilters.responsavel) ? 
                        `<p class="text-muted">Try changing your search criteria or <button class="btn btn-link p-0" onclick="clearAllFilters()">clear all filters</button>.</p>` : 
                        `<p class="text-muted">Click "Add New Facility" to create your first health facility.</p>`}
                </td>
            </tr>
        `;
        
        resultsInfo.textContent = 'No facilities found';
        updatePaginationControls();
        return;
    }
    
    // Calcular pagina√ß√£o
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const pageLocations = filteredLocations.slice(startIndex, endIndex);
    
    tbody.innerHTML = '';
    
    pageLocations.forEach(loc => {
        const resourcesCount = loc.resources ? loc.resources.length : 0;
        const updatedDate = loc.updateAt ? new Date(loc.updateAt) : null;
        const today = new Date().toDateString();
        const isUpdatedToday = updatedDate && updatedDate.toDateString() === today;
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><strong>#${loc.id}</strong></td>
            <td>
                <div class="fw-bold">${loc.name}</div>
                <small class="text-muted">ID: ${loc.id}</small>
            </td>
            <td>
                <div class="text-truncate" style="max-width: 200px;" title="${loc.description || 'No description'}">
                    ${loc.description || '<span class="text-muted">No description</span>'}
                </div>
            </td>
            <td>
                ${loc.latitude && loc.longitude ? 
                    `<div class="location-coordinates">
                        <div>${parseFloat(loc.latitude).toFixed(4)}</div>
                        <div>${parseFloat(loc.longitude).toFixed(4)}</div>
                    </div>` : 
                    '<span class="badge bg-warning">No location</span>'}
            </td>
            <td>
                <span class="badge ${resourcesCount > 0 ? 'bg-success' : 'bg-danger'} rounded-pill px-3 py-1">
                    ${resourcesCount} ${resourcesCount === 1 ? 'resource' : 'resources'}
                </span>
                ${resourcesCount > 0 ? 
                    `<button class="btn btn-sm btn-outline-primary ms-2" onclick="viewFacilityResources(${loc.id}, '${loc.name.replace(/'/g, "\\'")}')">
                        <i class="fas fa-eye"></i>
                    </button>` : ''}
            </td>
            <td>
                <span class="badge ${getResponsavelBadgeClass(loc.responsavel)} status-badge">
                    ${loc.responsavel}
                </span>
            </td>
            <td>
                ${loc.updateAt ? 
                    `<div>
                        <small class="text-muted d-block">${formatDate(loc.updateAt)}</small>
                        ${isUpdatedToday ? '<span class="badge bg-info badge-sm">Today</span>' : ''}
                    </div>` : 
                    '<span class="text-muted">N/A</span>'}
            </td>
            <td>
                <div class="btn-group" role="group">
                    <button class="btn btn-primary btn-sm" onclick="editLocation(${loc.id})" title="Edit">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-outline-primary btn-sm" onclick="viewFacilityResources(${loc.id}, '${loc.name.replace(/'/g, "\\'")}')" title="View Resources">
                        <i class="fas fa-boxes"></i>
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="deleteLocation(${loc.id})" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        `;
        tbody.appendChild(row);
    });
    
    // Atualizar info de resultados
    resultsInfo.textContent = currentFilters.name || currentFilters.responsavel ? 
        `Found ${filteredLocations.length} facilities matching your search` : 
        `Showing ${filteredLocations.length} facilities`;
    
    updatePaginationControls();
}

// ==================== FUN√á√ïES AUXILIARES ====================

function showLoading() {
    const tbody = document.getElementById('locationsTableBody');
    if (tbody) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 mb-0">Loading health facilities...</p>
                </td>
            </tr>
        `;
    }
}

function hideLoading() {
    // Spinner √© removido quando os dados s√£o carregados
}

function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = `
        top: 20px;
        right: 20px;
        z-index: 1050;
        min-width: 300px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    `;
    
    alertDiv.innerHTML = `
        <strong>${type === 'success' ? '‚úì' : '‚ö†'} ${type.charAt(0).toUpperCase() + type.slice(1)}!</strong> ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.classList.remove('show');
            setTimeout(() => alertDiv.remove(), 150);
        }
    }, 5000);
}

function updateSummaryCards(locations) {
    const totalFacilities = locations.length;
    const totalResources = locations.reduce((sum, loc) => sum + (loc.resources ? loc.resources.length : 0), 0);
    const dodFacilities = locations.filter(loc => loc.responsavel === 'DOD').length;
    const today = new Date().toDateString();
    const updatedToday = locations.filter(loc => {
        if (!loc.updateAt) return false;
        const updateDate = new Date(loc.updateAt);
        return updateDate.toDateString() === today;
    }).length;
    
    document.getElementById('totalFacilities').textContent = totalFacilities;
    document.getElementById('totalResources').textContent = totalResources;
    document.getElementById('dodFacilities').textContent = dodFacilities;
    document.getElementById('updatedToday').textContent = updatedToday;
}

function formatDate(dateString) {
    if (!dateString) return 'N/A';
    const date = new Date(dateString);
    return date.toLocaleDateString('pt-PT', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

function getResponsavelBadgeClass(responsavel) {
    const classes = {
        'DOD': 'bg-primary',
        'Jhpiego': 'bg-success',
        'RISE': 'bg-info',
        'MISAU': 'bg-warning'
    };
    return classes[responsavel] || 'bg-secondary';
}

// ==================== INICIALIZA√á√ÉO ====================

window.onload = async function() {
    await fetchAvailableResources();
    await loadLocations();
    
    // Inicializar listeners dos filtros
    document.getElementById('searchByName').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') performSearch();
    });
    
    let searchTimeout;
    document.getElementById('searchByName').addEventListener('input', function(e) {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => performSearch(), 300);
    });
    
    document.getElementById('searchByResponsavel').addEventListener('change', performSearch);
};

// ==================== FUN√á√ïES PARA RECURSOS ====================

async function fetchAvailableResources() {
    try {
        const res = await fetch(apiResources);
        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
        availableResources = await res.json();
    } catch (error) {
        console.error('Error fetching resources:', error);
        showAlert('warning', 'Error loading resources. Please refresh the page.');
    }
}

function addResourceRow(resourceData = {}) {
    const container = document.getElementById('resourceRows');
    const placeholder = container.querySelector('.alert');
    if (placeholder) placeholder.remove();
    
    const rowId = 'resource_' + Date.now() + Math.random().toString(36).substr(2, 9);
    const resourceId = resourceData.resource_id || '';
    
    let resourceName = '';
    let resourceDescription = '';
    if (resourceId) {
        const resource = availableResources.find(r => r.id == resourceId);
        if (resource) {
            resourceName = resource.name;
            resourceDescription = resource.description || '';
        }
    }

    const row = document.createElement('div');
    row.className = 'col-12';
    row.id = rowId;
    row.innerHTML = `
        <div class="resource-card">
            <div class="resource-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0 text-primary">
                    <i class="fas fa-box me-2"></i>Resource Details
                </h6>
                <div>
                    <button type="button" class="btn btn-sm btn-danger" onclick="removeResourceRow('${rowId}')" title="Remove">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            
            <div class="row g-3">
                <!-- Resource Selection -->
                <div class="col-md-6">
                    <label class="form-label">Resource Type *</label>
                    <select class="form-select resource-select" required onchange="updateResourceInfo(this)">
                        <option value="">Select Resource Type</option>
                        ${availableResources.map(r => `
                            <option value="${r.id}" ${r.id == resourceId ? 'selected' : ''}
                                    data-name="${r.name}" 
                                    data-description="${r.description || ''}">
                                ${r.name}${r.description ? ' - ' + r.description : ''}
                            </option>
                        `).join('')}
                    </select>
                </div>

                <div class="col-md-6">
                    <label class="form-label">Resource Name</label>
                    <input type="text" class="form-control resource-name" 
                           value="${resourceData.name || resourceName || ''}" 
                           placeholder="Optional custom name for this resource">
                </div>

                <!-- Quantity and Recep√ß√£o -->
                <div class="col-md-3">
                    <label class="form-label">Quantity *</label>
                    <input type="number" min="0" class="form-control quantity-input" 
                           value="${resourceData.quantity || 1}" required>
                </div>

                <div class="col-md-3">
                    <label class="form-label">Received By</label>
                    <input type="text" class="form-control recebidopor-input" 
                           value="${resourceData.recebidopor || ''}" 
                           placeholder="Person who received">
                </div>

                <div class="col-md-3">
                    <label class="form-label">Reception Date</label>
                    <input type="date" class="form-control datarecepcao-input" 
                           value="${resourceData.datarecepcao || ''}">
                </div>

                <div class="col-md-3">
                    <label class="form-label">Status</label>
                    <select class="form-select status-input">
                        <option value="available" ${resourceData.status === 'available' ? 'selected' : ''}>Available</option>
                        <option value="in-use" ${resourceData.status === 'in-use' ? 'selected' : ''}>In Use</option>
                        <option value="maintenance" ${resourceData.status === 'maintenance' ? 'selected' : ''}>Maintenance</option>
                        <option value="unavailable" ${resourceData.status === 'unavailable' ? 'selected' : ''}>Unavailable</option>
                    </select>
                </div>

                <!-- Description -->
                <div class="col-12">
                    <label class="form-label">Description / Notes</label>
                    <textarea class="form-control description-input" rows="2" 
                              placeholder="Additional details about this resource">${resourceData.description || resourceDescription || ''}</textarea>
                </div>

                <!-- Images and Files Section -->
                <div class="col-md-4">
                    <div class="card h-100">
                        <div class="card-header py-2 bg-light">
                            <label class="form-label mb-0">
                                <i class="fas fa-image me-1"></i> Main Image
                            </label>
                        </div>
                        <div class="card-body">
                            <input type="file" class="form-control mb-2 imagem-principal-input" 
                                   accept="image/*" onchange="handleImageUpload(this, '${rowId}')">
                            <div class="image-preview" id="preview_${rowId}">
                                ${resourceData.imagem_principal ? 
                                  `<img src="${resourceData.imagem_principal}" class="img-thumbnail mb-2" onclick="viewImage('${resourceData.imagem_principal}')">
                                   <button type="button" class="btn btn-sm btn-danger w-100 mt-1" onclick="clearImage('${rowId}', 'main')">
                                       <i class="fas fa-times me-1"></i> Remove
                                   </button>` : 
                                  '<div class="text-muted text-center py-3">No image selected</div>'}
                            </div>
                            <input type="hidden" class="imagem-principal-data" 
                                   value="${resourceData.imagem_principal || ''}">
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="card h-100">
                        <div class="card-header py-2 bg-light">
                            <label class="form-label mb-0">
                                <i class="fas fa-file-pdf me-1"></i> Signed Document
                            </label>
                        </div>
                        <div class="card-body">
                            <input type="file" class="form-control mb-2 anexospdf-input" 
                                   accept=".pdf" onchange="handlePdfUpload(this, '${rowId}')">
                            <div class="pdf-preview" id="pdf_preview_${rowId}">
                                ${resourceData.anexospdf ? 
                                  `<span class="badge bg-success mb-2 d-block">PDF document attached</span>
                                   <button type="button" class="btn btn-sm btn-danger w-100" onclick="clearFile('${rowId}', 'pdf')">
                                       <i class="fas fa-times me-1"></i> Remove
                                   </button>` : 
                                  '<div class="text-muted text-center py-3">No document selected</div>'}
                            </div>
                            <input type="hidden" class="anexospdf-data" 
                                   value="${resourceData.anexospdf || ''}">
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="card h-100">
                        <div class="card-header py-2 bg-light">
                            <label class="form-label mb-0">
                                <i class="fas fa-images me-1"></i> Additional Images
                            </label>
                        </div>
                        <div class="card-body">
                            <input type="file" class="form-control mb-2 imagens-input" 
                                   accept="image/*" multiple onchange="handleMultipleImages(this, '${rowId}')">
                            <div class="multiple-images-preview" id="multiple_preview_${rowId}">
                                ${resourceData.imagens ? 
                                  `<div class="preview-grid mb-2" id="grid_${rowId}"></div>
                                   <button type="button" class="btn btn-sm btn-danger w-100" onclick="clearFile('${rowId}', 'images')">
                                       <i class="fas fa-times me-1"></i> Remove All
                                   </button>` : 
                                  '<div class="text-muted text-center py-3">No images selected</div>'}
                            </div>
                            <input type="hidden" class="imagens-data" 
                                   value="${resourceData.imagens || ''}">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    container.insertBefore(row, container.firstChild);
    
    // Load existing images if editing
    if (resourceData.imagens) {
        loadMultipleImagesPreview(resourceData.imagens, rowId);
    }
}

function removeResourceRow(rowId) {
    if (document.querySelectorAll('#resourceRows > .col-12').length <= 1) {
        showAlert('warning', 'At least one resource is required.');
        return;
    }
    
    if (confirm('Are you sure you want to remove this resource?')) {
        const row = document.getElementById(rowId);
        if (row) row.remove();
        
        // Show placeholder if no resources
        if (document.querySelectorAll('#resourceRows > .col-12').length === 0) {
            const container = document.getElementById('resourceRows');
            container.innerHTML = `
                <div class="col-12">
                    <div class="alert alert-info mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        Click "Add Resource" to add equipment and supplies for this health facility.
                    </div>
                </div>
            `;
        }
    }
}

function updateResourceInfo(select) {
    const option = select.selectedOptions[0];
    const row = select.closest('.resource-card');
    
    if (option.value && option.dataset.name) {
        const nameInput = row.querySelector('.resource-name');
        const descInput = row.querySelector('.description-input');
        
        // Only update if fields are empty
        if (!nameInput.value) {
            nameInput.value = option.dataset.name;
        }
        if (!descInput.value && option.dataset.description) {
            descInput.value = option.dataset.description;
        }
    }
}

// Fun√ß√µes para upload de arquivos
function handleImageUpload(input, rowId) {
    const file = input.files[0];
    if (!file) return;
    
    if (!file.type.startsWith('image/')) {
        showAlert('error', 'Please select an image file.');
        return;
    }
    
    if (file.size > 5 * 1024 * 1024) { // 5MB limit
        showAlert('error', 'Image size should be less than 5MB.');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        const preview = document.getElementById(`preview_${rowId}`);
        preview.innerHTML = `
            <img src="${e.target.result}" class="img-thumbnail mb-2" onclick="viewImage('${e.target.result}')">
            <button type="button" class="btn btn-sm btn-danger w-100 mt-1" onclick="clearImage('${rowId}', 'main')">
                <i class="fas fa-times me-1"></i> Remove
            </button>
        `;
        
        const row = input.closest('.resource-card');
        const hiddenInput = row.querySelector('.imagem-principal-data');
        hiddenInput.value = e.target.result;
    };
    reader.readAsDataURL(file);
}

function handlePdfUpload(input, rowId) {
    const file = input.files[0];
    if (!file) return;
    
    if (file.type !== 'application/pdf') {
        showAlert('error', 'Only PDF files are allowed.');
        return;
    }
    
    if (file.size > 10 * 1024 * 1024) { // 10MB limit
        showAlert('error', `File ${file.name} is too large (max 10MB).`);
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        const preview = document.getElementById(`pdf_preview_${rowId}`);
        preview.innerHTML = `
            <span class="badge bg-success mb-2 d-block">${file.name}</span>
            <button type="button" class="btn btn-sm btn-danger w-100" onclick="clearFile('${rowId}', 'pdf')">
                <i class="fas fa-times me-1"></i> Remove
            </button>
        `;
        
        const row = input.closest('.resource-card');
        const hiddenInput = row.querySelector('.anexospdf-data');
        hiddenInput.value = e.target.result;
    };
    reader.readAsDataURL(file);
}

function handleMultipleImages(input, rowId) {
    const files = input.files;
    if (!files.length) return;
    
    const readers = [];
    const images = [];
    
    for (let i = 0; i < files.length; i++) {
        const file = files[i];
        if (!file.type.startsWith('image/')) {
            showAlert('error', 'Only image files are allowed.');
            continue;
        }
        
        if (file.size > 5 * 1024 * 1024) {
            showAlert('error', `Image ${file.name} is too large (max 5MB).`);
            continue;
        }
        
        const reader = new FileReader();
        readers.push(new Promise((resolve) => {
            reader.onload = function(e) {
                images.push(e.target.result);
                resolve();
            };
            reader.readAsDataURL(file);
        }));
    }
    
    Promise.all(readers).then(() => {
        if (images.length > 0) {
            const row = input.closest('.resource-card');
            const hiddenInput = row.querySelector('.imagens-data');
            hiddenInput.value = JSON.stringify(images);
            
            const preview = document.getElementById(`multiple_preview_${rowId}`);
            const grid = document.createElement('div');
            grid.className = 'preview-grid mb-2';
            grid.innerHTML = images.map((img, idx) => 
                `<img src="${img}" class="img-thumbnail" onclick="viewImage('${img}')">`
            ).join('');
            
            preview.innerHTML = '';
            preview.appendChild(grid);
            preview.innerHTML += `
                <button type="button" class="btn btn-sm btn-danger w-100" onclick="clearFile('${rowId}', 'images')">
                    <i class="fas fa-times me-1"></i> Remove All
                </button>
            `;
        }
    });
}

function loadMultipleImagesPreview(imagesData, rowId) {
    try {
        const images = JSON.parse(imagesData);
        if (Array.isArray(images)) {
            const grid = document.getElementById(`grid_${rowId}`) || document.createElement('div');
            grid.className = 'preview-grid mb-2';
            grid.innerHTML = images.map((img, idx) => 
                `<img src="${img}" class="img-thumbnail" onclick="viewImage('${img}')">`
            ).join('');
        }
    } catch (e) {
        console.error('Error loading images:', e);
    }
}

function clearImage(rowId, type) {
    const row = document.getElementById(rowId);
    if (!row) return;
    
    if (type === 'main') {
        const input = row.querySelector('.imagem-principal-input');
        const hiddenInput = row.querySelector('.imagem-principal-data');
        const preview = document.getElementById(`preview_${rowId}`);
        
        input.value = '';
        hiddenInput.value = '';
        preview.innerHTML = '<div class="text-muted text-center py-3">No image selected</div>';
    }
}

function clearFile(rowId, type) {
    const row = document.getElementById(rowId);
    if (!row) return;
    
    if (type === 'pdf') {
        const input = row.querySelector('.anexospdf-input');
        const hiddenInput = row.querySelector('.anexospdf-data');
        const preview = document.getElementById(`pdf_preview_${rowId}`);
        
        input.value = '';
        hiddenInput.value = '';
        preview.innerHTML = '<div class="text-muted text-center py-3">No document selected</div>';
    } else if (type === 'images') {
        const input = row.querySelector('.imagens-input');
        const hiddenInput = row.querySelector('.imagens-data');
        const preview = document.getElementById(`multiple_preview_${rowId}`);
        
        input.value = '';
        hiddenInput.value = '';
        preview.innerHTML = '<div class="text-muted text-center py-3">No images selected</div>';
    }
}

function viewImage(src) {
    const modal = new bootstrap.Modal(document.getElementById('imageViewModal'));
    const img = document.getElementById('imageViewModalImg');
    if (img) {
        img.src = src;
        modal.show();
    }
}

function collectResourceData() {
    const resources = [];

    document.querySelectorAll('#resourceRows .resource-card').forEach(card => {
        const resourceSelect = card.querySelector('.resource-select');
        if (!resourceSelect.value || resourceSelect.value === "") return;

        const resource = {
            resource_id: parseInt(resourceSelect.value),
            name: card.querySelector('.resource-name')?.value?.trim() || null,
            quantity: parseInt(card.querySelector('.quantity-input')?.value) || 1,
            description: card.querySelector('.description-input')?.value?.trim() || null,
            recebidopor: card.querySelector('.recebidopor-input')?.value?.trim() || null,
            datarecepcao: card.querySelector('.datarecepcao-input')?.value || null,
            status: card.querySelector('.status-input')?.value || 'available',
            imagem_principal: card.querySelector('.imagem-principal-data')?.value || null,
            imagens: card.querySelector('.imagens-data')?.value || null,
            anexospdf: card.querySelector('.anexospdf-data')?.value || null
        };

        // Remove empty fields
        Object.keys(resource).forEach(key => {
            if (resource[key] === null || resource[key] === undefined || resource[key] === '') {
                delete resource[key];
            }
        });

        resources.push(resource);
    });

    return resources;
}

// ==================== FUN√á√ïES DE CRUD ====================

async function editLocation(locationId) {
    try {
        showLoading();
        const res = await fetch(`${apiUrl}/${locationId}`);
        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
        
        const locationData = await res.json();
        openLocationModal(locationData);
        hideLoading();
        
    } catch (error) {
        console.error('Error fetching location:', error);
        showAlert('error', 'Error loading location data: ' + error.message);
        hideLoading();
    }
}

async function deleteLocation(id) {
    if (!confirm('Are you sure you want to delete this health facility? This action cannot be undone.')) return;
    
    try {
        const res = await fetch(`${apiUrl}/${id}`, { method: 'DELETE' });
        
        if (res.ok) {
            showAlert('success', 'Health facility deleted successfully.');
            loadLocations();
        } else {
            const error = await res.text();
            throw new Error(error);
        }
    } catch (err) {
        console.error('Error deleting location:', err);
        showAlert('error', 'Error deleting facility: ' + err.message);
    }
}

// ==================== MODAL FUNCTIONS ====================

function openLocationModal(locationData = null) {
    editMode = !!locationData;
    
    document.getElementById('locationForm').reset();
    document.getElementById('locationId').value = '';
    document.getElementById('resourceRows').innerHTML = '';
    document.getElementById('locationSearch').value = '';
    
    if (editMode) {
        document.getElementById('modalTitle').textContent = 'Edit Health Facility';
        document.getElementById('saveBtn').innerHTML = '<i class="fas fa-save me-1"></i> Update Facility';
        
        document.getElementById('locationId').value = locationData.id;
        document.getElementById('locationName').value = locationData.name;
        document.getElementById('locationDescription').value = locationData.description || '';
        document.getElementById('latitude').value = locationData.latitude || '';
        document.getElementById('longitude').value = locationData.longitude || '';
        document.getElementById('responsavel').value = locationData.responsavel || 'DOD';
        document.getElementById('observacoes').value = locationData.observacoes || '';

        document.getElementById('resourceRows').innerHTML = '';
        if (locationData.resources && locationData.resources.length > 0) {
            locationData.resources.forEach(resource => addResourceRow(resource));
        } else {
            addResourceRow();
        }
    } else {
        document.getElementById('modalTitle').textContent = 'Add Health Facility';
        document.getElementById('saveBtn').innerHTML = '<i class="fas fa-save me-1"></i> Save Facility';
        document.getElementById('latitude').value = '';
        document.getElementById('longitude').value = '';
        document.getElementById('responsavel').value = 'DOD';
        addResourceRow();
    }

    const modal = new bootstrap.Modal(document.getElementById('locationModal'));
    modal.show();

    document.getElementById('locationModal').addEventListener('shown.bs.modal', function() {
        if (editMode && locationData.latitude && locationData.longitude) {
            initializeMap(locationData.latitude, locationData.longitude);
        } else {
            initializeMap();
        }
        
        setTimeout(() => {
            google.maps.event.trigger(map, "resize");
            if (editMode && locationData.latitude && locationData.longitude) {
                const position = { lat: parseFloat(locationData.latitude), lng: parseFloat(locationData.longitude) };
                map.setCenter(position);
                map.setZoom(15);
            } else {
                map.setCenter(MAPUTO_CENTER);
            }
        }, 300);
    }, { once: true });
}

function viewFacilityResources(locationId, locationName) {
    fetch(`${apiUrl}/${locationId}`)
        .then(res => res.json())
        .then(location => {
            const resourcesList = document.getElementById('resourcesList');
            const title = document.getElementById('resourcesModalTitle');
            
            title.textContent = `Resources: ${locationName}`;
            resourcesList.innerHTML = '';
            
            if (location.resources && location.resources.length > 0) {
                location.resources.forEach((resource, index) => {
                    const resourceCard = document.createElement('div');
                    resourceCard.className = 'col-md-6';
                    
                    let imagesHtml = '';
                    if (resource.imagem_principal) {
                        imagesHtml += `
                            <div class="mb-2">
                                <strong>Main Image:</strong>
                                <img src="${resource.imagem_principal}" class="img-thumbnail mt-1 d-block" style="max-width: 150px; cursor: pointer;" onclick="viewImage('${resource.imagem_principal}')">
                            </div>
                        `;
                    }
                    
                    if (resource.imagens) {
                        try {
                            const additionalImages = JSON.parse(resource.imagens);
                            if (Array.isArray(additionalImages) && additionalImages.length > 0) {
                                imagesHtml += `
                                    <div class="mb-2">
                                        <strong>Additional Images:</strong>
                                        <div class="preview-grid mt-1">
                                            ${additionalImages.map(img => `
                                                <img src="${img}" class="img-thumbnail" style="cursor: pointer;" onclick="viewImage('${img}')">
                                            `).join('')}
                                        </div>
                                    </div>
                                `;
                            }
                        } catch (e) {
                            console.error('Error parsing images:', e);
                        }
                    }
                    
                    if (resource.anexospdf) {
                        imagesHtml += `
                            <div class="mb-2">
                                <strong>Signed Document:</strong><br>
                                <span class="badge bg-success">PDF attached</span>
                            </div>
                        `;
                    }
                    
                    resourceCard.innerHTML = `
                        <div class="card h-100">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">${resource.name || 'Unnamed Resource'}</h6>
                            </div>
                            <div class="card-body">
                                <p><strong>Type:</strong> ${getResourceName(resource.resource_id)}</p>
                                <p><strong>Quantity:</strong> ${resource.quantity}</p>
                                ${resource.description ? `<p><strong>Description:</strong> ${resource.description}</p>` : ''}
                                ${resource.recebidopor ? `<p><strong>Received by:</strong> ${resource.recebidopor}</p>` : ''}
                                ${resource.datarecepcao ? `<p><strong>Reception Date:</strong> ${resource.datarecepcao}</p>` : ''}
                                ${resource.status ? `<p><strong>Status:</strong> <span class="badge bg-${getStatusBadgeClass(resource.status)}">${resource.status}</span></p>` : ''}
                                ${imagesHtml}
                            </div>
                        </div>
                    `;
                    resourcesList.appendChild(resourceCard);
                });
            } else {
                resourcesList.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            No resources found for this facility.
                        </div>
                    </div>
                `;
            }
            
            new bootstrap.Modal(document.getElementById('viewResourcesModal')).show();
        })
        .catch(error => {
            console.error('Error fetching resources:', error);
            showAlert('error', 'Error loading resources.');
        });
}

function getResourceName(resourceId) {
    const resource = availableResources.find(r => r.id == resourceId);
    return resource ? resource.name : `Resource #${resourceId}`;
}

function getStatusBadgeClass(status) {
    switch(status) {
        case 'available': return 'success';
        case 'in-use': return 'primary';
        case 'maintenance': return 'warning';
        case 'unavailable': return 'danger';
        default: return 'secondary';
    }
}

// ==================== FORM SUBMISSION ====================

document.getElementById('locationForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const saveBtn = document.getElementById('saveBtn');
    const originalText = saveBtn.innerHTML;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Saving...';
    saveBtn.disabled = true;

    const id = document.getElementById('locationId').value;
    const name = document.getElementById('locationName').value;
    const description = document.getElementById('locationDescription').value;
    const latitude = document.getElementById('latitude').value;
    const longitude = document.getElementById('longitude').value;
    const responsavel = document.getElementById('responsavel').value;
    const observacoes = document.getElementById('observacoes').value;

    const resources = collectResourceData();
    
    if (resources.length === 0) {
        showAlert('warning', "Please add at least one resource before saving.");
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;
        document.getElementById('resources-tab').click();
        return;
    }

    const payload = {
        name: name.trim(),
        description: description.trim(),
        latitude: latitude ? parseFloat(latitude) : null,
        longitude: longitude ? parseFloat(longitude) : null,
        responsavel,
        observacoes: observacoes ? observacoes.trim() : null,
        resources: resources
    };

    try {
        const url = id ? `${apiUrl}/${id}` : apiUrl;
        const method = id ? 'PUT' : 'POST';

        const res = await fetch(url, {
            method: method,
            headers: { 
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify(payload)
        });

        const responseText = await res.text();
        let responseData;
        try {
            responseData = responseText ? JSON.parse(responseText) : {};
        } catch (e) {
            responseData = { message: responseText };
        }

        if (!res.ok) {
            throw new Error(responseData.message || responseData.error || `Failed to save. Status: ${res.status}`);
        }

        showAlert('success', editMode ? 'Health facility updated successfully!' : 'Health facility created successfully!');
        
        const modal = bootstrap.Modal.getInstance(document.getElementById('locationModal'));
        modal.hide();
        loadLocations();

    } catch (err) {
        console.error('Error saving location:', err);
        showAlert('error', 'Error saving facility: ' + err.message);
    } finally {
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;
    }
});

// ==================== MAP FUNCTIONS ====================

function initializeMap(lat = -25.9636, lng = 32.5805) {
    const center = { lat: parseFloat(lat), lng: parseFloat(lng) };

    const mapElement = document.getElementById("map");
    if (mapElement.innerHTML) mapElement.innerHTML = "";

    map = new google.maps.Map(mapElement, {
        center: center,
        zoom: 7,
        mapTypeId: "roadmap",
        streetViewControl: false,
        mapTypeControl: false,
        fullscreenControl: true,
        zoomControl: true
    });

    marker = new google.maps.Marker({
        position: center,
        map: map,
        draggable: true,
        animation: google.maps.Animation.DROP,
        title: "Drag to adjust location"
    });

    map.addListener("click", (event) => {
        marker.setPosition(event.latLng);
        updateCoordinates(event.latLng);
    });

    marker.addListener("dragend", () => {
        updateCoordinates(marker.getPosition());
    });

    const input = document.getElementById("locationSearch");
    autocomplete = new google.maps.places.Autocomplete(input, {
        types: ['establishment', 'geocode'],
        componentRestrictions: { country: 'mz' }
    });
    
    autocomplete.addListener("place_changed", () => {
        const place = autocomplete.getPlace();
        if (!place.geometry) {
            showAlert('warning', 'Place not found. Please try another search.');
            return;
        }

        map.panTo(place.geometry.location);
        map.setZoom(15);
        marker.setPosition(place.geometry.location);
        updateCoordinates(place.geometry.location);
    });

    document.getElementById("toggleMapTypeBtn").onclick = () => {
        const current = map.getMapTypeId();
        const newType = current === "roadmap" ? "satellite" : "roadmap";
        map.setMapTypeId(newType);
        document.getElementById("toggleMapTypeBtn").innerHTML = newType === "roadmap" 
            ? '<i class="fas fa-satellite me-1"></i> Satellite' 
            : '<i class="fas fa-map me-1"></i> Map';
    };

    updateCoordinates(center);
}

function updateCoordinates(position) {
    document.getElementById("latitude").value = position.lat().toFixed(6);
    document.getElementById("longitude").value = position.lng().toFixed(6);
}

function clearMapSearch() {
    document.getElementById('locationSearch').value = '';
    if (marker) {
        marker.setPosition(MAPUTO_CENTER);
        map.setCenter(MAPUTO_CENTER);
        map.setZoom(7);
        updateCoordinates(MAPUTO_CENTER);
    }
}

function resetMap() {
    if (marker) {
        marker.setPosition(MAPUTO_CENTER);
        map.setCenter(MAPUTO_CENTER);
        map.setZoom(7);
        updateCoordinates(MAPUTO_CENTER);
    }
}

function useCurrentLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            (position) => {
                const pos = { lat: position.coords.latitude, lng: position.coords.longitude };
                marker.setPosition(pos);
                map.setCenter(pos);
                map.setZoom(15);
                updateCoordinates(pos);
                
                const geocoder = new google.maps.Geocoder();
                geocoder.geocode({ location: pos }, (results, status) => {
                    if (status === "OK" && results[0]) {
                        document.getElementById('locationSearch').value = results[0].formatted_address;
                    }
                });
            },
            (error) => {
                console.error("Error getting location:", error);
                showAlert('error', 'Unable to get current location. Please enable location services.');
            }
        );
    } else {
        showAlert('error', 'Geolocation is not supported by your browser.');
    }
}
</script>

<!-- Google Maps com Places -->
<script async 
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDw8qHIN9go7Do3aouyR9343opJ33ZdDb0&libraries=places">
</script>

<!-- Font Awesome para √≠cones -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

{% endblock %}