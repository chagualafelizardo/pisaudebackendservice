{% extends 'base.html' %}

{% block title %}PI-SAÚDE / Locations{% endblock %}

{% block content %}
{% include 'navbar.html' %}

<h2>Manage Locations</h2>

<!-- Floating Action Button (FAB) -->
<button class="btn btn-success rounded-circle position-fixed"
        style="bottom: 20px; right: 20px; width: 60px; height: 60px; font-size: 28px; z-index: 1000;"
        data-bs-toggle="modal"
        data-bs-target="#locationModal"
        onclick="openLocationModal()">
    +
</button>

<!-- Tabela de locations -->
<table class="table table-bordered">
    <thead>
        <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Description</th>
            <th>Latitude</th>
            <th>Longitude</th>
            <th>Resources</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody id="locationsTableBody">
        <!-- Populado via JS -->
    </tbody>
</table>

<!-- Modal de Formulário -->
<div class="modal fade" id="locationModal" tabindex="-1" aria-labelledby="locationModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <form id="locationForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="locationModalLabel">Add/Edit Location</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="locationId">

        <div class="mb-3">
          <label for="locationName" class="form-label">Location Name</label>
          <input type="text" id="locationName" class="form-control" required>
        </div>

        <div class="mb-3">
          <label for="locationDescription" class="form-label">Description</label>
          <textarea id="locationDescription" class="form-control" required></textarea>
        </div>

        <div class="mb-3">
          <label for="latitude" class="form-label">Latitude</label>
          <input type="text" id="latitude" class="form-control" readonly required>
        </div>

        <div class="mb-3">
          <label for="longitude" class="form-label">Longitude</label>
          <input type="text" id="longitude" class="form-control" readonly required>
        </div>

        <!-- Search Location -->
        <div class="mb-3">
            <label for="locationSearch" class="form-label">Search Location</label>
            <input type="text" id="locationSearch" class="form-control" placeholder="Search for a place">
        </div>

        <!-- Container do mapa com botão de alternância -->
        <div id="mapContainer" style="position: relative; height: 400px; margin-bottom: 15px;">
          <div id="map" style="height: 100%;"></div>
          <button id="toggleMapTypeBtn" class="btn btn-info position-absolute"
                  style="top: 10px; left: 10px; z-index: 1000; padding: 5px 10px;">
              Satellite
          </button>
        </div>

        <div class="mb-3">
          <label class="form-label">Resources</label>
          <div id="resourceRows"></div>
          <button type="button" class="btn btn-sm btn-secondary mt-2" onclick="addResourceRow()">+ Add Resource</button>
        </div>
      </div>

      <div class="modal-footer">
        <button type="submit" class="btn btn-primary">Save</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
      </div>
    </form>
  </div>
</div>

<script>
const apiUrl = '/api/location';
const apiResources = '/api/resource';
let availableResources = [];

let map;
let marker;
let autocomplete;

async function fetchResources() {
    const res = await fetch(apiResources);
    availableResources = await res.json();
}

function addResourceRow(resourceId = '', quantity = '') {
    const container = document.getElementById('resourceRows');

    const row = document.createElement('div');
    row.className = 'row mb-2 align-items-center';
    row.innerHTML = `
        <div class="col-md-6">
            <select class="form-select resource-select" required>
                <option value="">Select Resource</option>
                ${availableResources.map(r => `
                    <option value="${r.id}" ${r.id == resourceId ? 'selected' : ''}>${r.name}</option>
                `).join('')}
            </select>
        </div>
        <div class="col-md-4">
            <input type="number" min="0" class="form-control quantity-input" value="${quantity}" placeholder="Quantity" required>
        </div>
        <div class="col-md-2">
            <button type="button" class="btn btn-danger btn-sm" onclick="this.closest('.row').remove()">✕</button>
        </div>
    `;
    container.appendChild(row);
}

function initMap(lat = -25.9636, lng = 32.5805) {
    const center = { lat: parseFloat(lat), lng: parseFloat(lng) };

    map = new google.maps.Map(document.getElementById("map"), {
        zoom: 6,
        center: center,
        mapTypeId: 'satellite'
    });

    marker = new google.maps.Marker({
        position: center,
        map: map,
        draggable: true
    });

    marker.addListener('dragend', () => {
        const pos = marker.getPosition();
        document.getElementById('latitude').value = pos.lat();
        document.getElementById('longitude').value = pos.lng();
    });

    map.addListener('click', (event) => {
        marker.setPosition(event.latLng);
        document.getElementById('latitude').value = event.latLng.lat();
        document.getElementById('longitude').value = event.latLng.lng();
    });

    const input = document.getElementById('locationSearch');
    autocomplete = new google.maps.places.Autocomplete(input, {
        fields: ["geometry", "name"]
    });
    autocomplete.bindTo("bounds", map);

    autocomplete.addListener("place_changed", () => {
        const place = autocomplete.getPlace();
        if (!place.geometry || !place.geometry.location) {
            alert("Please select a place from the suggestions.");
            input.classList.add("is-invalid");
            setTimeout(() => input.classList.remove("is-invalid"), 2000);
            return;
        }

        input.classList.remove("is-invalid");

        map.panTo(place.geometry.location);
        map.setZoom(15);
        marker.setPosition(place.geometry.location);

        document.getElementById('latitude').value = place.geometry.location.lat();
        document.getElementById('longitude').value = place.geometry.location.lng();
    });

    // Impede que o Enter envie o formulário sem escolher uma sugestão
    input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
        }
    });

    // Alternar tipo de mapa
    const toggleBtn = document.getElementById('toggleMapTypeBtn');
    toggleBtn.onclick = () => {
        const currentType = map.getMapTypeId();
        const newType = currentType === 'satellite' ? 'terrain' : 'satellite';
        map.setMapTypeId(newType);
        toggleBtn.textContent = newType.charAt(0).toUpperCase() + newType.slice(1);
    };
}

function openLocationModal() {
    document.getElementById('locationForm').reset();
    document.getElementById('locationId').value = '';
    document.getElementById('resourceRows').innerHTML = '';
    document.getElementById('latitude').value = '';
    document.getElementById('longitude').value = '';
    document.getElementById('locationSearch').value = '';

    addResourceRow();

    const modalEl = document.getElementById('locationModal');
    const modal = new bootstrap.Modal(modalEl);
    modal.show();

    modalEl.addEventListener('shown.bs.modal', function () {
        initMap();
        setTimeout(() => {
            document.getElementById('locationSearch').focus();
        }, 400);
    }, { once: true });
}

async function loadLocations() {
    try {
        const res = await fetch(apiUrl);
        const locations = await res.json();
        const tbody = document.getElementById('locationsTableBody');
        tbody.innerHTML = '';

        locations.forEach(loc => {
            const resourceList = loc.resources.map(r => `${r.name} (${r.quantity})`).join(', ');
            tbody.innerHTML += `
                <tr>
                    <td>${loc.id}</td>
                    <td>${loc.name}</td>
                    <td>${loc.description || ''}</td>
                    <td>${loc.latitude || ''}</td>
                    <td>${loc.longitude || ''}</td>
                    <td>${resourceList}</td>
                    <td>
                        <button class="btn btn-sm btn-warning" onclick='editLocation(${JSON.stringify(loc)})'>Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteLocation(${loc.id})">Delete</button>
                    </td>
                </tr>
            `;
        });
    } catch (err) {
        alert('Error loading locations: ' + err);
    }
}

function editLocation(loc) {
    document.getElementById('locationId').value = loc.id;
    document.getElementById('locationName').value = loc.name;
    document.getElementById('locationDescription').value = loc.description;
    document.getElementById('latitude').value = loc.latitude || '';
    document.getElementById('longitude').value = loc.longitude || '';
    document.getElementById('resourceRows').innerHTML = '';
    document.getElementById('locationSearch').value = '';

    loc.resources.forEach(r => addResourceRow(r.id, r.quantity));

    const modal = new bootstrap.Modal(document.getElementById('locationModal'));
    modal.show();

    document.getElementById('locationModal').addEventListener('shown.bs.modal', function () {
        initMap(loc.latitude || -25.9636, loc.longitude || 32.5805);
    }, { once: true });
}

document.getElementById('locationForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const id = document.getElementById('locationId').value;
    const name = document.getElementById('locationName').value;
    const description = document.getElementById('locationDescription').value;
    const latitude = document.getElementById('latitude').value;
    const longitude = document.getElementById('longitude').value;

    const resources = Array.from(document.querySelectorAll('#resourceRows .row')).map(row => ({
        resourceId: parseInt(row.querySelector('.resource-select').value),
        quantity: parseInt(row.querySelector('.quantity-input').value)
    })).filter(r => r.resourceId && !isNaN(r.quantity));

    const payload = { name, description, latitude, longitude, resources };

    try {
        const res = await fetch(id ? `${apiUrl}/${id}` : apiUrl, {
            method: id ? 'PUT' : 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (!res.ok) throw await res.json();

        const modalEl = document.getElementById('locationModal');
        const modal = bootstrap.Modal.getInstance(modalEl);
        modal.hide();

        // Remove o backdrop manualmente após esconder o modal
        document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());

        loadLocations();
    } catch (err) {
        alert(err.message || 'Error saving location');
    }
});

async function deleteLocation(id) {
    if (!confirm('Are you sure you want to delete this location?')) return;
    try {
        const res = await fetch(`${apiUrl}/${id}`, { method: 'DELETE' });
        if (!res.ok) throw await res.json();
        loadLocations();
    } catch (err) {
        alert(err.message || 'Error deleting location');
    }
}

window.onload = async () => {
    await fetchResources();
    loadLocations();
};
</script>

<!-- Google Maps com Places -->
<script async
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDw8qHIN9go7Do3aouyR9343opJ33ZdDb0&libraries=places">
</script>

{% endblock %}