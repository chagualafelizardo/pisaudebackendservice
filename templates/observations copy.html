{% extends 'base.html' %}
{% block title %}PI-SA√öDE / Observations{% endblock %}

{% block content %}

<h2>Manage Observations</h2>

<!-- Bot√£o flutuante -->
<button id="addUserBtn"
        class="btn btn-success rounded-circle position-fixed"
        style="bottom: 20px; right: 20px; width: 60px; height: 60px; font-size: 28px; z-index: 1050;"
        data-bs-toggle="modal"
        data-bs-target="#obsModal"
        onclick="openObsModal()">
  +
</button>

<!-- üîç Filtros no Topo -->
<div class="card p-3 mb-3 shadow-sm">
      <!-- Data Inicial -->
    <div class="col-md-2">
      <label class="form-label"><strong>Data Inicial</strong></label>
      <input type="date" id="filterStartDate" class="form-control">
      <label class="form-label"><strong>Data Final</strong></label>
      <input type="date" id="filterEndDate" class="form-control">
    </div>
  <div class="row g-3 align-items-end">
    <!-- Text Message -->
    <div class="col-md-2">
      <label class="form-label"><strong>Text Message</strong></label>
      <select id="filterTextmessage" class="form-select">
        <option value="">-- All --</option>
      </select>
      
    </div>

    <!-- State -->
    <div class="col-md-2">
      <label class="form-label"><strong>State</strong></label>
      <select id="filterState" class="form-select">
        <option value="">-- All --</option>
      </select>
    </div>

    <!-- Group Type -->
    <div class="col-md-2">
      <label class="form-label"><strong>Group Type</strong></label>
      <select id="filterGroupType" class="form-select">
        <option value="">-- All --</option>
      </select>
    </div>

    <!-- Group -->
    <div class="col-md-2">
      <label class="form-label"><strong>Group</strong></label>
      <select id="filterGroup" class="form-select">
        <option value="">-- All --</option>
      </select>
    </div>

    <!-- Location -->
    <div class="col-md-2">
      <label class="form-label"><strong>Location</strong></label>
      <select id="filterLocation" class="form-select">
        <option value="">-- All --</option>
      </select>
    </div>

    <!-- Bot√µes principais -->
    <div class="col-md-2 d-flex flex-column gap-2">
      <button class="btn btn-primary w-100" onclick="filterObservations()">Apply Filter</button>
      <button class="btn btn-secondary w-100" onclick="clearFilters()">Clear</button>
      <button class="btn btn-danger w-100" onclick="deleteSelected()">Delete Selected</button>
    </div>

    <div class="col-md-2 d-flex flex-column gap-2">
        <button class="btn btn-success w-100" onclick="confirmAction()">Confirmar a√ß√£o</button>
    </div>
    <div class="col-md-2 d-flex flex-column gap-2">
        <button class="btn btn-primary w-100" onclick="openInsertToGroupModal()">Inserir no Grupo</button>
    </div>
  </div>
</div>


<table class="table table-bordered">
  <thead>
      <tr>
          <th><input type="checkbox" id="selectAll"></th>
          <th>ID</th>
          <th>Full Name</th>
          <th>NID</th>
          <th>Gender</th>
          <th>Age</th>
          <th>Contact</th>
          <th>Occupation</th>
          <th>SMS Text Message</th>
          <th>Status</th>
          <th>Unidade Sanit√°ria</th>
          <th>Utilizador</th>
          <th>Actions</th>
      </tr>
  </thead>
  <tbody id="obsTableBody"></tbody>
</table>
<div id="pagination" class="mt-3 d-flex justify-content-center"></div>

<!-- ============== MODAL OBSERVATION ============== -->
<div class="modal fade" id="obsModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form id="obsForm">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle">Add Observation</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="obsId">
          <div class="row">
            <div class="col-md-6">
              <input class="form-control mb-2" id="nid" placeholder="NID" required>
              <input class="form-control mb-2" id="fullname" placeholder="Full Name" required>
              <select class="form-select mb-2" id="gender">
                <option value="M">M</option><option value="F">F</option>
              </select>
              <input class="form-control mb-2" id="age" placeholder="Age" required>
              <input class="form-control mb-2" id="contact" placeholder="Contact" required>
              <select class="form-select mb-2" id="occupation" required>
                <option value="">Select Occupation</option><option>Militar</option><option>Civil</option>
              </select>
              <input class="form-control mb-2" id="datainiciotarv" type="datetime-local">
              <input class="form-control mb-2" id="datalevantamento" type="datetime-local">
              <input class="form-control mb-2" id="dataproximolevantamento" type="datetime-local">
              <input class="form-control mb-2" id="dataconsulta" type="datetime-local">
              <input class="form-control mb-2" id="dataproximaconsulta" type="datetime-local">
              <input class="form-control mb-2" id="dataalocacao" type="datetime-local">
            </div>
            <div class="col-md-6">
              <input class="form-control mb-2" id="dataenvio" type="datetime-local">
              <input class="form-control mb-2" id="smssendernumber" placeholder="SMS Sender Number">
              <input class="form-control mb-2" id="smssuporternumber" placeholder="SMS Supporter Number">
              <input class="form-control mb-2" id="dataprimeiracv" type="datetime-local">
              <input class="form-control mb-2" id="dataultimacv" type="datetime-local">
              <input class="form-control mb-2" id="valorprimeiracv" type="number" placeholder="Valor 1st CV">
              <input class="form-control mb-2" id="valorultimacv" type="number" placeholder="Valor Last CV">
              <input class="form-control mb-2" id="linhaterapeutica" placeholder="Linha Terap√™utica">
              <input class="form-control mb-2" id="regime" placeholder="Regime">
              <select class="form-select mb-2" id="stateSelect"></select>
              <select class="form-select mb-2" id="textmessageSelect"></select>
              <select class="form-select mb-2" id="grouptypeSelect"></select>
              <select class="form-select mb-2" id="groupSelect"></select>
              <select class="form-select mb-2" id="locationSelect"></select>
              <select class="form-select mb-2" id="userSelect"></select>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" type="submit">Save</button>
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- ============== MODAL INSERIR NO GRUPO ============== -->
<div class="modal fade" id="insertGroupModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Criar Grupo e Inserir Pacientes</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Nome do Grupo</label>
            <input class="form-control" id="txtGroupName" placeholder="Ex: Grupo A">
          </div>
          <div class="col-md-6">
            <label class="form-label">Text Message</label>
            <select class="form-select" id="selectTextMessage"></select>
          </div>
          <div class="col-md-6">
            <label class="form-label">Data Inicial</label>
            <input class="form-control" id="dateStart" type="date">
          </div>
          <div class="col-md-6">
            <label class="form-label">Data Final</label>
            <input class="form-control" id="dateEnd" type="date">
          </div>
          <div class="col-12">
            <label class="form-label">Observa√ß√£o</label>
            <textarea class="form-control" id="txtObservation" rows="2"></textarea>
          </div>

          <div class="col-md-6">
            <label class="form-label">Selecione grupo j√° existente (opcional)</label>
            <select class="form-select" id="selectGroupInsert"></select>
          </div>
        </div>

        <hr>
        <h6>Pacientes selecionados:</h6>
        <table class="table table-bordered">
          <thead>
            <tr><th>ID</th><th>Full Name</th><th>NID</th><th>Gender</th><th>Age</th><th>Contact</th></tr>
          </thead>
          <tbody id="selectedPatientsBody"></tbody>
        </table>
      </div>

      <div class="modal-footer">
        <!-- Modal footer -->
        <div class="modal-footer">
            <button class="btn btn-primary" onclick="confirmAddMembers()">Guardar</button>
            <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Loader -->
<div id="overlay" style="display:none;position:fixed;inset:0;background:rgba(255,255,255,.8);z-index:2000;justify-content:center;align-items:center">
  <div class="circular-progress" style="width:120px;height:120px;border-radius:50%;background:conic-gradient(#007bff 0% 0%,#e0e0e0 0% 100%);display:flex;justify-content:center;align-items:center;font-size:20px;font-weight:bold;color:#007bff;">
    <span id="progressText">0%</span>
  </div>
</div>

<script>
/* ======== API ENDPOINTS ======== */
const apiObs = '/api/observation';
const apiState = '/api/state';
const apiTextMessage = '/api/textmessage';
const apiGrouptype = '/api/grouptype';
const apiGroup = '/api/group';
const apiLocation = '/api/location';
const apiUser = '/api/user';

let currentPage = 1;
const pageSize = 50;
let observationsData = [];
let filteredData = [];

/* --- PROGRESS BAR --- */
function updateProgress(percent){
  document.querySelector('.circular-progress').style.background =
    `conic-gradient(#007bff ${percent}%, #e0e0e0 ${percent}% 100%)`;
  document.getElementById('progressText').innerText = percent + "%";
}

/* --- Load Dropdowns --- */
async function loadDropdown(url, selectId, field='description'){
  const res = await fetch(url);
  const data = await res.json();
  const select = document.getElementById(selectId);
  select.innerHTML = '';
  data.forEach(i => select.innerHTML += `<option value="${i.id}">${i[field]}</option>`);
}

/* --- Load Observations With Loader --- */
async function loadObservationsWithProgress(){
  document.getElementById('overlay').style.display = "flex";

  let progress = 0;
  const interval = setInterval(() => {
    if(progress < 90) updateProgress(++progress);
  }, 25);

  try{
    const res = await fetch(apiObs);
    const data = await res.json();
    clearInterval(interval);
    updateProgress(100);

    observationsData = filteredData = data;
    renderTablePage(filteredData, currentPage);
  } catch(e){
    alert("Erro ao carregar observa√ß√µes.");
  } finally {
    setTimeout(() => {
      document.getElementById('overlay').style.display = "none";
      updateProgress(0);
    }, 400);
  }
}

/* --- Table & Pagination --- */
function renderTablePage(data, page){
  const tbody = document.getElementById('obsTableBody');
  tbody.innerHTML = '';
  const start = (page-1)*pageSize;
  data.slice(start, start+pageSize).forEach(o=>{
    tbody.innerHTML += `
      <tr>
        <td><input type="checkbox" class="rowCheck" value="${o.id}"></td>
        <td>${o.id}</td>
        <td>${o.fullname}</td>
        <td>${o.nid}</td>
        <td>${o.gender}</td>
        <td>${o.age}</td>
        <td>${o.contact}</td>
        <td>${o.occupation}</td>
        <td>${o.textMessageDescription}</td>
        <td>${o.status}</td>
        <td>${o.userFullName}</td>
        <td>${o.locationName}</td>
        <td>
          <button class="btn btn-warning btn-sm" onclick="editObs(${o.id})">Edit</button>
          <button class="btn btn-danger btn-sm" onclick="deleteObs(${o.id})">Delete</button>
        </td>
      </tr>`;
  });
  renderPagination(data,page);
}

function renderPagination(data,page){
  const c = document.getElementById('pagination');
  c.innerHTML = '';
  const total = Math.ceil(data.length / pageSize);
  for(let i=1;i<=total;i++){
    const b = document.createElement('button');
    b.className = 'btn btn-sm ' + (i===page? 'btn-primary':'btn-outline-primary') + ' me-1';
    b.innerText = i;
    b.onclick = () => { currentPage = i; renderTablePage(filteredData, currentPage); };
    c.appendChild(b);
  }
}

/* --- Open Modal for New Record --- */
function openObsModal(){
  document.getElementById('modalTitle').innerText = "Add Observation";
  document.getElementById('obsForm').reset();
  document.getElementById('obsId').value = "";
}

/* --- Edit Observation --- */
async function editObs(id){
  const res = await fetch(`${apiObs}/${id}`);
  const o = await res.json();
  document.getElementById('modalTitle').innerText = "Edit Observation";
  document.getElementById('obsId').value = o.id;

  for(const k in o){
    if(document.getElementById(k)) document.getElementById(k).value = o[k];
  }

  new bootstrap.Modal(document.getElementById('obsModal')).show();
}

/* --- Save Observation --- */
document.getElementById('obsForm').addEventListener('submit', async e=>{
  e.preventDefault();
  const id = obsId.value;
  const payload = {};

  document.querySelectorAll('#obsForm input,#obsForm select').forEach(el=>{
    if(el.id !== 'obsId' && el.value!=="") payload[el.id.replace("Select","Id")] = isNaN(el.value)? el.value : Number(el.value);
  });

  await fetch(id ? `${apiObs}/${id}` : apiObs, {
    method: id? 'PUT':'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(payload)
  });

  bootstrap.Modal.getInstance(document.getElementById('obsModal')).hide();
  loadObservationsWithProgress();
});

/* --- Delete observation single / bulk --- */
async function deleteObs(id){
  if(!confirm("Eliminar?")) return;
  await fetch(`${apiObs}/${id}`,{method:'DELETE'});
  loadObservationsWithProgress();
}

function getSelectedIds(){
  return [...document.querySelectorAll(".rowCheck:checked")].map(e=>Number(e.value));
}

async function deleteSelected(){
  const ids = getSelectedIds();
  if(!ids.length) return alert("Nenhum selecionado");
  if(!confirm(`Apagar ${ids.length} registros?`)) return;
  for(const id of ids) await fetch(`${apiObs}/${id}`,{method:'DELETE'});
  loadObservationsWithProgress();
}

/* --- Filters --- */
async function filterObservations(){
  const p = new URLSearchParams();

  // Filtros existentes
  ["filterTextmessage","filterState","filterGroupType","filterGroup","filterLocation"].forEach(id=>{
    const v = document.getElementById(id).value;
    if(v) p.append(id.replace("filter","").toLowerCase()+"Id", v);
  });

  // Novos filtros de datas
  const startDate = document.getElementById('filterStartDate').value;
  const endDate = document.getElementById('filterEndDate').value;

  if(startDate) p.append('startDate', startDate);
  if(endDate) p.append('endDate', endDate);

  // Chamada √† API
  const res = await fetch(p.toString()? `${apiObs}?${p}` : apiObs);
  const data = await res.json();

  filteredData = data;
  currentPage = 1;
  renderTablePage(filteredData, currentPage);
}

function clearFilters(){
  ["filterTextmessage","filterState","filterGroupType","filterGroup","filterLocation","filterStartDate","filterEndDate"]
    .forEach(id => document.getElementById(id).value = "");
  loadObservationsWithProgress();
}

// --- Adicionar membros ao grupo ---
async function confirmAddMembers() {
    const selectedPatientIds = getSelectedIds(); // array de pacientes
    if (!selectedPatientIds.length) return alert("Selecione pacientes.");

    const groupName = document.getElementById('txtGroupName').value;
    if (!groupName) return alert("Digite o nome do grupo.");

    const textMessageId = Number(document.getElementById('selectTextMessage').value);
    if (!textMessageId) return alert("Selecione Text Message.");

    // Outros campos opcionais do grupo
    const dateStart = document.getElementById('dateStart').value || null;
    const dateEnd = document.getElementById('dateEnd').value || null;
    const observation = document.getElementById('txtObservation').value || null;

    // 1Ô∏è‚É£ Criar grupo via API
    const resGroup = await fetch('/api/group', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            description: groupName,
            dateStart: dateStart,
            dateEnd: dateEnd,
            observation: observation
        })
    });

    if (!resGroup.ok) {
        const err = await resGroup.json();
        return alert("Erro ao criar grupo: " + (err.message || err.error));
    }

    const newGroup = await resGroup.json();
    const groupId = newGroup.id;

    // 2Ô∏è‚É£ Atualizar cada observa√ß√£o selecionada
    for (const obsId of selectedPatientIds) {
        await fetch(`/api/observation/updategroup/${obsId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ groupId: groupId, textmessageId: textMessageId })
        });
    }

    alert("Pacientes inseridos no grupo com sucesso!");
    bootstrap.Modal.getInstance(document.getElementById('insertGroupModal')).hide();
    loadObservationsWithProgress();
}

/* --- Confirm Action (State + Text) --- */
async function confirmAction(){
  const textId = filterTextmessage.value;
  const stateId = filterState.value;
  const stateText = filterState.options[filterState.selectedIndex].text; // pega o texto do dropdown
  const ids = getSelectedIds();

  if(!ids.length) return alert("Selecione pacientes.");
  if(!textId) return alert("Selecione Text Message.");
  if(!stateId) return alert("Selecione State.");
  if(!confirm(`Confirmar a√ß√£o para ${ids.length} pacientes?`)) return;

  for(const id of ids){
    await fetch(`/api/observation/confirm/${id}`, {
      method:'PUT', 
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({stateId:Number(stateId), textmessageId:Number(textId)})
    });

    // Atualiza localmente o campo status
    const obs = observationsData.find(o => o.id === id);
    if(obs) obs.status = stateText;
  }

  alert("A√ß√£o conclu√≠da!");
  renderTablePage(filteredData, currentPage); // atualiza a tabela com os novos status
}


/* --- Insert into Group --- */
async function openInsertToGroupModal(){
  const ids = getSelectedIds();
  if(!ids.length) return alert("Selecione pacientes.");

  selectedPatientsBody.innerHTML = "";
  observationsData.filter(o=>ids.includes(o.id)).forEach(o=>{
    selectedPatientsBody.innerHTML += `<tr><td>${o.id}</td><td>${o.fullname}</td><td>${o.nid}</td><td>${o.gender}</td><td>${o.age}</td><td>${o.contact}</td></tr>`;
  });

  /* load dropdowns */
  await loadDropdown(apiTextMessage,'selectTextMessage','messagetext');
  new bootstrap.Modal(document.getElementById('insertGroupModal')).show();
}

// Criar grupo
async function createGroup() {
    const description = document.getElementById('txtGroupName').value;
    if(!description) return alert("Digite o nome do grupo.");

    const payload = {
        description: description,
        dateStart: document.getElementById('dateStart').value,
        dateEnd: document.getElementById('dateEnd').value,
        observation: document.getElementById('txtObservation').value
    };

    console.log("Criar grupo payload:", payload);


    const res = await fetch('/api/group', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    });

    const data = await res.json();
    console.log(data);
}

// Adicionar membros
async function addMembers(groupId, selectedPatientIds) {
    const payload = {
        groupId: groupId,
        patients: selectedPatientIds
    };

    const res = await fetch('/api/group/addmembersingrup', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    });

    const data = await res.json();
    console.log(data);
}


async function submitInsertToGroup(){
  const ids = getSelectedIds();

  /* create group if name filled */
  if(txtGroupName.value){
    const res = await fetch(apiGroup, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        name: txtGroupName.value,
        textmessageId:Number(selectTextMessage.value),
        dateStart: dateStart.value,
        dateEnd: dateEnd.value,
        observation: txtObservation.value
      })
    });
    const newGroup = await res.json();
    finalGroupId = newGroup.id;
  }

  /* add members */
  await fetch('/api/group/addmembersingrup', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body:JSON.stringify({ groupId:finalGroupId, patients: ids })
  });

  alert("Pacientes inseridos com sucesso!");
  bootstrap.Modal.getInstance(document.getElementById('insertGroupModal')).hide();
}

/* --- Init Page --- */
window.onload = async ()=>{
  await loadDropdown(apiState,'filterState');
  await loadDropdown(apiTextMessage,'filterTextmessage','messagetext');
  await loadDropdown(apiGrouptype,'filterGroupType');
  await loadDropdown(apiGroup,'filterGroup');
  await loadDropdown(apiLocation,'filterLocation','name');

  await loadDropdown(apiState,'stateSelect');
  await loadDropdown(apiTextMessage,'textmessageSelect','messagetext');
  await loadDropdown(apiGrouptype,'grouptypeSelect');
  await loadDropdown(apiGroup,'groupSelect');
  await loadDropdown(apiLocation,'locationSelect','name');
  await loadDropdown(apiUser,'userSelect','fullname');

  document.getElementById('selectAll').addEventListener('change',()=> {
    document.querySelectorAll('.rowCheck').forEach(c=>c.checked = selectAll.checked);
  });

  await loadObservationsWithProgress();
};
</script>

{% endblock %}
